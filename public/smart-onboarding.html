<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Langflix üé¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .onboarding-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .step {
            display: none;
            animation: fadeIn 0.5s ease;
            text-align: center;
            width: 100%;
        }

        .step.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            animation: bounce 1s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        p {
            font-size: 1.1em;
            margin-bottom: 30px;
            opacity: 0.95;
            line-height: 1.6;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 400px;
        }

        button {
            padding: 18px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 65, 108, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-skip {
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: none;
            padding: 10px;
            font-size: 0.95em;
            margin-top: 10px;
        }

        .btn-skip:hover {
            color: white;
            text-decoration: underline;
        }

        .level-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
            width: 100%;
        }

        .level-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .level-card:hover {
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .level-card.selected {
            border-color: #FF416C;
            background: rgba(255, 65, 108, 0.3);
        }

        .level-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .level-card p {
            font-size: 0.85em;
            margin: 0;
            opacity: 0.8;
        }

        .video-preview {
            width: 100%;
            max-width: 400px;
            border-radius: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .feedback-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .feedback-btn {
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.5em;
            min-width: 80px;
        }

        .emoji {
            font-size: 3em;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF416C 0%, #FF4B2B 100%);
            transition: width 0.3s ease;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-box h3 {
            margin-bottom: 10px;
        }

        .info-box ul {
            text-align: left;
            padding-left: 20px;
        }

        .info-box li {
            margin: 8px 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="onboarding-container">
        <!-- Step 1: Welcome -->
        <div class="step active" id="step-welcome">
            <div class="emoji">üé¨</div>
            <h1>Welcome to Langflix!</h1>
            <p>Learn Spanish by watching videos you actually enjoy. Just like TikTok, but you'll become fluent.</p>
            
            <div class="button-group">
                <button class="btn-primary" onclick="startJourney()">
                    üöÄ Let's Go!
                </button>
                <button class="btn-secondary" onclick="skipToApp()">
                    üëÄ Just Browse (No Signup)
                </button>
            </div>
        </div>

        <!-- Step 2: Choose Assessment Method -->
        <div class="step" id="step-assessment-choice">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 25%"></div>
            </div>
            
            <h1>How should we find your level?</h1>
            <p>Choose the way that feels right for you</p>
            
            <div class="button-group">
                <button class="btn-primary" onclick="chooseMethod('swipe')">
                    üéØ Watch & Swipe (2 min)
                    <div style="font-size: 0.85em; opacity: 0.8; margin-top: 5px;">Watch videos, tell us if they're too easy or hard</div>
                </button>
                
                <button class="btn-primary" onclick="chooseMethod('test')">
                    üìù Quick Test (5 min)
                    <div style="font-size: 0.85em; opacity: 0.8; margin-top: 5px;">Answer fun questions to find your level</div>
                </button>
                
                <button class="btn-primary" onclick="chooseMethod('manual')">
                    üéì I Know My Level
                    <div style="font-size: 0.85em; opacity: 0.8; margin-top: 5px;">Just tell us and we'll personalize for you</div>
                </button>
            </div>
            
            <button class="btn-skip" onclick="skipToApp()">
                Skip - I'll decide later
            </button>
        </div>

        <!-- Step 3A: Manual Level Selection -->
        <div class="step" id="step-manual-level">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 75%"></div>
            </div>
            
            <h1>What's your Spanish level?</h1>
            <p>Be honest - we'll show you perfect content for you!</p>
            
            <div class="level-cards">
                <div class="level-card" onclick="selectLevel('A1')" data-level="A1">
                    <h3>A1</h3>
                    <p>Complete Beginner</p>
                </div>
                <div class="level-card" onclick="selectLevel('A2')" data-level="A2">
                    <h3>A2</h3>
                    <p>Elementary</p>
                </div>
                <div class="level-card" onclick="selectLevel('B1')" data-level="B1">
                    <h3>B1</h3>
                    <p>Intermediate</p>
                </div>
                <div class="level-card" onclick="selectLevel('B2')" data-level="B2">
                    <h3>B2</h3>
                    <p>Upper-Int</p>
                </div>
                <div class="level-card" onclick="selectLevel('C1')" data-level="C1">
                    <h3>C1</h3>
                    <p>Advanced</p>
                </div>
                <div class="level-card" onclick="selectLevel('C2')" data-level="C2">
                    <h3>C2</h3>
                    <p>Mastery</p>
                </div>
            </div>
            
            <div class="info-box">
                <h3>Not sure?</h3>
                <ul>
                    <li><strong>A1-A2:</strong> Can say basic phrases, order food</li>
                    <li><strong>B1-B2:</strong> Can have conversations, understand most shows</li>
                    <li><strong>C1-C2:</strong> Fluent, native-like understanding</li>
                </ul>
            </div>
        </div>

        <!-- Step 3B: Video Swipe Assessment -->
        <div class="step" id="step-swipe-assessment">
            <div class="progress-bar">
                <div class="progress-fill" id="swipe-progress" style="width: 0%"></div>
            </div>
            
            <h1>Watch these videos</h1>
            <p id="swipe-instruction">Tell us: Too easy, perfect, or too hard?</p>
            
            <video class="video-preview" id="assessment-video" controls muted>
                <source src="" type="video/mp4">
            </video>
            
            <div class="feedback-buttons">
                <button class="feedback-btn btn-secondary" onclick="rateVideo('easy')">
                    üò¥ Too Easy
                </button>
                <button class="feedback-btn btn-primary" onclick="rateVideo('perfect')">
                    üéØ Perfect
                </button>
                <button class="feedback-btn btn-secondary" onclick="rateVideo('hard')">
                    ü§Ø Too Hard
                </button>
            </div>
            
            <p style="margin-top: 20px; font-size: 0.9em; opacity: 0.8;">
                Video <span id="video-number">1</span> of 5
            </p>
        </div>

        <!-- Step 3C: Quick Test -->
        <div class="step" id="step-quick-test">
            <div class="progress-bar">
                <div class="progress-fill" id="test-progress" style="width: 0%"></div>
            </div>
            
            <h1 id="test-question">Loading question...</h1>
            <p id="test-subtitle"></p>
            
            <div class="button-group" id="test-options">
                <!-- Options will be populated by JavaScript -->
            </div>
            
            <button class="btn-skip" onclick="skipToApp()">
                Skip test
            </button>
        </div>

        <!-- Step 4: Final Setup -->
        <div class="step" id="step-final">
            <div class="emoji">üéâ</div>
            <h1>You're all set!</h1>
            <p id="level-result">We've matched you with <strong id="detected-level">B1</strong> level content!</p>
            
            <div class="button-group">
                <button class="btn-primary" onclick="enterApp()">
                    üé¨ Start Watching
                </button>
                <button class="btn-secondary" onclick="showSignup()">
                    üíæ Create Account (Save Progress)
                </button>
            </div>
            
            <button class="btn-skip" onclick="enterApp()">
                I'll sign up later
            </button>
        </div>

        <!-- Step 5: Optional Signup -->
        <div class="step" id="step-signup">
            <h1>Save Your Progress</h1>
            <p>Create an account to save your words, progress, and level across devices</p>
            
            <form id="signup-form" style="width: 100%; max-width: 400px;">
                <input type="email" id="email" placeholder="Email" 
                    style="width: 100%; padding: 15px; margin: 10px 0; border-radius: 15px; border: none; font-size: 1em;">
                <input type="password" id="password" placeholder="Password" 
                    style="width: 100%; padding: 15px; margin: 10px 0; border-radius: 15px; border: none; font-size: 1em;">
                
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 15px;">
                    Create Account
                </button>
            </form>
            
            <button class="btn-skip" onclick="enterApp()">
                Continue as guest
            </button>
        </div>
    </div>

    <script>
        // User state management
        const userState = {
            method: null,
            level: null,
            isGuest: true,
            swipeData: [],
            testData: [],
            userId: null
        };

        // Generate guest user ID
        function getOrCreateGuestId() {
            let guestId = localStorage.getItem('langflix_guest_id');
            if (!guestId) {
                guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('langflix_guest_id', guestId);
            }
            return guestId;
        }

        // Initialize
        userState.userId = getOrCreateGuestId();

        function startJourney() {
            showStep('step-assessment-choice');
        }

        function skipToApp() {
            // Set default level or use previously saved level
            const savedLevel = localStorage.getItem('langflix_user_level');
            userState.level = savedLevel || 'B1';
            localStorage.setItem('langflix_user_level', userState.level);
            
            // Enter app directly
            window.location.href = '/tiktok-video-feed.html';
        }

        function chooseMethod(method) {
            userState.method = method;
            
            if (method === 'swipe') {
                initSwipeAssessment();
            } else if (method === 'test') {
                initQuickTest();
            } else if (method === 'manual') {
                showStep('step-manual-level');
            }
        }

        function selectLevel(level) {
            // Remove previous selections
            document.querySelectorAll('.level-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select this level
            event.target.closest('.level-card').classList.add('selected');
            userState.level = level;
            
            // Auto-advance after selection
            setTimeout(() => {
                completeOnboarding();
            }, 500);
        }

        // Swipe Assessment
        const swipeVideos = [
            { url: '/videos/langfeed/langfeed_001.mp4', level: 'A2' },
            { url: '/videos/langfeed/langfeed_050.mp4', level: 'B1' },
            { url: '/videos/langfeed/langfeed_100.mp4', level: 'B2' },
            { url: '/videos/langfeed/langfeed_200.mp4', level: 'A1' },
            { url: '/videos/langfeed/langfeed_300.mp4', level: 'C1' }
        ];
        let currentSwipeVideo = 0;

        function initSwipeAssessment() {
            showStep('step-swipe-assessment');
            loadSwipeVideo(0);
        }

        function loadSwipeVideo(index) {
            if (index >= swipeVideos.length) {
                calculateSwipeLevel();
                return;
            }
            
            const video = document.getElementById('assessment-video');
            video.src = swipeVideos[index].url;
            video.load();
            
            document.getElementById('video-number').textContent = index + 1;
            
            const progress = ((index + 1) / swipeVideos.length) * 100;
            document.getElementById('swipe-progress').style.width = progress + '%';
        }

        function rateVideo(difficulty) {
            const videoData = swipeVideos[currentSwipeVideo];
            userState.swipeData.push({
                video: videoData,
                rating: difficulty
            });
            
            currentSwipeVideo++;
            
            if (currentSwipeVideo < swipeVideos.length) {
                loadSwipeVideo(currentSwipeVideo);
            } else {
                calculateSwipeLevel();
            }
        }

        function calculateSwipeLevel() {
            // Smart algorithm: analyze user feedback
            let score = 0;
            const levelScores = { 'A1': 1, 'A2': 2, 'B1': 3, 'B2': 4, 'C1': 5, 'C2': 6 };
            
            userState.swipeData.forEach(item => {
                const baseScore = levelScores[item.video.level];
                if (item.rating === 'easy') score += baseScore - 1;
                else if (item.rating === 'perfect') score += baseScore;
                else if (item.rating === 'hard') score += baseScore + 1;
            });
            
            const avgScore = Math.round(score / userState.swipeData.length);
            const levels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            userState.level = levels[Math.max(0, Math.min(avgScore - 1, 5))];
            
            completeOnboarding();
        }

        // Quick Test Assessment
        const testQuestions = [
            {
                question: '¬øQu√© significa "gato"?',
                subtitle: 'What does "gato" mean?',
                options: ['Cat', 'Dog', 'House', 'Water'],
                correct: 0,
                level: 'A1'
            },
            {
                question: 'Ayer ___ al supermercado.',
                subtitle: 'Choose the correct verb',
                options: ['fui', 'fue', 'voy', 'ir'],
                correct: 0,
                level: 'A2'
            },
            {
                question: 'Si tuviera tiempo, ___ a Espa√±a.',
                subtitle: 'Conditional sentence',
                options: ['viajar√≠a', 'viajo', 'viaj√©', 'viajar'],
                correct: 0,
                level: 'B1'
            },
            {
                question: 'Es importante que ___ a tiempo.',
                subtitle: 'Subjunctive mood',
                options: ['llegues', 'llegas', 'llegar√°s', 'llegar'],
                correct: 0,
                level: 'B2'
            },
            {
                question: 'Aunque ___ dinero, no lo comprar√≠a.',
                subtitle: 'Imperfect subjunctive',
                options: ['tuviera', 'ten√≠a', 'tuve', 'tendr√©'],
                correct: 0,
                level: 'C1'
            }
        ];
        let currentTestQuestion = 0;

        function initQuickTest() {
            showStep('step-quick-test');
            loadTestQuestion(0);
        }

        function loadTestQuestion(index) {
            if (index >= testQuestions.length) {
                calculateTestLevel();
                return;
            }
            
            const q = testQuestions[index];
            document.getElementById('test-question').textContent = q.question;
            document.getElementById('test-subtitle').textContent = q.subtitle;
            
            const optionsContainer = document.getElementById('test-options');
            optionsContainer.innerHTML = '';
            
            q.options.forEach((option, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn-secondary';
                btn.textContent = option;
                btn.onclick = () => answerTest(i, q.correct, q.level);
                optionsContainer.appendChild(btn);
            });
            
            const progress = ((index + 1) / testQuestions.length) * 100;
            document.getElementById('test-progress').style.width = progress + '%';
        }

        function answerTest(selected, correct, level) {
            const isCorrect = selected === correct;
            userState.testData.push({ level, correct: isCorrect });
            
            currentTestQuestion++;
            
            if (currentTestQuestion < testQuestions.length) {
                setTimeout(() => loadTestQuestion(currentTestQuestion), 500);
            } else {
                calculateTestLevel();
            }
        }

        function calculateTestLevel() {
            // Find highest level where user got questions right
            const levelOrder = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            let detectedLevel = 'A1';
            
            for (let i = userState.testData.length - 1; i >= 0; i--) {
                if (userState.testData[i].correct) {
                    detectedLevel = userState.testData[i].level;
                    break;
                }
            }
            
            userState.level = detectedLevel;
            completeOnboarding();
        }

        function completeOnboarding() {
            // Save level to localStorage
            localStorage.setItem('langflix_user_level', userState.level);
            localStorage.setItem('langflix_onboarding_complete', 'true');
            
            // Show final step
            document.getElementById('detected-level').textContent = userState.level;
            showStep('step-final');
        }

        function showSignup() {
            showStep('step-signup');
        }

        function enterApp() {
            // Save guest state
            localStorage.setItem('langflix_is_guest', 'true');
            
            // Redirect to main app
            window.location.href = '/tiktok-video-feed.html?level=' + userState.level;
        }

        // Signup form handler
        document.getElementById('signup-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/auth/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        password,
                        level: userState.level,
                        onboardingMethod: userState.method
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    localStorage.setItem('langflix_is_guest', 'false');
                    localStorage.setItem('langflix_user_token', result.token);
                    enterApp();
                } else {
                    alert(result.error || 'Signup failed. Please try again.');
                }
            } catch (error) {
                console.error('Signup error:', error);
                alert('Network error. Continuing as guest.');
                enterApp();
            }
        });

        function showStep(stepId) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
        }

        // Check if user has already completed onboarding
        window.addEventListener('DOMContentLoaded', () => {
            const onboardingComplete = localStorage.getItem('langflix_onboarding_complete');
            if (onboardingComplete === 'true') {
                // Skip onboarding, go straight to app
                enterApp();
            }
        });
    </script>
</body>
</html>

