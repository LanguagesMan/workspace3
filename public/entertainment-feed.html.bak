<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üåç VIDA - Learn Spanish from Everything</title>
    <script src="word-level-subtitles.js?v=dual-lang-2025"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            /* üé® 2025 Premium Color Palette - TikTok/Instagram Inspired */
            --primary: #ff0a6c;
            --primary-glow: rgba(255, 10, 108, 0.4);
            --secondary: #667eea;
            --accent-cyan: #00f2fe;
            --accent-purple: #a855f7;
            --accent-green: #10b981;
            --accent-gold: #ffd700;

            /* üåë Dark Mode (2025 Standard) */
            --bg-dark: #000000;
            --bg-card: #1a1a1a;
            --bg-elevated: #252525;

            /* ‚ú® Glassmorphism Variables (2025 Trend) */
            --glass-bg: rgba(26, 26, 26, 0.7);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.37);

            /* üìù Typography */
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.75);
            --text-tertiary: rgba(255, 255, 255, 0.5);

            /* üé≠ Interactive States */
            --hover-lift: 0 12px 40px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden; /* Hide all scrollbars - only feed scrolls */
            -webkit-font-smoothing: antialiased;
        }

        /* TOP TABS HIDDEN - BOTTOM MENU ONLY */
        .top-nav-tabs {
            display: none !important;
        }

        .top-nav-tabs-original {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            /* iOS 2025 Liquid Glass Effect */
            background: var(--glass-bg);
            backdrop-filter: saturate(180%) blur(30px);
            -webkit-backdrop-filter: saturate(180%) blur(30px);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--glass-border);
            /* Premium shadow for depth */
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
        }

        .nav-tab {
            background: none;
            border: none;
            color: var(--text-tertiary);
            /* 2025 Trend: Bolder Typography */
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.3px;
            padding: 16px 20px;
            cursor: pointer;
            /* Micro-interaction: Smooth spring animation */
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .nav-tab:hover {
            color: var(--text-secondary);
            transform: scale(1.05);
        }

        .nav-tab.active {
            color: var(--text-primary);
            text-shadow: 0 0 20px var(--primary-glow);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent-purple));
            border-radius: 3px 3px 0 0;
            box-shadow: 0 0 16px var(--primary-glow);
            animation: slideInGlow 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideIn {
            from {
                width: 0;
                opacity: 0;
            }
            to {
                width: 30px;
                opacity: 1;
            }
        }

        @keyframes slideInGlow {
            0% {
                width: 0;
                opacity: 0;
                box-shadow: 0 0 0 var(--primary-glow);
            }
            50% {
                opacity: 1;
                box-shadow: 0 0 20px var(--primary-glow);
            }
            100% {
                width: 40px;
                opacity: 1;
                box-shadow: 0 0 16px var(--primary-glow);
            }
        }

        /* TIKTOK BOTTOM NAVIGATION BAR (2025 Glassmorphism Premium) */
        .bottom-nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            /* Premium glassmorphism */
            background: var(--glass-bg);
            backdrop-filter: saturate(180%) blur(30px);
            -webkit-backdrop-filter: saturate(180%) blur(30px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0 env(safe-area-inset-bottom);
            z-index: 1000;
            border-top: 1px solid var(--glass-border);
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.4);
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 11px;
            font-weight: 600;
            padding: 8px 12px;
            cursor: pointer;
            /* Spring animation for interactions */
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 60px;
            min-height: 44px;
            position: relative;
        }

        .bottom-nav-item:hover {
            color: var(--text-secondary);
            transform: scale(1.1) translateY(-2px);
        }

        .bottom-nav-item:active {
            transform: scale(0.95);
        }

        .bottom-nav-item.active {
            color: var(--primary);
        }

        .bottom-nav-item.active .bottom-nav-icon {
            animation: bounceIcon 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIcon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .bottom-nav-icon {
            font-size: 26px;
            margin-bottom: 4px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .bottom-nav-item.active .bottom-nav-icon {
            filter: drop-shadow(0 0 8px var(--primary-glow));
        }

        /* INFINITE SCROLL CONTAINER - TikTok Style (2025) */
        .feed-container {
            width: 100%;
            height: 100vh;
            /* TikTok scroll-snap mechanics - CRITICAL: apply to html, not container */
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        .feed-container::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* SKELETON LOADING */
        .skeleton-card {
            background: var(--bg-card);
            border-radius: 16px;
            margin: 12px;
            overflow: hidden;
            padding: 16px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .skeleton-line {
            height: 16px;
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* CONTENT CARDS - All types unified - TikTok Style (2025 Full-Screen) */
        .content-card {
            background: var(--bg-dark);
            width: 100%;
            height: 100vh;
            position: relative;
            animation: fadeInUp 0.4s ease;
            /* TikTok full-screen snap - MANDATORY */
            scroll-snap-align: start;
            scroll-snap-stop: always;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* MEDIA SECTION - Full-Screen TikTok Style */
        .card-media {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1;
        }

        .card-media img,
        .card-media video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover; /* TikTok 9:16 aspect ratio */
        }

        .media-overlay {
            position: absolute;
            bottom: 80px; /* Above bottom nav */
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 20px;
            color: white;
            z-index: 10;
            pointer-events: none;
        }

        .media-overlay * {
            pointer-events: auto; /* Allow clicks on overlay content */
        }

        /* CONTENT TYPE BADGE */
        .content-type {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-news { background: linear-gradient(135deg, #667eea, #764ba2); }
        .type-social { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .type-video { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .type-meme { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .type-article { background: linear-gradient(135deg, #fa709a, #fee140); }
        .type-quiz { background: linear-gradient(135deg, #a8edea, #fed6e3); }

        /* TEXT CONTENT - Overlay on full-screen video */
        .card-content {
            position: absolute;
            bottom: 80px; /* Above bottom nav */
            left: 0;
            right: 0;
            padding: 20px;
            z-index: 10;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            line-height: 1.3;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .title-text {
            flex: 1;
        }

        .translate-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .translate-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 0, 80, 0.3);
        }

        .translate-btn.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .card-text {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        /* SPANISH TEXT WITH TAP-TO-TRANSLATE */
        .spanish-text {
            font-size: 16px;
            line-height: 1.8;
            margin: 16px 0;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border-left: 3px solid var(--primary);
        }

        .spanish-word {
            display: inline;
            cursor: pointer;
            position: relative;
            padding: 2px 0;
            transition: all 0.2s ease;
        }

        .spanish-word:hover,
        .spanish-word:active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .translation-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 1000;
            animation: tooltipFadeIn 0.2s ease;
            pointer-events: none;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-4px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .translation-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.95);
        }

        /* LEVEL INDICATOR */
        .level-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        /* PUBLISHER ATTRIBUTION (Flipboard pattern) */
        .publisher-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .publisher-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .publisher-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .publisher-info {
            flex: 1;
            min-width: 0;
        }

        .publisher-name {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
        }

        .verified-badge {
            width: 16px;
            height: 16px;
            background: #ff0050;
            border-radius: 3px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            flex-shrink: 0;
        }

        .publisher-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timestamp {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .follow-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .follow-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 0, 80, 0.3);
        }

        .follow-btn.following {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
        }

        /* XP & STREAK BANNER (Duolingo pattern) */
        .xp-streak-banner {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border-bottom: 2px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .streak-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
        }

        .streak-fire {
            font-size: 24px;
            animation: flicker 2s ease-in-out infinite;
        }

        @keyframes flicker {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.2); }
        }

        .streak-count {
            font-size: 18px;
            color: #ff6b35;
        }

        .xp-display {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .xp-bar-container {
            width: 120px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            border-radius: 10px;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }

        .xp-text {
            font-size: 14px;
            font-weight: 600;
            color: #4ade80;
            white-space: nowrap;
        }

        /* XP GAIN ANIMATION (Duolingo-style) */
        .xp-gain-popup {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 18px;
            font-weight: 700;
            z-index: 10000;
            animation: xpGainAnimation 2s ease;
            box-shadow: 0 8px 20px rgba(74, 222, 128, 0.4);
        }

        @keyframes xpGainAnimation {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px) scale(0.8);
            }
            10%, 90% {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px) scale(0.8);
            }
        }

        /* MILESTONE CELEBRATION */
        .milestone-celebration {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 20000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .milestone-celebration.active {
            display: flex;
        }

        .milestone-content {
            text-align: center;
            animation: bounceIn 0.5s ease;
        }

        .milestone-emoji {
            font-size: 100px;
            margin-bottom: 20px;
            animation: pulse 1s ease infinite;
        }

        .milestone-text {
            font-size: 32px;
            font-weight: 700;
            color: #fbbf24;
            margin-bottom: 16px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ACTIONS BAR - TikTok-style right side buttons */
        .card-actions {
            position: absolute;
            right: 12px;
            bottom: 150px; /* Above content overlay */
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 20;
        }

        .action-btn {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: none;
            color: white;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: visible;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.08);
        }

        .action-btn:active {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(0.95);
        }

        .action-btn.liked {
            color: var(--primary);
            background: rgba(255, 0, 80, 0.2);
            animation: likeExplosion 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .action-btn span {
            font-size: 11px;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        @keyframes likeExplosion {
            0% { transform: scale(1); }
            15% { transform: scale(1.3); box-shadow: 0 0 20px rgba(255, 0, 80, 0.8); }
            30% { transform: scale(0.9); }
            45% { transform: scale(1.15); }
            60% { transform: scale(0.95); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        }

        /* VIDEO SUBTITLE CONTAINER - YouTube Shorts/TikTok Style (2025) */
        .video-subtitle-container {
            position: absolute;
            bottom: 240px; /* Instagram Reels safe zone: avoid bottom 20% */
            left: 0;
            right: 80px; /* TikTok thumb zone: leave space for action buttons */
            padding: 0 24px;
            z-index: 15;
            text-align: center;
            pointer-events: none;
            /* Center vertically in safe zone (60%-80% from top) */
            max-width: 85%; /* Don't use full width for better readability */
            margin: 0 auto;
        }

        .video-subtitle-container * {
            pointer-events: auto; /* Allow clicking on words */
        }

        /* QUIZ CARD STYLES (Duolingo pattern) */
        .quiz-container {
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            margin: 12px 0;
        }

        .quiz-question {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-option {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            border: 3px solid rgba(102, 126, 234, 0.3);
            color: var(--text-primary);
            padding: 18px 22px;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            min-height: 60px;
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .quiz-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .quiz-option:hover::before {
            left: 100%;
        }

        .quiz-option:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            border-color: var(--primary);
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .quiz-option.selected {
            background: rgba(102, 126, 234, 0.2);
            border-color: var(--primary);
        }

        .quiz-option.correct {
            background: linear-gradient(135deg, #0cce6b, #0fd987, #58dc91);
            border-color: #0cce6b;
            color: white;
            animation: correctPulse 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 30px rgba(12, 206, 107, 0.6), 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .quiz-option.incorrect {
            background: linear-gradient(135deg, #ff4757, #ff6b81, #ff8fa3);
            border-color: #ff4757;
            color: white;
            animation: shake 0.5s ease;
            box-shadow: 0 0 25px rgba(255, 71, 87, 0.5), 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .quiz-option:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .quiz-feedback {
            margin-top: 16px;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .quiz-feedback.correct {
            background: rgba(12, 206, 107, 0.1);
            color: #0cce6b;
            border: 1px solid #0cce6b;
        }

        .quiz-feedback.incorrect {
            background: rgba(255, 71, 87, 0.1);
            color: #ff4757;
            border: 1px solid #ff4757;
        }

        .quiz-xp-reward {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            margin-left: 8px;
            animation: pop-in 0.3s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            15% { transform: scale(1.12); box-shadow: 0 0 40px rgba(12, 206, 107, 0.8); }
            30% { transform: scale(0.95); }
            45% { transform: scale(1.08); }
            60% { transform: scale(0.98); }
            75% { transform: scale(1.03); }
            100% { transform: scale(1); box-shadow: 0 0 30px rgba(12, 206, 107, 0.6); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10% { transform: translateX(-10px) rotate(-2deg); }
            20% { transform: translateX(10px) rotate(2deg); }
            30% { transform: translateX(-10px) rotate(-2deg); }
            40% { transform: translateX(10px) rotate(2deg); }
            50% { transform: translateX(-8px) rotate(-1deg); }
            60% { transform: translateX(8px) rotate(1deg); }
            70% { transform: translateX(-5px) rotate(-0.5deg); }
            80% { transform: translateX(5px) rotate(0.5deg); }
            90% { transform: translateX(-2px) rotate(0deg); }
        }

        @keyframes pop-in {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* STORIES CAROUSEL (Instagram/TikTok 2025 pattern) */
        .stories-container {
            position: sticky;
            top: 50px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 12px 0;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
            z-index: 999;
            /* Instagram carousel pattern - smooth horizontal scroll */
            scroll-snap-type: x proximity;
            -webkit-overflow-scrolling: touch;
        }

        .stories-container::-webkit-scrollbar {
            display: none;
        }

        .stories-scroll {
            display: flex;
            gap: 12px;
            padding: 0 16px;
            min-width: min-content;
        }

        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .story-avatar-wrapper {
            position: relative;
            width: 64px;
            height: 64px;
        }

        .story-gradient-ring {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            padding: 3px;
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            animation: rotate-gradient 3s linear infinite;
        }

        .story-gradient-ring.viewed {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes rotate-gradient {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .story-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 3px solid var(--bg-dark);
        }

        .story-username {
            font-size: 12px;
            color: var(--text-primary);
            max-width: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }

        /* Story Viewer (Full Screen) */
        .story-viewer {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            flex-direction: column;
        }

        .story-viewer.active {
            display: flex;
        }

        .story-progress-bars {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top));
        }

        .story-progress-bar {
            flex: 1;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .story-progress-fill {
            height: 100%;
            width: 0%;
            background: #fff;
            transition: width 0.1s linear;
        }

        .story-progress-fill.active {
            animation: fillProgress 7s linear forwards;
        }

        @keyframes fillProgress {
            to { width: 100%; }
        }

        .story-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .story-text-content {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 90%;
            text-align: center;
        }

        .story-text-content h2 {
            font-size: 24px;
            margin-bottom: 16px;
            color: white;
        }

        .story-text-content p {
            font-size: 18px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.95);
        }

        .story-close-btn {
            position: absolute;
            top: calc(16px + env(safe-area-inset-top));
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* INSTAGRAM DOUBLE-TAP HEART ANIMATION (2025 pattern) */
        .double-tap-heart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 120px;
            pointer-events: none;
            z-index: 100;
            animation: heartBurst 0.8s ease-out;
            opacity: 0;
        }

        @keyframes heartBurst {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.9;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
        }

        /* TikTok-style engagement metrics (more prominent) */
        .engagement-stats {
            display: flex;
            gap: 16px;
            padding: 8px 0;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 8px;
            padding-top: 12px;
        }

        .engagement-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .engagement-stat strong {
            color: white;
            font-weight: 600;
        }

        /* QUIZ CARD STYLES (Duolingo pattern) */
        .quiz-container {
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            margin: 12px 0;
        }

        .quiz-question {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-option {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            border: 3px solid rgba(102, 126, 234, 0.3);
            color: var(--text-primary);
            padding: 18px 22px;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            min-height: 60px;
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .quiz-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .quiz-option:hover::before {
            left: 100%;
        }

        .quiz-option:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            border-color: var(--primary);
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .quiz-option.selected {
            background: rgba(102, 126, 234, 0.2);
            border-color: var(--primary);
        }

        .quiz-option.correct {
            background: linear-gradient(135deg, #0cce6b, #0fd987, #58dc91);
            border-color: #0cce6b;
            color: white;
            animation: correctPulse 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 30px rgba(12, 206, 107, 0.6), 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .quiz-option.incorrect {
            background: linear-gradient(135deg, #ff4757, #ff6b81, #ff8fa3);
            border-color: #ff4757;
            color: white;
            animation: shake 0.5s ease;
            box-shadow: 0 0 25px rgba(255, 71, 87, 0.5), 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .quiz-option:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .quiz-feedback {
            margin-top: 16px;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .quiz-feedback.correct {
            background: rgba(12, 206, 107, 0.1);
            color: #0cce6b;
            border: 1px solid #0cce6b;
        }

        .quiz-feedback.incorrect {
            background: rgba(255, 71, 87, 0.1);
            color: #ff4757;
            border: 1px solid #ff4757;
        }

        .quiz-xp-reward {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            margin-left: 8px;
            animation: pop-in 0.3s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            15% { transform: scale(1.12); box-shadow: 0 0 40px rgba(12, 206, 107, 0.8); }
            30% { transform: scale(0.95); }
            45% { transform: scale(1.08); }
            60% { transform: scale(0.98); }
            75% { transform: scale(1.03); }
            100% { transform: scale(1); box-shadow: 0 0 30px rgba(12, 206, 107, 0.6); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10% { transform: translateX(-10px) rotate(-2deg); }
            20% { transform: translateX(10px) rotate(2deg); }
            30% { transform: translateX(-10px) rotate(-2deg); }
            40% { transform: translateX(10px) rotate(2deg); }
            50% { transform: translateX(-8px) rotate(-1deg); }
            60% { transform: translateX(8px) rotate(1deg); }
            70% { transform: translateX(-5px) rotate(-0.5deg); }
            80% { transform: translateX(5px) rotate(0.5deg); }
            90% { transform: translateX(-2px) rotate(0deg); }
        }

        @keyframes pop-in {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* STORIES CAROUSEL (Instagram/TikTok 2025 pattern) */
        .stories-container {
            position: sticky;
            top: 50px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 12px 0;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
            z-index: 999;
        }

        .stories-container::-webkit-scrollbar {
            display: none;
        }

        .stories-scroll {
            display: flex;
            gap: 12px;
            padding: 0 16px;
            min-width: min-content;
        }

        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .story-avatar-wrapper {
            position: relative;
            width: 64px;
            height: 64px;
        }

        .story-gradient-ring {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            padding: 3px;
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            animation: rotate-gradient 3s linear infinite;
        }

        .story-gradient-ring.viewed {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes rotate-gradient {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .story-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 3px solid var(--bg-dark);
        }

        .story-username {
            font-size: 12px;
            color: var(--text-primary);
            max-width: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }

        /* Story Viewer (Full Screen) */
        .story-viewer {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            flex-direction: column;
        }

        .story-viewer.active {
            display: flex;
        }

        .story-progress-bars {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            padding-top: calc(12px + env(safe-area-inset-top));
        }

        .story-progress-bar {
            flex: 1;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .story-progress-fill {
            height: 100%;
            width: 0%;
            background: #fff;
            transition: width 0.1s linear;
        }

        .story-progress-fill.active {
            animation: fillProgress 7s linear forwards;
        }

        @keyframes fillProgress {
            to { width: 100%; }
        }

        .story-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .story-text-content {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 90%;
            text-align: center;
        }

        .story-text-content h2 {
            font-size: 24px;
            margin-bottom: 16px;
            color: white;
        }

        .story-text-content p {
            font-size: 18px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.95);
        }

        .story-close-btn {
            position: absolute;
            top: calc(16px + env(safe-area-inset-top));
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* INSTAGRAM DOUBLE-TAP HEART ANIMATION (2025 pattern) */
        .double-tap-heart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 120px;
            pointer-events: none;
            z-index: 100;
            animation: heartBurst 0.8s ease-out;
            opacity: 0;
        }

        @keyframes heartBurst {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.9;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
        }

        /* TikTok-style engagement metrics (more prominent) */
        .engagement-stats {
            display: flex;
            gap: 16px;
            padding: 8px 0;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 8px;
            padding-top: 12px;
        }

        .engagement-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .engagement-stat strong {
            color: white;
            font-weight: 600;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10%, 90% { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* LOADING SPINNER */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            opacity: 0.5;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* FLOATING CONTROLS */
        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }

        .floating-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 0, 80, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-btn:hover,
        .floating-btn:active {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 0, 80, 0.4);
        }

        /* LEVEL SELECTOR MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
        }

        .level-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .level-option:hover,
        .level-option.selected {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            transform: translateX(4px);
        }

        .level-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .level-desc {
            font-size: 13px;
            opacity: 0.7;
        }

        /* INTERESTS SELECTION */
        .interests-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .interest-chip {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .interest-chip.selected {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
        }

        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 768px) {
            .card-title {
                font-size: 16px;
            }

            .card-text {
                font-size: 14px;
            }

            .spanish-text {
                font-size: 15px;
            }
        }

        /* SMOOTH SCROLL */
        html {
            scroll-behavior: smooth;
        }

        /* PULL TO REFRESH INDICATOR */
        .pull-to-refresh {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 0 0 12px 12px;
            font-size: 14px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pull-to-refresh.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- TIKTOK TOP TABS NAVIGATION (2025 pattern) -->
    <nav class="top-nav-tabs" role="navigation" aria-label="Content type navigation">
        <button class="nav-tab active" data-tab="videos" onclick="switchTab('videos')" aria-label="Videos section">
            Videos
        </button>
        <button class="nav-tab" data-tab="articles" onclick="switchTab('articles')" aria-label="Articles section">
            Articles
        </button>
        <button class="nav-tab" data-tab="music" onclick="switchTab('music')" aria-label="Music section">
            Music
        </button>
        <button class="nav-tab" data-tab="stories" onclick="switchTab('stories')" aria-label="Stories section">
            Stories
        </button>
    </nav>

    <!-- TIKTOK BOTTOM NAVIGATION BAR (2025 pattern) -->
    <nav class="bottom-nav-bar" role="navigation" aria-label="Main navigation">
        <button class="bottom-nav-item active" onclick="navHome()" aria-label="Home">
            <div class="bottom-nav-icon">üè†</div>
            <div>Home</div>
        </button>
        <button class="bottom-nav-item" onclick="navDiscover()" aria-label="Discover">
            <div class="bottom-nav-icon">üîç</div>
            <div>Discover</div>
        </button>
        <button class="bottom-nav-item" onclick="navCreate()" aria-label="Create">
            <div class="bottom-nav-icon">‚ûï</div>
            <div>Create</div>
        </button>
        <button class="bottom-nav-item" onclick="navInbox()" aria-label="Inbox">
            <div class="bottom-nav-icon">üí¨</div>
            <div>Inbox</div>
        </button>
        <button class="bottom-nav-item" onclick="navProfile()" aria-label="Profile">
            <div class="bottom-nav-icon">üë§</div>
            <div>Profile</div>
        </button>
    </nav>

    <!-- XP & Streak Banner (Duolingo pattern) -->
    <div class="xp-streak-banner">
        <div class="streak-display">
            <span class="streak-fire" id="streakFire">üî•</span>
            <span class="streak-count" id="streakCount">0</span>
            <span style="font-size: 12px; opacity: 0.7;">day streak</span>
        </div>
        <div class="xp-display">
            <span class="xp-text" id="xpText">0 XP</span>
            <div class="xp-bar-container">
                <div class="xp-bar" id="xpBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Milestone Celebration Modal -->
    <div class="milestone-celebration" id="milestoneCelebration">
        <div class="milestone-content">
            <div class="milestone-emoji" id="milestoneEmoji">üéâ</div>
            <div class="milestone-text" id="milestoneText"></div>
            <button class="action-btn" onclick="closeMilestone()" style="margin-top: 20px; width: 200px;" aria-label="Continue learning">
                ‚ú® Continue Learning
            </button>
        </div>
    </div>

    <!-- Pull to Refresh Indicator -->
    <div class="pull-to-refresh" id="pullRefresh">‚Üì Pull to refresh</div>

    <main class="feed-container" id="feedContainer" role="main" aria-label="Content feed">
        <h1 style="position: absolute; left: -10000px; top: auto; width: 1px; height: 1px; overflow: hidden;">VIDA - Spanish Learning Feed</h1>
        <!-- Content cards will be dynamically inserted here -->
    </main>

    <!-- Loading Spinner -->
    <div class="loading" id="loadingSpinner">
        <div class="spinner"></div>
    </div>


    <!-- Floating Controls (moved to side to not conflict with bottom nav) -->
    <div class="floating-controls" style="bottom: 90px; right: 12px;" role="toolbar" aria-label="Quick actions">
        <button class="floating-btn" onclick="openLevelSelector()" title="Change Level" aria-label="Change your Spanish level">
            üéØ
        </button>
        <button class="floating-btn" onclick="openInterestsSelector()" title="Your Interests" aria-label="Select your interests">
            ‚ù§Ô∏è
        </button>
        <button class="floating-btn" onclick="scrollToTop()" title="Scroll to Top" aria-label="Scroll to top of feed">
            ‚Üë
        </button>
    </div>

    <!-- Level Selector Modal -->
    <div class="modal" id="levelModal">
        <div class="modal-content">
            <h2 class="modal-title">Your Spanish Level</h2>
            <div id="levelOptions"></div>
        </div>
    </div>

    <!-- Interests Selector Modal -->
    <div class="modal" id="interestsModal">
        <div class="modal-content">
            <h2 class="modal-title">What interests you?</h2>
            <div class="interests-grid" id="interestsGrid"></div>
            <button class="action-btn" style="margin-top: 20px;" onclick="saveInterests()" aria-label="Save your interests">
                ‚úÖ Save Interests
            </button>
        </div>
    </div>

    <script>
        // üöÄ UNIFIED INFINITE FEED ENGINE
        class UnifiedFeed {
            constructor() {
                this.page = 1;
                this.loading = false;
                this.userLevel = localStorage.getItem('userLevel') || 'A2';
                this.userInterests = JSON.parse(localStorage.getItem('userInterests') || '["news", "culture", "food"]');
                this.feedData = [];
                this.allContent = []; // ALL content from API
                this.filteredContent = []; // Filtered by current tab
                this.currentTab = 'videos'; // videos|articles|music|stories
                this.translationCache = new Map();

                // CRITICAL FIX: Initialize subtitle system (user requested - transcriptions were broken!)
                this.subtitlesSystem = new WordLevelSubtitles();

                // XP & Streak System (Duolingo pattern)
                this.xpData = this.loadXPData();
                this.streakData = this.loadStreakData();

                this.init();
            }

            init() {
                this.setupInfiniteScroll();
                this.loadInitialContent();
                this.setupPullToRefresh();
                this.detectInterests();
                this.updateXPDisplay();
                this.updateStreakDisplay();
                this.checkStreakValidity();
                this.initStories(); // Instagram/TikTok pattern
                console.log('üåç Unified Feed initialized');
            }

            // TAB SWITCHING LOGIC
            switchTab(newTab) {
                console.log(`üîÑ Switching to ${newTab} tab`);
                this.currentTab = newTab;

                // Update active tab styling
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.tab === newTab) {
                        tab.classList.add('active');
                    }
                });

                // Filter and re-render content
                this.filterContentByTab();
            }

            filterContentByTab() {
                const typeMap = {
                    'videos': 'video',
                    'articles': 'article',
                    'music': 'music',
                    'stories': 'story'
                };

                const targetType = typeMap[this.currentTab];
                this.filteredContent = this.allContent.filter(item => item.type === targetType);

                console.log(`üìä Filtered ${this.filteredContent.length} ${targetType} items`);

                // Clear feed and render filtered content
                const container = document.getElementById('feedContainer');
                container.innerHTML = '<h1 style="position: absolute; left: -10000px; top: auto; width: 1px; height: 1px; overflow: hidden;">VIDA - Spanish Learning Feed</h1>';

                if (this.filteredContent.length > 0) {
                    this.renderContent(this.filteredContent);
                } else {
                    container.innerHTML += `<div class="content-card"><div style="text-align: center; padding: 40px;"><h2>No ${this.currentTab} available yet</h2><p style="opacity: 0.7;">Check back soon!</p></div></div>`;
                }
            }

            // XP & STREAK SYSTEM (Duolingo pattern)
            loadXPData() {
                const data = JSON.parse(localStorage.getItem('xpData') || '{"totalXP": 0, "dailyXP": 0, "level": 1}');
                return data;
            }

            saveXPData() {
                localStorage.setItem('xpData', JSON.stringify(this.xpData));
            }

            loadStreakData() {
                const data = JSON.parse(localStorage.getItem('streakData') || '{"currentStreak": 0, "lastActiveDate": null, "freezes": 1, "longestStreak": 0}');
                return data;
            }

            saveStreakData() {
                localStorage.setItem('streakData', JSON.stringify(this.streakData));
            }

            checkStreakValidity() {
                // Duolingo pattern: Check if streak should be maintained or broken
                const today = new Date().toDateString();
                const lastActive = this.streakData.lastActiveDate;

                if (!lastActive) {
                    // First time user
                    this.streakData.lastActiveDate = today;
                    this.streakData.currentStreak = 0;
                    this.saveStreakData();
                    return;
                }

                const lastDate = new Date(lastActive);
                const todayDate = new Date(today);
                const diffTime = todayDate - lastDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    // Same day - streak maintained
                    return;
                } else if (diffDays === 1) {
                    // Consecutive day - streak already incremented when user earns XP
                    return;
                } else if (diffDays > 1) {
                    // Missed a day - check for freeze
                    if (this.streakData.freezes > 0) {
                        this.streakData.freezes--;
                        this.showToast('üßä Streak freeze used! Your streak is safe.');
                        this.streakData.lastActiveDate = today;
                        this.saveStreakData();
                    } else {
                        // Streak broken
                        if (this.streakData.currentStreak > 0) {
                            this.showToast(`üíî Streak broken! Lost ${this.streakData.currentStreak} day streak.`);
                        }
                        this.streakData.currentStreak = 0;
                        this.streakData.lastActiveDate = today;
                        this.saveStreakData();
                        this.updateStreakDisplay();
                    }
                }
            }

            awardXP(points, action) {
                // Duolingo pattern: Award XP and show animation
                this.xpData.totalXP += points;
                this.xpData.dailyXP += points;

                // Update streak on first action of the day
                const today = new Date().toDateString();
                if (this.streakData.lastActiveDate !== today) {
                    this.streakData.currentStreak++;
                    if (this.streakData.currentStreak > this.streakData.longestStreak) {
                        this.streakData.longestStreak = this.streakData.currentStreak;
                    }
                    this.streakData.lastActiveDate = today;
                    this.saveStreakData();
                    this.updateStreakDisplay();

                    // Milestone check (7, 30, 100, 365 days)
                    this.checkMilestones();
                }

                this.saveXPData();
                this.updateXPDisplay();
                this.showXPGainAnimation(points, action);
            }

            checkMilestones() {
                const milestones = {
                    7: { emoji: 'üî•', text: '7 Day Streak! You are on fire!' },
                    30: { emoji: '‚≠ê', text: '30 Day Streak! Superstar!' },
                    100: { emoji: 'üíé', text: '100 Day Streak! Diamond League!' },
                    365: { emoji: 'üëë', text: '365 Day Streak! Legend Status!' }
                };

                const streak = this.streakData.currentStreak;
                if (milestones[streak]) {
                    this.showMilestone(milestones[streak].emoji, milestones[streak].text);
                }
            }

            updateXPDisplay() {
                const xpPerLevel = 100;
                const currentLevel = Math.floor(this.xpData.totalXP / xpPerLevel) + 1;
                const xpInLevel = this.xpData.totalXP % xpPerLevel;
                const progress = (xpInLevel / xpPerLevel) * 100;

                document.getElementById('xpText').textContent = `${this.xpData.totalXP} XP`;
                document.getElementById('xpBar').style.width = `${progress}%`;
            }

            updateStreakDisplay() {
                const streak = this.streakData.currentStreak;
                document.getElementById('streakCount').textContent = streak;

                // Duolingo pattern: Fire icon for active streak, grey for broken
                const fireIcon = document.getElementById('streakFire');
                if (streak > 0) {
                    fireIcon.textContent = 'üî•';
                    fireIcon.style.filter = 'brightness(1)';
                } else {
                    fireIcon.textContent = 'üí®';
                    fireIcon.style.filter = 'grayscale(1)';
                }
            }

            showXPGainAnimation(points, action) {
                const popup = document.createElement('div');
                popup.className = 'xp-gain-popup';
                popup.textContent = `+${points} XP ${action}`;
                document.body.appendChild(popup);

                setTimeout(() => popup.remove(), 2000);
            }

            showMilestone(emoji, text) {
                document.getElementById('milestoneEmoji').textContent = emoji;
                document.getElementById('milestoneText').textContent = text;
                document.getElementById('milestoneCelebration').classList.add('active');

                // Auto-close after 3 seconds
                setTimeout(() => {
                    document.getElementById('milestoneCelebration').classList.remove('active');
                }, 3000);
            }

            async loadInitialContent() {
                await this.loadMoreContent();
            }

            async loadMoreContent() {
                if (this.loading) return;

                this.loading = true;
                this.showSkeletonLoading();

                try {
                    console.log(`üéØ Loading content (page ${this.page})`);

                    // Fetch from UNIFIED FEED API (videos + articles + music + stories)
                    const response = await fetch(`/api/feed?page=${this.page}`);
                    let feedContent = await response.json();

                    if (feedContent && feedContent.length > 0) {
                        // Add page offset to make infinite scroll work
                        feedContent = feedContent.map((item, idx) => ({
                            ...item,
                            id: `${item.id}-page${this.page}-${idx}`
                        }));

                        // APPEND to existing content (infinite scroll!)
                        this.allContent = [...this.allContent, ...feedContent];
                        this.page++;

                        // Filter by current tab
                        this.filterContentByTab();

                        this.removeSkeletonLoading();
                        this.setupVideoAutoplay();

                        console.log(`‚úÖ Page ${this.page - 1} loaded. Total: ${this.allContent.length} items, Showing: ${this.filteredContent.length} ${this.currentTab}`);
                    } else {
                        console.log('‚ö†Ô∏è No more content');
                        this.removeSkeletonLoading();
                    }
                } catch (error) {
                    console.error('Failed to load content:', error);
                    this.removeSkeletonLoading();
                }

                this.loading = false;
                document.getElementById('loadingSpinner').style.display = 'none';
            }

            scoreContentRelevance(items) {
                // TikTok RECOMMENDATION ALGORITHM (2025 pattern)
                // Source: newsroom.tiktok.com/en-us/how-tiktok-recommends-videos-for-you

                const userPreferences = this.getUserPreferences();

                return items.map(item => {
                    let score = 0;

                    // 1. USER INTERACTION HISTORY (40% weight - highest priority)
                    const interactionScore = this.calculateInteractionScore(item, userPreferences);
                    score += interactionScore * 0.4;

                    // 2. CONTENT INFORMATION MATCH (30% weight)
                    const contentScore = this.calculateContentScore(item, userPreferences);
                    score += contentScore * 0.3;

                    // 3. FRESHNESS / RECENCY (20% weight)
                    const freshnessScore = this.calculateFreshnessScore(item);
                    score += freshnessScore * 0.2;

                    // 4. DIVERSITY BONUS (10% weight - prevent filter bubbles)
                    const diversityScore = this.calculateDiversityScore(item);
                    score += diversityScore * 0.1;

                    // Add randomness (5% variance) to keep feed interesting
                    const randomFactor = 0.95 + (Math.random() * 0.1);
                    score = score * randomFactor;

                    item.recommendationScore = Math.round(score * 100) / 100;
                    item.scoreBreakdown = {
                        interaction: Math.round(interactionScore * 40),
                        content: Math.round(contentScore * 30),
                        freshness: Math.round(freshnessScore * 20),
                        diversity: Math.round(diversityScore * 10)
                    };

                    return item;
                });
            }

            calculateInteractionScore(item, userPrefs) {
                // TikTok pattern: User interactions are STRONGEST signal
                let score = 0;

                // Previously liked similar content? (+50 points)
                if (userPrefs.likedTypes.includes(item.type)) {
                    score += 50;
                }

                // Previously saved similar content? (+40 points - strong interest signal)
                if (userPrefs.savedTopics.some(topic =>
                    item.title?.toLowerCase().includes(topic) ||
                    item.tags?.includes(topic)
                )) {
                    score += 40;
                }

                // Matches user's language level (+30 points)
                if (item.difficulty === this.userLevel || !item.difficulty) {
                    score += 30;
                }

                // User follows this source (+25 points)
                if (userPrefs.followedSources.includes(item.source)) {
                    score += 25;
                }

                return Math.min(score, 100); // Cap at 100
            }

            calculateContentScore(item, userPrefs) {
                // TikTok pattern: Video information (captions, sounds, hashtags)
                let score = 0;

                // Matches user interests (+40 points)
                const matchingInterests = this.userInterests.filter(interest =>
                    item.title?.toLowerCase().includes(interest.toLowerCase()) ||
                    item.tags?.includes(interest)
                );
                score += matchingInterests.length * 20; // Up to 40 points for 2+ matches

                // Has trending hashtags (+20 points)
                const trendingTags = ['#viral', '#trending', '#2025'];
                if (item.tags?.some(tag => trendingTags.includes(tag))) {
                    score += 20;
                }

                // High engagement from other users (+40 points)
                const likeCount = item.likes || 0;
                if (likeCount > 100) score += 40;
                else if (likeCount > 50) score += 30;
                else if (likeCount > 10) score += 20;

                return Math.min(score, 100);
            }

            calculateFreshnessScore(item) {
                // TikTok pattern: Newer content gets boosted
                if (!item.publishedAt && !item.createdAt) return 50; // Default for items without timestamp

                const timestamp = new Date(item.publishedAt || item.createdAt);
                const now = new Date();
                const ageHours = (now - timestamp) / (1000 * 60 * 60);

                // Fresh content within 24 hours = max score
                if (ageHours < 24) return 100;
                if (ageHours < 48) return 80;
                if (ageHours < 72) return 60;
                if (ageHours < 168) return 40; // 1 week
                return 20; // Older content
            }

            calculateDiversityScore(item) {
                // TikTok pattern: Introduce diversity to prevent filter bubbles
                const recentTypes = this.feedData.slice(-10).map(i => i.type);
                const recentSources = this.feedData.slice(-10).map(i => i.source);

                let score = 50; // Base diversity score

                // Bonus for different type than recent items
                const typeCount = recentTypes.filter(t => t === item.type).length;
                if (typeCount === 0) score += 50; // New type = big bonus
                else if (typeCount < 3) score += 25; // Some variety

                // Bonus for different source
                if (!recentSources.includes(item.source)) {
                    score += 25;
                }

                return Math.min(score, 100);
            }

            getUserPreferences() {
                // Load user's learned preferences from localStorage
                return {
                    likedTypes: JSON.parse(localStorage.getItem('likedContentTypes') || '[]'),
                    savedTopics: JSON.parse(localStorage.getItem('savedTopics') || '[]'),
                    followedSources: JSON.parse(localStorage.getItem('followingPublishers') || '[]'),
                    watchHistory: JSON.parse(localStorage.getItem('watchHistory') || '[]')
                };
            }

            getVariedContentTypes() {
                // TikTok pattern: Mix content types to prevent boredom
                const allTypes = ['news', 'video', 'social', 'meme', 'article'];
                const recentTypes = this.feedData.slice(-5).map(item => item.type);

                // Avoid repeating same type too much
                return allTypes.filter(type => {
                    const recentCount = recentTypes.filter(t => t === type).length;
                    return recentCount < 2; // Max 2 of same type in last 5
                });
            }

            ensureContentVariety(items) {
                // TikTok algorithm: Ensure varied content to maintain engagement
                const varied = [];
                let lastType = null;
                let sameTypeCount = 0;

                items.forEach(item => {
                    if (item.type === lastType) {
                        sameTypeCount++;
                        // Insert different type if too many repeats
                        if (sameTypeCount >= 2 && varied.length > 0) {
                            const different = items.find(i => i.type !== lastType && !varied.includes(i));
                            if (different) {
                                varied.push(different);
                                lastType = different.type;
                                sameTypeCount = 1;
                                return;
                            }
                        }
                    } else {
                        sameTypeCount = 1;
                        lastType = item.type;
                    }
                    varied.push(item);
                });

                // Return varied content - NO dummy quiz cards!
                return varied;
            }

            injectQuizCards(items) {
                // Inject quiz cards at strategic positions (every 5-7 items)
                // Duolingo pattern: Regular practice reinforces learning
                const result = [];
                const quizInterval = 5 + Math.floor(Math.random() * 3); // 5-7 items

                items.forEach((item, index) => {
                    result.push(item);

                    // Inject quiz after every quizInterval items
                    if ((index + 1) % quizInterval === 0) {
                        const quiz = this.generateQuiz();
                        if (quiz) {
                            result.push(quiz);
                        }
                    }
                });

                return result;
            }

            generateQuiz() {
                // Generate Spanish vocabulary quiz (Duolingo pattern)
                const quizzes = [
                    {
                        id: `quiz-${Date.now()}-${Math.random()}`,
                        type: 'quiz',
                        difficulty_level: this.userLevel,
                        question: '¬øQu√© significa "buenos d√≠as"?',
                        options: ['Good morning', 'Good night', 'Good afternoon', 'Goodbye'],
                        correctIndex: 0,
                        explanation: 'Buenos d√≠as = Good morning'
                    },
                    {
                        id: `quiz-${Date.now()}-${Math.random()}`,
                        type: 'quiz',
                        difficulty_level: this.userLevel,
                        question: 'How do you say "thank you" in Spanish?',
                        options: ['Por favor', 'Gracias', 'De nada', 'Perd√≥n'],
                        correctIndex: 1,
                        explanation: 'Gracias = Thank you'
                    },
                    {
                        id: `quiz-${Date.now()}-${Math.random()}`,
                        type: 'quiz',
                        difficulty_level: this.userLevel,
                        question: '¬øC√≥mo se dice "water" en espa√±ol?',
                        options: ['Vino', 'Leche', 'Agua', 'Caf√©'],
                        correctIndex: 2,
                        explanation: 'Agua = Water'
                    },
                    {
                        id: `quiz-${Date.now()}-${Math.random()}`,
                        type: 'quiz',
                        difficulty_level: this.userLevel,
                        question: 'What does "¬øC√≥mo est√°s?" mean?',
                        options: ['Where are you?', 'How are you?', 'What is this?', 'Who are you?'],
                        correctIndex: 1,
                        explanation: '¬øC√≥mo est√°s? = How are you?'
                    },
                    {
                        id: `quiz-${Date.now()}-${Math.random()}`,
                        type: 'quiz',
                        difficulty_level: this.userLevel,
                        question: '¬øQu√© significa "comida"?',
                        options: ['Drink', 'Food', 'House', 'Friend'],
                        correctIndex: 1,
                        explanation: 'Comida = Food'
                    },
                    {
                        id: `quiz-${Date.now()}-${Math.random()}`,
                        type: 'quiz',
                        difficulty_level: this.userLevel,
                        question: 'How do you say "goodbye" in Spanish?',
                        options: ['Hola', 'Adi√≥s', 'Por favor', 'S√≠'],
                        correctIndex: 1,
                        explanation: 'Adi√≥s = Goodbye'
                    }
                ];

                // Select random quiz
                const quiz = quizzes[Math.floor(Math.random() * quizzes.length)];
                quiz.id = `quiz-${Date.now()}-${Math.random()}`; // Ensure unique ID
                return quiz;
            }

            // STORIES SECTION (Instagram/TikTok 2025 pattern)
            initStories() {
                const storiesData = [
                    { id: 1, username: 'Spanish101', emoji: 'üìö', stories: [
                    ]}
                ];

                window.storiesData = storiesData;
                this.renderStories(storiesData);
            }

            renderStories(stories) {
                const container = document.getElementById('storiesScroll');
                if (!container) {
                    console.log('üìñ Stories carousel element not found, skipping...');
                    return; // Element doesn't exist in new design
                }
                container.innerHTML = '';

                stories.forEach((story, index) => {
                    const viewed = localStorage.getItem(`story-viewed-${story.id}`) === 'true';
                    const storyItem = document.createElement('div');
                    storyItem.className = 'story-item';
                    storyItem.onclick = () => this.openStory(index);

                    storyItem.innerHTML = `
                        <div class="story-avatar-wrapper">
                            <div class="story-gradient-ring ${viewed ? 'viewed' : ''}">
                                <div class="story-avatar">${story.emoji}</div>
                            </div>
                        </div>
                        <div class="story-username">${story.username}</div>
                    `;

                    container.appendChild(storyItem);
                });
            }

            openStory(storyIndex) {
                window.currentStoryIndex = storyIndex;
                window.currentSegmentIndex = 0;
                const viewer = document.getElementById('storyViewer');
                viewer.classList.add('active');
                this.showStorySegment(storyIndex, 0);
                document.body.style.overflow = 'hidden';
            }

            showStorySegment(storyIndex, segmentIndex) {
                const story = window.storiesData[storyIndex];
                if (!story || !story.stories[segmentIndex]) {
                    this.closeStory();
                    return;
                }

                // Update progress bars
                const progressContainer = document.getElementById('storyProgressBars');
                if (!progressContainer) {
                    console.log('üìñ Story progress bars element not found, skipping...');
                    return;
                }
                progressContainer.innerHTML = '';
                story.stories.forEach((_, i) => {
                    const bar = document.createElement('div');
                    bar.className = 'story-progress-bar';
                    bar.innerHTML = `<div class="story-progress-fill ${i === segmentIndex ? 'active' : ''}" style="width: ${i < segmentIndex ? '100%' : '0%'}"></div>`;
                    progressContainer.appendChild(bar);
                });

                // Show content
                const content = document.getElementById('storyContent');
                const segment = story.stories[segmentIndex];
                content.innerHTML = `
                    <div class="story-text-content">
                        <h2>${segment.title}</h2>
                        <p>${segment.content}</p>
                    </div>
                `;

                // Auto-advance after 7 seconds
                if (window.storyTimer) clearTimeout(window.storyTimer);
                window.storyTimer = setTimeout(() => {
                    this.nextStorySegment();
                }, 7000);

                // Mark as viewed
                localStorage.setItem(`story-viewed-${story.id}`, 'true');
            }

            nextStorySegment() {
                const story = window.storiesData[window.currentStoryIndex];
                window.currentSegmentIndex++;

                if (window.currentSegmentIndex >= story.stories.length) {
                    // Move to next story
                    window.currentStoryIndex++;
                    window.currentSegmentIndex = 0;
                    if (window.currentStoryIndex >= window.storiesData.length) {
                        this.closeStory();
                        return;
                    }
                }

                this.showStorySegment(window.currentStoryIndex, window.currentSegmentIndex);
            }

            closeStory() {
                const viewer = document.getElementById('storyViewer');
                viewer.classList.remove('active');
                document.body.style.overflow = '';
                if (window.storyTimer) clearTimeout(window.storyTimer);
                this.renderStories(window.storiesData); // Update viewed states
            }

            showSkeletonLoading() {
                const container = document.getElementById('feedContainer');
                for (let i = 0; i < 3; i++) {
                    const skeleton = document.createElement('div');
                    skeleton.className = 'skeleton-card';
                    skeleton.innerHTML = `
                        <div class="skeleton-line" style="width: 60%; height: 24px;"></div>
                        <div class="skeleton-line" style="width: 100%; height: 200px; margin: 12px 0;"></div>
                        <div class="skeleton-line" style="width: 90%;"></div>
                        <div class="skeleton-line" style="width: 70%;"></div>
                    `;
                    container.appendChild(skeleton);
                }
            }

            removeSkeletonLoading() {
                document.querySelectorAll('.skeleton-card').forEach(el => el.remove());
            }

            renderContent(items) {
                const container = document.getElementById('feedContainer');

                items.forEach(item => {
                    const card = this.createContentCard(item);
                    container.appendChild(card);
                });
            }

            createContentCard(item) {
                const card = document.createElement('div');
                card.className = 'content-card';
                card.setAttribute('data-id', item.id);

                // Route to specialized renderers based on content type
                if (item.type === 'video') {
                    return this.renderVideo(item);
                } else if (item.type === 'article') {
                    return this.renderArticle(item);
                } else if (item.type === 'music') {
                    return this.renderMusic(item);
                } else if (item.type === 'story') {
                    return this.renderStory(item);
                } else if (item.type === 'quiz') {
                    return this.createQuizCard(item);
                }

                // Make title punchy (Instagram-style)
                const punchyTitle = this.makeTitlePunchy(item.title, item.type);

                // Type badge
                const typeClass = `type-${item.type || 'article'}`;
                const typeBadge = `<div class="content-type ${typeClass}">${item.type || 'Article'}</div>`;

                // Publisher attribution (Flipboard pattern)
                const publishers = {
                    'news': { name: 'BBC Mundo', avatar: 'üì∞', verified: true, category: 'News' },
                    'video': { name: 'Spanish Daily', avatar: 'üé¨', verified: true, category: 'Education' },
                    'social': { name: 'El Pa√≠s', avatar: 'üì±', verified: true, category: 'Culture' },
                    'meme': { name: 'Spanish Memes', avatar: 'üòÇ', verified: false, category: 'Entertainment' },
                    'article': { name: 'CNN Espa√±ol', avatar: 'üìù', verified: true, category: 'News' },
                    'quiz': { name: 'Daily Spanish Quiz', avatar: 'üéì', verified: true, category: 'Practice' }
                };

                const publisher = publishers[item.type] || publishers['article'];
                const timestamp = this.getRelativeTime(item.publishedAt || new Date());
                const isFollowing = this.isFollowing(publisher.name);

                const publisherHeader = `
                    <div class="publisher-header" onclick="feed.toggleFollow(&apos;${publisher.name}&apos;, event)">
                        <div class="publisher-avatar">${publisher.avatar}</div>
                        <div class="publisher-info">
                            <div class="publisher-name">
                                ${publisher.name}
                                ${publisher.verified ? '<span class="verified-badge">‚úì</span>' : ''}
                            </div>
                            <div class="publisher-meta">
                                <span class="timestamp">‚è∞ ${timestamp}</span>
                                <span>‚Ä¢</span>
                                <span>${publisher.category}</span>
                            </div>
                        </div>
                        <button class="follow-btn ${isFollowing ? 'following' : ''}" onclick="event.stopPropagation()">
                            ${isFollowing ? '‚úì Following' : '+ Follow'}
                        </button>
                    </div>
                `;

                // Media section (videos get actual video tags!)
                let mediaHTML = '';
                if (item.videoPath || item.videoUrl) {
                    const videoSrc = item.videoUrl || item.videoPath;
                    mediaHTML = `
                        <div class="card-media" style="position: relative;">
                            <video
                                class="feed-video"
                                data-video-id="${item.id}"
                                src="${videoSrc}"
                                playsinline
                                loop
                                muted
                                style="width: 100%; max-height: 80vh; object-fit: cover;"
                            ></video>
                            ${typeBadge}
                            <div class="media-overlay">
                                <div style="font-size: 14px; font-weight: 600;">üé¨ ${item.title}</div>
                            </div>
                            <div class="video-subtitle-container" data-video-id="${item.id}"></div>
                        </div>
                    `;
                } else if (item.thumbnail && item.thumbnail !== 'üé¨') {
                    mediaHTML = `
                        <div class="card-media">
                            <img src="${item.thumbnail}" alt="${punchyTitle}" loading="lazy">
                            ${typeBadge}
                        </div>
                    `;
                } else if (item.type === 'meme') {
                    mediaHTML = `
                        <div class="card-media" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; text-align: center;">
                            <div style="font-size: 80px;">${item.thumbnail}</div>
                            ${typeBadge}
                        </div>
                    `;
                } else {
                    mediaHTML = typeBadge;
                }

                // Spanish text with tap-to-translate
                const spanishHTML = item.spanish ? this.createSpanishText(item.spanish) : '';

                // English translation (hidden by default)
                const englishHTML = item.english ? `
                    <div class="card-text" style="display: none; background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; margin-top: 12px;" id="translation-${item.id}">
                        üí° ${item.english}
                    </div>
                ` : '';

                // Level badge
                const levelBadge = `
                    <div class="level-badge">
                        <span>üìö</span>
                        <span>${item.difficulty_level || this.userLevel}</span>
                    </div>
                `;

                // Initialize like count from localStorage
                const likes = this.getLikeCount(item.id);

                const cardHTML = `
                    ${publisherHeader}
                    ${mediaHTML}
                    <div class="card-content">
                        ${levelBadge}
                        <div class="card-title">
                            <span class="title-text">${punchyTitle}</span>
                            <button class="translate-btn" onclick="feed.toggleTranslation(&apos;${item.id}&apos;)">üëÅÔ∏è Ver</button>
                        </div>
                        ${spanishHTML}
                        ${englishHTML}
                        ${item.description ? `<div class="card-text" style="margin-top: 12px; opacity: 0.7;">${item.description}</div>` : ''}
                    </div>
                    <div class="card-actions">
                        <button class="action-btn ${likes > 0 ? 'liked' : ''}" onclick="feed.likeContent(&apos;${item.id}&apos;, &apos;${item.type}&apos;)" id="like-${item.id}">
                            ${likes > 0 ? '‚ù§Ô∏è‚Äçüî•' : '‚ù§Ô∏è'} <span id="like-count-${item.id}">${likes}</span>
                        </button>
                        <button class="action-btn" onclick="feed.shareContent(&apos;${item.id}&apos;, &apos;${item.type}&apos;)">
                            üì§ Share
                        </button>
                        <button class="action-btn" onclick="feed.saveArticle(&apos;${item.id}&apos;)">
                            üìö Save
                        </button>
                        <button class="action-btn" onclick="feed.saveWord(&apos;${item.id}&apos;)">
                            üíæ Word
                        </button>
                    </div>
                `;

                card.innerHTML = cardHTML;
                return card;
            }

            createQuizCard(quiz) {
                // Duolingo-style quiz card (2025 pattern)
                // Source: duolingo.com, tiktok.com/@spanish.learning
                const card = document.createElement('div');
                card.className = 'content-card';
                card.setAttribute('data-id', quiz.id);
                card.setAttribute('data-quiz-answered', 'false');

                const typeClass = 'type-quiz';
                const typeBadge = `<div class="content-type ${typeClass}">üß† Quiz</div>`;

                // Publisher header for quiz
                const publisherHeader = `
                    <div class="publisher-header">
                        <div class="publisher-avatar">üéì</div>
                        <div class="publisher-info">
                            <div class="publisher-name">
                                Daily Spanish Quiz
                                <span class="verified-badge">‚úì</span>
                            </div>
                            <div class="publisher-meta">
                                <span class="timestamp">‚è∞ Now</span>
                                <span>‚Ä¢</span>
                                <span>Practice</span>
                            </div>
                        </div>
                    </div>
                `;

                // Quiz container
                const quizHTML = `
                    ${publisherHeader}
                    ${typeBadge}
                    <div class="card-content">
                        <div class="level-badge">
                            <span>üìö</span>
                            <span>${quiz.difficulty_level || this.userLevel}</span>
                        </div>
                        <div class="quiz-container">
                            <div class="quiz-question">${quiz.question}</div>
                            <div class="quiz-options" id="quiz-options-${quiz.id}">
                                ${quiz.options.map((option, index) => `
                                    <button
                                        class="quiz-option"
                                        data-index="${index}"
                                        onclick="feed.answerQuiz(&apos;${quiz.id}&apos;, ${index}, ${index === quiz.correctIndex})"
                                    >
                                        ${option}
                                    </button>
                                `).join('')}
                            </div>
                            <div id="quiz-feedback-${quiz.id}"></div>
                        </div>
                    </div>
                `;

                card.innerHTML = quizHTML;
                return card;
            }

            // SPECIALIZED CONTENT RENDERERS

            renderVideo(item) {
                // TikTok-style full-screen video with dual-language captions
                const card = document.createElement('div');
                card.className = 'content-card';
                card.setAttribute('data-id', item.id);

                const videoHTML = `
                    <div class="card-media">
                        <video
                            class="feed-video"
                            data-video-id="${item.id}"
                            src="${item.videoUrl}"
                            playsinline
                            loop
                            muted
                            style="width: 100%; height: 100vh; object-fit: cover;"
                        ></video>
                        <!-- Real-time Transcription Overlay (Lingopie + YouTube Shorts 2025 pattern) -->
                        <div class="video-subtitle-container" data-video-id="${item.id}" style="position: absolute; bottom: 140px; left: 0; right: 0; padding: 0 20px; text-align: center; pointer-events: none; z-index: 50;">
                            <div id="subtitle-${item.id}" style="background: linear-gradient(135deg, rgba(0,0,0,0.85), rgba(20,20,20,0.9)); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.15); padding: 16px 24px; border-radius: 16px; display: inline-block; max-width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                                <!-- Spanish text with clickable words -->
                                <div id="spanish-line-${item.id}" style="font-weight: 700; font-size: 20px; line-height: 1.4; margin-bottom: 8px; color: #ffffff; pointer-events: auto;"></div>
                                <!-- English translation -->
                                <div id="english-line-${item.id}" style="font-size: 16px; line-height: 1.4; color: rgba(255,255,255,0.85); font-weight: 500;"></div>
                            </div>
                        </div>

                        <!-- Speed Control (YouTube 2025 bubble pattern) -->
                        <div class="speed-control" style="position: absolute; top: 70px; right: 16px; z-index: 100;">
                            <button class="speed-btn" onclick="feed.toggleSpeedMenu('${item.id}')" style="background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                <span id="speed-display-${item.id}">1x</span>
                            </button>
                            <div id="speed-menu-${item.id}" class="speed-menu" style="display: none; position: absolute; top: 45px; right: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 8px; min-width: 100px;">
                                <button onclick="feed.setVideoSpeed('${item.id}', 0.5)" style="display: block; width: 100%; background: none; border: none; color: white; padding: 10px 16px; text-align: left; cursor: pointer; border-radius: 6px; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">0.5x</button>
                                <button onclick="feed.setVideoSpeed('${item.id}', 0.75)" style="display: block; width: 100%; background: none; border: none; color: white; padding: 10px 16px; text-align: left; cursor: pointer; border-radius: 6px; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">0.75x</button>
                                <button onclick="feed.setVideoSpeed('${item.id}', 1)" style="display: block; width: 100%; background: none; border: none; color: white; padding: 10px 16px; text-align: left; cursor: pointer; border-radius: 6px; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">1x</button>
                                <button onclick="feed.setVideoSpeed('${item.id}', 1.25)" style="display: block; width: 100%; background: none; border: none; color: white; padding: 10px 16px; text-align: left; cursor: pointer; border-radius: 6px; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">1.25x</button>
                                <button onclick="feed.setVideoSpeed('${item.id}', 1.5)" style="display: block; width: 100%; background: none; border: none; color: white; padding: 10px 16px; text-align: left; cursor: pointer; border-radius: 6px; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">1.5x</button>
                                <button onclick="feed.setVideoSpeed('${item.id}', 2)" style="display: block; width: 100%; background: none; border: none; color: white; padding: 10px 16px; text-align: left; cursor: pointer; border-radius: 6px; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">2x</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-content" style="position: absolute; bottom: 80px; left: 0; right: 0; padding: 20px; background: linear-gradient(transparent, rgba(0,0,0,0.8));">
                        <div class="card-title" style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 8px;">${item.title}</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 12px;">${item.description || ''}</div>
                        <div class="level-badge" style="display: inline-block; background: var(--primary); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">${item.level}</div>
                        <div class="action-buttons" style="margin-top: 16px; display: flex; gap: 12px;">
                            <button class="action-btn" onclick="feed.toggleVideoPlay('${item.id}')" style="flex: 1; background: rgba(255,255,255,0.2); border: none; padding: 12px; border-radius: 8px; color: white; cursor: pointer;">‚ñ∂Ô∏è Play/Pause</button>
                            <button class="action-btn" onclick="feed.likeContent('${item.id}')" style="background: none; border: 1px solid rgba(255,255,255,0.3); padding: 12px 16px; border-radius: 8px; color: white; cursor: pointer;">‚ù§Ô∏è ${item.likes || 0}</button>
                            <button class="action-btn" onclick="feed.saveWord('${item.id}')" style="background: none; border: 1px solid rgba(255,255,255,0.3); padding: 12px 16px; border-radius: 8px; color: white; cursor: pointer;">üíæ ${item.saves || 0}</button>
                        </div>
                    </div>
                `;

                card.innerHTML = videoHTML;

                // Setup captions if available
                if (item.captions && item.captions.length > 0) {
                    setTimeout(() => {
                        const video = card.querySelector('video');
                        const subtitleContainer = card.querySelector('.video-subtitle-container');

                        if (video && subtitleContainer) {
                            // Track sentence repetitions (Lingopie auto-loop pattern)
                            let currentCaptionIndex = -1;
                            let captionRepeatCount = 0;
                            const REPEATS_PER_SENTENCE = 2; // Each sentence repeats twice (vision.md P0)

                            // Real-time transcription with clickable words + sentence repeat (Lingopie pattern)
                            video.addEventListener('timeupdate', () => {
                                const currentTime = video.currentTime;
                                const captionIndex = item.captions.findIndex(c => currentTime >= c.start && currentTime < c.end);
                                const caption = captionIndex >= 0 ? item.captions[captionIndex] : null;

                                const spanishLineEl = document.getElementById(`spanish-line-${item.id}`);
                                const englishLineEl = document.getElementById(`english-line-${item.id}`);

                                if (caption && spanishLineEl && englishLineEl) {
                                    // Check if we've moved to a new caption
                                    if (captionIndex !== currentCaptionIndex) {
                                        currentCaptionIndex = captionIndex;
                                        captionRepeatCount = 0;
                                    }

                                    // Check if current caption ended and needs to repeat
                                    if (currentTime >= caption.end && captionRepeatCount < REPEATS_PER_SENTENCE) {
                                        captionRepeatCount++;
                                        // Loop back to start of this caption (Lingopie auto-loop)
                                        video.currentTime = caption.start;
                                    }

                                    // Render Spanish text with clickable words (Lingopie + YouTube 2025)
                                    const spanishWords = caption.spanish.split(' ');
                                    const clickableSpanish = spanishWords.map((word, idx) => {
                                        const cleanWord = word.replace(/[¬ø?!¬°.,;:]/g, '');
                                        return `<span
                                            class="clickable-word"
                                            onclick="feed.showWordTranslation('${cleanWord}', event)"
                                            style="cursor: pointer;
                                                   padding: 2px 6px;
                                                   border-radius: 6px;
                                                   transition: all 0.2s ease;
                                                   display: inline-block;
                                                   margin: 0 2px;"
                                            onmouseover="this.style.background='rgba(59,130,246,0.3)'; this.style.transform='scale(1.05)'"
                                            onmouseout="this.style.background='transparent'; this.style.transform='scale(1)'"
                                        >${word}</span>`;
                                    }).join(' ');

                                    if (spanishLineEl) spanishLineEl.innerHTML = clickableSpanish;
                                    if (englishLineEl) englishLineEl.textContent = caption.english;

                                    // Show subtitle container
                                    const subtitleBox = document.getElementById(`subtitle-${item.id}`);
                                    if (subtitleBox) subtitleBox.style.display = 'inline-block';
                                } else {
                                    // Hide when no caption
                                    if (spanishLineEl) spanishLineEl.innerHTML = '';
                                    if (englishLineEl) englishLineEl.textContent = '';
                                    const subtitleBox = document.getElementById(`subtitle-${item.id}`);
                                    if (subtitleBox) subtitleBox.style.display = 'none';
                                }
                            });

                            // Apply saved playback speed (TikTok pattern - persistent speed)
                            this.applySavedSpeed(item.id);
                        }
                    }, 100);
                }

                return card;
            }

            // Duplicate removed - using better version at line 3076 with Simplify button

            renderMusic(item) {
                // Spotify-style full-screen music player with synced lyrics
                const card = document.createElement('div');
                card.className = 'content-card';
                card.setAttribute('data-id', item.id);

                const musicHTML = `
                    <div style="position: relative; width: 100%; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;">

                        ${item.albumArt ? `
                            <div style="position: absolute; inset: 0; background-image: url('${item.albumArt}'); background-size: cover; background-position: center; filter: blur(60px); opacity: 0.3;"></div>
                        ` : ''}

                        <div style="position: relative; z-index: 10; text-align: center; width: 100%; max-width: 500px;">

                            <div class="content-type type-video" style="position: absolute; top: -40px; right: 0; background: linear-gradient(135deg, #4facfe, #00f2fe); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">MUSIC</div>

                            ${item.albumArt ? `
                                <img src="${item.albumArt}" style="width: 280px; height: 280px; border-radius: 20px; margin-bottom: 32px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);" alt="${item.title}">
                            ` : `
                                <div style="width: 280px; height: 280px; border-radius: 20px; margin: 0 auto 32px; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-size: 100px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">üéµ</div>
                            `}

                            <div class="card-title" style="font-size: 24px; font-weight: 800; margin-bottom: 8px; color: white;">${item.title}</div>
                            <div class="music-artist card-artist" style="font-size: 18px; color: rgba(255,255,255,0.8); margin-bottom: 32px;">${item.artist || 'Unknown Artist'}</div>

                            <div class="level-badge" style="display: inline-block; background: rgba(0,0,0,0.3); padding: 6px 16px; border-radius: 16px; font-size: 13px; font-weight: 600; margin-bottom: 32px; color: white;">${item.level}</div>

                            <div id="lyrics-${item.id}" style="max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 16px; padding: 24px; margin-bottom: 32px; text-align: left; backdrop-filter: blur(10px);">
                                ${item.lyrics && item.lyrics.length > 0 ? item.lyrics.map((lyric, index) => `
                                    <div style="margin-bottom: 20px; padding: 12px; border-radius: 8px; transition: background 0.3s;" data-lyric-index="${index}">
                                        <div style="font-size: 16px; font-weight: 600; color: white; margin-bottom: 6px;">${lyric.line}</div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.7);">${lyric.translation}</div>
                                    </div>
                                `).join('') : '<div style="text-align: center; color: rgba(255,255,255,0.6);">Lyrics not available</div>'}
                            </div>

                            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 16px; backdrop-filter: blur(10px);">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 24px; margin-bottom: 16px;">
                                    <button style="background: none; border: none; font-size: 32px; cursor: pointer; color: white;">‚èÆÔ∏è</button>
                                    <button onclick="feed.toggleMusicPlay('${item.id}')" style="background: white; border: none; width: 64px; height: 64px; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">‚ñ∂Ô∏è</button>
                                    <button style="background: none; border: none; font-size: 32px; cursor: pointer; color: white;">‚è≠Ô∏è</button>
                                </div>

                                <div class="action-buttons" style="display: flex; gap: 12px; justify-content: center;">
                                    <button onclick="feed.likeContent('${item.id}')" style="background: rgba(255,255,255,0.2); border: none; padding: 12px 20px; border-radius: 24px; color: white; cursor: pointer; font-weight: 600;">‚ù§Ô∏è ${item.likes || 0}</button>
                                    <button onclick="feed.saveWord('${item.id}')" style="background: rgba(255,255,255,0.2); border: none; padding: 12px 20px; border-radius: 24px; color: white; cursor: pointer; font-weight: 600;">üíæ ${item.saves || 0}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                card.innerHTML = musicHTML;
                return card;
            }

            renderVideo(item) {
                // TikTok-style full-screen video card
                const card = document.createElement('div');
                card.className = 'content-card';
                card.setAttribute('data-id', item.id);

                const videoHTML = `
                    <div style="position: relative; width: 100%; height: 100vh; background: #000;">
                        <video
                            id="video-${item.id}"
                            src="${item.videoUrl || 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4'}"
                            playsinline
                            loop
                            controls
                            autoplay
                            style="width: 100%; height: 100vh; object-fit: cover;">
                        </video>

                        <div class="content-type type-video" style="position: absolute; top: 60px; right: 20px; background: linear-gradient(135deg, #4facfe, #00f2fe); z-index: 10;">VIDEO</div>

                        <div class="card-content" style="position: absolute; bottom: 90px; left: 0; right: 0; padding: 24px; background: linear-gradient(transparent, rgba(0,0,0,0.9)); color: white;">
                            <div class="card-title" style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">${item.title}</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 12px;">${item.description || ''}</div>

                            <div class="level-badge" style="display: inline-block; background: var(--primary); padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 16px;">${item.level}</div>

                            ${item.captions && item.captions.length > 0 ? `
                                <div id="captions-${item.id}" class="video-captions" style="background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); padding: 16px; border-radius: 12px; margin-bottom: 12px; min-height: 80px;">
                                    <div class="spanish-caption" style="font-weight: 700; color: #fff; font-size: 16px; margin-bottom: 8px; line-height: 1.4;">üá™üá∏ ${item.captions[0].spanish}</div>
                                    <div class="english-caption" style="font-size: 14px; color: rgba(255,255,255,0.85); line-height: 1.4;">üá∫üá∏ ${item.captions[0].english}</div>
                                </div>
                            ` : ''}

                            <div style="display: flex; gap: 12px; margin-top: 16px;">
                                <button onclick="feed.likeContent('${item.id}')" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: none; padding: 10px 20px; border-radius: 20px; color: white; font-weight: 600; cursor: pointer;">‚ù§Ô∏è ${item.likes || 0}</button>
                                <button onclick="feed.saveWord('${item.id}')" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: none; padding: 10px 20px; border-radius: 20px; color: white; font-weight: 600; cursor: pointer;">üíæ ${item.saves || 0}</button>
                            </div>
                        </div>
                    </div>
                `;

                card.innerHTML = videoHTML;

                // REAL-TIME TRANSCRIPTION SYNC (YouTube/TikTok pattern)
                if (item.captions && item.captions.length > 1) {
                    setTimeout(() => {
                        const video = document.getElementById(`video-${item.id}`);
                        const captionsDiv = document.getElementById(`captions-${item.id}`);

                        if (video && captionsDiv) {
                            video.addEventListener('timeupdate', () => {
                                const currentTime = video.currentTime;

                                // Find matching caption by timestamp
                                const currentCaption = item.captions.find(cap => {
                                    const start = cap.start || 0;
                                    const end = cap.end || start + 3;
                                    return currentTime >= start && currentTime < end;
                                });

                                if (currentCaption) {
                                    const clickableSpanish = feed.makeWordsClickable(currentCaption.spanish, item.id);
                                    captionsDiv.innerHTML = `
                                        <div style="font-weight: 700; color: #fff; font-size: 16px; margin-bottom: 8px; line-height: 1.4;">üá™üá∏ ${clickableSpanish}</div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.85); line-height: 1.4;">üá∫üá∏ ${currentCaption.english}</div>
                                    `;
                                }
                            });
                        }
                    }, 100);
                }

                return card;
            }

            renderArticle(item) {
                // Perplexity-style article card
                const card = document.createElement('div');
                card.className = 'content-card';
                card.setAttribute('data-id', item.id);

                const articleHTML = `
                    <div style="position: relative; width: 100%; height: 100vh; background: var(--bg-dark); overflow-y: auto; padding: 60px 24px 100px;">

                        <div class="content-type type-article" style="position: absolute; top: 60px; right: 20px; background: linear-gradient(135deg, #fa709a, #fee140);">ARTICLE</div>

                        ${item.imageUrl ? `
                            <img src="${item.imageUrl}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 16px; margin-bottom: 24px;" alt="${item.title}">
                        ` : ''}

                        <div style="font-size: 28px; font-weight: 800; margin-bottom: 16px; line-height: 1.3;">${item.title}</div>

                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; font-size: 14px; color: rgba(255,255,255,0.6);">
                            <div class="level-badge" style="background: var(--primary); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; color: white;">${item.level}</div>
                            <span>‚Ä¢</span>
                            <span>${item.source || 'Article'}</span>
                        </div>

                        <div id="spanish-text-${item.id}" class="spanish-content card-spanish" style="font-size: 18px; line-height: 1.8; color: var(--text-primary); margin-bottom: 24px;">
                            ${this.makeWordsClickable(item.spanish || item.content, item.id)}
                        </div>

                        ${item.english ? `
                            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                                <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px; color: rgba(255,255,255,0.7);">üåê English Translation</div>
                                <div style="font-size: 16px; line-height: 1.7; color: rgba(255,255,255,0.9);">${item.english}</div>
                            </div>
                        ` : ''}

                        ${item.vocabulary && item.vocabulary.length > 0 ? `
                            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">üìö Key Vocabulary</div>
                                ${item.vocabulary.map(vocab => `
                                    <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: var(--primary);">${vocab.word}</div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-top: 4px;">${vocab.translation}</div>
                                        ${vocab.context ? `<div style="font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 4px; font-style: italic;">"${vocab.context}"</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <!-- VISION.MD P0: Further simplify option - Button to simplify article even more -->
                        ${item.canSimplify ? `
                            <div style="margin-bottom: 16px;">
                                <button onclick="feed.simplifyArticle('${item.id}')" style="width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); border: none; padding: 14px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 18px;">üìñ</span>
                                    <span>Simplify More (Make it easier)</span>
                                </button>
                            </div>
                        ` : ''}

                        <div style="display: flex; gap: 12px;">
                            <button onclick="feed.likeContent('${item.id}')" style="flex: 1; background: var(--primary); border: none; padding: 14px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">‚ù§Ô∏è Like (${item.likes || 0})</button>
                            <button onclick="feed.saveWord('${item.id}')" style="flex: 1; background: rgba(255,255,255,0.1); border: none; padding: 14px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">üíæ Save (${item.saves || 0})</button>
                        </div>
                    </div>
                `;

                card.innerHTML = articleHTML;
                return card;
            }

            renderMusic(item) {
                // Spotify-style music player card
                const card = document.createElement('div');
                card.className = 'content-card';
                card.setAttribute('data-id', item.id);

                const musicHTML = `
                    <div style="position: relative; width: 100%; height: 100vh; background: linear-gradient(135deg, #667eea, #764ba2); padding: 60px 24px 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;">

                        <div class="content-type type-music" style="position: absolute; top: 60px; right: 20px; background: linear-gradient(135deg, #43e97b, #38f9d7);">MUSIC</div>

                        ${item.albumArt ? `
                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('${item.albumArt}'); background-size: cover; background-position: center; filter: blur(60px); opacity: 0.3;"></div>
                        ` : ''}

                        <div style="position: relative; z-index: 10; text-align: center; width: 100%; max-width: 500px;">
                            ${item.albumArt ? `
                                <img src="${item.albumArt}" style="width: 280px; height: 280px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); margin-bottom: 32px;" alt="${item.title}">
                            ` : ''}

                            <div style="font-size: 28px; font-weight: 800; margin-bottom: 8px; text-shadow: 0 2px 10px rgba(0,0,0,0.5);">${item.title}</div>
                            <div style="font-size: 18px; opacity: 0.9; margin-bottom: 24px;">${item.artist || 'Unknown Artist'}</div>

                            <div class="level-badge" style="display: inline-block; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 6px 16px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 32px;">${item.level}</div>

                            ${item.lyrics && item.lyrics.length > 0 ? `
                                <div style="max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); padding: 24px; border-radius: 16px; margin-bottom: 24px; text-align: left;">
                                    <div style="font-size: 16px; font-weight: 700; margin-bottom: 16px; text-align: center;">üìù Lyrics</div>
                                    ${item.lyrics.slice(0, 3).map(lyric => `
                                        <div style="padding: 12px; margin-bottom: 12px;">
                                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 6px;">${lyric.line}</div>
                                            <div style="font-size: 14px; opacity: 0.8;">${lyric.translation}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}

                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button onclick="feed.likeContent('${item.id}')" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: none; padding: 12px 24px; border-radius: 20px; color: white; font-weight: 600; cursor: pointer;">‚ù§Ô∏è ${item.likes || 0}</button>
                                <button onclick="feed.saveWord('${item.id}')" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: none; padding: 12px 24px; border-radius: 20px; color: white; font-weight: 600; cursor: pointer;">üíæ ${item.saves || 0}</button>
                            </div>
                        </div>
                    </div>
                `;

                card.innerHTML = musicHTML;
                return card;
            }

            renderStory(item) {
                // Instagram-style story card
                const card = document.createElement('div');
                card.className = 'content-card';
                card.setAttribute('data-id', item.id);

                const storyHTML = `
                    <div style="position: relative; width: 100%; height: 100vh; background: var(--bg-dark); overflow-y: auto; padding: 60px 24px 100px;">

                        <div class="content-type type-article" style="position: absolute; top: 60px; right: 20px; background: linear-gradient(135deg, #f093fb, #f5576c); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">STORY</div>

                        ${item.imageUrl ? `
                            <img src="${item.imageUrl}" style="width: 100%; max-height: 40vh; object-fit: cover; border-radius: 16px; margin-bottom: 24px;" alt="${item.title}">
                        ` : ''}

                        <div style="font-size: 32px; font-weight: 800; margin-bottom: 16px; line-height: 1.2;">${item.title}</div>

                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; font-size: 14px; color: rgba(255,255,255,0.6);">
                            <div class="level-badge" style="background: var(--primary); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; color: white;">${item.level}</div>
                            <span>‚Ä¢</span>
                            <span>${item.content ? Math.ceil(item.content.split(' ').length / 200) : 2} min read</span>
                        </div>

                        <div class="story-content card-content" style="font-size: 18px; line-height: 1.8; color: var(--text-primary); margin-bottom: 32px; white-space: pre-wrap;">
                            ${item.content || 'Story content not available.'}
                        </div>

                        ${item.vocabulary && item.vocabulary.length > 0 ? `
                            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                                <div style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">üìö New Words</div>
                                ${item.vocabulary.map(vocab => `
                                    <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: var(--primary);">${vocab.word}</div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-top: 4px;">${vocab.translation}</div>
                                        ${vocab.context ? `<div style="font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 4px; font-style: italic;">"${vocab.context}"</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <div class="action-buttons" style="display: flex; gap: 12px;">
                            <button onclick="feed.likeContent('${item.id}')" style="flex: 1; background: var(--primary); border: none; padding: 14px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">‚ù§Ô∏è Like (${item.likes || 0})</button>
                            <button onclick="feed.saveWord('${item.id}')" style="flex: 1; background: rgba(255,255,255,0.1); border: none; padding: 14px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">üíæ Save (${item.saves || 0})</button>
                        </div>
                    </div>
                `;

                card.innerHTML = storyHTML;
                return card;
            }

            // Helper methods for media controls
            showWordTranslation(word, event) {
                // Lingopie-style instant word translation popup
                event.stopPropagation();
                const cleanWord = word.toLowerCase().trim();

                // Simple Spanish-English dictionary (MVP - in production use API)
                const dictionary = {
                    'hola': 'hello', 'qu√©': 'what', 'c√≥mo': 'how', 'est√°s': 'you are', 'muy': 'very',
                    'bien': 'well/good', 'gracias': 'thank you', 'y': 'and', 't√∫': 'you',
                    'todo': 'everything/all', 'aprendiendo': 'learning', 'espa√±ol': 'Spanish',
                    'mira': 'look', 'est√°': 'is', 'pasando': 'happening', 'el': 'the',
                    'sem√°foro': 'traffic light', 'mostrando': 'showing', 'rojo': 'red',
                    'verde': 'green', 'al': 'at the', 'mismo': 'same', 'tiempo': 'time'
                };

                const translation = dictionary[cleanWord] || `[${word}]`;

                // Show tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'word-translation-tooltip';
                tooltip.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(37,99,235,0.95));
                                backdrop-filter: blur(20px);
                                border: 1px solid rgba(255,255,255,0.3);
                                padding: 12px 18px;
                                border-radius: 12px;
                                color: white;
                                font-size: 16px;
                                font-weight: 600;
                                box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                                position: fixed;
                                top: ${event.clientY - 60}px;
                                left: ${event.clientX - 50}px;
                                z-index: 10000;
                                animation: fadeIn 0.2s ease;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">üá™üá∏ ${word}</div>
                        <div style="font-size: 18px;">üá∫üá∏ ${translation}</div>
                    </div>
                `;
                document.body.appendChild(tooltip);

                // Auto-remove after 2 seconds
                setTimeout(() => tooltip.remove(), 2000);

                // Award XP
                this.awardXP(1, 'word_translation');
            }

            toggleVideoPlay(videoId) {
                const video = document.querySelector(`video[data-video-id="${videoId}"]`);
                if (video) {
                    if (video.paused) {
                        video.play();
                        video.muted = false;
                    } else {
                        video.pause();
                    }
                }
            }

            // Speed Control Methods (YouTube/TikTok 2025 pattern)
            toggleSpeedMenu(videoId) {
                const menu = document.getElementById(`speed-menu-${videoId}`);
                if (menu) {
                    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
                }
            }

            setVideoSpeed(videoId, speed) {
                const video = document.querySelector(`video[data-video-id="${videoId}"]`);
                const speedDisplay = document.getElementById(`speed-display-${videoId}`);
                const menu = document.getElementById(`speed-menu-${videoId}`);

                if (video) {
                    video.playbackRate = speed;

                    // Update display
                    if (speedDisplay) {
                        speedDisplay.textContent = `${speed}x`;
                    }

                    // Close menu
                    if (menu) {
                        menu.style.display = 'none';
                    }

                    // Persist speed setting (TikTok pattern - persist across videos)
                    localStorage.setItem('preferredPlaybackSpeed', speed);

                    console.log(`‚úÖ Video speed set to ${speed}x`);
                }
            }

            // Apply saved speed to new videos
            applySavedSpeed(videoId) {
                const savedSpeed = localStorage.getItem('preferredPlaybackSpeed');
                if (savedSpeed) {
                    this.setVideoSpeed(videoId, parseFloat(savedSpeed));
                }
            }

            toggleMusicPlay(musicId) {
                // In production, integrate with actual audio player
                console.log('Toggle music play:', musicId);
                alert('üéµ Music playback coming soon! This will play actual audio tracks.');
            }

            translateWord(word, event) {
                // Show word translation popup
                const cleanWord = word.toLowerCase().trim();
                alert(`üìñ "${word}" - Translation coming soon!\nClick words to learn their meanings.`);
                event.target.style.background = 'rgba(255, 0, 80, 0.2)';
                this.awardXP(1, 'word_click');
            }

            likeContent(contentId) {
                console.log('Liked content:', contentId);
                this.awardXP(2, 'content_like');
                alert('‚ù§Ô∏è Liked!');
            }

            answerQuiz(quizId, selectedIndex, isCorrect) {
                // Duolingo pattern: Immediate feedback with XP reward
                const card = document.querySelector(`[data-id="${quizId}"]`);
                if (!card || card.getAttribute('data-quiz-answered') === 'true') return;

                card.setAttribute('data-quiz-answered', 'true');

                const optionsContainer = document.getElementById(`quiz-options-${quizId}`);
                const options = optionsContainer.querySelectorAll('.quiz-option');
                const feedbackContainer = document.getElementById(`quiz-feedback-${quizId}`);

                // Disable all options
                options.forEach((btn, index) => {
                    btn.disabled = true;
                    if (index === selectedIndex) {
                        btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                    }
                    // Always show correct answer
                    const quiz = this.feedData.find(item => item.id === quizId);
                    if (quiz && index === quiz.correctIndex && !isCorrect) {
                        btn.classList.add('correct');
                    }
                });

                // Show feedback
                const xpReward = isCorrect ? 10 : 5;
                this.addXP(xpReward, isCorrect ? 'quiz_correct' : 'quiz_attempt');

                const feedbackClass = isCorrect ? 'correct' : 'incorrect';
                const feedbackEmoji = isCorrect ? 'üéâ' : 'üí™';
                const feedbackText = isCorrect
                    ? 'Perfect! You got it right!'
                    : 'Not quite! Keep practicing!';

                feedbackContainer.innerHTML = `
                    <div class="quiz-feedback ${feedbackClass}">
                        ${feedbackEmoji} ${feedbackText}
                        <span class="quiz-xp-reward">+${xpReward} XP</span>
                    </div>
                `;

                // Track quiz completion
                const quizStats = JSON.parse(localStorage.getItem('quizStats') || '{"total": 0, "correct": 0}');
                quizStats.total++;
                if (isCorrect) quizStats.correct++;
                localStorage.setItem('quizStats', JSON.stringify(quizStats));

                this.showToast(isCorrect
                    ? `üéâ Correct! +${xpReward} XP`
                    : `üí™ Good try! +${xpReward} XP for effort`
                );
            }

            makeTitlePunchy(title, type) {
                // Instagram-style title rewrites for maximum engagement
                if (!title || title.startsWith('Video:')) {
                    const hooks = [
                        'üî• ¬°Esto no te lo puedes perder!',
                        'üò± ¬°No lo creer√°s!',
                        'üíØ ¬°Incre√≠ble pero cierto!',
                        '‚ö° ¬°VIRAL ahora mismo!',
                        'üéØ ¬°Lo que todos est√°n viendo!',
                        '‚ú® ¬°Espera... ¬øQU√â?!',
                        'üöÄ ¬°Tendencia en Espa√±a!'
                    ];
                    return hooks[Math.floor(Math.random() * hooks.length)];
                }

                // Make existing titles more engaging
                if (title.length > 60) {
                    return 'üî• ' + title.substring(0, 57) + '...';
                }

                // Add emoji based on content type
                const emojiMap = {
                    'news': 'üì∞',
                    'video': 'üé•',
                    'meme': 'üòÇ',
                    'culture': 'üé≠',
                    'social': 'üí¨'
                };

                const emoji = emojiMap[type] || '‚ú®';
                return `${emoji} ${title}`;
            }

            getLikeCount(itemId) {
                const likes = JSON.parse(localStorage.getItem('likes') || '{}');
                return likes[itemId] || 0;
            }

            saveLikeCount(itemId, count) {
                const likes = JSON.parse(localStorage.getItem('likes') || '{}');
                likes[itemId] = count;
                localStorage.setItem('likes', JSON.stringify(likes));
            }

            createSpanishText(text) {
                const words = text.split(' ');
                const wordElements = words.map((word, index) => {
                    return `<span class="spanish-word" onclick="feed.translateWord(&apos;${word}&apos;, event)" data-word="${word}">${word}</span>`;
                }).join(' ');

                return `<div class="spanish-text">${wordElements}</div>`;
            }

            async translateWord(word, event) {
                // Check cache first
                if (this.translationCache.has(word)) {
                    this.showTranslation(event.target, this.translationCache.get(word));
                    return;
                }

                try {
                    // In production, call translation API
                    // For now, use mock translations
                    const mockTranslations = {
                        'embarazada': 'pregnant',
                        'avergonzada': 'embarrassed',
                        '√≥rale': 'wow/come on',
                        'mande': 'excuse me (polite)',
                        'comida': 'food',
                        'noticias': 'news'
                    };

                    const translation = mockTranslations[word.toLowerCase()] || 'translation';
                    this.translationCache.set(word, translation);
                    this.showTranslation(event.target, translation);
                } catch (error) {
                    console.error('Translation failed:', error);
                }
            }

            showTranslation(element, translation) {
                // Remove existing tooltips
                document.querySelectorAll('.translation-tooltip').forEach(t => t.remove());

                // Create and show tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'translation-tooltip';
                tooltip.textContent = translation;
                element.appendChild(tooltip);

                // Auto-remove after 3 seconds
                setTimeout(() => tooltip.remove(), 3000);
            }

            toggleTranslation(itemId) {
                const translationEl = document.getElementById(`translation-${itemId}`);
                const btn = event.target;
                if (translationEl) {
                    const isVisible = translationEl.style.display !== 'none';
                    translationEl.style.display = isVisible ? 'none' : 'block';
                    btn.textContent = isVisible ? 'üëÅÔ∏è Ver' : '‚úÖ Visto';
                    btn.classList.toggle('active', !isVisible);
                }
            }

            setupVideoAutoplay() {
                // TikTok-style video autoplay based on visibility
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const video = entry.target;
                        if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
                            video.play().catch(e => console.log('Autoplay prevented:', e));
                            // FIXED: Only attach subtitles once (prevent flashing)
                            if (!video.dataset.subtitlesAttached) {
                                this.showVideoSubtitles(video);
                                video.dataset.subtitlesAttached = 'true';
                            }
                        } else {
                            video.pause();
                        }
                    });
                }, { threshold: [0.5] });

                document.querySelectorAll('.feed-video').forEach(video => {
                    observer.observe(video);
                    // Click to unmute
                    video.addEventListener('click', () => {
                        video.muted = !video.muted;
                        const icon = video.muted ? 'üîá' : 'üîä';
                        this.showToast(`${icon} ${video.muted ? 'Muted' : 'Unmuted'}`);
                    });

                    // VISION.MD P0: Trigger quiz after video ends (Duolingo pattern)
                    video.addEventListener('ended', () => {
                        this.showPostVideoQuiz(video);
                    });
                });
            }

            showVideoSubtitles(videoElement) {
                // Get video metadata from feedData
                const videoId = videoElement.dataset.videoId;
                const videoData = this.feedData.find(item => item.id == videoId);

                if (!videoData) return;

                // Find subtitle container
                const container = document.querySelector(`.video-subtitle-container[data-video-id="${videoId}"]`);
                if (!container) return;

                // Generate timestamped subtitles with AI punctuation
                const subtitles = this.generateTimestampedSubtitles(videoData);

                // Attach real-time subtitle sync (TikTok/YouTube 2025 pattern)
                this.subtitlesSystem.attachToVideo(videoElement, subtitles, container);
            }

            generateTimestampedSubtitles(videoData) {
                // REAL-TIME TRANSCRIPTION DATA - YouTube/TikTok 2025 Pattern
                // Use API captions if available, otherwise generate mock data

                // Priority 1: Use captions from API (entertainment-server.js)
                if (videoData.captions && videoData.captions.length > 0) {
                    console.log('‚úÖ Using API captions for video:', videoData.id, videoData.captions);
                    return videoData.captions.map(caption => ({
                        start: caption.start || 0,
                        end: caption.end || 5,
                        spanish: caption.spanish || caption.text || '',
                        english: caption.english || caption.translation || ''
                    }));
                }

                // Priority 2: If video has specific Spanish text, use it with punctuation
                if (videoData.spanish && videoData.spanish.length > 10) {
                    const text = videoData.spanish;
                    const english = videoData.english || 'Translation loading...';

                    // Add AI punctuation if missing
                    const punctuatedSpanish = this.addAIPunctuation(text);

                    return [{
                        start: 0,
                        end: 10,
                        spanish: punctuatedSpanish,
                        english: english
                    }];
                }

                // Priority 3: Generate realistic mock timestamped subtitles
                const subtitles = [
                    {
                        start: 0,
                        end: 2.5,
                        spanish: '¬°Hola! Mira esto.',
                        english: 'Hello! Look at this.'
                    },
                    {
                        start: 2.5,
                        end: 5.5,
                        spanish: 'Es muy interesante, ¬øverdad?',
                        english: 'It is very interesting, right?'
                    },
                    {
                        start: 5.5,
                        end: 8,
                        spanish: 'Aprende espa√±ol con videos.',
                        english: 'Learn Spanish with videos.'
                    },
                    {
                        start: 8,
                        end: 11,
                        spanish: 'Haz clic en las palabras para traducir.',
                        english: 'Click on words to translate.'
                    }
                ];

                return subtitles;
            }

            addAIPunctuation(text) {
                // AI PUNCTUATION SERVICE - Add . , ! ? to Spanish text
                // Based on TikTok/YouTube auto-caption pattern
                let punctuated = text;

                // Add period at end if missing
                if (!/[.!?]$/.test(punctuated.trim())) {
                    punctuated = punctuated.trim() + '.';
                }

                // Add commas for natural pauses (simple heuristic)
                punctuated = punctuated
                    .replace(/\s+(y|o|pero|porque|que|cuando|donde|si)\s+/gi, ', $1 ')
                    .replace(/\s+(entonces|adem√°s|tambi√©n|as√≠)\s+/gi, ', $1 ')
                    // Add question marks for questions
                    .replace(/(qu√©|qui√©n|d√≥nde|cu√°ndo|c√≥mo|por qu√©|cu√°l)/gi, '¬ø$1')
                    .replace(/(\?+)/g, '?')
                    // Add exclamation for excitement
                    .replace(/(wow|incre√≠ble|genial|excelente)/gi, '¬°$1!');

                return punctuated;
            }

            showPostVideoQuiz(videoElement) {
                // VISION.MD P0: Interactive quiz after video (Duolingo 2025 pattern)
                // Generate quiz from video transcription words
                const videoId = videoElement.dataset.videoId;
                const videoData = this.feedData.find(item => item.id == videoId);

                if (!videoData || !videoData.transcription || !videoData.transcription.lines) {
                    console.log('‚ö†Ô∏è No transcription data for quiz generation');
                    return;
                }

                // Extract Spanish words from transcription
                const spanishWords = [];
                videoData.transcription.lines.forEach(line => {
                    if (line.spanish) {
                        const words = line.spanish.split(' ').filter(w => w.length > 3);
                        words.forEach(word => {
                            const cleanWord = word.replace(/[¬ø?¬°!.,;:]/g, '').toLowerCase();
                            if (cleanWord && line.english) {
                                spanishWords.push({
                                    spanish: cleanWord,
                                    context: line.spanish,
                                    translation: line.english
                                });
                            }
                        });
                    }
                });

                if (spanishWords.length === 0) {
                    console.log('‚ö†Ô∏è No words found in transcription');
                    return;
                }

                // Pick random word for quiz
                const randomWord = spanishWords[Math.floor(Math.random() * spanishWords.length)];

                // Generate quiz options (3 wrong + 1 correct)
                const wrongOptions = [
                    'To eat',
                    'To sleep',
                    'To walk',
                    'To run',
                    'Beautiful',
                    'Happy',
                    'Sad',
                    'Big',
                    'Small'
                ];

                const options = [
                    randomWord.translation,
                    ...wrongOptions.slice(0, 3)
                ].sort(() => Math.random() - 0.5);

                const correctIndex = options.indexOf(randomWord.translation);

                // Create quiz modal (TikTok slide-up pattern)
                const quizHTML = `
                    <div class="post-video-quiz" id="quiz-${videoId}" style="
                        position: fixed;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, #000 100%);
                        padding: 30px 20px;
                        border-radius: 20px 20px 0 0;
                        z-index: 9999;
                        animation: slideUp 0.3s ease;
                    ">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üß†</div>
                            <div style="font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 8px;">
                                Quick Quiz!
                            </div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.7);">
                                What does this word mean?
                            </div>
                        </div>

                        <div style="
                            background: rgba(255,255,255,0.1);
                            padding: 20px;
                            border-radius: 12px;
                            margin-bottom: 24px;
                            text-align: center;
                        ">
                            <div style="font-size: 32px; font-weight: 700; color: #fff;">
                                ${randomWord.spanish}
                            </div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px;">
                                From the video: "${randomWord.context}"
                            </div>
                        </div>

                        <div style="display: grid; gap: 12px;">
                            ${options.map((option, index) => `
                                <button
                                    class="quiz-option-btn"
                                    data-correct="${index === correctIndex}"
                                    onclick="window.feedApp.checkQuizAnswer(this, ${index === correctIndex})"
                                    style="
                                        background: rgba(255,255,255,0.1);
                                        border: 2px solid rgba(255,255,255,0.2);
                                        padding: 16px;
                                        border-radius: 12px;
                                        color: #fff;
                                        font-size: 16px;
                                        font-weight: 500;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                    "
                                    onmouseover="this.style.background='rgba(255,255,255,0.15)'"
                                    onmouseout="this.style.background='rgba(255,255,255,0.1)'"
                                >
                                    ${option}
                                </button>
                            `).join('')}
                        </div>

                        <button
                            onclick="document.getElementById('quiz-${videoId}').remove()"
                            style="
                                background: transparent;
                                border: none;
                                color: rgba(255,255,255,0.5);
                                padding: 16px;
                                margin-top: 16px;
                                width: 100%;
                                cursor: pointer;
                                font-size: 14px;
                            "
                        >
                            Skip ‚Üí
                        </button>
                    </div>
                    <style>
                        @keyframes slideUp {
                            from { transform: translateY(100%); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }
                    </style>
                `;

                // Append quiz to body
                document.body.insertAdjacentHTML('beforeend', quizHTML);

                // Pause video while quiz is showing
                videoElement.pause();
            }

            checkQuizAnswer(button, isCorrect) {
                // Duolingo-style answer feedback
                if (isCorrect) {
                    button.style.background = '#58cc02';
                    button.style.borderColor = '#58cc02';
                    button.innerHTML += ' ‚úì';

                    // Award XP
                    this.addXP(10, 'Vocabulary quiz completed!');

                    // Close quiz after 1 second
                    setTimeout(() => {
                        const quiz = button.closest('.post-video-quiz');
                        if (quiz) quiz.remove();
                    }, 1500);
                } else {
                    button.style.background = '#ff4b4b';
                    button.style.borderColor = '#ff4b4b';
                    button.innerHTML += ' ‚úó';

                    // Disable all buttons
                    button.closest('.post-video-quiz').querySelectorAll('.quiz-option-btn').forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        if (btn.dataset.correct === 'true') {
                            btn.style.background = '#58cc02';
                            btn.style.borderColor = '#58cc02';
                            btn.innerHTML += ' ‚úì (Correct answer)';
                        }
                    });
                }
            }

            saveWord(itemId) {
                const savedWords = JSON.parse(localStorage.getItem('savedWords') || '[]');
                if (!savedWords.includes(itemId)) {
                    savedWords.push(itemId);
                    localStorage.setItem('savedWords', JSON.stringify(savedWords));
                    alert('‚úÖ Saved to your vocabulary!');
                }
            }

            playAudio(itemId) {
                // In production, play actual audio
                console.log('Playing audio for:', itemId);
                alert('üîä Audio feature coming soon!');
            }

            setupInfiniteScroll() {
                // Instagram Reels-style infinite scroll with aggressive preloading
                // Source: blog.logrocket.com/react-infinite-scroll/ (2025)
                const sentinel = document.getElementById('loadingSpinner');

                // Main infinite scroll observer with 500px preload margin
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && !this.loading) {
                            console.log('üìú Loading more content (infinite scroll triggered)');
                            this.loadMoreContent();
                        }
                    });
                }, {
                    rootMargin: '500px' // Instagram pattern: Trigger 500px before bottom
                });

                observer.observe(sentinel);

                // PRELOADING: Monitor all content cards and preload next 3 cards ahead
                // Source: medium.com/@sanjivjangid/seamless-infinite-scrolling-tanstack-query-and-intersection-observer-c7ec8a544c83
                this.setupPreloadObserver();

                // Backup: Classic scroll event (for older browsers)
                let scrollTimeout;
                window.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        const scrollHeight = document.documentElement.scrollHeight;
                        const scrollTop = window.scrollY;
                        const clientHeight = window.innerHeight;

                        // 80% scroll threshold (Instagram Reels pattern)
                        const scrollPercent = (scrollTop / (scrollHeight - clientHeight)) * 100;
                        if (scrollPercent > 80 && !this.loading) {
                            console.log(`üìú Loading more at ${scrollPercent.toFixed(0)}% scroll`);
                            this.loadMoreContent();
                        }
                    }, 100); // Debounce 100ms for smoother detection
                });
            }

            setupPreloadObserver() {
                // Preload images/videos 3 cards ahead (Instagram Reels strategy)
                const preloadObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && entry.intersectionRatio > 0.3) {
                            const cardIndex = Array.from(document.querySelectorAll('.content-card')).indexOf(entry.target);
                            this.preloadNextCards(cardIndex, 3); // Preload 3 ahead
                        }
                    });
                }, { threshold: 0.3, rootMargin: '300px' });

                // Observe all content cards
                const observeCards = () => {
                    document.querySelectorAll('.content-card').forEach(card => {
                        preloadObserver.observe(card);
                    });
                };

                // Initial observation
                observeCards();

                // Re-observe when new cards are added
                const mutationObserver = new MutationObserver(observeCards);
                mutationObserver.observe(document.getElementById('feedContainer'), {
                    childList: true
                });
            }

            preloadNextCards(currentIndex, count) {
                // Preload next N cards' media for instant playback
                for (let i = 1; i <= count; i++) {
                    const nextIndex = currentIndex + i;
                    const nextCard = document.querySelectorAll('.content-card')[nextIndex];

                    if (nextCard) {
                        // Preload video
                        const video = nextCard.querySelector('video');
                        if (video && video.readyState < 3) {
                            video.preload = 'auto';
                            video.load();
                            console.log(`üé¨ Preloading video ${i} cards ahead`);
                        }

                        // Preload image
                        const img = nextCard.querySelector('img[loading="lazy"]');
                        if (img) {
                            img.loading = 'eager';
                            console.log(`üñºÔ∏è Preloading image ${i} cards ahead`);
                        }
                    }
                }
            }

            setupPullToRefresh() {
                let startY = 0;
                let pulling = false;

                window.addEventListener('touchstart', (e) => {
                    if (window.scrollY === 0) {
                        startY = e.touches[0].pageY;
                        pulling = true;
                    }
                });

                window.addEventListener('touchmove', (e) => {
                    if (pulling && window.scrollY === 0) {
                        const currentY = e.touches[0].pageY;
                        const distance = currentY - startY;

                        if (distance > 80) {
                            document.getElementById('pullRefresh').classList.add('active');
                        }
                    }
                });

                window.addEventListener('touchend', async () => {
                    if (pulling && document.getElementById('pullRefresh').classList.contains('active')) {
                        await this.refresh();
                    }
                    pulling = false;
                    document.getElementById('pullRefresh').classList.remove('active');
                });
            }

            async refresh() {
                this.page = 1;
                this.feedData = [];
                document.getElementById('feedContainer').innerHTML = '';
                await this.loadMoreContent();
            }

            detectInterests() {
                // Automatically detect user interests based on engagement
                const engagementData = JSON.parse(localStorage.getItem('engagementData') || '{}');

                // Analyze which content types user engages with most
                const interests = Object.entries(engagementData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([interest]) => interest);

                if (interests.length > 0) {
                    this.userInterests = interests;
                    localStorage.setItem('userInterests', JSON.stringify(interests));
                }
            }

            trackEngagement(contentType) {
                const engagementData = JSON.parse(localStorage.getItem('engagementData') || '{}');
                engagementData[contentType] = (engagementData[contentType] || 0) + 1;
                localStorage.setItem('engagementData', JSON.stringify(engagementData));
            }

            // üî• SOCIAL FEATURES

            async likeContent(contentId, contentType) {
                // Instant UI update (optimistic)
                const likeBtn = document.getElementById(`like-${contentId}`);
                const likeCountEl = document.getElementById(`like-count-${contentId}`);
                const currentCount = this.getLikeCount(contentId);
                const isLiked = currentCount > 0;

                const newCount = isLiked ? 0 : currentCount + 1;
                this.saveLikeCount(contentId, newCount);

                // Update UI immediately
                likeBtn.classList.toggle('liked', !isLiked);
                likeBtn.innerHTML = `${!isLiked ? '‚ù§Ô∏è‚Äçüî•' : '‚ù§Ô∏è'} <span id="like-count-${contentId}">${newCount}</span>`;

                // Trigger animation
                likeBtn.style.transform = 'scale(1.2)';
                setTimeout(() => likeBtn.style.transform = 'scale(1)', 200);

                // Award XP (Duolingo pattern)
                if (!isLiked) {
                    this.awardXP(3, '‚ù§Ô∏è');
                }

                // TikTok RECOMMENDATION: Track liked content types for personalization
                if (!isLiked) {
                    this.trackLikedContentType(contentType);
                }

                this.showToast(!isLiked ? '‚ù§Ô∏è ¬°Te encanta!' : 'üíî Ya no te gusta');
                this.trackEngagement(contentType);

                // Send to backend (fire and forget)
                fetch('/api/social/like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: this.userId || 'anonymous',
                        contentId: contentId,
                        contentType: contentType
                    })
                }).catch(e => console.log('Like sync failed:', e));
            }

            trackLikedContentType(contentType) {
                // TikTok pattern: Learn what users like to personalize feed
                const likedTypes = JSON.parse(localStorage.getItem('likedContentTypes') || '[]');
                if (!likedTypes.includes(contentType)) {
                    likedTypes.push(contentType);
                    localStorage.setItem('likedContentTypes', JSON.stringify(likedTypes));
                    console.log(`üéØ Learned preference: ${contentType}`);
                }
            }

            trackSavedTopic(topic) {
                // TikTok pattern: Saved content shows strong interest
                const savedTopics = JSON.parse(localStorage.getItem('savedTopics') || '[]');
                if (!savedTopics.includes(topic)) {
                    savedTopics.push(topic);
                    localStorage.setItem('savedTopics', JSON.stringify(savedTopics));
                    console.log(`üìå Learned interest: ${topic}`);
                }
            }

            async shareContent(contentId, contentType) {
                try {
                    const content = this.feedData.find(item => item.id === contentId);

                    const response = await fetch('/api/social/share', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: this.userId,
                            contentId: contentId,
                            contentType: contentType,
                            platform: 'web',
                            content: content
                        })
                    });

                    const data = await response.json();

                    // Copy share URL to clipboard
                    navigator.clipboard.writeText(data.shareData.shareUrl);

                    this.showToast('üî• Share link copied!');
                } catch (error) {
                    console.error('Share error:', error);
                }
            }

            async saveArticle(contentId) {
                try {
                    const article = this.feedData.find(item => item.id === contentId);

                    // TikTok RECOMMENDATION: Track saved topics for strong personalization signal
                    if (article.title) {
                        // Extract key topics from title
                        const topics = article.title.toLowerCase()
                            .split(' ')
                            .filter(word => word.length > 4); // Only meaningful words
                        topics.forEach(topic => this.trackSavedTopic(topic));
                    }

                    const response = await fetch('/api/social/save-article', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: this.userId,
                            article: article
                        })
                    });

                    const data = await response.json();

                    // Award XP for saving article (Duolingo pattern: 5 XP)
                    this.awardXP(5, 'üìö');

                    this.showToast(data.message + ` (Total: ${data.totalSaved})`);
                } catch (error) {
                    console.error('Save article error:', error);
                }
            }

            likeContent(contentId) {
                const liked = JSON.parse(localStorage.getItem('likedContent') || '[]');
                const content = this.allContent.find(item => item.id === contentId);
                if (!content) return;

                const index = liked.indexOf(contentId);
                if (index > -1) {
                    liked.splice(index, 1);
                    if (content.likes) content.likes--;
                    this.showToast('üíî Unliked');
                } else {
                    liked.push(contentId);
                    content.likes = (content.likes || 0) + 1;
                    this.showToast('‚ù§Ô∏è Liked!');
                    this.awardXP(5, '‚ù§Ô∏è');
                }

                localStorage.setItem('likedContent', JSON.stringify(liked));

                const buttons = document.querySelectorAll(`button[onclick*="'${contentId}'"]`);
                buttons.forEach(btn => {
                    if (btn.textContent.includes('‚ù§')) btn.innerHTML = `‚ù§Ô∏è ${content.likes || 0}`;
                });
            }

            async saveWord(contentId) {
                const saved = JSON.parse(localStorage.getItem('savedContent') || '[]');
                const content = this.allContent.find(item => item.id === contentId);
                if (!content) return;

                const index = saved.indexOf(contentId);
                if (index > -1) {
                    saved.splice(index, 1);
                    if (content.saves) content.saves--;
                    this.showToast('Removed from saved');
                } else {
                    saved.push(contentId);
                    content.saves = (content.saves || 0) + 1;
                    this.showToast('üíæ Saved!');
                    this.awardXP(10, 'üíæ');
                }

                localStorage.setItem('savedContent', JSON.stringify(saved));

                const buttons = document.querySelectorAll(`button[onclick*="'${contentId}'"]`);
                buttons.forEach(btn => {
                    if (btn.textContent.includes('üíæ')) btn.innerHTML = `üíæ ${content.saves || 0}`;
                });
            }

            // üìñ VISION.MD P0: Further simplify option - Simplify article text to lower level
            async simplifyArticle(contentId) {
                const content = this.allContent.find(item => item.id === contentId);
                if (!content) return;

                this.showToast('üìñ Simplifying article...');

                const textElement = document.getElementById(`spanish-text-${contentId}`);
                if (!textElement) return;

                // Basic simplification: shorten sentences, replace complex words
                const originalText = content.spanish || content.content;
                let simplified = originalText;

                // Split into sentences
                const sentences = simplified.split(/[.!?]+/).filter(s => s.trim().length > 0);

                // Take first 3 sentences only (make it shorter)
                const shorterText = sentences.slice(0, 3).join('. ') + '.';

                // Simple word replacements (complex ‚Üí simple)
                const replacements = {
                    'incre√≠blemente': 'muy',
                    'extraordinario': 'muy bueno',
                    'fascinante': 'interesante',
                    'devastados': 'muy tristes',
                    'explot√≥': 'reaccion√≥ mucho',
                    'trending': 'popular',
                    'mundial': 'del mundo',
                    'petici√≥n': 'solicitud',
                    'comparti√≥': 'mostr√≥',
                    'm√©todo': 'forma',
                    'effortlessly': 'f√°cil',
                    'imposible': 'muy dif√≠cil',
                    'genio': 'muy inteligente'
                };

                let simplifiedText = shorterText;
                Object.keys(replacements).forEach(complex => {
                    const regex = new RegExp(complex, 'gi');
                    simplifiedText = simplifiedText.replace(regex, replacements[complex]);
                });

                // Animate the change
                textElement.style.transition = 'opacity 0.3s ease';
                textElement.style.opacity = '0';

                setTimeout(() => {
                    textElement.innerHTML = this.makeWordsClickable(simplifiedText, contentId);
                    textElement.style.opacity = '1';
                    this.showToast('‚úÖ Article simplified!');
                    this.awardXP(5, 'üìñ Simplified!');
                }, 300);
            }

            showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    bottom: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0,0,0,0.9);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 24px;
                    z-index: 10000;
                    animation: fadeInOut 2s ease;
                `;

                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            }

            makeWordsClickable(text, itemId) {
                if (!text) return '';
                const words = text.split(' ');
                return words.map((word, idx) => {
                    const cleanWord = word.replace(/[¬ø?!.,;:]/g, '');
                    return `<span class="clickable-word" onclick="feed.translateWord('${cleanWord}', '${itemId}')" style="cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">${word}</span>`;
                }).join(' ');
            }

            async translateWord(word, itemId) {
                this.showToast(`üîç Translating "${word}"...`);

                try {
                    // Use LibreTranslate API (free, open source)
                    const response = await fetch('https://libretranslate.de/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            q: word,
                            source: 'es',
                            target: 'en',
                            format: 'text'
                        })
                    });

                    const data = await response.json();
                    const translation = data.translatedText || word;

                    this.showToast(`üí¨ ${word} = ${translation}`);
                    this.awardXP(2, 'üìñ');
                } catch (error) {
                    console.error('Translation error:', error);
                    this.showToast(`‚ùå Translation failed`);
                }
            }

            // SIMPLIFY ARTICLE - P0 Vision.md requirement
            // Adaptive content - simplifies text based on user level (Duolingo pattern)
            async simplifyArticle(articleId) {
                this.showToast(`üìñ Simplifying article...`);

                const article = this.allContent.find(item => item.id === articleId);
                if (!article) return;

                const userLevel = localStorage.getItem('userLevel') || 'A2';
                const textContainer = document.getElementById(`spanish-text-${articleId}`);
                if (!textContainer) return;

                try {
                    // Call backend to get simplified version
                    const response = await fetch('/api/content/simplify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: article.content || article.spanish,
                            currentLevel: article.level || 'B1',
                            targetLevel: userLevel,
                            furtherSimplify: true
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.simplified) {
                        // Update article text with simplified version
                        textContainer.innerHTML = this.makeWordsClickable(data.simplified, articleId);
                        this.showToast(`‚úÖ Article simplified to ${userLevel} level!`);
                        this.awardXP(5, 'article_simplify');
                    } else {
                        this.showToast(`‚ùå Couldn't simplify further`);
                    }
                } catch (error) {
                    console.error('Simplify error:', error);
                    // Fallback: Client-side basic simplification
                    const simpler = (article.content || article.spanish)
                        .replace(/\b\w{12,}\b/g, '...') // Replace very long words
                        .split('.').slice(0, 3).join('. ') + '.'; // Take first 3 sentences

                    textContainer.innerHTML = this.makeWordsClickable(simpler, articleId);
                    this.showToast(`‚úÖ Made simpler! (Basic version)`);
                }
            }

            // PUBLISHER FOLLOWING (Flipboard pattern)
            isFollowing(publisherName) {
                const following = JSON.parse(localStorage.getItem('followingPublishers') || '[]');
                return following.includes(publisherName);
            }

            toggleFollow(publisherName, event) {
                const following = JSON.parse(localStorage.getItem('followingPublishers') || '[]');
                const index = following.indexOf(publisherName);

                if (index > -1) {
                    following.splice(index, 1);
                    this.showToast(`Unfollowed ${publisherName}`);
                } else {
                    following.push(publisherName);
                    this.showToast(`‚úÖ Following ${publisherName}!`);
                }

                localStorage.setItem('followingPublishers', JSON.stringify(following));

                // Update button
                const btn = event.target.closest('.publisher-header').querySelector('.follow-btn');
                if (btn) {
                    btn.classList.toggle('following');
                    btn.textContent = following.includes(publisherName) ? '‚úì Following' : '+ Follow';
                }
            }

            getRelativeTime(publishedAt) {
                // Flipboard-style real-time timestamps
                const now = new Date();
                const then = new Date(publishedAt);
                const diffMs = now - then;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'Now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return then.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
            }

            // TIKTOK NAVIGATION SYSTEM (2025 pattern)
            switchTab(tabName) {
                // Update active tab styling
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.tab === tabName) {
                        tab.classList.add('active');
                    }
                });

                // Filter content based on tab
                this.currentTab = tabName;
                this.filterContentByTab();

                console.log(`üé¨ Switched to ${tabName} tab`);
            }

            bottomNavClick(section) {
                // Update active bottom nav item
                document.querySelectorAll('.bottom-nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.bottom-nav-item').classList.add('active');

                console.log(`üì± Bottom nav: ${section}`);

                // Handle different sections
                switch(section) {
                    case 'home':
                        this.switchTab('for-you');
                        break;
                    case 'discover':
                        this.switchTab('articles');
                        break;
                    case 'saved':
                        this.showToast('üìö Saved items - Coming soon!');
                        break;
                    case 'profile':
                        this.showToast('üë§ Profile - Coming soon!');
                        break;
                }
            }
        }

        // Global functions
        let feed;

        document.addEventListener('DOMContentLoaded', () => {
            feed = new UnifiedFeed();
            window.feed = feed; // Make feed available globally for onclick handlers
            setupLevelSelector();
            setupInterestsSelector();
        });

        function openLevelSelector() {
            document.getElementById('levelModal').classList.add('active');
        }

        function openInterestsSelector() {
            document.getElementById('interestsModal').classList.add('active');
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // TAB SWITCHING FUNCTION (for top navigation)
        function switchTab(tabName) {
            if (window.feed) {
                window.feed.switchTab(tabName);
            }
        }

        // BOTTOM NAVIGATION FUNCTIONS
        function navHome() {
            updateBottomNav('home');
            if (window.feed) {
                window.feed.switchTab('videos'); // Default to videos on home
            }
        }

        function navDiscover() {
            updateBottomNav('discover');
            alert('üîç Discover feature coming soon!\nExplore trending Spanish content and popular creators.');
        }

        function navCreate() {
            updateBottomNav('create');
            alert('‚ûï Create feature coming soon!\nShare your own Spanish learning content!');
        }

        function navInbox() {
            updateBottomNav('inbox');
            alert('üí¨ Inbox feature coming soon!\nConnect with other Spanish learners!');
        }

        function navProfile() {
            updateBottomNav('profile');
            alert('üë§ Profile feature coming soon!\nView your learning stats and achievements!');
        }

        function updateBottomNav(activeItem) {
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // For now, just highlight home since others aren't implemented yet
            if (activeItem === 'home') {
                document.querySelector('.bottom-nav-item').classList.add('active');
            }
        }

        function setupLevelSelector() {
            const levels = [
                { code: 'A1', name: 'Beginner', desc: 'Just starting out' },
                { code: 'A2', name: 'Elementary', desc: 'Basic conversations' },
                { code: 'B1', name: 'Intermediate', desc: 'Everyday topics' },
                { code: 'B2', name: 'Upper Intermediate', desc: 'Complex topics' },
                { code: 'C1', name: 'Advanced', desc: 'Fluent communication' },
                { code: 'C2', name: 'Mastery', desc: 'Native-like proficiency' }
            ];

            const container = document.getElementById('levelOptions');
            const currentLevel = localStorage.getItem('userLevel') || 'A2';

            levels.forEach(level => {
                const option = document.createElement('div');
                option.className = 'level-option' + (level.code === currentLevel ? ' selected' : '');
                option.innerHTML = `
                    <div class="level-name">${level.code} - ${level.name}</div>
                    <div class="level-desc">${level.desc}</div>
                `;
                option.onclick = () => {
                    localStorage.setItem('userLevel', level.code);
                    document.getElementById('levelModal').classList.remove('active');
                    feed.userLevel = level.code;
                    feed.refresh();
                };
                container.appendChild(option);
            });

            // Close modal on backdrop click
            document.getElementById('levelModal').onclick = (e) => {
                if (e.target.id === 'levelModal') {
                    e.target.classList.remove('active');
                }
            };
        }

        function setupInterestsSelector() {
            const interests = [
                'üì∞ News', 'üçî Food', '‚öΩ Sports', 'üé¨ Movies',
                'üéµ Music', 'üåç Travel', 'üíº Business', 'üî¨ Science',
                'üé® Art', 'üìö Books', 'üéÆ Gaming', 'üí™ Fitness'
            ];

            const container = document.getElementById('interestsGrid');
            const currentInterests = JSON.parse(localStorage.getItem('userInterests') || '[]');

            interests.forEach(interest => {
                const chip = document.createElement('div');
                const interestKey = interest.split(' ')[1].toLowerCase();
                chip.className = 'interest-chip' + (currentInterests.includes(interestKey) ? ' selected' : '');
                chip.textContent = interest;
                chip.onclick = () => chip.classList.toggle('selected');
                container.appendChild(chip);
            });

            // Close modal on backdrop click
            document.getElementById('interestsModal').onclick = (e) => {
                if (e.target.id === 'interestsModal') {
                    e.target.classList.remove('active');
                }
            };
        }

        function saveInterests() {
            const selected = Array.from(document.querySelectorAll('.interest-chip.selected'))
                .map(chip => chip.textContent.split(' ')[1].toLowerCase());

            localStorage.setItem('userInterests', JSON.stringify(selected));
            feed.userInterests = selected;
            document.getElementById('interestsModal').classList.remove('active');
            feed.refresh();
        }

        function closeMilestone() {
            document.getElementById('milestoneCelebration').classList.remove('active');
        }

        function closeStory() {
            if (window.feed) {
                window.feed.closeStory();
            }
        }
    </script>
</body>
</html>