<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>üåç VIDA - Complete Spanish Learning Feed</title>

    <!-- Mobile-First CSS Framework -->
    <link rel="stylesheet" href="/css/mobile-first-framework.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #ff0050;
            --secondary: #667eea;
            --bg-dark: #000000;
            --bg-card: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* MAIN CONTAINER */
        .app-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: calc(60px + env(safe-area-inset-bottom, 0px)); /* Space for bottom nav + safe area */
            overflow: hidden;
        }

        /* SECTION CONTAINERS */
        .section {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .section.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Bottom nav - Mobile-first with safe areas */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(60px + env(safe-area-inset-bottom, 0px));
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            padding-bottom: env(safe-area-inset-bottom, 0px);
            z-index: 1000;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px;
            min-height: 44px; /* Mobile tap target */
            min-width: 44px;
        }

        .nav-btn:hover {
            color: rgba(255, 255, 255, 0.8);
        }

        .nav-btn.active {
            color: #fff;
        }

        .nav-btn div {
            font-size: 20px;
        }

        .nav-btn span {
            font-size: 12px; /* Minimum readable - exception for nav labels */
        }

        /* FEED SECTION */
        #feed-section {
            display: flex;
            flex-direction: column;
        }

        .feed-tabs {
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
            z-index: 100;
        }

        .feed-tab {
            flex: 1;
            padding: 16px 12px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .feed-tab.active {
            color: #ffffff;
        }

        .feed-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 2px;
            background: var(--primary);
            border-radius: 2px 2px 0 0;
        }

        .feed-content {
            flex: 1;
            position: relative;
        }

        .feed-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            overflow-y: auto;
        }

        .feed-panel.active {
            opacity: 1;
            pointer-events: all;
        }

        /* VIDEO PLAYER (TikTok 2025 style with safe zones) */
        .video-container {
            height: calc(100vh - 70px);
            scroll-snap-type: y mandatory;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Hide scrollbar Firefox */
        }

        .video-container::-webkit-scrollbar {
            display: none; /* Hide scrollbar Chrome/Safari */
        }

        .video-item {
            width: 100%;
            height: 100vh;
            scroll-snap-align: start;
            scroll-snap-stop: always;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* TikTok-style video overlay with safe zones */
        .video-overlay {
            position: absolute;
            bottom: 90px; /* 20px padding + 70px nav = safe zone */
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 70%, transparent 100%);
            z-index: 10;
            pointer-events: none;
        }

        .video-overlay * {
            pointer-events: auto;
        }

        /* Fixed transcription box (no flashing) */
        .transcription-box {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .trans-line {
            margin-bottom: 12px;
            line-height: 1.6;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .trans-es {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 6px;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
        }

        .trans-en {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        /* Clickable words with hover effect */
        .word-clickable {
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 6px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-block;
            position: relative;
        }

        .word-clickable:hover {
            background: var(--primary);
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 0, 80, 0.4);
        }

        .word-clickable:active {
            transform: scale(0.95);
        }

        /* Translation tooltip */
        .word-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .word-clickable:hover .word-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }

        .word-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--primary);
        }

        /* NEWS/ARTICLES FEED */
        .articles-feed {
            padding: 16px;
        }

        .article-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .article-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .article-content {
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .article-footer {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .article-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            font-size: 14px; /* Minimum 14px for readability */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px; /* Mobile tap target */
        }

        .article-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* MUSIC SECTION */
        .music-player {
            padding: 20px;
        }

        .now-playing {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
        }

        .album-art {
            width: 200px;
            height: 200px;
            border-radius: 16px;
            background: rgba(0, 0, 0, 0.3);
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
        }

        .track-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .track-artist {
            font-size: 16px;
            opacity: 0.9;
        }

        .lyrics-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .lyric-line {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        /* STORIES SECTION */
        .stories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            padding: 16px;
        }

        .story-card {
            aspect-ratio: 9/16;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            transition: transform 0.2s ease;
        }

        .story-card:hover {
            transform: scale(1.03);
        }

        .story-title {
            font-size: 14px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* CHAT SECTION */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 16px;
        }

        .chat-header {
            text-align: center;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .chat-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .chat-header p {
            color: var(--text-secondary);
            font-size: 16px; /* 16px prevents iOS zoom */
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }

        .chat-message {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            max-width: 80%;
        }

        .chat-message.user {
            background: var(--primary);
            margin-left: auto;
        }

        .chat-input-container {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 16px;
            position: sticky;
            bottom: 0;
        }

        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
        }

        .voice-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .voice-btn:hover {
            transform: scale(1.1);
        }

        /* LOADING STATE */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* PLACEHOLDER CONTENT */
        .placeholder {
            padding: 40px 20px;
            text-align: center;
        }

        .placeholder h3 {
            font-size: 20px;
            margin-bottom: 12px;
        }

        .placeholder p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- MAIN APP CONTAINER -->
    <div class="app-container">
        <!-- FEED SECTION (Videos + Articles) -->
        <div id="feed-section" class="section active">
            <div class="feed-tabs">
                <button class="feed-tab active" data-feed="videos">Videos</button>
                <button class="feed-tab" data-feed="articles">News</button>
            </div>
            <div class="feed-content">
                <!-- VIDEOS PANEL -->
                <div id="videos-panel" class="feed-panel active">
                    <div class="video-container" id="video-container">
                        <div class="loading">Loading videos...</div>
                    </div>
                </div>
                <!-- ARTICLES PANEL -->
                <div id="articles-panel" class="feed-panel">
                    <div class="articles-feed" id="articles-feed">
                        <div class="loading">Loading news articles...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MUSIC SECTION -->
        <div id="music-section" class="section">
            <div class="music-player">
                <div class="now-playing">
                    <div class="album-art">üéµ</div>
                    <div class="track-title">Connect to Spotify</div>
                    <div class="track-artist">Play Spanish music with lyrics</div>
                </div>
                <div class="lyrics-container">
                    <div class="placeholder">
                        <h3>Music with Lyrics</h3>
                        <p>Connect your Spotify account to listen to Spanish music with synchronized lyrics and translations. Click any word to learn!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- STORIES SECTION -->
        <div id="stories-section" class="section">
            <div class="stories-grid">
                <div class="placeholder">
                    <h3>üìö Short Stories</h3>
                    <p>Read engaging stories adapted to your level with AI-generated images and audio. Uses words you've already learned!</p>
                </div>
            </div>
        </div>

        <!-- CHAT SECTION -->
        <div id="chat-section" class="section">
            <div class="chat-container">
                <div class="chat-header">
                    <h2>üí¨ AI Spanish Chat</h2>
                    <p>Practice speaking with voice AI. Talks about your interests and uses words from your learning progress.</p>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <!-- Messages will be added here -->
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" placeholder="Type your message...">
                    <button class="voice-btn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                            <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="location.href='/tiktok-video-feed.html'">
            <div>üé¨</div>
            <span>Videos</span>
        </button>
        <button class="nav-btn" onclick="location.href='/langflix-app.html'">
            <div>üì∫</div>
            <span>Shows</span>
        </button>
        <button class="nav-btn" onclick="location.href='/premium.html'">
            <div>üëë</div>
            <span>Premium</span>
        </button>
        <button class="nav-btn" onclick="location.href='/profile.html'">
            <div>üë§</div>
            <span>Profile</span>
        </button>
    </nav>

    <script>
        // SECTION NAVIGATION
        const sections = document.querySelectorAll('.section');
        const navItems = document.querySelectorAll('.nav-btn');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetSection = item.dataset.section;

                // Update nav items
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');

                // Update sections
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === `${targetSection}-section`) {
                        section.classList.add('active');
                    }
                });
            });
        });

        // FEED TABS (Videos / Articles)
        const feedTabs = document.querySelectorAll('.feed-tab');
        const feedPanels = document.querySelectorAll('.feed-panel');

        feedTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetFeed = tab.dataset.feed;

                // Update tabs
                feedTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update panels
                feedPanels.forEach(panel => {
                    panel.classList.remove('active');
                    if (panel.id === `${targetFeed}-panel`) {
                        panel.classList.add('active');
                    }
                });
            });
        });

        // Helper function to make words clickable with translations
        function makeWordsClickable(text, translations = {}) {
            const words = text.split(' ');
            return words.map(word => {
                const cleanWord = word.replace(/[.,;!?¬ø¬°]/g, '');
                const translation = translations[cleanWord.toLowerCase()] || 'Click for translation';
                return `<span class="word-clickable" data-word="${cleanWord}">${word}<span class="word-tooltip">${translation}</span></span>`;
            }).join(' ');
        }

        // Sample translations for demo
        const commonTranslations = {
            'hola': 'hello',
            'tengo': 'I have',
            'hambre': 'hunger',
            'el': 'the',
            'la': 'the',
            'un': 'a/an',
            'una': 'a/an',
            'sem√°foro': 'traffic light',
            'est√°': 'is',
            'rojo': 'red',
            'verde': 'green',
            'tiempo': 'time',
            'mismo': 'same',
            'mostrando': 'showing',
            'persona': 'person',
            'dice': 'says',
            'mira': 'look',
            'pasando': 'happening',
            'espa√±ol': 'Spanish',
            'aprender': 'to learn',
            'contenido': 'content',
            'real': 'real'
        };

        // LOAD VIDEOS FROM API (Improved for TikTok-style full-screen)
        async function loadVideos() {
            try {
                const response = await fetch('http://localhost:3001/api/videos?limit=20');
                const data = await response.json();

                const container = document.getElementById('video-container');
                container.innerHTML = '';

                if (!data.videos || data.videos.length === 0) {
                    container.innerHTML = '<div class="loading">No videos found. Add videos to your server.</div>';
                    return;
                }

                data.videos.forEach((video, index) => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'video-item';

                    // Sample Spanish transcriptions
                    const sampleTranscriptions = [
                        { es: '¬°Hola! Estoy aprendiendo espa√±ol con videos.', en: 'Hello! I am learning Spanish with videos.' },
                        { es: 'El sem√°foro est√° mostrando rojo y verde.', en: 'The traffic light is showing red and green.' },
                        { es: 'Tengo hambre. Voy a comer algo delicioso.', en: 'I am hungry. I am going to eat something delicious.' },
                        { es: 'Mira lo que est√° pasando en la calle.', en: 'Look at what is happening in the street.' },
                        { es: 'Esta es una manera divertida de aprender.', en: 'This is a fun way to learn.' }
                    ];

                    const transcription = sampleTranscriptions[index % sampleTranscriptions.length];
                    const spanishWithClickableWords = makeWordsClickable(transcription.es, commonTranslations);

                    videoItem.innerHTML = `
                        <video class="video-player" src="http://localhost:3001${video.url}" playsinline loop muted></video>
                        <div class="video-overlay">
                            <div class="transcription-box">
                                <div class="trans-line">
                                    <div class="trans-es">${spanishWithClickableWords}</div>
                                    <div class="trans-en">${transcription.en}</div>
                                </div>
                            </div>
                            <button class="video-control-btn mute-btn" aria-label="Unmute video" style="position: absolute; top: 20px; right: 20px; width: 48px; height: 48px; background: rgba(0,0,0,0.6); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 20;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                    <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                                    <path class="muted-indicator" d="M23 9l-6 6M17 9l6 6" stroke="#ff0050" stroke-width="2"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    container.appendChild(videoItem);
                });

                // Auto-play first video with sound
                const firstVideo = container.querySelector('video');
                if (firstVideo) {
                    firstVideo.muted = false;
                    firstVideo.play().catch(e => {
                        console.log('Autoplay prevented, user must interact first');
                        // Keep muted for autoplay
                        firstVideo.muted = true;
                        firstVideo.play();
                    });
                }

                // Setup intersection observer for TikTok-style autoplay
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const video = entry.target.querySelector('video');
                        if (entry.isIntersecting) {
                            video.currentTime = 0; // Reset to beginning
                            video.play().catch(e => console.log('Play prevented:', e));
                        } else {
                            video.pause();
                        }
                    });
                }, { threshold: 0.75 }); // 75% visible to trigger

                container.querySelectorAll('.video-item').forEach(item => {
                    observer.observe(item);
                });

                // Add click to unmute
                container.querySelectorAll('video').forEach(video => {
                    video.addEventListener('click', () => {
                        video.muted = !video.muted;
                    });
                });

                console.log(`‚úÖ Loaded ${data.videos.length} videos with clickable word translations`);

            } catch (error) {
                console.error('Error loading videos:', error);
                document.getElementById('video-container').innerHTML = '<div class="loading">Error loading videos. Check if server is running on port 3001.</div>';
            }
        }

        // LOAD ARTICLES FROM API
        async function loadArticles() {
            try {
                const response = await fetch('http://localhost:3001/api/news/personalized/test-user?limit=10');
                const data = await response.json();

                const container = document.getElementById('articles-feed');
                container.innerHTML = '';

                data.articles.forEach(article => {
                    const articleCard = document.createElement('div');
                    articleCard.className = 'article-card';
                    articleCard.innerHTML = `
                        <div class="article-title">${article.title || 'Spanish News Article'}</div>
                        <div class="article-content">${article.summary || 'Click any word to see translation. Simplified to your Spanish level.'}</div>
                        <div class="article-footer">
                            <button class="article-btn">üìñ Translate</button>
                            <button class="article-btn">üìù Simplify</button>
                            <button class="article-btn">üíæ Save</button>
                        </div>
                    `;
                    container.appendChild(articleCard);
                });

            } catch (error) {
                console.error('Error loading articles:', error);
                document.getElementById('articles-feed').innerHTML = '<div class="loading">Error loading articles. Please check server connection.</div>';
            }
        }

        // Initialize app
        loadVideos();
        loadArticles();

        console.log('üåç VIDA Spanish Learning App loaded');
        console.log('‚úÖ 4 sections: Feed (Videos+News), Music, Stories, Chat');
        console.log('‚úÖ Instagram-style bottom navigation');
        console.log('‚úÖ Connected to API at http://localhost:3001');
    </script>
</body>
</html>