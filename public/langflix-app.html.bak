<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Langflix - Learn Spanish Through Viral Videos</title>

    <!-- BEGINNER MODE STYLES -->
    <link rel="stylesheet" href="/components/beginner-mode-styles.html">
    <link rel="stylesheet" href="/components/quiz-mode-styles.html">

    <style>
        /* CRITICAL: TikTok 2025 Exact Scroll-Snap Implementation */
        /* Research: stackoverflow.com/questions/75340067 + CSS-Tricks scroll-snap guide */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* TIKTOK-STYLE BUTTON BEHAVIOR: Remove focus outlines, all interactions via touch/click */
        button,
        input[type="button"],
        input[type="submit"],
        a {
            outline: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        button:focus,
        button:active,
        input:focus,
        input:active,
        a:focus,
        a:active {
            outline: none !important;
            box-shadow: none !important;
        }

        :root {
            /* Safe area insets for notched devices (iPhone X+, modern Android) */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
        }

        /* Main container with TikTok scroll behavior */
        .feed-container {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        .feed-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }

        /* TikTok-style fullscreen video cards */
        .video-card {
            width: 100vw;
            height: 100vh;
            position: relative;
            scroll-snap-align: start;
            scroll-snap-stop: always;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        /* Video element - fullscreen contain */
        .video-card video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        /* ðŸŽ¬ LOADING SKELETON - TikTok/Instagram 2025 Style */
        .video-loading-skeleton {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            z-index: 100;
            transition: opacity 0.3s ease;
        }

        .skeleton-pulse {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.03) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: skeleton-pulse 2s ease-in-out infinite;
        }

        @keyframes skeleton-pulse {
            0%, 100% {
                transform: translateX(-100%);
            }
            50% {
                transform: translateX(100%);
            }
        }

        .skeleton-spinner {
            width: 50px;
            height: 50px;
            margin-bottom: 16px;
            position: relative;
            z-index: 101;
        }

        .spinner-circle {
            animation: spinner-rotate 1.5s linear infinite;
            transform-origin: center;
        }

        @keyframes spinner-rotate {
            0% {
                stroke-dashoffset: 125;
                transform: rotate(0deg);
            }
            50% {
                stroke-dashoffset: 25;
                transform: rotate(180deg);
            }
            100% {
                stroke-dashoffset: 125;
                transform: rotate(360deg);
            }
        }

        .skeleton-text {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 0.5px;
            position: relative;
            z-index: 101;
            animation: skeleton-text-pulse 1.5s ease-in-out infinite;
        }

        @keyframes skeleton-text-pulse {
            0%, 100% {
                opacity: 0.7;
            }
            50% {
                opacity: 0.3;
            }
        }

        /* TikTok 2025 Subtitles - Bold Spanish + Yellow English */
        .transcription-overlay {
            position: absolute;
            bottom: 25%; /* LOWER position for better visibility - moved down from 38% */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            z-index: 10;
            display: block; /* ALWAYS VISIBLE by default (TikTok style) */
            text-align: center;
            pointer-events: auto;
        }

        .transcription-overlay.active {
            display: block;
        }

        /* Hidden state when user toggles off */
        .transcription-overlay.hidden {
            display: none;
        }

        .subtitle-container {
            position: relative;
            display: inline-block;
        }

        /* SPEED CONTROL - REMOVED (moved to sidebar) */

        /* Spanish line - TikTok 2025 Professional Style (WHITE text, THICK BLACK OUTLINE) */
        .spanish-line {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            font-size: 26px; /* Slightly larger */
            font-weight: 900; /* Maximum boldness */
            margin-bottom: 8px;
            line-height: 1.2;
            color: #ffffff; /* WHITE text */

            /* THICKER BLACK OUTLINE - Enhanced legibility (increased from 3px to 5px) */
            -webkit-text-stroke: 5px black;
            text-stroke: 5px black;
            paint-order: stroke fill;

            /* Plus shadow for depth - multiple layers for maximum visibility */
            text-shadow:
                0 2px 4px rgba(0, 0, 0, 1.0),
                0 4px 8px rgba(0, 0, 0, 0.9),
                0 0 10px rgba(0, 0, 0, 0.8),
                0 0 20px rgba(0, 0, 0, 0.6),
                0 0 30px rgba(0, 0, 0, 0.4);

            letter-spacing: 0.5px;
        }

        /* Clickable Spanish words */
        .word {
            display: inline-block;
            padding: 4px 8px;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .word:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: scale(1.05);
        }

        .word:active {
            background: rgba(255, 215, 0, 0.5);
            transform: scale(0.95);
        }

        /* English line - YELLOW text with THICK BLACK OUTLINE */
        .english-line {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            font-size: 20px;
            color: #ffeb3b !important; /* YELLOW text - force in all modes */
            font-weight: 800;
            line-height: 1.4;
            letter-spacing: 0.2px;

            /* THICKER BLACK OUTLINE - Enhanced legibility (increased from 3px to 5px) */
            -webkit-text-stroke: 5px black !important;
            text-stroke: 5px black !important;
            paint-order: stroke fill;

            /* Multiple shadow layers for maximum visibility */
            text-shadow:
                0 2px 4px rgba(0, 0, 0, 1.0),
                0 4px 8px rgba(0, 0, 0, 0.9),
                0 0 8px rgba(0, 0, 0, 0.8),
                0 0 16px rgba(0, 0, 0, 0.6),
                0 0 24px rgba(0, 0, 0, 0.4);

            /* HIDE English by default - will toggle with JavaScript */
            display: none;
            margin-top: 8px;
        }

        /* Show only ONE line at a time - TikTok style */
        /* Default: Show BOTH Spanish and English (stacked) */
        .subtitle-container .spanish-line {
            display: block;
        }

        .subtitle-container .english-line {
            display: block;
        }

        /* Toggle modes */
        .subtitle-container.spanish-only .english-line {
            display: none;
        }

        .subtitle-container.english-only .spanish-line {
            display: none;
        }

        .subtitle-container.hidden-subtitles .spanish-line,
        .subtitle-container.hidden-subtitles .english-line {
            display: none;
        }

        /* DARK MODE PROTECTION - Force black outlines and correct colors */
        @media (prefers-color-scheme: dark) {
            .spanish-line {
                color: #ffffff !important; /* WHITE text */
                -webkit-text-stroke: 5px black !important;
                text-stroke: 5px black !important;
            }

            .english-line {
                color: #ffeb3b !important; /* YELLOW text */
                -webkit-text-stroke: 5px black !important;
                text-stroke: 5px black !important;
            }
        }

        /* TikTok Right Sidebar - 54px circles, white bg 20% opacity, drop shadow */
        .sidebar {
            position: absolute;
            right: calc(12px + var(--safe-area-right));
            bottom: calc(120px + var(--safe-area-bottom));
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 15;
        }

        .sidebar-button {
            width: 54px;
            height: 54px;
            min-width: 44px; /* iOS/Android minimum touch target */
            min-height: 44px;
            border-radius: 0;
            background: transparent;
            backdrop-filter: none;
            border: none;
            color: #fff;
            font-size: 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: none;
            user-select: none;
        }

        .sidebar-button:active {
            transform: scale(0.88);
        }

        .sidebar-button.liked {
            animation: likeAnimation 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .sidebar-button.liked svg {
            fill: #fe2c55;
            stroke: #fe2c55;
        }

        @keyframes likeAnimation {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.25); }
        }

        /* PLAYBACK CONTROLS - Bottom-left near subtitles (TikTok pattern) */
        .playback-controls {
            position: absolute;
            left: calc(16px + var(--safe-area-left));
            bottom: calc(140px + var(--safe-area-bottom));
            display: flex;
            gap: 12px;
            z-index: 15;
        }

        .playback-btn {
            width: 42px;
            height: 42px;
            border-radius: 8px; /* TikTok-style: Rounded square, NOT circle */
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            border: none;
            outline: none !important; /* NO outline ever */
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .playback-btn:active {
            transform: scale(0.9);
        }

        .playback-status {
            font-size: 9px;
            font-weight: 700;
            color: #fff;
            margin-top: 2px;
        }

        .sidebar-count {
            font-size: 11px;
            margin-top: 2px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9), 0 0 8px rgba(0, 0, 0, 0.8);
        }

        /* Profile Avatar with + Follow Button (TikTok style) */
        .profile-avatar {
            position: relative;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .follow-plus {
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fe2c55;
            color: #fff;
            font-size: 16px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #000;
            line-height: 1;
        }

        .sidebar-button svg {
            transition: all 0.2s ease;
            stroke: white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8));
        }

        .sidebar-button:active svg {
            transform: scale(0.9);
        }

        .sidebar-button:hover {
            transform: scale(1.1);
        }

        /* Delete button for admins */
        .delete-btn {
            background: rgba(254, 44, 85, 0.2) !important;
            border-color: rgba(254, 44, 85, 0.5) !important;
        }

        .delete-btn:hover {
            background: rgba(254, 44, 85, 0.4) !important;
        }

        /* ðŸŽ¯ GENIUS LEVEL DETECTION: Hard/Easy Button Styles */
        .too-easy-btn {
            background: rgba(76, 175, 80, 0.15) !important;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .too-easy-btn:hover {
            background: rgba(76, 175, 80, 0.3) !important;
            transform: scale(1.15) translateY(-2px);
        }

        .too-easy-btn.marked {
            background: rgba(76, 175, 80, 0.9) !important;
            animation: feedbackAnimation 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .too-easy-btn.marked svg {
            stroke: #fff;
        }

        .too-hard-btn {
            background: rgba(244, 67, 54, 0.15) !important;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .too-hard-btn:hover {
            background: rgba(244, 67, 54, 0.3) !important;
            transform: scale(1.15) translateY(2px);
        }

        .too-hard-btn.marked {
            background: rgba(244, 67, 54, 0.9) !important;
            animation: feedbackAnimation 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .too-hard-btn.marked svg {
            stroke: #fff;
        }

        @keyframes feedbackAnimation {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }

        /* Double-tap heart animation (Instagram/TikTok pattern) */
        .double-tap-heart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 120px;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
            animation: heartBurst 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes heartBurst {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }

        /* Pause/Play indicator (single tap) - PROFESSIONAL SVG */
        .pause-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0;
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            z-index: 20;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .pause-indicator svg {
            width: 40px;
            height: 40px;
            fill: white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .pause-indicator.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        /* Video info overlay - MOVED TO TOP LEFT for subtle appearance */
        .video-info {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 10;
        }

        .video-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
        }

        .video-level {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(255, 215, 0, 0.25);
            color: #ffd700;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        /* Bottom Navigation - MINIMAL PROFESSIONAL (uniform 24px icons) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 0.5px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 100;
            padding: 0 8px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px 8px;
            min-width: 44px; /* iOS/Android minimum touch target */
            min-height: 44px;
            flex: 1;
            justify-content: center;
        }

        .nav-item:active {
            transform: scale(0.9);
        }

        .nav-icon svg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
            transition: all 0.2s ease;
        }

        .nav-item:not(.active) .nav-icon svg {
            opacity: 0.6;
        }

        .nav-item.active .nav-icon svg {
            opacity: 1;
            transform: scale(1.1);
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
            opacity: 0.7;
        }

        .nav-item.active .nav-label {
            opacity: 1;
            font-weight: 700;
        }

        /* Progress bar */
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.9);
            width: 0%;
            transition: width 0.1s linear;
            z-index: 20;
        }

        /* Loading spinner */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 200;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Word tooltip - MINIMAL TIKTOK-STYLE (80px above word) */
        .word-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            pointer-events: none;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-width: 280px;
        }

        .word-tooltip::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(0, 0, 0, 0.85);
        }

        .word-tooltip.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .word-spanish {
            font-weight: 700;
            font-size: 16px;
            color: #fff;
        }

        .word-english {
            font-size: 14px;
            color: #ffeb3b;
            font-weight: 600;
            opacity: 0.95;
        }

        .save-word-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-top: 4px;
        }

        .save-word-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .save-word-btn:active {
            transform: scale(0.95);
        }

        /* Speed Control Button */
        .speed-control {
            position: absolute;
            top: 80px;
            right: 12px;
            z-index: 15;
        }

        .speed-btn {
            width: 54px;
            height: 54px;
            min-width: 44px;
            min-height: 44px;
            border-radius: 0;
            background: transparent;
            backdrop-filter: none;
            border: none;
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: none;
            user-select: none;
        }

        .speed-btn:active {
            transform: scale(0.88);
            background: transparent;
        }

        /* Speed Menu Dropdown */
        .speed-menu {
            position: absolute;
            top: 0;
            right: 70px;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 6px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .speed-menu.show {
            display: flex;
        }

        .speed-option {
            padding: 10px 20px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            text-align: center;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .speed-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .speed-option.active {
            background: rgba(102, 126, 234, 0.9);
            color: #fff;
        }

        /* Auth Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .auth-modal.show {
            display: flex;
        }

        .auth-container {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .auth-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-input {
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            outline: none;
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #667eea;
        }

        .auth-button {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-button:active {
            transform: translateY(0);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .auth-toggle-link {
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
        }

        .auth-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Profile View */
        .profile-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 999;
            display: none;
            overflow-y: auto;
            padding-bottom: 60px;
        }

        .profile-view.show {
            display: block;
        }

        .profile-header {
            padding: 60px 20px 30px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-email {
            font-size: 14px;
            opacity: 0.8;
        }

        /* LEVEL BADGE - Duolingo Style */
        .profile-level-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 20px auto 0;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            width: fit-content;
        }

        .level-badge-icon {
            font-size: 32px;
        }

        .level-badge-text {
            text-align: left;
        }

        .level-badge-level {
            font-size: 24px;
            font-weight: 900;
            color: #fff;
        }

        .level-badge-label {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* XP PROGRESS BAR */
        .profile-xp-container {
            margin: 16px 20px 0;
        }

        .profile-xp-label {
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .profile-xp-next {
            opacity: 0.7;
            font-size: 12px;
            margin-left: 8px;
        }

        .profile-xp-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .profile-xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* FREQUENCY LIST PROGRESS - Duolingo-inspired */
        .frequency-progress-container {
            margin: 24px 20px 16px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .frequency-progress-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .frequency-icon {
            font-size: 32px;
        }

        .frequency-text {
            flex: 1;
        }

        .frequency-title {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 2px;
        }

        .frequency-subtitle {
            font-size: 13px;
            opacity: 0.7;
            color: rgba(255, 255, 255, 0.8);
        }

        .frequency-stats {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin-bottom: 16px;
            padding: 16px 0;
        }

        .frequency-stat-item {
            text-align: center;
            flex: 1;
        }

        .frequency-stat-number {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .frequency-stat-label {
            font-size: 12px;
            opacity: 0.8;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .frequency-stat-divider {
            width: 1px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
        }

        .frequency-progress-bar {
            height: 14px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
            position: relative;
        }

        .frequency-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            border-radius: 12px;
            transition: width 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .frequency-progress-text {
            font-size: 13px;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            font-style: italic;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
        }

        .profile-stat {
            text-align: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .profile-stat-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .profile-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .profile-stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .profile-section {
            padding: 20px;
        }

        .profile-section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vocabulary-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .vocabulary-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vocabulary-word {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .vocabulary-translation {
            font-size: 14px;
            color: #ffeb3b;
            opacity: 0.9;
        }

        .vocabulary-context {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
            font-style: italic;
        }

        .profile-back-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .profile-logout-btn {
            margin-top: 20px;
            padding: 14px;
            background: rgba(255, 59, 48, 0.15);
            border: 1px solid rgba(255, 59, 48, 0.3);
            border-radius: 10px;
            color: #ff3b30;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* GAMIFICATION BAR - MINIMAL (streak only, centered, auto-hide) */
        .gamification-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .gamification-bar.hidden {
            transform: translateY(-100%);
        }

        .gamification-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .gamification-item .emoji {
            font-size: 18px;
        }

        /* MINIMAL TOP BAR - Clean and Professional */
        .stats-top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 36px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 16px;
            z-index: 100;
            pointer-events: none;
        }

        .minimal-stats {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.85);
            letter-spacing: 0.3px;
            pointer-events: auto;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 10px 18px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .minimal-stats:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.25) 0%, rgba(118, 75, 162, 0.25) 100%);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 6px 32px rgba(0, 0, 0, 0.3);
        }

        .minimal-stats span {
            color: #ffffff;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 600;
        }

        /* Milestone Celebration Modal */
        .milestone-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .milestone-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .milestone-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            padding: 40px 32px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            transform: scale(0.8);
            animation: milestonePopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes milestonePopIn {
            to {
                transform: scale(1);
            }
        }

        .milestone-emoji {
            font-size: 80px;
            margin-bottom: 16px;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .milestone-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 12px;
            color: #fff;
        }

        .milestone-message {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
        }

        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            z-index: 2001;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Practice Tab Styles */
        .practice-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: #000;
            z-index: 999;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .practice-view.show {
            display: flex;
        }

        .practice-header {
            padding: 60px 20px 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .practice-header h1 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .practice-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .flashcard-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .flashcard {
            width: 100%;
            max-width: 400px;
            height: 450px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            cursor: pointer;
            transition: all 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform-style: preserve-3d;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            height: 100%;
        }

        .flashcard-back {
            transform: rotateY(180deg);
        }

        .flashcard-word {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 16px;
            color: #fff;
        }

        .flashcard-translation {
            font-size: 32px;
            font-weight: 700;
            color: #ffeb3b;
            margin-bottom: 24px;
        }

        .flashcard-sentence {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            font-style: italic;
        }

        .flashcard-controls {
            display: flex;
            gap: 12px;
            padding: 20px;
            justify-content: center;
        }

        .flashcard-btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: 2px solid;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        .flashcard-btn.hard {
            background: rgba(255, 59, 48, 0.15);
            border-color: rgba(255, 59, 48, 0.5);
            color: #ff3b30;
        }

        .flashcard-btn.good {
            background: rgba(255, 204, 0, 0.15);
            border-color: rgba(255, 204, 0, 0.5);
            color: #ffcc00;
        }

        .flashcard-btn.easy {
            background: rgba(52, 199, 89, 0.15);
            border-color: rgba(52, 199, 89, 0.5);
            color: #34c759;
        }

        .flashcard-btn:active {
            transform: scale(0.95);
        }

        .practice-progress {
            padding: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Quiz Tab Styles */
        .quiz-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: #000;
            z-index: 999;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .quiz-view.show {
            display: flex;
        }

        .quiz-header {
            padding: 60px 20px 20px;
            text-align: center;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .quiz-container {
            flex: 1;
            padding: 30px 20px;
        }

        .quiz-question {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 32px 24px;
            margin-bottom: 24px;
            border: 2px solid rgba(255, 255, 255, 0.15);
        }

        .quiz-question-text {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quiz-option {
            padding: 18px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quiz-option:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(8px);
        }

        .quiz-option.correct {
            background: rgba(52, 199, 89, 0.2);
            border-color: #34c759;
            color: #34c759;
        }

        .quiz-option.incorrect {
            background: rgba(255, 59, 48, 0.2);
            border-color: #ff3b30;
            color: #ff3b30;
        }

        .quiz-score {
            text-align: center;
            padding: 40px 20px;
        }

        .quiz-score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 48px;
            font-weight: 800;
        }

        .quiz-restart-btn {
            padding: 16px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Per-Video Quiz Prompt */
        .video-quiz-prompt {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px 24px;
            z-index: 1500;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 215, 0, 0.3);
            max-width: 320px;
        }

        .video-quiz-prompt.show {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .quiz-prompt-title {
            font-size: 18px;
            font-weight: 700;
            text-align: center;
        }

        .quiz-prompt-buttons {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .quiz-prompt-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            outline: none !important; /* NO outline ever - TikTok style */
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quiz-prompt-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .quiz-prompt-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .quiz-prompt-btn:active {
            transform: scale(0.95);
        }

        /* Admin delete button - TOP-LEFT corner (subtle) */
        .admin-delete-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
            cursor: pointer;
            z-index: 150;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0.5;
        }

        .admin-delete-btn:hover {
            opacity: 1;
            background: rgba(254, 44, 85, 0.3);
            border-color: rgba(254, 44, 85, 0.5);
        }

        .admin-delete-btn:active {
            transform: scale(0.9);
        }

        /* Onboarding tooltip */
        .onboarding-tooltip {
            position: fixed;
            bottom: 145px;
            right: 80px;
            background: rgba(102, 126, 234, 0.95);
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            z-index: 200;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            white-space: nowrap;
            animation: tooltipPulse 2s infinite;
        }

        .onboarding-tooltip::after {
            content: '';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 6px solid rgba(102, 126, 234, 0.95);
        }

        @keyframes tooltipPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <!-- MINIMAL TOP BAR - Clean and Professional -->
    <div class="stats-top-bar" id="statsTopBar">
        <div class="minimal-stats">
            <span id="wordsDisplay">0</span> words Â· <span id="streakDisplay">0</span> day streak
        </div>
    </div>

    <!-- MILESTONE CELEBRATION MODAL -->
    <div class="milestone-modal" id="milestoneModal">
        <div class="milestone-content">
            <div class="milestone-emoji" id="milestoneEmoji">ðŸŽ‰</div>
            <div class="milestone-title" id="milestoneTitle">Amazing!</div>
            <div class="milestone-message" id="milestoneMessage">You're making great progress!</div>
        </div>
    </div>

    <!-- PER-VIDEO QUIZ PROMPT -->
    <div class="video-quiz-prompt" id="videoQuizPrompt">
        <div class="quiz-prompt-title">ðŸŽ¯ Test yourself on this video?</div>
        <div class="quiz-prompt-buttons">
            <button class="quiz-prompt-btn secondary" onclick="skipVideoQuiz()">Skip</button>
            <button class="quiz-prompt-btn primary" onclick="startVideoQuiz()">Let's go!</button>
        </div>
    </div>

    <!-- Global Speed Control - REMOVED (now in sidebar per video) -->

    <!-- BEGINNER ONBOARDING TOOLTIPS - Only show for complete beginners -->
    <div class="beginner-onboarding-overlay" id="beginnerOnboarding" style="display: none;">
        <!-- Welcome Message -->
        <div class="beginner-welcome-modal" id="welcomeModal">
            <div class="beginner-modal-content">
                <h2 style="font-size: 28px; margin-bottom: 16px;">ðŸ‘‹ Welcome to Langflix!</h2>
                <p style="font-size: 16px; line-height: 1.6; margin-bottom: 24px;">
                    Learn Spanish naturally by watching short videos.<br>
                    Let's show you the basics to get started!
                </p>
                <button onclick="startBeginnerTour()" style="
                    padding: 14px 32px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border: none;
                    border-radius: 12px;
                    color: white;
                    font-size: 16px;
                    font-weight: 700;
                    cursor: pointer;
                    width: 100%;
                ">Start Tour</button>
                <button onclick="skipBeginnerTour()" style="
                    padding: 12px 32px;
                    background: transparent;
                    border: none;
                    color: rgba(255,255,255,0.6);
                    font-size: 14px;
                    cursor: pointer;
                    width: 100%;
                    margin-top: 8px;
                ">Skip - I know how to use this</button>
            </div>
        </div>

        <!-- Tooltip 1: Speed Control -->
        <div class="beginner-tooltip speed-tooltip" id="speedTooltip" style="display: none;">
            <div class="tooltip-arrow"></div>
            <div class="tooltip-content">
                <div style="font-size: 20px; margin-bottom: 8px;">ðŸ¢</div>
                <div style="font-weight: 700; margin-bottom: 4px;">Tap to Slow Down</div>
                <div style="font-size: 13px; opacity: 0.8;">Videos too fast? Tap this button to play at 0.5x speed!</div>
            </div>
            <button onclick="nextBeginnerStep()" class="tooltip-next-btn">Got it!</button>
        </div>

        <!-- Tooltip 2: Hard/Easy Buttons -->
        <div class="beginner-tooltip difficulty-tooltip" id="difficultyTooltip" style="display: none;">
            <div class="tooltip-arrow"></div>
            <div class="tooltip-content">
                <div style="font-size: 20px; margin-bottom: 8px;">ðŸŽ¯</div>
                <div style="font-weight: 700; margin-bottom: 4px;">Tell Us How You Feel</div>
                <div style="font-size: 13px; opacity: 0.8;">
                    <strong style="color: #4CAF50;">Too Easy?</strong> Tap green â†‘<br>
                    <strong style="color: #f44336;">Too Hard?</strong> Tap red â†“<br>
                    We'll adjust your videos!
                </div>
            </div>
            <button onclick="nextBeginnerStep()" class="tooltip-next-btn">Got it!</button>
        </div>

        <!-- Tooltip 3: Click Words for Translation -->
        <div class="beginner-tooltip words-tooltip" id="wordsTooltip" style="display: none;">
            <div class="tooltip-arrow"></div>
            <div class="tooltip-content">
                <div style="font-size: 20px; margin-bottom: 8px;">ðŸ“–</div>
                <div style="font-weight: 700; margin-bottom: 4px;">Tap Any Spanish Word</div>
                <div style="font-size: 13px; opacity: 0.8;">See instant translations and save words to learn later!</div>
            </div>
            <button onclick="finishBeginnerTour()" class="tooltip-next-btn">Start Learning!</button>
        </div>
    </div>

    <style>
        /* BEGINNER ONBOARDING STYLES */
        .beginner-onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .beginner-welcome-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            padding: 40px 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .beginner-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            max-width: 280px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
            border: 2px solid rgba(255, 215, 0, 0.3);
            animation: tooltipPulse 2s ease-in-out infinite;
        }

        @keyframes tooltipPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .tooltip-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
        }

        .speed-tooltip {
            top: 100px;
            right: 80px;
        }

        .speed-tooltip .tooltip-arrow {
            right: 30px;
            top: -12px;
            border-bottom: 12px solid rgba(255, 215, 0, 0.3);
        }

        .difficulty-tooltip {
            bottom: 200px;
            right: 80px;
        }

        .difficulty-tooltip .tooltip-arrow {
            right: 30px;
            bottom: -12px;
            border-top: 12px solid rgba(255, 215, 0, 0.3);
        }

        .words-tooltip {
            bottom: 30%;
            left: 50%;
            transform: translateX(-50%);
        }

        .words-tooltip .tooltip-arrow {
            left: 50%;
            transform: translateX(-50%);
            bottom: -12px;
            border-top: 12px solid rgba(255, 215, 0, 0.3);
        }

        .tooltip-content {
            text-align: center;
            color: white;
        }

        .tooltip-next-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s ease;
        }

        .tooltip-next-btn:active {
            transform: scale(0.95);
        }
    </style>

    <!-- Loading indicator -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Spanish videos...</div>
    </div>

    <!-- Feed container with scroll-snap -->
    <div class="feed-container" id="feedContainer">
        <!-- Video cards will be dynamically inserted here -->
    </div>

    <!-- Word translation tooltip - MINIMAL TIKTOK-STYLE -->
    <div class="word-tooltip" id="wordTooltip">
        <div class="word-spanish"></div>
        <div class="word-english"></div>
        <button class="save-word-btn" title="Save word">Save</button>
    </div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-container" style="position: relative;">
            <button class="auth-close" onclick="closeAuthModal()">Ã—</button>
            <div class="auth-header">
                <div class="auth-title" id="authTitle">Sign In</div>
                <div class="auth-subtitle">Save your progress and vocabulary</div>
            </div>
            <form class="auth-form" id="authForm" onsubmit="handleAuth(event)">
                <input type="email" class="auth-input" id="authEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="authPassword" placeholder="Password" required>
                <input type="text" class="auth-input" id="authDisplayName" placeholder="Display Name" style="display: none;">
                <button type="submit" class="auth-button" id="authSubmitBtn">Sign In</button>
            </form>
            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <span class="auth-toggle-link" onclick="toggleAuthMode()">Sign Up</span>
            </div>
        </div>
    </div>

    <!-- Profile View - REDESIGNED BEAUTIFUL UI -->
    <div class="profile-view" id="profileView">
        <!-- Modern Header with Glassmorphism -->
        <div class="profile-header-modern">
            <!-- Back Button - Top Left -->
            <button class="profile-back-btn-modern" onclick="closeProfile()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>

            <!-- Sign Out Button - Top Right -->
            <button class="profile-signout-btn-modern" onclick="handleLogout()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span>Sign Out</span>
            </button>

            <!-- Profile Info Card -->
            <div class="profile-card-modern">
                <div class="profile-avatar-modern" id="profileAvatar">
                    <div class="avatar-gradient"></div>
                    <span class="avatar-emoji">ðŸ‘¤</span>
                </div>
                <h1 class="profile-name-modern" id="profileName">Guest User</h1>
                <p class="profile-email-modern" id="profileEmail">guest@example.com</p>

                <!-- LEVEL BADGE - Redesigned Premium -->
                <div class="profile-level-badge-modern" id="profileLevelBadge">
                    <div class="level-badge-icon-modern">ðŸŽ¯</div>
                    <div class="level-badge-text-modern">
                        <div class="level-badge-level-modern" id="profileLevel">A1</div>
                        <div class="level-badge-label-modern">Level</div>
                    </div>
                </div>
            </div>

            <!-- XP PROGRESS BAR -->
            <div class="profile-xp-container">
                <div class="profile-xp-label">
                    <span id="profileXP">0</span> XP
                    <span class="profile-xp-next">/ <span id="profileXPNext">100</span> to level up</span>
                </div>
                <div class="profile-xp-bar">
                    <div class="profile-xp-fill" id="profileXPFill" style="width: 0%"></div>
                </div>
            </div>

            <!-- FREQUENCY LIST PROGRESS (Duolingo-style) -->
            <div class="frequency-progress-container">
                <div class="frequency-progress-header">
                    <span class="frequency-icon">ðŸ“Š</span>
                    <div class="frequency-text">
                        <div class="frequency-title">Vocabulary Journey</div>
                        <div class="frequency-subtitle">Top 10,000 Spanish Words</div>
                    </div>
                </div>
                <div class="frequency-stats">
                    <div class="frequency-stat-item">
                        <div class="frequency-stat-number" id="frequencyWordsLearned">0</div>
                        <div class="frequency-stat-label">Words Mastered</div>
                    </div>
                    <div class="frequency-stat-divider"></div>
                    <div class="frequency-stat-item">
                        <div class="frequency-stat-number" id="frequencyPosition">1-500</div>
                        <div class="frequency-stat-label">Current Range</div>
                    </div>
                </div>
                <div class="frequency-progress-bar">
                    <div class="frequency-progress-fill" id="frequencyProgressFill" style="width: 0%"></div>
                </div>
                <div class="frequency-progress-text" id="frequencyProgressText">
                    You're learning the most essential Spanish words
                </div>
            </div>
        </div>

        <div class="profile-stats">
            <div class="profile-stat">
                <div class="profile-stat-icon">ðŸ“š</div>
                <div class="profile-stat-value" id="statsWords">0</div>
                <div class="profile-stat-label">Words Learned</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-icon">ðŸ”¥</div>
                <div class="profile-stat-value" id="statsDays">0</div>
                <div class="profile-stat-label">Day Streak</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-icon">ðŸŽ¬</div>
                <div class="profile-stat-value" id="statsVideos">0</div>
                <div class="profile-stat-label">Videos Watched</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-icon">â±ï¸</div>
                <div class="profile-stat-value" id="statsTime">0m</div>
                <div class="profile-stat-label">Study Time</div>
            </div>
        </div>
        <div class="profile-section">
            <div class="profile-section-title">
                <span>ðŸ“š</span>
                <span>Saved Vocabulary</span>
            </div>
            <div class="vocabulary-list" id="vocabularyList">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“–</div>
                    <div class="empty-state-text">No words saved yet. Tap on Spanish words to save them!</div>
                </div>
            </div>
        </div>
        <div class="profile-section">
            <button class="profile-logout-btn" onclick="handleLogout()">Sign Out</button>
        </div>
    </div>

    <!-- PRACTICE VIEW - Anki-style Flashcards -->
    <div class="practice-view" id="practiceView">
        <div class="practice-header">
            <h1>ðŸ“š Practice</h1>
            <p>Master your vocabulary with flashcards</p>
        </div>
        <div class="practice-progress" id="practiceProgress">
            Loading your words...
        </div>
        <div class="flashcard-container" id="flashcardContainer">
            <!-- Flashcards will be inserted here -->
        </div>
        <div class="flashcard-controls" id="flashcardControls" style="display: none;">
            <button class="flashcard-btn hard" onclick="rateCard('hard')">Hard</button>
            <button class="flashcard-btn good" onclick="rateCard('good')">Good</button>
            <button class="flashcard-btn easy" onclick="rateCard('easy')">Easy</button>
        </div>
    </div>

    <!-- QUIZ VIEW - Complete Quiz & Practice Section -->
    <div class="quiz-view" id="quizView">
        <div class="quiz-header">
            <h1>Quiz & Practice</h1>
            <p>Test your knowledge and review flashcards</p>
        </div>

        <!-- Mode Selector: Quiz or Practice -->
        <div style="display: flex; gap: 12px; padding: 16px; justify-content: center;">
            <button onclick="showQuizMode()" style="flex: 1; padding: 12px 24px; background: #007AFF; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
                Quizzes
            </button>
            <button onclick="showPracticeMode()" style="flex: 1; padding: 12px 24px; background: #34C759; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
                Flashcards
            </button>
        </div>

        <div class="quiz-container" id="quizContainer">
            <!-- Quiz questions will be inserted here -->
        </div>

        <!-- Practice/Flashcard Container (moved from separate view) -->
        <div id="practiceContainer" style="display: none;">
            <div class="practice-progress" id="practiceProgress">
                Loading your words...
            </div>
            <div class="flashcard-container" id="flashcardContainer">
                <!-- Flashcards will be shown here -->
            </div>
            <div class="flashcard-controls" id="flashcardControls" style="display: none;">
                <button onclick="rateCard('hard')" style="background: #FF3B30;">Hard</button>
                <button onclick="rateCard('good')" style="background: #34C759;">Good</button>
                <button onclick="rateCard('easy')" style="background: #007AFF;">Easy</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation - 4 tabs: Home, Discover, Quiz, Profile -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-feed="home" onclick="switchTab('home')">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
            </div>
            <div class="nav-label">Home</div>
        </div>
        <div class="nav-item" data-feed="discover" onclick="switchTab('discover')">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            <div class="nav-label">Discover</div>
        </div>
        <div class="nav-item" data-feed="quizzes" onclick="switchTab('quizzes')">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </div>
            <div class="nav-label">Games</div>
        </div>
        <div class="nav-item" onclick="window.location.href='/voice-chat.html'">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </div>
            <div class="nav-label">Chat</div>
        </div>
        <div class="nav-item" data-feed="profile" onclick="switchTab('profile')">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </div>
            <div class="nav-label">Profile</div>
        </div>
    </nav>

    <script type="module">
        // TikTok-Style Video Feed - Complete Rebuild with Supabase
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Supabase client - UPDATED CREDENTIALS
        const SUPABASE_URL = 'https://uejiwteujraxczrxbqff.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlaml3dGV1anJheGN6cnhicWZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDMxMzksImV4cCI6MjA3NTUxOTEzOX0.iva8q5bMcLHfqd6niXqB_i-i-VrPmKLNGr9eiiPwZHQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let videos = [];
        let currentVideoIndex = 0;
        let loadedVideoCount = 0;
        const BATCH_SIZE = 5; // Load videos in smaller batches for better performance
        const WORDS_CACHE = new Map();
        let currentUser = null;
        let currentTab = 'home';
        let isAuthMode = 'signin'; // 'signin' or 'signup'
        let currentPlaybackSpeed = parseFloat(localStorage.getItem('playbackSpeed') || '1');
        let wordsLearned = new Set(JSON.parse(localStorage.getItem('wordsLearned') || '[]'));

        // GAMIFICATION STATE
        let userXP = parseInt(localStorage.getItem('userXP') || '0');
        let userStreak = parseInt(localStorage.getItem('userStreak') || '0');
        let lastActiveDate = localStorage.getItem('lastActiveDate') || null;
        let videosWatched = parseInt(localStorage.getItem('videosWatched') || '0');
        let milestonesReached = new Set(JSON.parse(localStorage.getItem('milestonesReached') || '[]'));

        // PRACTICE/FLASHCARD STATE
        let practiceCards = [];
        let currentCardIndex = 0;
        let isCardFlipped = false;

        // QUIZ STATE
        let quizQuestions = [];
        let currentQuizIndex = 0;
        let quizScore = 0;
        let videoQuizData = null;

        // ðŸŽ¯ TIKTOK-STYLE BEHAVIORAL TRACKING STATE
        let behaviorTracker = {
            videoSessions: {}, // Track watch time per video
            skipPatterns: [], // Track which videos were skipped (< 30% watched)
            completionPatterns: [], // Track which videos were completed (> 70% watched)
            interests: {}, // Track topic/level engagement
            levelSignals: [], // Track signals indicating user's actual level
            lastVideoId: null,
            lastVideoStartTime: null
        };

        // Load behavioral data from localStorage
        try {
            const savedBehavior = localStorage.getItem('behaviorTracker');
            if (savedBehavior) {
                const parsed = JSON.parse(savedBehavior);
                behaviorTracker = { ...behaviorTracker, ...parsed };
            }
        } catch (e) {
            console.log('No saved behavioral data');
        }

        // GENERATE VIDEO TITLE - Only show real description, no fake viral hooks
        function generateViralTitle(video) {
            // Option 1: Use video's actual description/title if available
            if (video.title && video.title.trim() && video.title !== 'Untitled') {
                return video.title;
            }

            // Option 2: Use first sentence from transcription as description
            if (video.transcription && video.transcription.lines && video.transcription.lines.length > 0) {
                const firstLine = video.transcription.lines[0];
                if (firstLine.spanish) {
                    // Use first Spanish sentence (up to 60 chars)
                    let title = firstLine.spanish.substring(0, 60);
                    if (firstLine.spanish.length > 60) {
                        title += '...';
                    }
                    return title;
                }
            }

            // Option 3: Generic but honest description
            return `${video.level} Spanish Lesson`;
        }

        // Load ALL 106 videos from API with PERSONALIZED FEED ALGORITHM
        async function loadVideos() {
            try {
                const response = await fetch('/api/videos');
                let allVideos = await response.json();

                console.log(`âœ… Loaded ${allVideos.length} videos from API`);

                // Personalize feed based on user's saved words (spaced repetition)
                videos = await getPersonalizedFeed(allVideos);

                console.log(`ðŸŽ¯ Personalized feed: ${videos.length} videos`);

                // ðŸš¨ EMERGENCY FIX: Filter out videos without transcripts (CEO AUDIT)
                const originalCount = videos.length;
                videos = videos.filter(v => {
                    return v.transcription &&
                           v.transcription.lines &&
                           v.transcription.lines.length > 0;
                });
                console.log(`âœ… Filtered to ${videos.length} videos with transcripts (hidden ${originalCount - videos.length} broken videos)`);

                // ðŸ—‘ï¸ Filter out permanently deleted videos from localStorage
                const deletedVideos = JSON.parse(localStorage.getItem('deletedVideos') || '[]');
                if (deletedVideos.length > 0) {
                    const beforeDeleteFilter = videos.length;
                    videos = videos.filter(v => !deletedVideos.includes(v.id));
                    console.log(`âœ… Filtered out ${beforeDeleteFilter - videos.length} deleted videos`);
                }

                // ðŸ”„ Filter out videos being retranscribed (hide until retranscription complete)
                const retranscribingVideos = JSON.parse(localStorage.getItem('retranscribingVideos') || '[]');
                if (retranscribingVideos.length > 0) {
                    const beforeRetranscribeFilter = videos.length;
                    videos = videos.filter(v => !retranscribingVideos.includes(v.id));
                    console.log(`âœ… Filtered out ${beforeRetranscribeFilter - videos.length} videos being retranscribed`);
                }

                // Hide loading
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }

                // Render first batch immediately
                renderVideosBatch(0, BATCH_SIZE);

                // Setup intersection observer for autoplay and infinite scroll
                setupIntersectionObserver();

            } catch (error) {
                console.error('âŒ Error loading videos:', error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.innerHTML =
                        '<div class="loading-text">âŒ Error loading videos. Please refresh.</div>';
                }
            }
        }

        // SMART VIDEO RECOMMENDATION ALGORITHM with spaced repetition + behavioral tracking
        async function getPersonalizedFeed(allVideos) {
            if (!Array.isArray(allVideos)) {
                allVideos = [];
            }

            const appOrigin = window.location.origin;
            const originHost = (() => {
                try {
                    const parsed = new URL(appOrigin);
                    return parsed.host;
                } catch (err) {
                    return null;
                }
            })();

            allVideos = allVideos
                .map((video, index) => {
                    const normalized = { ...video };
                    normalized.id = normalized.id || `video_${index}`;
                    normalized.level = normalized.level || normalized.cefr || 'A1';

                    const candidateUrls = [
                        normalized.videoUrl,
                        normalized.url,
                        normalized.path,
                        normalized.video_path,
                        normalized.streamUrl,
                        normalized.stream_url,
                        normalized.playbackUrl,
                        normalized.playback_url
                    ].filter(Boolean);

                    let videoUrl = candidateUrls.find(Boolean);

                    if (videoUrl) {
                        if (typeof videoUrl === 'string') {
                            videoUrl = videoUrl.replace(/\\/g, '/');

                            if (videoUrl.startsWith('http://localhost') || videoUrl.startsWith('https://localhost')) {
                                try {
                                    const parsed = new URL(videoUrl);
                                    videoUrl = parsed.pathname + parsed.search + parsed.hash;
                                } catch (err) {
                                    // leave as-is
                                }
                            } else if (originHost && videoUrl.startsWith('http')) {
                                try {
                                    const parsed = new URL(videoUrl);
                                    if (parsed.host === originHost) {
                                        videoUrl = parsed.pathname + parsed.search + parsed.hash;
                                    }
                                } catch (err) {
                                    // leave as-is
                                }
                            } else if (!videoUrl.startsWith('http')) {
                                if (!videoUrl.startsWith('/')) {
                                    videoUrl = `/videos/${videoUrl.replace(/^videos\//i, '')}`;
                                } else if (!videoUrl.startsWith('/videos/')) {
                                    videoUrl = `/videos${videoUrl}`;
                                }
                            }
                        }
                    }

                    normalized.videoUrl = videoUrl || null;
                    normalized.path = normalized.path || (typeof videoUrl === 'string' && !videoUrl.startsWith('http') ? videoUrl : normalized.path);
                    normalized.thumbnail = normalized.thumbnail || normalized.thumbnailUrl || normalized.previewImage || normalized.coverImage || null;

                    if (!normalized.title) {
                        normalized.title = normalized.name || normalized.spanish || 'Spanish Learning Video';
                    }

                    return normalized;
                })
                .filter(video => {
                    if (!video.videoUrl) {
                        console.warn('âš ï¸ Skipping video without playable URL', video);
                        return false;
                    }
                    return true;
                });

            console.log(`ðŸŽ¥ Normalized ${allVideos.length} videos with playable URLs`);

            // Get user's level from localStorage or user metadata
            let userLevel = localStorage.getItem('userLevel') || 'A1';

            if (currentUser && currentUser.user_metadata && currentUser.user_metadata.level) {
                userLevel = currentUser.user_metadata.level;
            }

            console.log(`ðŸ‘¤ User level: ${userLevel}`);

            // ðŸŽ¯ CRITICAL: Load persistent watch history from localStorage (for all users, even non-signed in)
            const persistentWatchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '[]');
            const persistentCompletedVideos = JSON.parse(localStorage.getItem('completedVideos') || '[]');
            const persistentSkippedVideos = JSON.parse(localStorage.getItem('skippedVideos') || '[]');

            console.log(`ðŸ“Š Persistent history: ${persistentWatchedVideos.length} watched, ${persistentCompletedVideos.length} completed, ${persistentSkippedVideos.length} skipped`);

            // Merge in-memory behavioral tracking with persistent localStorage
            const allWatchedIds = new Set([
                ...persistentWatchedVideos,
                ...persistentCompletedVideos,
                ...Object.keys(behaviorTracker.videoSessions)
            ]);

            const allCompletedIds = new Set([
                ...persistentCompletedVideos,
                ...behaviorTracker.completionPatterns.map(p => p.videoId)
            ]);

            const allSkippedIds = new Set([
                ...persistentSkippedVideos,
                ...behaviorTracker.skipPatterns.map(p => p.videoId)
            ]);

            // ðŸŽ¯ TIKTOK-STYLE FILTERING: Hide watched videos and frequently skipped ones
            if (allWatchedIds.size > 0 || allSkippedIds.size > 0 || allCompletedIds.size > 0) {
                const skippedVideoIds = allSkippedIds;
                const completedVideoIds = allCompletedIds;
                const watchedVideoIds = allWatchedIds;

                // Filter out watched videos (TikTok behavior - never show same video twice)
                allVideos = allVideos.filter(v => {
                    // Check if video was completed (watched >70%)
                    if (completedVideoIds.has(v.id)) {
                        return false; // Hide completely watched videos
                    }

                    // Check if video has significant watch time (>30% or >10s)
                    const session = behaviorTracker.videoSessions[v.id];
                    if (session && session.totalWatchTime > 10000) {
                        return false; // Hide videos with significant watch time
                    }

                    // Filter out frequently skipped videos (user doesn't like them)
                    const skipCount = behaviorTracker.skipPatterns.filter(p => p.videoId === v.id).length;
                    if (skipCount >= 2) {
                        return false; // If skipped 2+ times, hide it
                    }

                    return true; // Show only fresh, unwatched videos
                });

                console.log(`ðŸŽ¯ TikTok-style filtering: ${completedVideoIds.size} completed hidden, ${skippedVideoIds.size} skipped, ${allVideos.length} fresh videos remaining`);
            }

            // Define level hierarchy for filtering
            const levelOrder = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            const userLevelIndex = levelOrder.indexOf(userLevel);

            // Filter videos by user level: 70% at level, 20% easier, 10% harder
            const atLevelVideos = [];
            const easierVideos = [];
            const harderVideos = [];

            allVideos.forEach(video => {
                const videoLevel = video.level || 'A1';
                const videoLevelIndex = levelOrder.indexOf(videoLevel);

                if (videoLevelIndex === userLevelIndex) {
                    atLevelVideos.push(video);
                } else if (videoLevelIndex < userLevelIndex) {
                    easierVideos.push(video);
                } else {
                    harderVideos.push(video);
                }
            });

            console.log(`ðŸ“Š Video distribution - At level (${userLevel}): ${atLevelVideos.length}, Easier: ${easierVideos.length}, Harder: ${harderVideos.length}`);

            // Calculate target counts: 70% at level, 20% easier, 10% harder
            const totalVideos = allVideos.length;
            const targetAtLevel = Math.ceil(totalVideos * 0.7);
            const targetEasier = Math.ceil(totalVideos * 0.2);
            const targetHarder = totalVideos - targetAtLevel - targetEasier;

            // ðŸŽ¯ GENIUS DIFFICULTY SORTING: Sort by actual difficulty score (easiest first)
            // This ensures complete beginners see the EASIEST videos first
            const sortByDifficulty = (videos) => {
                return videos.sort((a, b) => {
                    const scoreA = a.difficulty?.difficultyScore || 50;
                    const scoreB = b.difficulty?.difficultyScore || 50;
                    return scoreA - scoreB; // Ascending (easiest first)
                });
            };

            // Sort each category by difficulty
            const sortedAtLevel = sortByDifficulty([...atLevelVideos]);
            const sortedEasier = sortByDifficulty([...easierVideos]);
            const sortedHarder = sortByDifficulty([...harderVideos]);

            // For COMPLETE BEGINNERS (A1): Show easiest videos first, NO shuffling
            if (userLevel === 'A1') {
                console.log('ðŸŽ“ BEGINNER MODE: Showing easiest videos first (no shuffling)');
                const selectedAtLevel = sortedAtLevel.slice(0, Math.min(targetAtLevel, sortedAtLevel.length));
                const selectedEasier = sortedEasier.slice(0, Math.min(targetEasier, sortedEasier.length));
                const selectedHarder = sortedHarder.slice(0, Math.min(targetHarder, sortedHarder.length));

                // Combine: easiest at-level first, then easier, then harder
                let personalizedFeed = [...selectedAtLevel, ...selectedEasier, ...selectedHarder];
                return personalizedFeed;
            }

            // For intermediate/advanced: Mix with some shuffling for variety
            const selectedAtLevel = shuffle(sortedAtLevel.slice(0, Math.ceil(atLevelVideos.length * 0.7)));
            const selectedEasier = shuffle(sortedEasier.slice(0, Math.ceil(easierVideos.length * 0.2)));
            const selectedHarder = shuffle(sortedHarder.slice(0, Math.ceil(harderVideos.length * 0.1)));

            // If not enough videos at user's level, backfill with others
            let personalizedFeed = [...selectedAtLevel, ...selectedEasier, ...selectedHarder];

            if (personalizedFeed.length < totalVideos) {
                const remaining = shuffle(allVideos.filter(v => !personalizedFeed.includes(v)));
                personalizedFeed = [...personalizedFeed, ...remaining].slice(0, totalVideos);
            }

            // NOW apply vocabulary-based personalization if user is logged in
            if (currentUser) {
                try {
                    // Get user's saved words from vocabulary
                    const { data: vocabulary, error } = await supabase
                        .from('vocabulary')
                        .select('word, created_at')
                        .eq('user_id', currentUser.id);

                    if (!error && vocabulary && vocabulary.length > 0) {
                        const learnedWords = vocabulary.map(v => v.word.toLowerCase());
                        console.log(`ðŸ“š User has ${learnedWords.length} saved words`);

                        // Separate level-appropriate videos by learned words
                        const reviewVideos = [];
                        const newVideos = [];

                        personalizedFeed.forEach(video => {
                            if (!video.transcription || !video.transcription.lines) {
                                newVideos.push(video);
                                return;
                            }

                            const hasLearnedWord = video.transcription.lines.some(line => {
                                if (!line.spanish) return false;
                                const words = line.spanish.toLowerCase().split(/\s+/);
                                return words.some(word => {
                                    const cleanWord = word.replace(/[Â¿Â¡.,!?]/g, '');
                                    return learnedWords.includes(cleanWord);
                                });
                            });

                            if (hasLearnedWord) {
                                reviewVideos.push(video);
                            } else {
                                newVideos.push(video);
                            }
                        });

                        console.log(`ðŸ”„ Review: ${reviewVideos.length}, ðŸ†• New: ${newVideos.length}`);

                        // Mix: 70% new vocabulary, 30% review (spaced repetition)
                        const numReview = Math.min(Math.ceil(personalizedFeed.length * 0.3), reviewVideos.length);
                        const numNew = personalizedFeed.length - numReview;

                        const selectedReview = shuffle(reviewVideos).slice(0, numReview);
                        const selectedNew = shuffle(newVideos).slice(0, numNew);

                        // Interleave: 2 new, 1 review pattern
                        personalizedFeed = [];
                        let newIndex = 0, reviewIndex = 0;

                        while (newIndex < selectedNew.length || reviewIndex < selectedReview.length) {
                            if (newIndex < selectedNew.length) personalizedFeed.push(selectedNew[newIndex++]);
                            if (newIndex < selectedNew.length) personalizedFeed.push(selectedNew[newIndex++]);
                            if (reviewIndex < selectedReview.length) personalizedFeed.push(selectedReview[reviewIndex++]);
                        }
                    }
                } catch (err) {
                    console.warn('Vocabulary personalization error:', err);
                }
            }

            console.log(`âœ¨ Personalized feed: ${personalizedFeed.length} videos (Level: ${userLevel}, Mix: at-level + easier + harder + vocabulary)`);
            return personalizedFeed;
        }

        // Shuffle array (Fisher-Yates algorithm)
        function shuffle(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Render videos in batches (performance optimization)
        function renderVideosBatch(startIndex, count) {
            const feedContainer = document.getElementById('feedContainer');

            if (!feedContainer) {
                console.error('âŒ feedContainer not found!');
                return;
            }

            const endIndex = Math.min(startIndex + count, videos.length);

            for (let i = startIndex; i < endIndex; i++) {
                const card = createVideoCard(videos[i], i);
                if (card) {
                    feedContainer.appendChild(card);
                }
            }

            loadedVideoCount = endIndex;
            console.log(`ðŸ“Š Loaded ${loadedVideoCount}/${videos.length} videos`);
        }

        // Create a single video card
        function createVideoCard(video, index) {
            if (!video || !video.videoUrl) {
                console.warn('âš ï¸ Attempted to render video without playable URL', video);
                return null;
            }

            const card = document.createElement('div');
            card.className = 'video-card';
            card.dataset.index = index;
            card.dataset.id = video.id;

            // ðŸŽ¬ LOADING SKELETON - TikTok/Instagram Style
            const loadingSkeleton = document.createElement('div');
            loadingSkeleton.className = 'video-loading-skeleton';
            loadingSkeleton.innerHTML = `
                <div class="skeleton-pulse"></div>
                <div class="skeleton-spinner">
                    <svg width="50" height="50" viewBox="0 0 50 50">
                        <circle cx="25" cy="25" r="20" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
                        <circle cx="25" cy="25" r="20" fill="none" stroke="#fff" stroke-width="3" 
                                stroke-dasharray="125" stroke-dashoffset="125" class="spinner-circle"/>
                    </svg>
                </div>
                <div class="skeleton-text">Loading...</div>
            `;
            card.appendChild(loadingSkeleton);

            // Video element
            const videoEl = document.createElement('video');
            videoEl.src = video.videoUrl;
            videoEl.loop = false;
            videoEl.muted = false; // Start unmuted (will be managed by user interaction)
            videoEl.playsinline = true;
            videoEl.autoplay = false; // Changed to false - we'll control autoplay manually
            videoEl.preload = 'none'; // Start with no preload

            // ðŸŽ¯ SMART PRELOAD STRATEGY - Instagram/TikTok Style
            // Preload aggressively for first 5 videos, then load on demand
            if (index < 5) {
                videoEl.preload = 'auto'; // Fully preload first 5 videos
                setTimeout(() => {
                    videoEl.load(); // Force load
                }, index * 100); // Stagger loading to prevent network congestion
            } else if (index < 10) {
                videoEl.preload = 'metadata'; // Load metadata for next 5
            }

            // Apply saved playback speed - read directly from localStorage to ensure freshness
            const savedSpeed = parseFloat(localStorage.getItem('playbackSpeed') || '1');
            videoEl.playbackRate = savedSpeed;
            console.log(`ðŸŽ¬ Video #${index} created with speed ${savedSpeed}x (from localStorage)`);

            // ðŸŽ¯ VIDEO LOADING EVENT HANDLERS - TikTok/Instagram Style
            let isVideoReady = false;

            // Show loading skeleton until video is ready
            videoEl.addEventListener('loadstart', () => {
                loadingSkeleton.style.display = 'flex';
                console.log(`ðŸ“¥ Video #${index} loading started`);
            });

            // When metadata is loaded
            videoEl.addEventListener('loadedmetadata', () => {
                console.log(`ðŸ“Š Video #${index} metadata loaded - Duration: ${videoEl.duration}s`);
            });

            // When video can start playing
            videoEl.addEventListener('loadeddata', () => {
                console.log(`âœ… Video #${index} data loaded - ready to play`);
            });

            // When video can play through without buffering
            videoEl.addEventListener('canplaythrough', () => {
                if (!isVideoReady) {
                    isVideoReady = true;
                    // Hide loading skeleton with smooth fade
                    loadingSkeleton.style.opacity = '0';
                    setTimeout(() => {
                        loadingSkeleton.style.display = 'none';
                    }, 300);
                    console.log(`ðŸŽ¬ Video #${index} ready to play (can play through)`);
                    
                    // Auto-play if this is the current video in view
                    const feedContainer = document.getElementById('feedContainer');
                    if (feedContainer) {
                        const cardTop = card.offsetTop;
                        const scrollTop = feedContainer.scrollTop;
                        const isInView = Math.abs(cardTop - scrollTop) < 100;
                        if (isInView) {
                            videoEl.play().catch(err => console.warn('Autoplay failed:', err));
                        }
                    }
                }
            });

            // Show buffering indicator when waiting for data
            videoEl.addEventListener('waiting', () => {
                loadingSkeleton.style.display = 'flex';
                loadingSkeleton.querySelector('.skeleton-text').textContent = 'Buffering...';
                console.log(`â³ Video #${index} buffering...`);
            });

            // Hide buffering when playing resumes
            videoEl.addEventListener('playing', () => {
                loadingSkeleton.style.display = 'none';
                console.log(`â–¶ï¸ Video #${index} playing`);
            });

            // Error handling with retry logic
            let retryCount = 0;
            const maxRetries = 3;
            videoEl.addEventListener('error', (e) => {
                console.error(`âŒ Video #${index} error:`, e, videoEl.error);
                
                if (retryCount < maxRetries) {
                    retryCount++;
                    loadingSkeleton.querySelector('.skeleton-text').textContent = `Retrying... (${retryCount}/${maxRetries})`;
                    console.log(`ðŸ”„ Retrying video #${index} (attempt ${retryCount})`);
                    setTimeout(() => {
                        videoEl.load();
                        videoEl.play().catch(err => console.warn('Retry play failed:', err));
                    }, 1000 * retryCount); // Exponential backoff
                } else {
                    loadingSkeleton.innerHTML = `
                        <div style="text-align: center; color: rgba(255,255,255,0.8);">
                            <div style="font-size: 40px; margin-bottom: 10px;">âš ï¸</div>
                            <div style="font-size: 16px; font-weight: 600;">Video unavailable</div>
                            <div style="font-size: 13px; opacity: 0.7; margin-top: 5px;">Swipe to next video</div>
                        </div>
                    `;
                    console.error(`ðŸ’¥ Video #${index} failed after ${maxRetries} retries`);
                }
            });

            // Track when video is paused
            videoEl.addEventListener('pause', () => {
                console.log(`â¸ï¸ Video #${index} paused`);
            });

            // Auto-advance to next video OR x2 mode (TikTok behavior)
            videoEl.addEventListener('ended', () => {
                // Track video completion
                trackVideoWatched(video.id);

                // Check if x2 mode is enabled for this video
                const x2Btn = card.querySelector('.x2-btn');
                const isX2Active = x2Btn && x2Btn.classList.contains('x2-active');
                const x2FirstPlay = x2Btn && x2Btn.dataset.firstPlayDone !== 'true';

                if (isX2Active && x2FirstPlay) {
                    // First playthrough done - now play again with transcript only
                    x2Btn.dataset.firstPlayDone = 'true';
                    x2Btn.querySelector('.x2-status').textContent = '2nd';

                    // Hide subtitles overlay, keep transcript
                    const subtitlesOverlay = card.querySelector('.subtitles-overlay');
                    if (subtitlesOverlay) {
                        subtitlesOverlay.style.display = 'none';
                    }

                    // Restart video
                    videoEl.currentTime = 0;
                    videoEl.play();
                    console.log('ðŸ” x2 mode: Second playthrough (transcript only)');
                } else if (isX2Active && !x2FirstPlay) {
                    // Second playthrough done - reset and advance
                    x2Btn.classList.remove('x2-active');
                    x2Btn.dataset.firstPlayDone = 'false';
                    x2Btn.querySelector('.x2-status').textContent = 'Off';
                    x2Btn.style.background = '';

                    // Show subtitles again for next video
                    const subtitlesOverlay = card.querySelector('.subtitles-overlay');
                    if (subtitlesOverlay) {
                        subtitlesOverlay.style.display = '';
                    }

                    // Auto-advance to next video
                    const nextCard = card.nextElementSibling;
                    if (nextCard && nextCard.classList.contains('video-card')) {
                        nextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else if (loadedVideoCount < videos.length) {
                        renderVideosBatch(loadedVideoCount, BATCH_SIZE);
                        setTimeout(() => {
                            const newNextCard = card.nextElementSibling;
                            if (newNextCard) {
                                newNextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 100);
                    }
                }
            });

            // Transcription overlay (clean, no speed control - moved to global button)
            const transcriptionOverlay = document.createElement('div');
            transcriptionOverlay.className = 'transcription-overlay';
            transcriptionOverlay.innerHTML = `
                <div class="subtitle-container">
                    <div class="spanish-line"></div>
                    <div class="english-line"></div>
                </div>
            `;

            // Video info with GENIUS difficulty badge
            const videoInfo = document.createElement('div');
            videoInfo.className = 'video-info';

            // Get difficulty data
            const difficultyScore = video.difficulty?.difficultyScore || 50;
            const cefrLevel = video.difficulty?.cefrLevel || video.level;

            // CEFR level colors (matching Duolingo/Memrise 2025)
            const levelColors = {
                'A1': { bg: '#58cc02', text: '#000', label: 'Beginner' },
                'A2': { bg: '#00cd9c', text: '#000', label: 'Elementary' },
                'B1': { bg: '#0095f6', text: '#fff', label: 'Intermediate' },
                'B2': { bg: '#667eea', text: '#fff', label: 'Upper-Int' },
                'C1': { bg: '#764ba2', text: '#fff', label: 'Advanced' },
                'C2': { bg: '#ff3b5c', text: '#fff', label: 'Mastery' }
            };

            const levelStyle = levelColors[cefrLevel] || levelColors['B1'];

            // Subtle, minimal badge - top-left position
            videoInfo.innerHTML = `
                <div class="difficulty-badge" style="
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    color: rgba(255, 255, 255, 0.95);
                    padding: 6px 12px;
                    border-radius: 12px;
                    font-size: 13px;
                    font-weight: 600;
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                ">
                    <span style="font-size: 13px; opacity: 0.9;">${cefrLevel}</span>
                </div>
            `;

            // Speed Control
            const speedControl = document.createElement('div');
            speedControl.className = 'speed-control';
            speedControl.innerHTML = `
                <button class="speed-btn" onclick="event.stopPropagation(); toggleSpeedMenu(this.closest('.video-card'))">
                    ${currentPlaybackSpeed}x
                </button>
                <div class="speed-menu">
                    <div class="speed-option ${currentPlaybackSpeed === 0.5 ? 'active' : ''}" onclick="event.stopPropagation(); changeSpeed(0.5)">0.5x</div>
                    <div class="speed-option ${currentPlaybackSpeed === 0.75 ? 'active' : ''}" onclick="event.stopPropagation(); changeSpeed(0.75)">0.75x</div>
                    <div class="speed-option ${currentPlaybackSpeed === 1 ? 'active' : ''}" onclick="event.stopPropagation(); changeSpeed(1)">1x</div>
                    <div class="speed-option ${currentPlaybackSpeed === 1.25 ? 'active' : ''}" onclick="event.stopPropagation(); changeSpeed(1.25)">1.25x</div>
                    <div class="speed-option ${currentPlaybackSpeed === 1.5 ? 'active' : ''}" onclick="event.stopPropagation(); changeSpeed(1.5)">1.5x</div>
                </div>
            `;

            // Sidebar buttons - REORDERED: x2 (top), speed, like, comment, delete (bottom)
            const sidebar = document.createElement('div');
            sidebar.className = 'sidebar';
            // TIKTOK-STYLE SIDEBAR - Only level feedback (minimal, clean)
            sidebar.innerHTML = `
                <!-- ðŸŽ¯ LEVEL DETECTION: Difficulty Feedback -->
                <button class="sidebar-button too-easy-btn" onclick="event.stopPropagation(); markVideoEasy('${video.id}', '${cefrLevel}', ${difficultyScore}, this);" title="This is too easy - Show me harder content" aria-label="Too Easy">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                    <span class="sidebar-count" style="font-size: 11px; font-weight: 700;">Too Easy</span>
                </button>

                <button class="sidebar-button too-hard-btn" onclick="event.stopPropagation(); markVideoHard('${video.id}', '${cefrLevel}', ${difficultyScore}, this);" title="This is too hard - Show me easier content" aria-label="Too Hard">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M12 5v14M19 12l-7 7-7-7"/>
                    </svg>
                    <span class="sidebar-count" style="font-size: 11px; font-weight: 700;">Too Hard</span>
                </button>

                <!-- More Options (Delete, Report) -->
                <button class="sidebar-button more-btn" onclick="event.stopPropagation(); showVideoOptions('${video.id}', '${video.videoUrl}', this);" title="More options" aria-label="More">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1" fill="currentColor"/>
                        <circle cx="12" cy="5" r="1" fill="currentColor"/>
                        <circle cx="12" cy="19" r="1" fill="currentColor"/>
                    </svg>
                    <span class="sidebar-count" style="font-size: 10px;">More</span>
                </button>
            `;

            // PLAYBACK CONTROLS - Bottom-left near subtitles (TikTok pattern)
            const playbackControls = document.createElement('div');
            playbackControls.className = 'playback-controls';
            playbackControls.innerHTML = `
                <button class="playback-btn x2-btn" onclick="event.stopPropagation(); toggleX2Mode(this);" title="Watch twice" aria-label="x2 mode">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <text x="6" y="18" font-size="12" fill="currentColor" stroke="none" font-weight="bold">x2</text>
                        <circle cx="12" cy="12" r="10" stroke-width="2"/>
                    </svg>
                    <span class="playback-status x2-status">Off</span>
                </button>
                <button class="playback-btn speed-btn" onclick="event.stopPropagation(); cycleSpeed();" title="Speed control" aria-label="Playback speed">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polygon points="10 8 16 12 10 16 10 8"/>
                    </svg>
                    <span class="playback-status speed-display">${currentPlaybackSpeed}x</span>
                </button>
                <button class="playback-btn translate-btn" onclick="event.stopPropagation(); toggleTranslation(this);" title="Toggle translation" aria-label="Translation">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 8h6m-2 0v10M6 18h8M15 8h.01M17 12h.01M21 16h.01"/>
                        <path d="m13 16 2-2 2 2"/>
                        <path d="M11 8l2 2 2-2"/>
                    </svg>
                    <span class="playback-status translate-status">EN</span>
                </button>
            `;

            // Admin delete button - TOP-LEFT corner (separate from sidebar)
            let adminDeleteBtn = null;
            if (currentUser?.role === 'admin') {
                adminDeleteBtn = document.createElement('button');
                adminDeleteBtn.className = 'admin-delete-btn';
                adminDeleteBtn.setAttribute('aria-label', 'Delete Video');
                adminDeleteBtn.dataset.videoId = video.id;
                adminDeleteBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                `;
            }

            // Progress bar
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';

            // Pause indicator - PROFESSIONAL SVG (NOT EMOJI)
            const pauseIndicator = document.createElement('div');
            pauseIndicator.className = 'pause-indicator';
            pauseIndicator.innerHTML = `
                <svg viewBox="0 0 24 24">
                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                </svg>
            `;
            pauseIndicator.dataset.state = 'pause';

            // Assemble card
            card.appendChild(videoEl);
            card.appendChild(transcriptionOverlay);
            card.appendChild(videoInfo);
            card.appendChild(playbackControls); // NEW: Playback controls bottom-left
            card.appendChild(sidebar);
            card.appendChild(progressBar);
            card.appendChild(pauseIndicator);
            if (adminDeleteBtn) {
                card.appendChild(adminDeleteBtn);
            }

            // Setup interactions
            setupTouchInteractions(card, videoEl, video);
            setupTranscriptions(videoEl, video.transcription, transcriptionOverlay);
            setupSidebarActions(sidebar, video, adminDeleteBtn);
            setupVideoProgress(videoEl, progressBar);

            return card;
        }

        // Setup touch interactions (TikTok pattern)
        // Single tap = pause/play, Double tap = like
        function setupTouchInteractions(card, videoEl, videoData) {
            let tapCount = 0;
            let tapTimer = null;
            const pauseIndicator = card.querySelector('.pause-indicator');
            const likeBtn = card.querySelector('.like-btn');

            card.addEventListener('click', (e) => {
                // Ignore clicks on buttons and words
                if (e.target.closest('.sidebar-button') ||
                    e.target.closest('.word') ||
                    e.target.closest('.nav-item')) {
                    return;
                }

                tapCount++;

                if (tapCount === 1) {
                    // Wait to see if it's a double tap
                    tapTimer = setTimeout(() => {
                        // Single tap - pause/play with professional SVG
                        if (videoEl.paused) {
                            videoEl.play();
                            // Play icon SVG
                            pauseIndicator.innerHTML = `
                                <svg viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            `;
                        } else {
                            videoEl.pause();
                            // Pause icon SVG
                            pauseIndicator.innerHTML = `
                                <svg viewBox="0 0 24 24">
                                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                                </svg>
                            `;
                        }

                        // Show pause indicator with smooth animation
                        pauseIndicator.classList.add('show');
                        setTimeout(() => pauseIndicator.classList.remove('show'), 600);

                        tapCount = 0;
                    }, 300);
                } else if (tapCount === 2) {
                    // Double tap - like
                    clearTimeout(tapTimer);

                    // Show double-tap heart animation
                    const heart = document.createElement('div');
                    heart.className = 'double-tap-heart';
                    heart.textContent = 'â¤ï¸';
                    card.appendChild(heart);

                    // Remove heart after animation
                    setTimeout(() => heart.remove(), 800);

                    // Toggle like button
                    likeBtn.classList.add('liked');

                    tapCount = 0;
                }
            });
        }

        // Setup synchronized transcriptions with video.currentTime
        function setupTranscriptions(videoEl, transcription, overlay) {
            if (!transcription || !transcription.lines || transcription.lines.length === 0) {
                console.warn('No transcription data available');
                return;
            }

            const spanishLine = overlay.querySelector('.spanish-line');
            const englishLine = overlay.querySelector('.english-line');
            let currentLineIndex = -1;

            videoEl.addEventListener('timeupdate', () => {
                const currentTime = videoEl.currentTime;

                // Find active transcription line - FIXED: proper timing comparison
                const activeLineIndex = transcription.lines.findIndex(line => {
                    const start = parseFloat(line.startTime);
                    const end = parseFloat(line.endTime);

                    // Validate timing values
                    if (isNaN(start) || isNaN(end)) {
                        console.warn('Invalid timing:', line);
                        return false;
                    }

                    // CRITICAL FIX: Use >= for start and <= for end (inclusive range)
                    return currentTime >= start && currentTime <= end;
                });

                // Only update DOM when line changes (prevents flashing)
                if (activeLineIndex !== currentLineIndex) {
                    currentLineIndex = activeLineIndex;

                    if (activeLineIndex >= 0) {
                        const activeLine = transcription.lines[activeLineIndex];
                        const subtitleContainer = overlay.querySelector('.subtitle-container');

                        // Debug logging
                        if (window.DEBUG_SUBTITLES) {
                            console.log(`[${currentTime.toFixed(2)}s] Showing subtitle:`, activeLine.spanish);
                        }

                        // Make Spanish words clickable
                        const words = (activeLine.spanish || '').split(' ');
                        spanishLine.innerHTML = words.map((word, i) =>
                            `<span class="word" data-word="${word}" data-english="${activeLine.english || ''}">${word}</span>`
                        ).join(' ');

                        // Set English translation
                        englishLine.textContent = activeLine.english || '';

                        // Show BOTH Spanish and English by default
                        subtitleContainer.className = 'subtitle-container';

                        // Show overlay
                        overlay.classList.add('active');

                        // Add click handlers to words
                        spanishLine.querySelectorAll('.word').forEach(wordEl => {
                            wordEl.addEventListener('click', (e) => {
                                e.stopPropagation();
                                // Show translation tooltip when word is clicked
                                showWordTranslation(wordEl, activeLine.spanish, videoEl);
                            });
                        });
                    } else {
                        // Hide overlay when no active line
                        overlay.classList.remove('active');
                    }
                }
            });
        }

        // Show word translation tooltip WITHOUT requiring sign-in
        // Only require sign-in when user wants to SAVE the word
        async function showWordTranslation(wordEl, contextSentence, videoEl) {
            const tooltip = document.getElementById('wordTooltip');
            const word = wordEl.dataset.word.replace(/[Â¿Â¡.,!?]/g, '');
            const englishSentence = wordEl.dataset.english;

            // CRITICAL FIX: Pause the video when user clicks a word
            if (videoEl && !videoEl.paused) {
                videoEl.pause();
                console.log('ðŸ”‡ Video paused for word translation');
            }

            // Position tooltip ABOVE word (centered horizontally, 80px above)
            const rect = wordEl.getBoundingClientRect();
            const tooltipHeight = 120; // Approximate tooltip height
            const topPosition = rect.top - tooltipHeight;

            // Ensure tooltip stays on screen
            const finalTop = Math.max(10, topPosition); // At least 10px from top

            tooltip.style.left = `${rect.left + (rect.width / 2)}px`;
            tooltip.style.top = `${finalTop}px`;
            tooltip.style.transform = 'translateX(-50%)';

            // CRITICAL FIX: Get translation from API (ALWAYS works)
            const translation = await getWordTranslationAPI(word);

            // Update tooltip content
            tooltip.querySelector('.word-spanish').textContent = word;
            tooltip.querySelector('.word-english').textContent = translation;

            // Show tooltip with "Save" button
            tooltip.classList.add('show');

            // Add click handler to save button (requires sign-in)
            const saveBtn = tooltip.querySelector('.save-word-btn');
            if (saveBtn) {
                saveBtn.onclick = () => {
                    if (!currentUser) {
                        // Prompt to sign in when trying to SAVE
                        document.getElementById('authModal').classList.add('show');
                        tooltip.classList.remove('show');
                    } else {
                        // Save word if logged in - change icon to filled bookmark
                        saveWordToVocabulary(word, translation, contextSentence);
                        saveBtn.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                            </svg>
                        `;
                        saveBtn.disabled = true;
                        saveBtn.style.color = '#4CAF50';

                        // Track word clicked and update counter
                        trackWordClicked(word);
                    }
                };
            }

            // Track word clicked (even without saving)
            trackWordClicked(word);

            // Hide after 3 seconds
            setTimeout(() => tooltip.classList.remove('show'), 3000);
        }

        // CRITICAL FIX: Get word translation from API (ALWAYS returns valid translation)
        async function getWordTranslationAPI(word) {
            // Check cache first for performance
            if (WORDS_CACHE.has(word)) {
                return WORDS_CACHE.get(word);
            }

            try {
                const response = await fetch('/api/translate/word', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ word, sourceLang: 'es', targetLang: 'en' })
                });

                const data = await response.json();

                if (data.success && data.translation) {
                    // Cache the translation
                    WORDS_CACHE.set(word, data.translation);
                    console.log(`âœ… Translated "${word}" â†’ "${data.translation}" (${data.source || 'API'})`);
                    return data.translation;
                } else {
                    console.warn(`âš ï¸ Translation failed for "${word}", using fallback`);
                    return word; // Fallback to original word
                }
            } catch (error) {
                console.error(`âŒ Translation API error for "${word}":`, error);
                // Fallback to heuristic if API fails
                return getWordTranslationHeuristic(word);
            }
        }

        // Get word translation (heuristic fallback - kept for offline mode)
        function getWordTranslationHeuristic(word, englishSentence = '') {
            if (WORDS_CACHE.has(word)) {
                return WORDS_CACHE.get(word);
            }

            // Enhanced translation extraction with better heuristics
            let translation = word; // fallback to original word

            if (englishSentence) {
                // Method 1: Try to find word by position alignment
                // Split both Spanish and English sentences and try to match by position
                const englishWords = englishSentence.split(' ').filter(w => w.length > 0);

                // Method 2: Common Spanish-English word mappings
                const commonTranslations = {
                    'hola': 'hello', 'adiÃ³s': 'goodbye', 'gracias': 'thanks', 'por favor': 'please',
                    'sÃ­': 'yes', 'no': 'no', 'agua': 'water', 'comida': 'food', 'casa': 'house',
                    'dÃ­a': 'day', 'noche': 'night', 'buenos': 'good', 'dÃ­as': 'days', 'noches': 'nights',
                    'estÃ¡': 'is', 'estoy': 'am', 'muy': 'very', 'bien': 'well', 'mal': 'bad',
                    'grande': 'big', 'pequeÃ±o': 'small', 'nuevo': 'new', 'viejo': 'old',
                    'mucho': 'much', 'poco': 'little', 'mÃ¡s': 'more', 'menos': 'less',
                    'quiero': 'want', 'tengo': 'have', 'puedo': 'can', 'necesito': 'need',
                    'donde': 'where', 'cuando': 'when', 'como': 'how', 'que': 'what', 'quien': 'who',
                    'tiempo': 'time', 'persona': 'person', 'vida': 'life', 'mundo': 'world',
                    'hacer': 'do', 'decir': 'say', 'ir': 'go', 'ver': 'see', 'dar': 'give',
                    'poder': 'can', 'saber': 'know', 'querer': 'want', 'llegar': 'arrive',
                    'pensar': 'think', 'creer': 'believe', 'hablar': 'speak', 'encontrar': 'find'
                };

                const wordLower = word.toLowerCase();

                // Check common translations first
                if (commonTranslations[wordLower]) {
                    translation = commonTranslations[wordLower];
                }
                // Try to find similar word in English sentence
                else if (englishWords.length > 0) {
                    // Method 3: Find word with matching first 3 letters (improved)
                    const matchingWord = englishWords.find(w => {
                        const wLower = w.toLowerCase().replace(/[.,!?;:]/g, '');
                        const wordPrefix = wordLower.substring(0, Math.min(4, wordLower.length));
                        return wLower.startsWith(wordPrefix) || wLower.includes(wordPrefix);
                    });

                    if (matchingWord) {
                        translation = matchingWord.replace(/[.,!?;:]/g, '');
                    }
                    // Method 4: If no match, return first content word from English sentence
                    else {
                        const contentWords = englishWords.filter(w =>
                            w.length > 3 &&
                            !['the', 'and', 'for', 'with', 'this', 'that', 'from', 'have', 'been'].includes(w.toLowerCase())
                        );
                        if (contentWords.length > 0) {
                            translation = contentWords[0].replace(/[.,!?;:]/g, '');
                        }
                    }
                }
            }

            // Add console log for debugging
            console.log(`ðŸ”¤ Translation: "${word}" â†’ "${translation}"`);

            WORDS_CACHE.set(word, translation);
            return translation;
        }

        // Setup sidebar actions (like, comment, share only)
        function setupSidebarActions(sidebar, video, adminDeleteBtn) {
            const likeBtn = sidebar.querySelector('.like-btn');
            const commentBtn = sidebar.querySelector('.comment-btn');
            const shareBtn = sidebar.querySelector('.share-btn');

            // Like button
            if (likeBtn) {
                likeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    likeBtn.classList.toggle('liked');

                    // Update like count
                    const countEl = likeBtn.querySelector('.sidebar-count');
                    const currentCount = parseInt(countEl.textContent.replace(/[KM]/g, '')) || 0;
                    const isLiked = likeBtn.classList.contains('liked');
                    const newCount = isLiked ? currentCount + 1 : Math.max(0, currentCount - 1);
                    countEl.textContent = formatCount(newCount);

                    // Track analytics
                    trackVideoInteraction(video.id, 'like', isLiked);
                });
            }

            // Comment button - hide for now (feature in development)
            if (commentBtn) {
                commentBtn.style.opacity = '0.3';
                commentBtn.style.pointerEvents = 'none';
            }

            // Share button
            if (shareBtn) {
                shareBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (navigator.share) {
                        navigator.share({
                            title: video.title,
                            text: `Learn Spanish: ${video.title}`,
                            url: window.location.href
                        });
                    } else {
                        // Fallback: copy to clipboard
                        navigator.clipboard.writeText(window.location.href);
                        alert('Link copied to clipboard! ðŸ“‹');
                    }
                    trackVideoInteraction(video.id, 'share', true);
                });
            }

            // Admin delete button (top-left corner)
            if (adminDeleteBtn) {
                adminDeleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();

                    if (confirm('Delete this video? This cannot be undone.')) {
                        try {
                            const response = await fetch(`/api/videos/${video.id}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${currentUser.token}`
                                }
                            });

                            if (response.ok) {
                                // Remove video card from DOM
                                const card = e.target.closest('.video-card');
                                card.remove();
                                alert('Video deleted successfully âœ…');
                            } else {
                                alert('Failed to delete video âŒ');
                            }
                        } catch (error) {
                            console.error('Delete error:', error);
                            alert('Error deleting video âŒ');
                        }
                    }
                });
            }
        }

        // Setup video progress bar
        function setupVideoProgress(videoEl, progressBar) {
            videoEl.addEventListener('timeupdate', () => {
                const progress = (videoEl.currentTime / videoEl.duration) * 100;
                progressBar.style.width = progress + '%';
            });
        }

        // Format numbers (1.2K, 3.4M)
        function formatCount(count) {
            if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
            if (count >= 1000) return (count / 1000).toFixed(1) + 'K';
            return count;
        }

        // Intersection Observer for autoplay + infinite scroll
        // Threshold 0.5 = 50%+ visible (TikTok/YouTube Shorts pattern)
        function setupIntersectionObserver() {
            const options = {
                root: null,
                threshold: [0, 0.5, 1] // Multiple thresholds for better detection
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target.querySelector('video');
                    if (!video) return;

                    const cardIndex = parseInt(entry.target.dataset.index);
                    const videoData = videos[cardIndex];

                    if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
                        // ðŸŽ¯ Track video start
                        if (videoData && videoData.id) {
                            trackVideoStart(videoData.id, videoData);
                        }

                        // CRITICAL FIX: Ensure video is fully loaded before playing
                        if (video.readyState < 3) { // 3 = HAVE_FUTURE_DATA
                            video.preload = 'auto';

                            // Wait for video to be ready before playing
                            video.addEventListener('loadeddata', () => {
                                if (entry.isIntersecting) {
                                    video.play().catch(e => {
                                        console.log('Autoplay prevented:', e);
                                        video.muted = true;
                                        video.play();
                                    });
                                }
                            }, { once: true });
                        } else {
                            // Video already loaded, play immediately
                            video.play().catch(e => {
                                console.log('Autoplay prevented:', e);
                                video.muted = true;
                                video.play();
                            });
                        }

                        // Preload next 2-3 videos for smooth scrolling (prevents black screen)
                        preloadNextVideos(entry.target, 3);

                        // Check if we need to load more videos (infinite scroll)
                        if (cardIndex >= loadedVideoCount - 5 && loadedVideoCount < videos.length) {
                            renderVideosBatch(loadedVideoCount, BATCH_SIZE);
                        }
                    } else {
                        // ðŸŽ¯ Track video stop before pausing
                        if (videoData && videoData.id && video.duration) {
                            trackVideoStop(videoData.id, video.duration, video.currentTime);
                        }

                        // Pause video when not visible
                        video.pause();
                    }
                });
            }, options);

            // Observe all video cards
            const observeVideos = () => {
                document.querySelectorAll('.video-card').forEach(card => {
                    observer.observe(card);
                });
            };

            observeVideos();

            // Re-observe when new videos are added
            const feedContainer = document.getElementById('feedContainer');
            const mutationObserver = new MutationObserver(observeVideos);
            mutationObserver.observe(feedContainer, { childList: true });
        }

        // ðŸŽ¯ TIKTOK-STYLE BEHAVIORAL TRACKING FUNCTIONS

        // Track when video starts playing
        function trackVideoStart(videoId, videoData) {
            behaviorTracker.lastVideoId = videoId;
            behaviorTracker.lastVideoStartTime = Date.now();

            // Initialize session tracking for this video
            if (!behaviorTracker.videoSessions[videoId]) {
                behaviorTracker.videoSessions[videoId] = {
                    totalWatchTime: 0,
                    viewCount: 0,
                    lastViewStart: Date.now(),
                    completed: false,
                    skipped: false,
                    level: videoData.level,
                    difficulty: videoData.difficulty?.difficultyScore || 50
                };
            } else {
                behaviorTracker.videoSessions[videoId].lastViewStart = Date.now();
            }

            behaviorTracker.videoSessions[videoId].viewCount++;

            // ðŸŽ¯ CRITICAL: Immediately save to localStorage so it persists across refreshes
            const watchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '[]');
            if (!watchedVideos.includes(videoId)) {
                watchedVideos.push(videoId);
                localStorage.setItem('watchedVideos', JSON.stringify(watchedVideos));
                console.log(`âœ… Saved ${videoId} to persistent watched list (${watchedVideos.length} total)`);
            }
        }

        // Track when video stops/pauses (skip or completion)
        function trackVideoStop(videoId, videoDuration, currentTime) {
            const session = behaviorTracker.videoSessions[videoId];
            if (!session || !session.lastViewStart) return;

            // Calculate watch time for this session
            const watchTime = Date.now() - session.lastViewStart;
            session.totalWatchTime += watchTime;

            // Calculate completion percentage
            const completionPercent = (currentTime / videoDuration) * 100;

            // Skip detection: < 30% watched = skip
            if (completionPercent < 30 && !session.skipped) {
                session.skipped = true;
                behaviorTracker.skipPatterns.push({
                    videoId,
                    level: session.level,
                    difficulty: session.difficulty,
                    watchTime,
                    completionPercent,
                    timestamp: Date.now()
                });
                console.log(`â­ï¸ Video skipped: ${videoId} (${completionPercent.toFixed(1)}% watched)`);
            }

            // Completion detection: > 70% watched = completed
            if (completionPercent > 70 && !session.completed) {
                session.completed = true;
                behaviorTracker.completionPatterns.push({
                    videoId,
                    level: session.level,
                    difficulty: session.difficulty,
                    watchTime: session.totalWatchTime,
                    completionPercent,
                    timestamp: Date.now()
                });
                console.log(`âœ… Video completed: ${videoId} (${completionPercent.toFixed(1)}% watched)`);

                // Level signal: Completing videos indicates comfort at that level
                trackLevelSignal(session.level, session.difficulty, 'completion');
            }

            // Save behavioral data
            saveBehaviorData();
        }

        // Track level signals from user behavior
        function trackLevelSignal(level, difficulty, signalType) {
            behaviorTracker.levelSignals.push({
                level,
                difficulty,
                signalType, // 'completion', 'skip', 'word_click', 'word_save'
                timestamp: Date.now()
            });

            // Update interests
            if (!behaviorTracker.interests[level]) {
                behaviorTracker.interests[level] = {
                    completions: 0,
                    skips: 0,
                    engagementScore: 0
                };
            }

            if (signalType === 'completion') {
                behaviorTracker.interests[level].completions++;
                behaviorTracker.interests[level].engagementScore += 10;
            } else if (signalType === 'skip') {
                behaviorTracker.interests[level].skips++;
                behaviorTracker.interests[level].engagementScore -= 5;
            }

            // Dynamically adjust user level based on recent behavior
            updateDynamicUserLevel();
        }

        // ðŸŽ¯ GENIUS MULTI-SIGNAL LEVEL DETECTION ALGORITHM
        // Weighs ALL signals: assessment, hard/easy buttons, completions, skips, word interactions
        function updateGeniusLevelDetection() {
            const levelOrder = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            const currentLevel = localStorage.getItem('userLevel') || 'A1';
            const currentLevelIndex = levelOrder.indexOf(currentLevel);

            // ðŸŽ¯ SIGNAL WEIGHTS (higher = more important)
            const weights = {
                marked_hard: 50,      // User explicitly says "too hard" - STRONGEST signal
                marked_easy: 50,      // User explicitly says "too easy" - STRONGEST signal
                assessment: 30,       // Initial assessment test - HIGH weight but fades
                completion: 15,       // Completed video - MODERATE signal
                skip: 10,             // Skipped video - MODERATE signal
                word_save: 8,         // Saved word - MODERATE-LOW signal
                word_click: 3         // Clicked word - WEAK signal
            };

            // Get recent signals (last 30, with decay for older ones)
            const recentSignals = behaviorTracker.levelSignals.slice(-30);

            if (recentSignals.length < 5) {
                console.log('ðŸ“Š Not enough data for level adjustment (need 5+ signals)');
                return; // Need at least 5 signals
            }

            // Calculate weighted votes for each level
            const levelVotes = {};
            levelOrder.forEach(level => {
                levelVotes[level] = { promote: 0, demote: 0, neutral: 0 };
            });

            recentSignals.forEach((signal, index) => {
                const level = signal.level;
                const levelIndex = levelOrder.indexOf(level);
                const signalType = signal.signalType;
                const weight = weights[signalType] || 1;

                // Time decay: recent signals matter more (last 10 at full weight)
                const decay = index >= recentSignals.length - 10 ? 1 : 0.5;
                const adjustedWeight = weight * decay;

                // Interpret signal direction
                if (signalType === 'marked_easy') {
                    // Video at this level is too easy â†’ promote user ABOVE this level
                    levelOrder.forEach((targetLevel, targetIndex) => {
                        if (targetIndex > levelIndex) {
                            levelVotes[targetLevel].promote += adjustedWeight;
                        } else if (targetIndex === levelIndex) {
                            levelVotes[targetLevel].demote += adjustedWeight / 2;
                        }
                    });
                } else if (signalType === 'marked_hard') {
                    // Video at this level is too hard â†’ demote user BELOW this level
                    levelOrder.forEach((targetLevel, targetIndex) => {
                        if (targetIndex < levelIndex) {
                            levelVotes[targetLevel].promote += adjustedWeight;
                        } else if (targetIndex === levelIndex) {
                            levelVotes[targetLevel].demote += adjustedWeight / 2;
                        }
                    });
                } else if (signalType === 'completion') {
                    // Completed video at this level â†’ user is comfortable at this level
                    levelVotes[level].promote += adjustedWeight;
                } else if (signalType === 'skip') {
                    // Skipped video at this level â†’ might be struggling
                    levelVotes[level].demote += adjustedWeight;
                } else if (signalType === 'word_save' || signalType === 'word_click') {
                    // Engaged with content â†’ slight positive signal
                    levelVotes[level].neutral += adjustedWeight;
                }
            });

            // Calculate net score for each level
            const levelScores = {};
            levelOrder.forEach(level => {
                const votes = levelVotes[level];
                levelScores[level] = votes.promote - votes.demote + (votes.neutral * 0.3);
            });

            // Find level with highest positive score
            let bestLevel = currentLevel;
            let bestScore = levelScores[currentLevel];

            levelOrder.forEach(level => {
                if (levelScores[level] > bestScore) {
                    bestScore = levelScores[level];
                    bestLevel = level;
                }
            });

            // Prevent over-promotion/demotion (max 1 level change at a time)
            const bestLevelIndex = levelOrder.indexOf(bestLevel);
            const levelDiff = Math.abs(bestLevelIndex - currentLevelIndex);

            if (levelDiff > 1) {
                // Only move 1 level at a time
                if (bestLevelIndex > currentLevelIndex) {
                    bestLevel = levelOrder[currentLevelIndex + 1];
                } else {
                    bestLevel = levelOrder[currentLevelIndex - 1];
                }
            }

            // Require significant evidence to change levels (threshold)
            const changeThreshold = 20; // Need at least 20 points to change
            if (Math.abs(levelScores[bestLevel] - levelScores[currentLevel]) < changeThreshold) {
                console.log(`ðŸ“Š Level stays at ${currentLevel} (score diff ${Math.abs(levelScores[bestLevel] - levelScores[currentLevel]).toFixed(1)} < threshold ${changeThreshold})`);
                return;
            }

            // Update user level if changed
            if (bestLevel !== currentLevel) {
                console.log(`ðŸŽ¯ LEVEL ADJUSTED: ${currentLevel} â†’ ${bestLevel}`);
                console.log(`ðŸ“Š Scores: ${JSON.stringify(levelScores)}`);
                console.log(`ðŸ’¡ Based on ${recentSignals.length} recent signals`);

                localStorage.setItem('userLevel', bestLevel);

                // Save to Supabase if user is logged in
                if (currentUser) {
                    supabase.auth.updateUser({
                        data: { level: bestLevel }
                    }).then(() => {
                        console.log(`âœ… Level synced to Supabase: ${bestLevel}`);
                    }).catch(e => console.log('Could not sync level to Supabase'));
                }

                // Show notification to user
                showLevelChangeNotification(currentLevel, bestLevel);
            }
        }

        // Show notification when level changes
        function showLevelChangeNotification(oldLevel, newLevel) {
            const levelOrder = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            const direction = levelOrder.indexOf(newLevel) > levelOrder.indexOf(oldLevel) ? 'up' : 'down';
            const emoji = direction === 'up' ? 'ðŸŽ‰' : 'ðŸ“š';
            const message = direction === 'up'
                ? `Level Up! You've progressed to ${newLevel}`
                : `Level adjusted to ${newLevel} for better learning`;

            // Create notification (TikTok-style toast)
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 700;
                z-index: 9999;
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                animation: slideDown 0.3s ease-out;
            `;
            notification.textContent = `${emoji} ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Backward compatibility alias
        const updateDynamicUserLevel = updateGeniusLevelDetection;

        // Save behavioral data to localStorage
        function saveBehaviorData() {
            try {
                // Keep only last 100 skip/completion patterns (prevent localStorage bloat)
                if (behaviorTracker.skipPatterns.length > 100) {
                    behaviorTracker.skipPatterns = behaviorTracker.skipPatterns.slice(-100);
                }
                if (behaviorTracker.completionPatterns.length > 100) {
                    behaviorTracker.completionPatterns = behaviorTracker.completionPatterns.slice(-100);
                }
                if (behaviorTracker.levelSignals.length > 50) {
                    behaviorTracker.levelSignals = behaviorTracker.levelSignals.slice(-50);
                }

                localStorage.setItem('behaviorTracker', JSON.stringify(behaviorTracker));
            } catch (e) {
                console.error('Error saving behavior data:', e);
            }
        }

        // ðŸŽ¯ GENIUS HARD/EASY BUTTON FUNCTIONS
        window.markVideoEasy = function(videoId, level, difficulty, button) {
            console.log(`âœ… User marked video as TOO EASY: ${videoId} (${level}, difficulty ${difficulty})`);

            // Visual feedback
            button.classList.add('marked');
            setTimeout(() => button.classList.remove('marked'), 500);

            // STRONG signal: User finds this level too easy â†’ promote user
            trackLevelSignal(level, difficulty, 'marked_easy');

            // Add to behavioral tracker
            if (!behaviorTracker.easyMarked) behaviorTracker.easyMarked = [];
            behaviorTracker.easyMarked.push({
                videoId,
                level,
                difficulty,
                timestamp: Date.now()
            });

            // Immediate level adjustment check (weighted heavily)
            updateGeniusLevelDetection();

            saveBehaviorData();

            // Advance to next video after feedback
            setTimeout(() => {
                const currentCard = button.closest('.video-card');
                if (currentCard) {
                    const nextCard = currentCard.nextElementSibling;
                    if (nextCard && nextCard.classList.contains('video-card')) {
                        nextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else if (loadedVideoCount < videos.length) {
                        renderVideosBatch(loadedVideoCount, BATCH_SIZE);
                        setTimeout(() => {
                            const newNextCard = currentCard.nextElementSibling;
                            if (newNextCard) {
                                newNextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 100);
                    }
                }
            }, 600); // Wait for animation
        };

        window.markVideoHard = function(videoId, level, difficulty, button) {
            console.log(`âŒ User marked video as TOO HARD: ${videoId} (${level}, difficulty ${difficulty})`);

            // Visual feedback
            button.classList.add('marked');
            setTimeout(() => button.classList.remove('marked'), 500);

            // STRONG signal: User finds this level too hard â†’ demote user
            trackLevelSignal(level, difficulty, 'marked_hard');

            // Add to behavioral tracker
            if (!behaviorTracker.hardMarked) behaviorTracker.hardMarked = [];
            behaviorTracker.hardMarked.push({
                videoId,
                level,
                difficulty,
                timestamp: Date.now()
            });

            // Immediate level adjustment check (weighted heavily)
            updateGeniusLevelDetection();

            saveBehaviorData();

            // Advance to next video after feedback
            setTimeout(() => {
                const currentCard = button.closest('.video-card');
                if (currentCard) {
                    const nextCard = currentCard.nextElementSibling;
                    if (nextCard && nextCard.classList.contains('video-card')) {
                        nextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else if (loadedVideoCount < videos.length) {
                        renderVideosBatch(loadedVideoCount, BATCH_SIZE);
                        setTimeout(() => {
                            const newNextCard = currentCard.nextElementSibling;
                            if (newNextCard) {
                                newNextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 100);
                    }
                }
            }, 600); // Wait for animation
        };

        // Preload next N videos for smooth transition (prevents black screen)
        // ðŸš€ PERFORMANCE: Smart Video Preloading (TikTok/Instagram Style)
        function preloadNextVideos(currentCard, count = 3) {
            let nextCard = currentCard.nextElementSibling;
            let preloaded = 0;

            // Check network speed to adjust preload strategy
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            let preloadStrategy = 'auto';
            
            if (connection) {
                // On slow connections (2G/slow-2G), only preload metadata
                if (connection.effectiveType === '2g' || connection.effectiveType === 'slow-2g') {
                    preloadStrategy = 'metadata';
                    count = 1; // Only preload next 1 video
                    console.log('ðŸŒ Slow connection detected - reducing preload');
                }
                // On fast connections (4G), preload more aggressively
                else if (connection.effectiveType === '4g') {
                    count = 5; // Preload more videos
                    console.log('ðŸš€ Fast connection detected - preloading more videos');
                }
            }

            while (nextCard && preloaded < count) {
                if (nextCard.classList.contains('video-card')) {
                    const nextVideo = nextCard.querySelector('video');
                    if (nextVideo) {
                        // Set preload strategy based on network
                        nextVideo.preload = preloadStrategy;

                        // Force load by setting a small currentTime (browser optimization)
                        if (nextVideo.readyState < 2) {
                            nextVideo.load();

                            // CRITICAL FIX: .load() resets playbackRate to 1.0
                            // Reapply saved speed after load()
                            const savedSpeed = parseFloat(localStorage.getItem('playbackSpeed') || '1');
                            nextVideo.playbackRate = savedSpeed;
                        }

                        console.log(`ðŸ“¹ Preloading video ${preloaded + 1}/${count} (strategy: ${preloadStrategy})`);
                        preloaded++;
                    }
                }
                nextCard = nextCard.nextElementSibling;
            }
        }

        // AUTH FUNCTIONS
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            currentUser = user;
            if (user) {
                updateProfileUI(user);
            }
        }

        async function handleAuth(event) {
            event.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const displayName = document.getElementById('authDisplayName').value;
            const submitBtn = document.getElementById('authSubmitBtn');
            const originalText = submitBtn.textContent;

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = isAuthMode === 'signup' ? 'Creating account...' : 'Signing in...';
            submitBtn.style.opacity = '0.7';

            try {
                if (isAuthMode === 'signup') {
                    // Sign up new user
                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                display_name: displayName || email.split('@')[0],
                                level: 'A1', // Default level
                                words_learned: 0,
                                videos_watched: 0
                            }
                        }
                    });

                    if (error) throw error;

                    // Check if email confirmation is required
                    if (data.user && data.user.identities && data.user.identities.length === 0) {
                        // Email already exists
                        throw new Error('This email is already registered. Please sign in instead.');
                    }

                    // Create user profile in database
                    if (data.user) {
                        try {
                            const { error: profileError } = await supabase
                                .from('user_profiles')
                                .insert({
                                    user_id: data.user.id,
                                    email: email,
                                    display_name: displayName || email.split('@')[0],
                                    level: 'A1',
                                    words_learned: 0,
                                    videos_watched: 0,
                                    current_streak: 0,
                                    xp_points: 0
                                });

                            // Don't fail if table doesn't exist yet
                            if (profileError) console.warn('Profile creation warning:', profileError.message);
                        } catch (profileErr) {
                            console.warn('Profile creation error:', profileErr);
                        }
                    }

                    // Success message
                    submitBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                    submitBtn.textContent = 'âœ“ Account created!';

                    setTimeout(() => {
                        alert('ðŸŽ‰ Welcome to Langflix!\n\nYour account has been created successfully.\n\nTip: Start by taking the level assessment test to get personalized videos!');

                        // Auto sign in after signup
                        currentUser = data.user;
                        updateProfileUI(data.user);
                        closeAuthModal();

                        // Prompt for level test
                        setTimeout(() => {
                            if (confirm('Would you like to take a 5-minute test to find your Spanish level? (Recommended)')) {
                                window.location.href = '/level-assessment.html';
                            }
                        }, 500);
                    }, 1000);

                } else {
                    // Sign in existing user
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) throw error;

                    currentUser = data.user;
                    updateProfileUI(data.user);

                    submitBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                    submitBtn.textContent = 'âœ“ Signed in!';

                    setTimeout(() => {
                        closeAuthModal();
                        alert('ðŸ‘‹ Welcome back!');
                    }, 800);
                }
            } catch (error) {
                // Show detailed error message
                console.error('Auth error:', error);

                let errorMessage = 'Authentication failed';

                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'âŒ Invalid email or password.\n\nPlease check your credentials and try again.';
                } else if (error.message.includes('already registered')) {
                    errorMessage = 'âŒ This email is already registered.\n\nPlease sign in instead or use a different email.';
                } else if (error.message.includes('email')) {
                    errorMessage = 'âŒ Please enter a valid email address.';
                } else if (error.message.includes('password')) {
                    errorMessage = 'âŒ Password must be at least 6 characters long.';
                } else if (error.message.includes('rate limit')) {
                    errorMessage = 'âŒ Too many attempts.\n\nPlease wait a minute and try again.';
                } else {
                    errorMessage = `âŒ Error: ${error.message}`;
                }

                alert(errorMessage);

                // Reset button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                submitBtn.style.opacity = '1';
                submitBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            currentUser = null;
            closeProfile();
            alert('Signed out successfully');
        }

        function toggleAuthMode() {
            isAuthMode = isAuthMode === 'signin' ? 'signup' : 'signin';
            const displayNameInput = document.getElementById('authDisplayName');
            const authTitle = document.getElementById('authTitle');
            const authSubmitBtn = document.getElementById('authSubmitBtn');
            const authToggleText = document.getElementById('authToggleText');

            if (isAuthMode === 'signup') {
                displayNameInput.style.display = 'block';
                authTitle.textContent = 'Sign Up';
                authSubmitBtn.textContent = 'Sign Up';
                authToggleText.textContent = 'Already have an account?';
            } else {
                displayNameInput.style.display = 'none';
                authTitle.textContent = 'Sign In';
                authSubmitBtn.textContent = 'Sign In';
                authToggleText.textContent = "Don't have an account?";
            }
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('show');
        }

        function updateProfileUI(user) {
            document.getElementById('profileName').textContent = user.user_metadata?.display_name || user.email;
            document.getElementById('profileEmail').textContent = user.email;

            // Update level badge
            const userLevel = user.user_metadata?.level || localStorage.getItem('userLevel') || 'A1';
            document.getElementById('profileLevel').textContent = userLevel;

            // Update XP and progress bar
            const userXP = user.user_metadata?.xp_points || parseInt(localStorage.getItem('userXP') || '0');
            const xpForNextLevel = 100 * (parseInt(userLevel.substring(1)) || 1); // A1=100, A2=200, B1=300, etc
            const xpProgress = (userXP % xpForNextLevel) / xpForNextLevel * 100;

            document.getElementById('profileXP').textContent = userXP % xpForNextLevel;
            document.getElementById('profileXPNext').textContent = xpForNextLevel;
            document.getElementById('profileXPFill').style.width = `${xpProgress}%`;

            // Update frequency list progress
            updateFrequencyProgress(userLevel);

            // Update streak
            const lastVisit = localStorage.getItem('lastVisit');
            const today = new Date().toDateString();
            let streak = parseInt(localStorage.getItem('currentStreak') || '0');

            if (lastVisit !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastVisit === yesterday.toDateString()) {
                    streak++; // Continue streak
                } else if (lastVisit !== today) {
                    streak = 1; // Reset streak
                }

                localStorage.setItem('currentStreak', streak.toString());
                localStorage.setItem('lastVisit', today);
            }

            document.getElementById('statsDays').textContent = streak;

            // Update videos watched
            const videosWatched = parseInt(localStorage.getItem('videosWatched') || '0');
            document.getElementById('statsVideos').textContent = videosWatched;

            // Update study time (in minutes)
            const studyTimeSeconds = parseInt(localStorage.getItem('totalStudyTime') || '0');
            const studyTimeMinutes = Math.floor(studyTimeSeconds / 60);
            document.getElementById('statsTime').textContent = studyTimeMinutes > 60 ?
                `${Math.floor(studyTimeMinutes / 60)}h ${studyTimeMinutes % 60}m` :
                `${studyTimeMinutes}m`;

            loadUserVocabulary();
        }

        async function loadUserVocabulary() {
            if (!currentUser) return;

            const { data, error } = await supabase
                .from('vocabulary')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading vocabulary:', error);
                return;
            }

            const vocabList = document.getElementById('vocabularyList');
            document.getElementById('statsWords').textContent = data.length;

            if (data.length === 0) {
                vocabList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“–</div>
                        <div class="empty-state-text">No words saved yet. Tap on Spanish words to save them!</div>
                    </div>
                `;
            } else {
                vocabList.innerHTML = data.map(word => `
                    <div class="vocabulary-item">
                        <div class="vocabulary-word">${word.word}</div>
                        <div class="vocabulary-translation">${word.translation}</div>
                        ${word.context_sentence ? `<div class="vocabulary-context">${word.context_sentence}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        // Update frequency list progress based on level and words learned
        async function updateFrequencyProgress(userLevel) {
            // Frequency ranges by CEFR level (based on assessment test)
            const frequencyRanges = {
                'A1': { min: 1, max: 500, total: 500, text: '1-500' },
                'A2': { min: 500, max: 1500, total: 1000, text: '500-1,500' },
                'B1': { min: 1500, max: 3000, total: 1500, text: '1,500-3,000' },
                'B2': { min: 3000, max: 6000, total: 3000, text: '3,000-6,000' },
                'C1': { min: 6000, max: 10000, total: 4000, text: '6,000+' },
                'C2': { min: 10000, max: 15000, total: 5000, text: '10,000+' }
            };

            const range = frequencyRanges[userLevel] || frequencyRanges['A1'];

            // Get number of words learned
            const wordsLearnedCount = wordsLearned.size;

            // Calculate progress within current range
            const progressInRange = Math.min((wordsLearnedCount / range.total) * 100, 100);

            // Calculate overall progress (out of 10,000)
            const overallProgress = Math.min((wordsLearnedCount / 10000) * 100, 100);

            // Update UI elements
            document.getElementById('frequencyWordsLearned').textContent = wordsLearnedCount;
            document.getElementById('frequencyPosition').textContent = range.text;
            document.getElementById('frequencyProgressFill').style.width = `${progressInRange}%`;

            // Update progress text based on level
            let progressMessage = '';
            if (userLevel === 'A1') {
                progressMessage = "You're learning the most essential Spanish words";
            } else if (userLevel === 'A2') {
                progressMessage = "Building your foundation with common phrases";
            } else if (userLevel === 'B1') {
                progressMessage = "Expanding vocabulary for everyday situations";
            } else if (userLevel === 'B2') {
                progressMessage = "Mastering advanced vocabulary and nuances";
            } else {
                progressMessage = "Achieving fluency with sophisticated vocabulary";
            }

            document.getElementById('frequencyProgressText').textContent = progressMessage;

            console.log(`ðŸ“Š Frequency Progress: ${wordsLearnedCount} words (${userLevel}: ${range.text}), ${progressInRange.toFixed(1)}% in range`);
        }

        async function saveWordToVocabulary(word, translation, contextSentence) {
            if (!currentUser) {
                document.getElementById('authModal').classList.add('show');
                alert('Please sign in to save words');
                return;
            }

            try {
                const { error } = await supabase
                    .from('vocabulary')
                    .upsert({
                        user_id: currentUser.id,
                        word: word,
                        translation: translation,
                        language: 'Spanish',
                        source_app: 'workspace3',
                        context_sentence: contextSentence
                    }, {
                        onConflict: 'user_id,word,language'
                    });

                if (error) throw error;
                console.log(`âœ… Saved "${word}" to vocabulary`);

                // ðŸŽ¯ Track level signal: Saving a word indicates engagement with that difficulty
                const wordData = await getWordFrequencyData(word);
                if (wordData && wordData.cefr_level) {
                    trackLevelSignal(wordData.cefr_level, wordData.frequency_rank, 'word_save');
                }
            } catch (error) {
                console.error('Error saving word:', error);
                alert('Error saving word âŒ');
            }
        }

        // ANALYTICS: Track video interactions (like, save, share, view)
        async function trackVideoInteraction(videoId, action, value) {
            if (!currentUser) return;

            try {
                await supabase
                    .from('video_analytics')
                    .insert({
                        user_id: currentUser.id,
                        video_id: videoId,
                        action: action,
                        value: value,
                        timestamp: new Date().toISOString()
                    });
            } catch (error) {
                console.error('Analytics error:', error);
            }
        }

        // Track word clicked and update counter
        async function trackWordClicked(word) {
            const cleanWord = word.toLowerCase().replace(/[Â¿Â¡.,!?]/g, '');

            if (!wordsLearned.has(cleanWord)) {
                wordsLearned.add(cleanWord);
                localStorage.setItem('wordsLearned', JSON.stringify([...wordsLearned]));

                // Award XP for learning new word
                addXP(10, 'Learned new word');

                // Update stats display
                updateStatsDisplay();

                // Update frequency progress
                const userLevel = localStorage.getItem('userLevel') || 'A1';
                updateFrequencyProgress(userLevel);

                // Check for milestones
                checkWordMilestones(wordsLearned.size);

                console.log(`âœ… Word learned: ${cleanWord} (Total: ${wordsLearned.size})`);

                // ðŸŽ¯ Track level signal: Clicking a word indicates interest in that difficulty
                const wordData = await getWordFrequencyData(cleanWord);
                if (wordData && wordData.cefr_level) {
                    trackLevelSignal(wordData.cefr_level, wordData.frequency_rank, 'word_click');
                }
            }
        }

        // ========== GAMIFICATION SYSTEM ==========

        // Update stats display (top bar)
        function updateStatsDisplay() {
            document.getElementById('streakDisplay').textContent = userStreak;
            document.getElementById('xpDisplay').textContent = userXP;
            document.getElementById('wordsDisplay').textContent = wordsLearned.size;
        }

        // Add XP with animation
        function addXP(amount, reason) {
            userXP += amount;
            localStorage.setItem('userXP', userXP);
            updateStatsDisplay();

            // Animate XP display
            const xpEl = document.getElementById('xpDisplay');
            if (xpEl) {
                xpEl.style.transform = 'scale(1.3)';
                xpEl.style.color = '#ffd700';
                setTimeout(() => {
                    xpEl.style.transform = 'scale(1)';
                    xpEl.style.color = '';
                }, 300);
            }

            console.log(`ðŸ† +${amount} XP: ${reason}`);
        }

        // Update streak (called daily)
        function updateStreak() {
            const today = new Date().toDateString();

            if (lastActiveDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();

                if (lastActiveDate === yesterdayStr) {
                    // Consecutive day - increment streak
                    userStreak++;
                    addXP(50, `${userStreak} day streak!`);
                } else if (lastActiveDate !== null) {
                    // Streak broken - reset to 1
                    userStreak = 1;
                } else {
                    // First day
                    userStreak = 1;
                }

                lastActiveDate = today;
                localStorage.setItem('userStreak', userStreak);
                localStorage.setItem('lastActiveDate', lastActiveDate);
                updateStatsDisplay();

                console.log(`ðŸ”¥ Streak updated: ${userStreak} days`);
            }
        }

        // Check word learning milestones
        function checkWordMilestones(wordCount) {
            const milestones = [
                { count: 10, emoji: 'ðŸŽ‰', title: '10 Words!', message: 'Great start! Keep learning!' },
                { count: 25, emoji: 'ðŸ”¥', title: '25 Words!', message: "You're on fire!" },
                { count: 50, emoji: 'â­', title: '50 Words!', message: 'Halfway to fluent!' },
                { count: 100, emoji: 'ðŸ†', title: 'Century!', message: '100 words mastered!' },
                { count: 250, emoji: 'ðŸ’Ž', title: 'Champion!', message: '250 words! Incredible!' },
                { count: 500, emoji: 'ðŸ‘‘', title: 'Master!', message: '500 words! You are amazing!' }
            ];

            for (const milestone of milestones) {
                if (wordCount === milestone.count && !milestonesReached.has(milestone.count)) {
                    showMilestoneCelebration(milestone);
                    milestonesReached.add(milestone.count);
                    localStorage.setItem('milestonesReached', JSON.stringify([...milestonesReached]));
                    addXP(100, `Reached ${milestone.count} words milestone!`);
                    break;
                }
            }
        }

        // Show milestone celebration with confetti
        function showMilestoneCelebration(milestone) {
            const modal = document.getElementById('milestoneModal');
            document.getElementById('milestoneEmoji').textContent = milestone.emoji;
            document.getElementById('milestoneTitle').textContent = milestone.title;
            document.getElementById('milestoneMessage').textContent = milestone.message;

            modal.classList.add('show');

            // Create confetti
            createConfetti();

            // Auto-hide after 3 seconds
            setTimeout(() => {
                modal.classList.remove('show');
            }, 3000);
        }

        // Create confetti animation
        function createConfetti() {
            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f7b731', '#5f27cd'];
            const confettiCount = 50;

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);

                // Remove after animation
                setTimeout(() => confetti.remove(), 3500);
            }
        }

        // Track video watched
        function trackVideoWatched(videoId) {
            videosWatched++;
            localStorage.setItem('videosWatched', videosWatched);

            // Award XP
            addXP(5, 'Watched video');

            // Check if quiz should be triggered (every 3 videos)
            if (videosWatched % 3 === 0) {
                setTimeout(() => showVideoQuizPrompt(videoId), 1000);
            }

            console.log(`ðŸ“¹ Videos watched: ${videosWatched}`);
        }

        // ========== PER-VIDEO QUIZ SYSTEM ==========

        // Show quiz prompt after video
        function showVideoQuizPrompt(videoId) {
            // Find the video data
            const video = videos.find(v => v.id === videoId);
            if (!video || !video.transcription || !video.transcription.lines) {
                return;
            }

            videoQuizData = video;
            document.getElementById('videoQuizPrompt').classList.add('show');
        }

        // Skip video quiz
        function skipVideoQuiz() {
            document.getElementById('videoQuizPrompt').classList.remove('show');
            videoQuizData = null;
        }

        // Start video quiz
        function startVideoQuiz() {
            document.getElementById('videoQuizPrompt').classList.remove('show');

            if (!videoQuizData) return;

            // Generate quiz questions from video
            generateVideoQuiz(videoQuizData);

            // Switch to quiz tab
            switchTab('quizzes');
        }

        // Generate quiz from video transcription
        function generateVideoQuiz(video) {
            quizQuestions = [];
            const words = new Set();

            // Extract unique words from transcription
            video.transcription.lines.forEach(line => {
                if (line.spanish && line.english) {
                    const spanishWords = line.spanish.split(' ').filter(w => w.length > 3);
                    spanishWords.forEach(word => {
                        const cleanWord = word.replace(/[Â¿Â¡.,!?]/g, '');
                        if (cleanWord.length > 3) {
                            words.add({
                                spanish: cleanWord,
                                english: line.english,
                                sentence: line.spanish
                            });
                        }
                    });
                }
            });

            // Create 3-5 quiz questions
            const wordsArray = Array.from(words).slice(0, 5);
            wordsArray.forEach(wordData => {
                quizQuestions.push({
                    question: `What does "${wordData.spanish}" mean?`,
                    correctAnswer: wordData.english,
                    options: generateQuizOptions(wordData.english),
                    context: wordData.sentence
                });
            });

            currentQuizIndex = 0;
            quizScore = 0;
            renderQuiz();
        }

        // Generate quiz options (1 correct + 3 wrong)
        function generateQuizOptions(correctAnswer) {
            const wrongAnswers = [
                'Hello', 'Goodbye', 'Thank you', 'Please', 'Yes', 'No',
                'Good morning', 'Good night', 'How are you?', 'I am fine',
                'What is your name?', 'My name is', 'Nice to meet you',
                'See you later', 'Excuse me', 'I am sorry'
            ];

            const options = [correctAnswer];

            while (options.length < 4) {
                const randomAnswer = wrongAnswers[Math.floor(Math.random() * wrongAnswers.length)];
                if (!options.includes(randomAnswer)) {
                    options.push(randomAnswer);
                }
            }

            // Shuffle options
            return options.sort(() => Math.random() - 0.5);
        }

        // Render quiz UI
        function renderQuiz() {
            const container = document.getElementById('quizContainer');

            if (currentQuizIndex >= quizQuestions.length) {
                // Quiz complete - show score
                container.innerHTML = `
                    <div class="quiz-score">
                        <div class="quiz-score-circle">
                            ${quizScore}/${quizQuestions.length}
                        </div>
                        <h2 style="font-size: 32px; margin-bottom: 16px;">
                            ${quizScore === quizQuestions.length ? 'ðŸŽ‰ Perfect!' : quizScore >= quizQuestions.length * 0.7 ? 'ðŸŽ¯ Great job!' : 'ðŸ’ª Keep practicing!'}
                        </h2>
                        <p style="font-size: 18px; opacity: 0.8; margin-bottom: 20px;">
                            You got ${quizScore} out of ${quizQuestions.length} correct!
                        </p>
                        <button class="quiz-restart-btn" onclick="switchTab('home')">Back to Videos</button>
                    </div>
                `;

                // Award XP
                addXP(20, `Quiz completed: ${quizScore}/${quizQuestions.length}`);

                return;
            }

            const question = quizQuestions[currentQuizIndex];

            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <span style="font-size: 18px; font-weight: 700; color: rgba(255, 255, 255, 0.6);">
                        Question ${currentQuizIndex + 1} of ${quizQuestions.length}
                    </span>
                </div>
                <div class="quiz-question">
                    <div class="quiz-question-text">${question.question}</div>
                    <div class="quiz-options" id="quizOptions">
                        ${question.options.map((option, i) => `
                            <div class="quiz-option" onclick="selectQuizAnswer('${option}', '${question.correctAnswer}', ${i})">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Handle quiz answer selection
        function selectQuizAnswer(selected, correct, optionIndex) {
            const options = document.querySelectorAll('.quiz-option');
            const selectedOption = options[optionIndex];

            if (selected === correct) {
                selectedOption.classList.add('correct');
                quizScore++;
            } else {
                selectedOption.classList.add('incorrect');
                // Highlight correct answer
                options.forEach((opt, i) => {
                    if (quizQuestions[currentQuizIndex].options[i] === correct) {
                        opt.classList.add('correct');
                    }
                });
            }

            // Disable all options
            options.forEach(opt => opt.style.pointerEvents = 'none');

            // Next question after 1.5s
            setTimeout(() => {
                currentQuizIndex++;
                renderQuiz();
            }, 1500);
        }

        // ========== FLASHCARD PRACTICE SYSTEM ==========

        // Load practice cards from vocabulary
        async function loadPracticeCards() {
            practiceCards = [];

            // Get saved words
            const savedWords = Array.from(wordsLearned);

            if (savedWords.length === 0) {
                document.getElementById('practiceProgress').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“–</div>
                        <div style="font-size: 18px; opacity: 0.7;">
                            No words saved yet. Start learning by clicking on Spanish words in videos!
                        </div>
                    </div>
                `;
                return;
            }

            // Load from Supabase if logged in
            if (currentUser) {
                try {
                    const { data, error } = await supabase
                        .from('vocabulary')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('created_at', { ascending: false });

                    if (!error && data) {
                        practiceCards = data.map(item => ({
                            spanish: item.word,
                            english: item.translation,
                            sentence: item.context_sentence || ''
                        }));
                    }
                } catch (e) {
                    console.error('Error loading vocabulary:', e);
                }
            }

            // Fallback: use saved words with mock translations
            if (practiceCards.length === 0) {
                practiceCards = savedWords.map(word => ({
                    spanish: word,
                    english: `Translation of ${word}`,
                    sentence: ''
                }));
            }

            currentCardIndex = 0;
            renderFlashcard();
        }

        // Render current flashcard
        function renderFlashcard() {
            if (practiceCards.length === 0) return;

            const container = document.getElementById('flashcardContainer');
            const card = practiceCards[currentCardIndex];

            document.getElementById('practiceProgress').textContent =
                `${currentCardIndex + 1} / ${practiceCards.length} cards`;

            container.innerHTML = `
                <div class="flashcard" onclick="flipCard()">
                    <div class="flashcard-front">
                        <div class="flashcard-word">${card.spanish}</div>
                        <div style="font-size: 14px; opacity: 0.6; margin-top: 20px;">
                            Tap to reveal translation
                        </div>
                    </div>
                    <div class="flashcard-back">
                        <div class="flashcard-translation">${card.english}</div>
                        ${card.sentence ? `<div class="flashcard-sentence">"${card.sentence}"</div>` : ''}
                    </div>
                </div>
            `;

            document.getElementById('flashcardControls').style.display = 'flex';
            isCardFlipped = false;
        }

        // Flip flashcard
        function flipCard() {
            const card = document.querySelector('.flashcard');
            if (card) {
                card.classList.toggle('flipped');
                isCardFlipped = !isCardFlipped;
            }
        }

        // Rate flashcard (Easy/Good/Hard) - SM-2 algorithm placeholder
        function rateCard(difficulty) {
            console.log(`Card rated as: ${difficulty}`);

            // Award XP based on difficulty
            const xpReward = { hard: 5, good: 10, easy: 15 };
            addXP(xpReward[difficulty], `Practiced flashcard (${difficulty})`);

            // Move to next card
            currentCardIndex++;

            if (currentCardIndex >= practiceCards.length) {
                // Practice complete
                const container = document.getElementById('flashcardContainer');
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 80px; margin-bottom: 20px;">ðŸŽ‰</div>
                        <h2 style="font-size: 32px; margin-bottom: 12px;">Practice Complete!</h2>
                        <p style="font-size: 18px; opacity: 0.8;">
                            You reviewed ${practiceCards.length} cards. Great work!
                        </p>
                        <button class="quiz-restart-btn" onclick="loadPracticeCards()" style="margin-top: 24px;">
                            Practice Again
                        </button>
                    </div>
                `;
                document.getElementById('flashcardControls').style.display = 'none';
                createConfetti();
            } else {
                renderFlashcard();
            }
        }

        // SPEED MENU: Show speed control modal (thumb-accessible)
        function showSpeedMenu(card) {
            // Find the old speed control
            const oldSpeedControl = card.querySelector('.speed-control');
            if (!oldSpeedControl) return;

            const speedMenu = oldSpeedControl.querySelector('.speed-menu');
            if (!speedMenu) return;

            // Toggle menu visibility
            speedMenu.classList.toggle('show');

            // Close menu when clicking outside
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!speedMenu.contains(e.target) && !e.target.closest('.speed-btn-new')) {
                        speedMenu.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 100);
        }

        // TAB SWITCHING (ENHANCED with Practice and Quiz)
        function switchTab(tabName) {
            currentTab = tabName;

            // Update active tab
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-feed="${tabName}"]`)?.classList.add('active');

            // Hide all views
            document.getElementById('profileView').classList.remove('show');
            if (document.getElementById('practiceView')) {
                document.getElementById('practiceView').classList.remove('show');
            }
            document.getElementById('quizView').classList.remove('show');
            document.getElementById('feedContainer').style.display = 'block';

            // Handle different tabs
            if (tabName === 'profile') {
                if (!currentUser) {
                    document.getElementById('authModal').classList.add('show');
                } else {
                    openProfile();
                }
            } else if (tabName === 'home') {
                // Show video feed
                document.getElementById('feedContainer').style.display = 'block';
            } else if (tabName === 'discover') {
                // Navigate to Spanish Articles feed
                window.location.href = '/spanish-articles.html';
            } else if (tabName === 'quizzes') {
                // Navigate to Duolingo-style quiz page
                window.location.href = '/components/duolingo-quiz.html';
            } else if (tabName === 'games') {
                // Navigate to Language Games page
                window.location.href = '/components/language-games.html';
            }
        }

        // Show Quiz Mode
        function showQuizMode() {
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('practiceContainer').style.display = 'none';

            // Start general quiz if no video quiz is active
            if (quizQuestions.length === 0) {
                startGeneralQuiz();
            }
        }

        // Show Practice Mode (Flashcards)
        function showPracticeMode() {
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('practiceContainer').style.display = 'block';
            loadPracticeCards();
        }

        // Start general quiz (not video-specific)
        function startGeneralQuiz() {
            const savedWords = Array.from(wordsLearned).slice(0, 10);

            if (savedWords.length === 0) {
                document.getElementById('quizContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“š</div>
                        <div style="font-size: 18px; opacity: 0.7;">
                            Learn some words first, then come back to practice!
                        </div>
                        <button class="quiz-restart-btn" onclick="switchTab('home')" style="margin-top: 24px;">
                            Watch Videos
                        </button>
                    </div>
                `;
                return;
            }

            // Create quiz from learned words
            quizQuestions = savedWords.map(word => ({
                question: `What does "${word}" mean in Spanish?`,
                correctAnswer: `Translation of ${word}`,
                options: generateQuizOptions(`Translation of ${word}`)
            }));

            currentQuizIndex = 0;
            quizScore = 0;
            renderQuiz();
        }

        function openProfile() {
            document.getElementById('profileView').classList.add('show');
            loadUserVocabulary();

            // Update frequency progress when profile is opened
            const userLevel = localStorage.getItem('userLevel') || 'A1';
            updateFrequencyProgress(userLevel);
        }

        function closeProfile() {
            document.getElementById('profileView').classList.remove('show');
        }

        // X2 MODE CONTROL - Watch video twice (first with subtitles, then transcript only)
        function toggleX2Mode(btn) {
            const isX2Active = btn.classList.toggle('x2-active');
            const x2Status = btn.querySelector('.x2-status');
            const card = btn.closest('.video-card');

            if (isX2Active) {
                x2Status.textContent = 'On';
                btn.style.background = 'rgba(124, 58, 237, 0.3)'; // Purple tint when active
                btn.dataset.firstPlayDone = 'false';
                console.log('ðŸ” x2 mode enabled: Will play twice (subtitles â†’ transcript only)');
            } else {
                x2Status.textContent = 'Off';
                btn.style.background = '';
                btn.dataset.firstPlayDone = 'false';

                // Restore subtitles if they were hidden
                const subtitlesOverlay = card.querySelector('.subtitles-overlay');
                if (subtitlesOverlay) {
                    subtitlesOverlay.style.display = '';
                }
                console.log('â†ªï¸ x2 mode disabled');
            }
        }

        // SPEED CONTROL FUNCTIONS - Single-tap cycle (1x â†’ 0.5x â†’ 0.75x â†’ 1x)
        const speedOptions = [1, 0.5, 0.75]; // NEW ORDER: normal â†’ half â†’ 0.75
        let speedIndex = 0;

        function cycleSpeed() {
            // Cycle through speeds
            speedIndex = (speedIndex + 1) % speedOptions.length;
            const newSpeed = speedOptions[speedIndex];

            // Update global speed
            currentPlaybackSpeed = newSpeed;
            localStorage.setItem('playbackSpeed', newSpeed);

            // Apply to all loaded videos
            document.querySelectorAll('video').forEach(video => {
                video.playbackRate = newSpeed;
            });

            // Update ALL speed displays in sidebar (all video cards)
            document.querySelectorAll('.speed-display').forEach(display => {
                display.textContent = newSpeed + 'x';
            });

            // Hide onboarding tooltip if shown
            const tooltip = document.getElementById('speedTooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }

            console.log(`âš¡ Speed changed to ${newSpeed}x`);
        }

        function toggleTranslation(btn) {
            // Get current video card
            const card = btn.closest('.video-card');
            if (!card) return;

            // Get subtitle container
            const subtitleContainer = card.querySelector('.subtitle-container');
            if (!subtitleContainer) return;

            // Get status display
            const statusDisplay = btn.querySelector('.translate-status');

            // Cycle through modes: Both -> Spanish Only -> English Only -> Both
            if (!subtitleContainer.classList.contains('spanish-only') && !subtitleContainer.classList.contains('english-only')) {
                // Currently: Both -> Switch to Spanish Only
                subtitleContainer.classList.add('spanish-only');
                statusDisplay.textContent = 'ES';
                console.log('ðŸ”¤ Translation mode: Spanish Only');
            } else if (subtitleContainer.classList.contains('spanish-only')) {
                // Currently: Spanish Only -> Switch to English Only
                subtitleContainer.classList.remove('spanish-only');
                subtitleContainer.classList.add('english-only');
                statusDisplay.textContent = 'EN';
                console.log('ðŸ”¤ Translation mode: English Only');
            } else {
                // Currently: English Only -> Switch to Both
                subtitleContainer.classList.remove('english-only');
                statusDisplay.textContent = 'Both';
                console.log('ðŸ”¤ Translation mode: Both');
            }
        }

        function applyPlaybackSpeed(videoEl) {
            videoEl.playbackRate = currentPlaybackSpeed;
        }

        function changeSpeed(speed) {
            currentPlaybackSpeed = speed;
            localStorage.setItem('playbackSpeed', speed);

            // Apply to all loaded videos
            document.querySelectorAll('video').forEach(video => {
                video.playbackRate = speed;
            });

            // Update speed button text
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.textContent = speed + 'x';
            });
            const globalBtn = document.getElementById('globalSpeedBtn');
            if (globalBtn) {
                globalBtn.textContent = speed + 'x';
            }

            // Update active state
            document.querySelectorAll('.speed-option').forEach(opt => {
                opt.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Hide menu
            document.querySelectorAll('.speed-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }

        function toggleSpeedMenu(card) {
            const menu = card.querySelector('.speed-menu');
            if (!menu) return;

            const isShown = menu.classList.contains('show');

            // Close all speed menus
            document.querySelectorAll('.speed-menu').forEach(m => m.classList.remove('show'));

            // Toggle current menu
            if (!isShown) {
                menu.classList.add('show');
            }
        }

        // DELETE VIDEO FUNCTION (called from sidebar delete button)
        async function deleteVideo(videoId, videoCard) {
            if (!confirm('Delete this video permanently? This cannot be undone.')) {
                return;
            }

            try {
                // Show loading indicator
                if (videoCard) {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 20px 40px;
                        border-radius: 12px;
                        font-size: 16px;
                        z-index: 10000;
                    `;
                    loadingDiv.textContent = 'Deleting...';
                    videoCard.appendChild(loadingDiv);
                }

                const response = await fetch(`/api/videos/${videoId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Add to localStorage blacklist for permanent hiding
                    const deletedVideos = JSON.parse(localStorage.getItem('deletedVideos') || '[]');
                    if (!deletedVideos.includes(videoId)) {
                        deletedVideos.push(videoId);
                        localStorage.setItem('deletedVideos', JSON.stringify(deletedVideos));
                    }

                    // Remove from DOM
                    if (videoCard) videoCard.remove();

                    // Remove from videos array
                    videos = videos.filter(v => v.id !== videoId);

                    console.log(`âœ… Video ${videoId} deleted permanently`);
                } else {
                    alert('Failed to delete video');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error deleting video');
            }
        }

        // Report transcription/timing issues for re-transcription
        async function reportTranscription(videoId, videoUrl, videoCard) {
            const confirmed = confirm('Report this video for incorrect transcription or timing?\n\nThis will flag it for automatic re-transcription.');

            if (!confirmed) return;

            try {
                // Show loading indicator
                let loadingDiv;
                if (videoCard) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 20px 40px;
                        border-radius: 12px;
                        font-size: 16px;
                        z-index: 10000;
                    `;
                    loadingDiv.textContent = 'Reporting...';
                    videoCard.appendChild(loadingDiv);
                }

                const response = await fetch('/api/transcription/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        videoId,
                        videoUrl,
                        reportedBy: currentUser?.email || 'anonymous',
                        timestamp: new Date().toISOString()
                    })
                });

                const data = await response.json();

                if (loadingDiv) loadingDiv.remove();

                if (response.ok) {
                    // IMMEDIATELY HIDE VIDEO until retranscription is complete (same as delete)
                    // Add to localStorage blacklist so user doesn't see it again
                    const retranscribingVideos = JSON.parse(localStorage.getItem('retranscribingVideos') || '[]');
                    if (!retranscribingVideos.includes(videoId)) {
                        retranscribingVideos.push(videoId);
                        localStorage.setItem('retranscribingVideos', JSON.stringify(retranscribingVideos));
                    }

                    // Remove from DOM immediately
                    if (videoCard) videoCard.remove();

                    // Remove from videos array
                    videos = videos.filter(v => v.id !== videoId);

                    alert(`âœ… Thank you! Video has been hidden and flagged for re-transcription.\n\nQueue position: #${data.queuePosition}\nExpected: ${data.estimatedCompletion || '5-10 min'}\n\nThe video will reappear once retranscription is complete.`);
                    console.log('ðŸ“ Transcription report:', data);
                } else {
                    alert(`âŒ Failed to report: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Report transcription error:', error);
                alert('âŒ Error submitting report. Please try again.');
            }
        }

        // Show video options menu (bottom sheet with more actions)
        function showVideoOptions(videoId, videoUrl, button) {
            const card = button.closest('.video-card');

            // Create bottom sheet overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 9999;
                display: flex;
                align-items: flex-end;
                animation: fadeIn 0.2s ease;
            `;

            const sheet = document.createElement('div');
            sheet.style.cssText = `
                background: #1a1a1a;
                border-radius: 20px 20px 0 0;
                padding: 24px;
                width: 100%;
                max-width: 500px;
                margin: 0 auto;
                animation: slideUp 0.3s ease;
            `;

            sheet.innerHTML = `
                <style>
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
                    .option-btn {
                        display: flex;
                        align-items: center;
                        gap: 16px;
                        padding: 16px;
                        background: rgba(255, 255, 255, 0.05);
                        border: none;
                        border-radius: 12px;
                        color: white;
                        font-size: 16px;
                        width: 100%;
                        margin-bottom: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .option-btn:hover {
                        background: rgba(255, 255, 255, 0.1);
                        transform: scale(1.02);
                    }
                    .option-btn:active {
                        transform: scale(0.98);
                    }
                    .option-btn.danger {
                        color: #ff4444;
                    }
                </style>
                <h3 style="margin: 0 0 20px 0; color: white; font-size: 18px;">Video Options</h3>

                <button class="option-btn" onclick="reportTranscription('${videoId}', '${videoUrl}'); this.closest('.overlay-tmp').remove();">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    Report Transcription Issue
                </button>

                <button class="option-btn danger" onclick="deleteVideo('${videoId}', document.querySelector('[data-video-id=\\'${videoId}\\']')); this.closest('.overlay-tmp').remove();">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Delete Video
                </button>

                <button class="option-btn" onclick="this.closest('.overlay-tmp').remove();" style="background: rgba(255, 255, 255, 0.1);">
                    Cancel
                </button>
            `;

            overlay.appendChild(sheet);
            overlay.className = 'overlay-tmp';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            document.body.appendChild(overlay);
        }

        // Make functions available globally for onclick handlers
        window.switchTab = switchTab;
        window.closeAuthModal = closeAuthModal;
        window.toggleAuthMode = toggleAuthMode;
        window.handleAuth = handleAuth;
        window.handleLogout = handleLogout;
        window.closeProfile = closeProfile;
        window.changeSpeed = changeSpeed;
        window.toggleSpeedMenu = toggleSpeedMenu;
        window.cycleSpeed = cycleSpeed;
        window.deleteVideo = deleteVideo;
        window.reportTranscription = reportTranscription;
        window.showVideoOptions = showVideoOptions;
        window.skipVideoQuiz = skipVideoQuiz;
        window.startVideoQuiz = startVideoQuiz;
        window.selectQuizAnswer = selectQuizAnswer;
        window.flipCard = flipCard;
        window.rateCard = rateCard;
        window.loadPracticeCards = loadPracticeCards;
        window.startGeneralQuiz = startGeneralQuiz;
        window.showQuizMode = showQuizMode;
        window.showPracticeMode = showPracticeMode;

        // GAMIFICATION BAR AUTO-HIDE on scroll (slides down, hides after 2s)
        let gamificationTimeout;
        const gamificationBar = document.getElementById('gamificationBar');
        const feedContainer = document.getElementById('feedContainer');

        feedContainer.addEventListener('scroll', () => {
            // Show bar on scroll
            gamificationBar.classList.remove('hidden');

            // Clear previous timeout
            clearTimeout(gamificationTimeout);

            // Hide after 2 seconds
            gamificationTimeout = setTimeout(() => {
                gamificationBar.classList.add('hidden');
            }, 2000);
        });

        // ðŸ“Š PERFORMANCE MONITORING - Track app performance
        if (window.performance && window.performance.mark) {
            performance.mark('app-init-start');
        }

        // ðŸŽ¯ NETWORK QUALITY INDICATOR
        function showNetworkQuality() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                const effectiveType = connection.effectiveType;
                const speedEmoji = {
                    'slow-2g': 'ðŸŒ',
                    '2g': 'ðŸ“¶',
                    '3g': 'ðŸ“¶ðŸ“¶',
                    '4g': 'ðŸš€'
                };
                
                console.log(`ðŸ“¡ Network: ${effectiveType} ${speedEmoji[effectiveType] || 'ðŸ“¶'}`);
                
                // Show warning on slow connections
                if (effectiveType === 'slow-2g' || effectiveType === '2g') {
                    console.warn('âš ï¸ Slow connection detected - videos will load with reduced quality');
                }
            }
        }

        showNetworkQuality();

        // Initialize app FIRST (critical path)
        checkAuth();
        loadVideos();
        
        // Track app load performance
        if (window.performance && window.performance.mark) {
            performance.mark('app-init-end');
            performance.measure('app-init', 'app-init-start', 'app-init-end');
            const measure = performance.getEntriesByName('app-init')[0];
            console.log(`âš¡ App initialized in ${Math.round(measure.duration)}ms`);
        }

        // ===== BEGINNER MODE INTEGRATION =====
        // Import beginner mode and quiz controllers (non-blocking, after critical init)
        import('/lib/beginnerModeController.js').then(module => {
            const BeginnerModeController = module.default;
            window.beginnerModeController = new BeginnerModeController(supabase);

            // Make functions globally available
            window.activateBeginnerMode = () => {
                window.beginnerModeController.activate();
                // Close prompt modal
                const modal = document.querySelector('.beginner-mode-prompt-modal');
                if (modal) modal.remove();
                // Reload videos with A1 filter
                loadVideos();
            };

            window.speakWord = (text) => {
                window.beginnerModeController.speakWord(text);
            };

            window.replayVocabPreview = () => {
                // Replay audio for current vocab preview
                const words = document.querySelectorAll('.word-item');
                words.forEach((item, i) => {
                    setTimeout(() => {
                        const spanish = item.querySelector('.spanish').textContent;
                        window.beginnerModeController.speakWord(spanish);
                        item.classList.add('active');
                        setTimeout(() => item.classList.remove('active'), 1000);
                    }, i * 1500);
                });
            };
        }).catch(err => {
            console.warn('Beginner mode controller failed to load:', err);
        });

        import('/lib/quizModeController.js').then(module => {
            const QuizModeController = module.default;
            window.quizModeController = new QuizModeController(supabase);

            // Make quiz functions globally available
            window.startBeginnerQuiz = () => {
                // Close quiz prompt
                const prompt = document.querySelector('.quiz-prompt-modal');
                if (prompt) prompt.remove();
                // Start quiz
                window.quizModeController.startQuiz();
            };
        }).catch(err => {
            console.warn('Quiz mode controller failed to load:', err);
        });

        // Initialize gamification
        updateStreak();
        updateStatsDisplay();

        // Update global speed button with saved speed
        const globalSpeedBtn = document.getElementById('globalSpeedBtn');
        if (globalSpeedBtn) {
            globalSpeedBtn.textContent = currentPlaybackSpeed + 'x';
            // Set initial speedIndex based on saved speed
            speedIndex = speedOptions.indexOf(currentPlaybackSpeed);
            if (speedIndex === -1) speedIndex = 0;
        }

        // Auto-hide stats top bar on scroll
        let statsBarTimeout;
        const statsTopBar = document.getElementById('statsTopBar');
        // feedContainer already declared above - reuse it

        feedContainer.addEventListener('scroll', () => {
            // Show bar on scroll
            statsTopBar.classList.remove('hidden');

            // Clear previous timeout
            clearTimeout(statsBarTimeout);

            // Hide after 3 seconds
            statsBarTimeout = setTimeout(() => {
                statsTopBar.classList.add('hidden');
            }, 3000);
        });

        // ========== BEGINNER ONBOARDING SYSTEM ==========

        let beginnerTourStep = 0;

        // Check if user is a complete beginner (demo mode or first visit)
        function isBeginnerUser() {
            // Demo mode: Add ?beginner=true to URL or use demo account
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('beginner') === 'true') return true;

            // Check if this is first visit AND user level is A1
            const hasSeenTour = localStorage.getItem('hasSeenBeginnerTour');
            const userLevel = localStorage.getItem('userLevel') || 'A1';
            const videosWatched = parseInt(localStorage.getItem('videosWatched') || '0');

            return !hasSeenTour && userLevel === 'A1' && videosWatched < 3;
        }

        // Start beginner tour
        window.startBeginnerTour = function() {
            beginnerTourStep = 1;
            document.getElementById('welcomeModal').style.display = 'none';
            showBeginnerStep(1);
        };

        // Skip beginner tour
        window.skipBeginnerTour = function() {
            localStorage.setItem('hasSeenBeginnerTour', 'true');
            document.getElementById('beginnerOnboarding').style.display = 'none';
        };

        // Show specific step of beginner tour
        function showBeginnerStep(step) {
            // Hide all tooltips
            document.getElementById('speedTooltip').style.display = 'none';
            document.getElementById('difficultyTooltip').style.display = 'none';
            document.getElementById('wordsTooltip').style.display = 'none';

            // Show current step
            if (step === 1) {
                document.getElementById('speedTooltip').style.display = 'block';
            } else if (step === 2) {
                document.getElementById('difficultyTooltip').style.display = 'block';
            } else if (step === 3) {
                document.getElementById('wordsTooltip').style.display = 'block';
            }
        }

        // Move to next step
        window.nextBeginnerStep = function() {
            beginnerTourStep++;
            showBeginnerStep(beginnerTourStep);
        };

        // Finish beginner tour
        window.finishBeginnerTour = function() {
            localStorage.setItem('hasSeenBeginnerTour', 'true');
            document.getElementById('beginnerOnboarding').style.display = 'none';

            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
                padding: 24px 32px;
                border-radius: 16px;
                font-size: 18px;
                font-weight: 700;
                z-index: 9999;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                text-align: center;
            `;
            successMsg.innerHTML = 'ðŸŽ‰ You\'re all set!<br><span style="font-size: 14px; opacity: 0.9;">Start learning Spanish!</span>';
            document.body.appendChild(successMsg);

            setTimeout(() => successMsg.remove(), 2500);
        };

        // Initialize beginner onboarding if needed
        setTimeout(() => {
            const shouldShow = isBeginnerUser();
            console.log('ðŸ” Checking beginner status:', {
                shouldShow,
                urlParam: new URLSearchParams(window.location.search).get('beginner'),
                hasSeenTour: localStorage.getItem('hasSeenBeginnerTour'),
                userLevel: localStorage.getItem('userLevel') || 'A1',
                videosWatched: parseInt(localStorage.getItem('videosWatched') || '0')
            });

            if (shouldShow) {
                console.log('ðŸ‘‹ Showing beginner onboarding tour');
                const onboardingEl = document.getElementById('beginnerOnboarding');
                if (onboardingEl) {
                    onboardingEl.style.display = 'flex';
                } else {
                    console.error('âŒ beginnerOnboarding element not found!');
                }
            } else {
                console.log('â„¹ï¸ Skipping beginner tour');
            }
        }, 2000);

        console.log('ðŸŽ® Gamification initialized:', {
            streak: userStreak,
            xp: userXP,
            words: wordsLearned.size,
            videosWatched: videosWatched
        });
    </script>
</body>
</html>
