<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üé¥ Review Queue - Spaced Repetition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #fff;
        }

        /* Header */
        .header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .progress-stats {
            text-align: right;
        }

        .stats-number {
            font-size: 24px;
            font-weight: 700;
        }

        .stats-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Flashcard Container */
        .flashcard-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .flashcard {
            width: 90%;
            max-width: 500px;
            height: 400px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .flashcard-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .word-spanish {
            font-size: 48px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
        }

        .word-translation {
            font-size: 36px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .word-context {
            font-size: 18px;
            opacity: 0.8;
            text-align: center;
            font-style: italic;
        }

        .tap-to-flip {
            font-size: 14px;
            opacity: 0.6;
            margin-top: 20px;
        }

        /* Quality Buttons */
        .quality-buttons {
            padding: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .quality-button {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 120px;
        }

        .quality-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-hard {
            background: #ef4444;
            color: white;
        }

        .btn-good {
            background: #fbbf24;
            color: #1f2937;
        }

        .btn-easy {
            background: #10b981;
            color: white;
        }

        .btn-perfect {
            background: #667eea;
            color: white;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
        }

        .empty-state-icon {
            font-size: 72px;
            margin-bottom: 20px;
        }

        .empty-state-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .btn-primary {
            background: white;
            color: #667eea;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            .flashcard {
                height: 350px;
            }

            .word-spanish {
                font-size: 36px;
            }

            .word-translation {
                font-size: 28px;
            }

            .quality-buttons {
                flex-direction: column;
            }

            .quality-button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="back-button" onclick="window.location.href='/tiktok-video-feed.html'">
            ‚Üê Back
        </button>
        <div class="progress-stats">
            <div class="stats-number" id="reviewedCount">0</div>
            <div class="stats-label">reviewed today</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flashcard-container" id="flashcardContainer">
        <div class="loading" id="loadingState">
            <div class="spinner"></div>
            <div>Loading review queue...</div>
        </div>
    </div>

    <!-- Quality Rating Buttons -->
    <div class="quality-buttons" id="qualityButtons" style="display: none;">
        <button class="quality-button btn-hard" onclick="rateWord(1)">
            Again<br><small>(Hard)</small>
        </button>
        <button class="quality-button btn-good" onclick="rateWord(3)">
            Good<br><small>(1 day)</small>
        </button>
        <button class="quality-button btn-easy" onclick="rateWord(4)">
            Easy<br><small>(3 days)</small>
        </button>
        <button class="quality-button btn-perfect" onclick="rateWord(5)">
            Perfect<br><small>(7 days)</small>
        </button>
    </div>

    <script>
        let reviewQueue = [];
        let currentIndex = 0;
        let reviewedCount = 0;
        let currentWord = null;
        let isFlipped = false;
        let userId = 'anonymous_' + Date.now(); // Default anonymous user

        // Initialize
        async function init() {
            // Try to get user ID from localStorage or header
            const savedUserId = localStorage.getItem('userId');
            if (savedUserId) {
                userId = savedUserId;
            }

            await loadReviewQueue();
        }

        // Load words due for review
        async function loadReviewQueue() {
            try {
                const response = await fetch(`/api/vocabulary/review?limit=20`, {
                    headers: {
                        'x-anonymous-user-id': userId
                    }
                });

                const data = await response.json();

                if (data.success && data.words && data.words.length > 0) {
                    reviewQueue = data.words;
                    currentIndex = 0;
                    showCurrentWord();
                } else {
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading review queue:', error);
                showEmptyState();
            }
        }

        // Show current flashcard
        function showCurrentWord() {
            if (currentIndex >= reviewQueue.length) {
                showCompletionState();
                return;
            }

            currentWord = reviewQueue[currentIndex];
            isFlipped = false;

            const container = document.getElementById('flashcardContainer');
            container.innerHTML = `
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-face">
                        <div class="word-spanish">${currentWord.original_word || currentWord.lemma}</div>
                        <div class="word-context">${currentWord.context || ''}</div>
                        <div class="tap-to-flip">üëÜ Tap to reveal translation</div>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <div class="word-translation">${currentWord.translation}</div>
                        <div class="word-context">${currentWord.source || ''}</div>
                        <div class="tap-to-flip">Rate your recall below ‚¨áÔ∏è</div>
                    </div>
                </div>
            `;

            document.getElementById('loadingState')?.remove();
            document.getElementById('qualityButtons').style.display = 'none';
        }

        // Flip flashcard
        function flipCard() {
            const flashcard = document.getElementById('flashcard');
            if (!flashcard) return;

            isFlipped = !isFlipped;
            flashcard.classList.toggle('flipped');

            if (isFlipped) {
                // Show quality buttons after flipping
                setTimeout(() => {
                    document.getElementById('qualityButtons').style.display = 'flex';
                }, 300);
            } else {
                document.getElementById('qualityButtons').style.display = 'none';
            }
        }

        // Rate word quality (0-5)
        async function rateWord(quality) {
            if (!currentWord || !isFlipped) {
                alert('Please flip the card first to see the answer!');
                return;
            }

            try {
                // Update review in database
                const response = await fetch('/api/vocabulary/update-review', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-anonymous-user-id': userId
                    },
                    body: JSON.stringify({
                        word: currentWord.lemma,
                        quality: quality
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update stats
                    reviewedCount++;
                    document.getElementById('reviewedCount').textContent = reviewedCount;

                    // Move to next word
                    currentIndex++;
                    showCurrentWord();
                } else {
                    console.error('Error updating review:', data.error);
                    // Continue anyway
                    currentIndex++;
                    showCurrentWord();
                }
            } catch (error) {
                console.error('Error rating word:', error);
                // Continue anyway
                currentIndex++;
                showCurrentWord();
            }
        }

        // Show empty state (no words to review)
        function showEmptyState() {
            const container = document.getElementById('flashcardContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üéâ</div>
                    <div class="empty-state-title">All caught up!</div>
                    <div class="empty-state-text">You have no words due for review right now.</div>
                    <button class="btn-primary" onclick="window.location.href='/tiktok-video-feed.html'">
                        Learn More Words
                    </button>
                </div>
            `;
            document.getElementById('qualityButtons').style.display = 'none';
        }

        // Show completion state
        function showCompletionState() {
            const container = document.getElementById('flashcardContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚úÖ</div>
                    <div class="empty-state-title">Review Complete!</div>
                    <div class="empty-state-text">You reviewed ${reviewedCount} words today. Great work!</div>
                    <button class="btn-primary" onclick="window.location.href='/tiktok-video-feed.html'">
                        Continue Learning
                    </button>
                </div>
            `;
            document.getElementById('qualityButtons').style.display = 'none';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                flipCard();
            } else if (e.key === '1') {
                rateWord(1);
            } else if (e.key === '2') {
                rateWord(3);
            } else if (e.key === '3') {
                rateWord(4);
            } else if (e.key === '4') {
                rateWord(5);
            }
        });

        // Initialize on load
        init();
    </script>

    <!-- Bottom Navigation -->
    <script>
        fetch('/components/unified-bottom-nav.html')
            .then(r => r.text())
            .then(html => document.body.insertAdjacentHTML('beforeend', html));
    </script>
</body>
</html>

