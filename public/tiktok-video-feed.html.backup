<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Langflix - Learn Spanish Through Viral Videos</title>
    
    <!-- ðŸŽ¯ SEO & Performance Optimization -->
    <meta name="description" content="Learn Spanish naturally through viral TikTok-style videos. AI-powered adaptive learning with spaced repetition (HLR), instant translations, and gamified progress tracking.">
    <meta name="keywords" content="learn spanish, spanish videos, language learning, adaptive learning, spaced repetition, duolingo alternative">
    <meta name="theme-color" content="#000000">
    <meta name="author" content="Langflix">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="Langflix - Learn Spanish Through Viral Videos">
    <meta property="og:description" content="Master Spanish with TikTok-style videos and AI-powered learning">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/assets/og-image.jpg">
    
    <!-- Performance Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">

    <!-- BEGINNER MODE STYLES (Deferred for performance) -->
    <link rel="preload" href="/components/beginner-mode-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/components/quiz-mode-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="/components/beginner-mode-styles.css">
        <link rel="stylesheet" href="/components/quiz-mode-styles.css">
    </noscript>

    <style>
        /* CRITICAL: TikTok 2025 Exact Scroll-Snap Implementation */
        /* Research: stackoverflow.com/questions/75340067 + CSS-Tricks scroll-snap guide */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* TIKTOK-STYLE BUTTON BEHAVIOR: Remove focus outlines, all interactions via touch/click */
        button,
        input[type="button"],
        input[type="submit"],
        a {
            outline: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        button:focus,
        button:active,
        input:focus,
        input:active,
        a:focus,
        a:active {
            outline: none !important;
            box-shadow: none !important;
        }

        :root {
            /* Safe area insets for notched devices (iPhone X+, modern Android) */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
        }

        /* Main container with TikTok scroll behavior */
        .feed-container {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        .feed-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }

        /* TikTok-style fullscreen video cards */
        .video-card {
            width: 100vw;
            height: 100vh;
            position: relative;
            scroll-snap-align: start;
            scroll-snap-stop: always;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        /* Video element - fullscreen contain */
        .video-card video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        /* TikTok 2025 Subtitles - Bold Spanish + Yellow English */
        .transcription-overlay {
            position: absolute;
            bottom: 25%; /* LOWER position for better visibility - moved down from 38% */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            z-index: 10;
            display: block; /* ALWAYS VISIBLE by default (TikTok style) */
            text-align: center;
            pointer-events: auto;
        }

        .transcription-overlay.active {
            display: block;
        }

        /* Hidden state when user toggles off */
        .transcription-overlay.hidden {
            display: none;
        }

        .subtitle-container {
            position: relative;
            display: inline-block;
        }

        /* SPEED CONTROL - REMOVED (moved to sidebar) */

        /* Spanish line - TikTok 2025 Professional Style (WHITE text, THICK BLACK OUTLINE) */
        .spanish-line {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            font-size: 26px; /* Slightly larger */
            font-weight: 900; /* Maximum boldness */
            margin-bottom: 8px;
            line-height: 1.2;
            color: #ffffff; /* WHITE text */

            /* THICKER BLACK OUTLINE - Enhanced legibility (increased from 3px to 5px) */
            -webkit-text-stroke: 5px black;
            text-stroke: 5px black;
            paint-order: stroke fill;

            /* Plus shadow for depth - multiple layers for maximum visibility */
            text-shadow:
                0 2px 4px rgba(0, 0, 0, 1.0),
                0 4px 8px rgba(0, 0, 0, 0.9),
                0 0 10px rgba(0, 0, 0, 0.8),
                0 0 20px rgba(0, 0, 0, 0.6),
                0 0 30px rgba(0, 0, 0, 0.4);

            letter-spacing: 0.5px;
        }

        /* Clickable Spanish words */
        .word {
            display: inline-block;
            padding: 4px 8px;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .word:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: scale(1.05);
        }

        .word:active {
            background: rgba(255, 215, 0, 0.5);
            transform: scale(0.95);
        }

        /* English line - YELLOW text with THICK BLACK OUTLINE */
        .english-line {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            font-size: 20px;
            color: #ffeb3b !important; /* YELLOW text - force in all modes */
            font-weight: 800;
            line-height: 1.4;
            letter-spacing: 0.2px;

            /* THICKER BLACK OUTLINE - Enhanced legibility (increased from 3px to 5px) */
            -webkit-text-stroke: 5px black !important;
            text-stroke: 5px black !important;
            paint-order: stroke fill;

            /* Multiple shadow layers for maximum visibility */
            text-shadow:
                0 2px 4px rgba(0, 0, 0, 1.0),
                0 4px 8px rgba(0, 0, 0, 0.9),
                0 0 8px rgba(0, 0, 0, 0.8),
                0 0 16px rgba(0, 0, 0, 0.6),
                0 0 24px rgba(0, 0, 0, 0.4);

            /* HIDE English by default - will toggle with JavaScript */
            display: none;
            margin-top: 8px;
        }

        /* Show only ONE line at a time - TikTok style */
        /* Default: Show BOTH Spanish and English (stacked) */
        .subtitle-container .spanish-line {
            display: block;
        }

        .subtitle-container .english-line {
            display: block;
        }

        /* Toggle modes */
        .subtitle-container.spanish-only .english-line {
            display: none;
        }

        .subtitle-container.english-only .spanish-line {
            display: none;
        }

        .subtitle-container.hidden-subtitles .spanish-line,
        .subtitle-container.hidden-subtitles .english-line {
            display: none;
        }

        /* DARK MODE PROTECTION - Force black outlines and correct colors */
        @media (prefers-color-scheme: dark) {
            .spanish-line {
                color: #ffffff !important; /* WHITE text */
                -webkit-text-stroke: 5px black !important;
                text-stroke: 5px black !important;
            }

            .english-line {
                color: #ffeb3b !important; /* YELLOW text */
                -webkit-text-stroke: 5px black !important;
                text-stroke: 5px black !important;
            }
        }

        /* TikTok Right Sidebar - 54px circles, white bg 20% opacity, drop shadow */
        .sidebar {
            position: absolute;
            right: calc(12px + var(--safe-area-right));
            bottom: calc(120px + var(--safe-area-bottom));
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 15;
        }

        .sidebar-button {
            width: 54px;
            height: 54px;
            min-width: 44px; /* iOS/Android minimum touch target */
            min-height: 44px;
            border-radius: 0;
            background: transparent;
            backdrop-filter: none;
            border: none;
            color: #fff;
            font-size: 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: none;
            user-select: none;
        }

        .sidebar-button:active {
            transform: scale(0.88);
        }

        .sidebar-button.liked {
            animation: likeAnimation 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .sidebar-button.liked svg {
            fill: #fe2c55;
            stroke: #fe2c55;
        }

        @keyframes likeAnimation {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.25); }
        }

        /* PLAYBACK CONTROLS - Bottom-left near subtitles (TikTok pattern) */
        .playback-controls {
            position: absolute;
            left: calc(16px + var(--safe-area-left));
            bottom: calc(140px + var(--safe-area-bottom));
            display: flex;
            gap: 12px;
            z-index: 15;
        }

        .playback-btn {
            width: 42px;
            height: 42px;
            border-radius: 8px; /* TikTok-style: Rounded square, NOT circle */
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            border: none;
            outline: none !important; /* NO outline ever */
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .playback-btn:active {
            transform: scale(0.9);
        }

        .playback-status {
            font-size: 9px;
            font-weight: 700;
            color: #fff;
            margin-top: 2px;
        }

        .sidebar-count {
            font-size: 11px;
            margin-top: 2px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9), 0 0 8px rgba(0, 0, 0, 0.8);
        }

        /* Profile Avatar with + Follow Button (TikTok style) */
        .profile-avatar {
            position: relative;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            background: #00F5FF;
        }

        .follow-plus {
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fe2c55;
            color: #fff;
            font-size: 16px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #000;
            line-height: 1;
        }

        .sidebar-button svg {
            transition: all 0.2s ease;
            stroke: white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8));
        }

        .sidebar-button:active svg {
            transform: scale(0.9);
        }

        .sidebar-button:hover {
            transform: scale(1.1);
        }

        /* Delete button for admins */
        .delete-btn {
            background: rgba(254, 44, 85, 0.2) !important;
            border-color: rgba(254, 44, 85, 0.5) !important;
        }

        .delete-btn:hover {
            background: rgba(254, 44, 85, 0.4) !important;
        }

        /* ðŸŽ¯ GENIUS LEVEL DETECTION: Hard/Easy Button Styles */
        .too-easy-btn {
            background: rgba(76, 175, 80, 0.15) !important;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .too-easy-btn:hover {
            background: rgba(76, 175, 80, 0.3) !important;
            transform: scale(1.15) translateY(-2px);
        }

        .too-easy-btn.marked {
            background: rgba(76, 175, 80, 0.9) !important;
            animation: feedbackAnimation 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .too-easy-btn.marked svg {
            stroke: #fff;
        }

        .too-hard-btn {
            background: rgba(244, 67, 54, 0.15) !important;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .too-hard-btn:hover {
            background: rgba(244, 67, 54, 0.3) !important;
            transform: scale(1.15) translateY(2px);
        }

        .too-hard-btn.marked {
            background: rgba(244, 67, 54, 0.9) !important;
            animation: feedbackAnimation 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .too-hard-btn.marked svg {
            stroke: #fff;
        }

        @keyframes feedbackAnimation {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }

        /* Double-tap heart animation (Instagram/TikTok pattern) */
        .double-tap-heart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 120px;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
            animation: heartBurst 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes heartBurst {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }

        /* Pause/Play indicator (single tap) - PROFESSIONAL SVG */
        .pause-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0;
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            z-index: 20;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .pause-indicator svg {
            width: 40px;
            height: 40px;
            fill: white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .pause-indicator.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        /* Video info overlay - MOVED TO TOP LEFT for subtle appearance */
        .video-info {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 10;
        }

        .video-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
        }

        .video-level {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(255, 215, 0, 0.25);
            color: #ffd700;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        /* Bottom Navigation - MINIMAL PROFESSIONAL (uniform 24px icons) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 0.5px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 100;
            padding: 0 8px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px 8px;
            min-width: 44px; /* iOS/Android minimum touch target */
            min-height: 44px;
            flex: 1;
            justify-content: center;
        }

        .nav-item:active {
            transform: scale(0.9);
        }

        .nav-icon svg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
            transition: all 0.2s ease;
        }

        .nav-item:not(.active) .nav-icon svg {
            opacity: 0.6;
        }

        .nav-item.active .nav-icon svg {
            opacity: 1;
            transform: scale(1.1);
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
            opacity: 0.7;
        }

        .nav-item.active .nav-label {
            opacity: 1;
            font-weight: 700;
        }

        /* Progress bar */
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.9);
            width: 0%;
            transition: width 0.1s linear;
            z-index: 20;
        }

        /* TikTok-grade loading screen */
        .loading {
            position: fixed;
            inset: 0;
            z-index: 10001; /* Higher than achievement popups (10000) */
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
        }

        .spinner, .loading-spinner {
            width: 56px;
            height: 56px;
            border: 4px solid rgba(254, 44, 85, 0.1);
            border-top-color: #FE2C55;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.5px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        .loading-dots {
            display: flex;
            gap: 8px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #FE2C55;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1.2); opacity: 1; }
        }

        /* Word tooltip - MINIMAL TIKTOK-STYLE (80px above word) */
        .word-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            pointer-events: none;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-width: 280px;
        }

        .word-tooltip::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(0, 0, 0, 0.85);
        }

        .word-tooltip.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .word-spanish {
            font-weight: 700;
            font-size: 16px;
            color: #fff;
        }

        .word-english {
            font-size: 14px;
            color: #ffeb3b;
            font-weight: 600;
            opacity: 0.95;
        }

        .save-word-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-top: 4px;
        }

        .save-word-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .save-word-btn:active {
            transform: scale(0.95);
        }

        /* Speed Control Button */
        .speed-control {
            position: absolute;
            top: 80px;
            right: 12px;
            z-index: 15;
        }

        .speed-btn {
            width: 54px;
            height: 54px;
            min-width: 44px;
            min-height: 44px;
            border-radius: 0;
            background: transparent;
            backdrop-filter: none;
            border: none;
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: none;
            user-select: none;
        }

        .speed-btn:active {
            transform: scale(0.88);
            background: transparent;
        }

        /* Speed Menu Dropdown */
        .speed-menu {
            position: absolute;
            top: 0;
            right: 70px;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 6px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .speed-menu.show {
            display: flex;
        }

        .speed-option {
            padding: 10px 20px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            text-align: center;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .speed-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .speed-option.active {
            background: rgba(102, 126, 234, 0.9);
            color: #fff;
        }

        /* Auth Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .auth-modal.show {
            display: flex;
        }

        .auth-container {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .auth-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-input {
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            outline: none;
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #00F5FF;
        }

        .auth-button {
            padding: 14px;
            background: #00F5FF;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-button:active {
            transform: translateY(0);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .auth-toggle-link {
            color: #00F5FF;
            cursor: pointer;
            font-weight: 600;
        }

        .auth-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Profile View */
        .profile-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 999;
            display: none;
            overflow-y: auto;
            padding-bottom: 60px;
        }

        .profile-view.show {
            display: block;
        }

        .profile-header {
            padding: 60px 20px 30px;
            text-align: center;
            background: #00F5FF;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-email {
            font-size: 14px;
            opacity: 0.8;
        }

        /* LEVEL BADGE - Duolingo Style */
        .profile-level-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 20px auto 0;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            width: fit-content;
        }

        .level-badge-icon {
            font-size: 32px;
        }

        .level-badge-text {
            text-align: left;
        }

        .level-badge-level {
            font-size: 24px;
            font-weight: 900;
            color: #fff;
        }

        .level-badge-label {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* XP PROGRESS BAR */
        .profile-xp-container {
            margin: 16px 20px 0;
        }

        .profile-xp-label {
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .profile-xp-next {
            opacity: 0.7;
            font-size: 12px;
            margin-left: 8px;
        }

        .profile-xp-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .profile-xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* FREQUENCY LIST PROGRESS - Duolingo-inspired */
        .frequency-progress-container {
            margin: 24px 20px 16px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .frequency-progress-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .frequency-icon {
            font-size: 32px;
        }

        .frequency-text {
            flex: 1;
        }

        .frequency-title {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 2px;
        }

        .frequency-subtitle {
            font-size: 13px;
            opacity: 0.7;
            color: rgba(255, 255, 255, 0.8);
        }

        .frequency-stats {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin-bottom: 16px;
            padding: 16px 0;
        }

        .frequency-stat-item {
            text-align: center;
            flex: 1;
        }

        .frequency-stat-number {
            font-size: 28px;
            font-weight: 800;
            background: #00F5FF;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .frequency-stat-label {
            font-size: 12px;
            opacity: 0.8;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .frequency-stat-divider {
            width: 1px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
        }

        .frequency-progress-bar {
            height: 14px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
            position: relative;
        }

        .frequency-progress-fill {
            height: 100%;
            background: #00F5FF;
            border-radius: 12px;
            transition: width 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .frequency-progress-text {
            font-size: 13px;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            font-style: italic;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
        }

        .profile-stat {
            text-align: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .profile-stat-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .profile-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .profile-stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .profile-section {
            padding: 20px;
        }

        .profile-section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vocabulary-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .vocabulary-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vocabulary-word {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .vocabulary-translation {
            font-size: 14px;
            color: #ffeb3b;
            opacity: 0.9;
        }

        .vocabulary-context {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
            font-style: italic;
        }

        .profile-back-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .profile-logout-btn {
            margin-top: 20px;
            padding: 14px;
            background: rgba(255, 59, 48, 0.15);
            border: 1px solid rgba(255, 59, 48, 0.3);
            border-radius: 10px;
            color: #ff3b30;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        /* GAMIFICATION BAR - MINIMAL (streak only, centered, auto-hide) */
        .gamification-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .gamification-bar.hidden {
            transform: translateY(-100%);
        }

        .gamification-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .gamification-item .emoji {
            font-size: 18px;
        }

        /* MINIMAL TOP BAR - Clean and Professional */
        .stats-top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 36px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 16px;
            z-index: 100;
            pointer-events: none;
        }

        .minimal-stats {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.85);
            letter-spacing: 0.3px;
            pointer-events: auto;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 10px 18px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .minimal-stats:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.25) 0%, rgba(118, 75, 162, 0.25) 100%);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 6px 32px rgba(0, 0, 0, 0.3);
        }

        .level-badge {
            background: #00F5FF !important;
            padding: 4px 10px !important;
            border-radius: 12px !important;
            font-weight: 800 !important;
            font-size: 12px !important;
            -webkit-background-clip: initial !important;
            -webkit-text-fill-color: white !important;
            color: white !important;
        }

        .minimal-stats span {
            color: #ffffff;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 600;
        }

        /* Milestone Celebration Modal */
        .milestone-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .milestone-modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .milestone-content {
            background: #00F5FF;
            border-radius: 24px;
            padding: 40px 32px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            transform: scale(0.8);
            animation: milestonePopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes milestonePopIn {
            to {
                transform: scale(1);
            }
        }

        .milestone-emoji {
            font-size: 80px;
            margin-bottom: 16px;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .milestone-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 12px;
            color: #fff;
        }

        .milestone-message {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
        }

        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            z-index: 2001;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Practice Tab Styles */
        .practice-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: #000;
            z-index: 999;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .practice-view.show {
            display: flex;
        }

        .practice-header {
            padding: 60px 20px 20px;
            text-align: center;
            background: #00F5FF;
        }

        .practice-header h1 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .practice-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .flashcard-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .flashcard {
            width: 100%;
            max-width: 400px;
            height: 450px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            cursor: pointer;
            transition: all 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform-style: preserve-3d;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            height: 100%;
        }

        .flashcard-back {
            transform: rotateY(180deg);
        }

        .flashcard-word {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 16px;
            color: #fff;
        }

        .flashcard-translation {
            font-size: 32px;
            font-weight: 700;
            color: #ffeb3b;
            margin-bottom: 24px;
        }

        .flashcard-sentence {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            font-style: italic;
        }

        .flashcard-controls {
            display: flex;
            gap: 12px;
            padding: 20px;
            justify-content: center;
        }

        .flashcard-btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: 2px solid;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        .flashcard-btn.hard {
            background: rgba(255, 59, 48, 0.15);
            border-color: rgba(255, 59, 48, 0.5);
            color: #ff3b30;
        }

        .flashcard-btn.good {
            background: rgba(255, 204, 0, 0.15);
            border-color: rgba(255, 204, 0, 0.5);
            color: #ffcc00;
        }

        .flashcard-btn.easy {
            background: rgba(52, 199, 89, 0.15);
            border-color: rgba(52, 199, 89, 0.5);
            color: #34c759;
        }

        .flashcard-btn:active {
            transform: scale(0.95);
        }

        .practice-progress {
            padding: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Quiz Tab Styles */
        .quiz-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: #000;
            z-index: 999;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .quiz-view.show {
            display: flex;
        }

        .quiz-header {
            padding: 60px 20px 20px;
            text-align: center;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .quiz-container {
            flex: 1;
            padding: 30px 20px;
        }

        .quiz-question {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 32px 24px;
            margin-bottom: 24px;
            border: 2px solid rgba(255, 255, 255, 0.15);
        }

        .quiz-question-text {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quiz-option {
            padding: 18px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quiz-option:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(8px);
        }

        .quiz-option.correct {
            background: rgba(52, 199, 89, 0.2);
            border-color: #34c759;
            color: #34c759;
        }

        .quiz-option.incorrect {
            background: rgba(255, 59, 48, 0.2);
            border-color: #ff3b30;
            color: #ff3b30;
        }

        .quiz-score {
            text-align: center;
            padding: 40px 20px;
        }

        .quiz-score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #00F5FF;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 48px;
            font-weight: 800;
        }

        .quiz-restart-btn {
            padding: 16px 32px;
            background: #00F5FF;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Per-Video Quiz Prompt */
        .video-quiz-prompt {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px 24px;
            z-index: 1500;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 215, 0, 0.3);
            max-width: 320px;
        }

        .video-quiz-prompt.show {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .quiz-prompt-title {
            font-size: 18px;
            font-weight: 700;
            text-align: center;
        }

        .quiz-prompt-buttons {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .quiz-prompt-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            outline: none !important; /* NO outline ever - TikTok style */
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quiz-prompt-btn.primary {
            background: #00F5FF;
            color: #fff;
        }

        .quiz-prompt-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .quiz-prompt-btn:active {
            transform: scale(0.95);
        }

        /* Admin delete button - TOP-LEFT corner (subtle) */
        .admin-delete-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
            cursor: pointer;
            z-index: 150;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0.5;
        }

        .admin-delete-btn:hover {
            opacity: 1;
            background: rgba(254, 44, 85, 0.3);
            border-color: rgba(254, 44, 85, 0.5);
        }

        .admin-delete-btn:active {
            transform: scale(0.9);
        }

        /* Onboarding tooltip */
        .onboarding-tooltip {
            position: fixed;
            bottom: 145px;
            right: 80px;
            background: rgba(102, 126, 234, 0.95);
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            z-index: 200;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            white-space: nowrap;
            animation: tooltipPulse 2s infinite;
        }

        .onboarding-tooltip::after {
            content: '';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 6px solid rgba(102, 126, 234, 0.95);
        }

        @keyframes tooltipPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
<!-- ðŸš€ COMPLETE APP INTEGRATION - Priority 1 Features -->
<!-- Add this snippet to <head> of tiktok-video-feed.html before 
    <!-- Sentry Error Tracking -->
    <meta name="sentry-dsn" content="">
    <meta name="sentry-environment" content="production">
    <meta name="sentry-traces-sample-rate" content="0.1">
    <meta name="app-version" content="1.0.0">
    <script src="/lib/sentry-client.js" defer></script>
</head> -->

<!-- Confetti Library -->
<script src="/lib/confetti.min.js"></script>

<!-- Achievement System Styles -->
<link rel="stylesheet" href="/css/achievements-gamification.css">
<link rel="stylesheet" href="/css/onboarding.css">

<!-- Core Systems -->
<script src="/lib/achievement-system.js"></script>
<script src="/lib/onboarding-system.js"></script>
<script src="/lib/app-complete-integration.js"></script>

<style>
/* Additional quick-fix styles for complete app */

/* Ensure progress cards are visible */
.progress-summary {
    padding-top: calc(env(safe-area-inset-top, 0px) + 20px);
}

/* Video Controls Container */
.video-controls-enhanced button:hover {
    transform: scale(1.1);
    border-color: #00F5FF !important;
}

.video-controls-enhanced button:active {
    transform: scale(0.95);
}

/* Ensure touch targets are 44px minimum */
.video-controls-enhanced button,
.help-button,
.onboarding-action,
button {
    min-width: 44px;
    min-height: 44px;
}

/* Pull to refresh indicator */
.pull-to-refresh-indicator {
    position: fixed;
    top: calc(env(safe-area-inset-top, 0px) + 10px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: #00F5FF;
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 14px;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
}

.pull-to-refresh-indicator.visible {
    opacity: 1;
}

/* Success celebration overlay */
.success-celebration {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9998;
    pointer-events: none;
}

/* Level up animation */
@keyframes levelUp {
    0% {
        transform: scale(0) rotate(-180deg);
        opacity: 0;
    }
    50% {
        transform: scale(1.2) rotate(10deg);
        opacity: 1;
    }
    100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
    }
}

.level-up-animation {
    animation: levelUp 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
</style>

<script>
// Initialize pull-to-refresh
(function() {
    // Wait for DOM to be ready to avoid null appendChild error
    function initPullToRefresh() {
        let startY = 0;
        let pullDistance = 0;
        const threshold = 80;
        let isPulling = false;

        const indicator = document.createElement('div');
        indicator.className = 'pull-to-refresh-indicator';
        indicator.textContent = 'â†“ Pull to refresh';
        if (document.body) {
            document.body.appendChild(indicator);
        } else {
            console.warn('document.body not ready for pull-to-refresh');
            return;
        }

        document.addEventListener('touchstart', (e) => {
            const scrollTop = document.querySelector('.feed-container')?.scrollTop || 0;
            if (scrollTop === 0) {
                startY = e.touches[0].pageY;
                isPulling = true;
            }
        });

        document.addEventListener('touchmove', (e) => {
            if (!isPulling) return;

            pullDistance = e.touches[0].pageY - startY;

            if (pullDistance > 0) {
                indicator.style.opacity = Math.min(pullDistance / threshold, 1);
                if (pullDistance > threshold) {
                    indicator.textContent = 'â†‘ Release to refresh';
                    indicator.style.color = '#00AACC';
                } else {
                    indicator.textContent = 'â†“ Pull to refresh';
                    indicator.style.color = '#00F5FF';
                }
            }
        });

        document.addEventListener('touchend', () => {
            if (pullDistance > threshold) {
                indicator.textContent = 'âŸ³ Refreshing...';
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else {
                indicator.style.opacity = 0;
            }
            isPulling = false;
            pullDistance = 0;
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPullToRefresh);
    } else {
        initPullToRefresh();
    }
})();

// Dispatch custom events for video completions
// Hook into existing video event listeners
document.addEventListener('DOMContentLoaded', () => {
    // Observe video ended events
    setInterval(() => {
        const videos = document.querySelectorAll('video');
        videos.forEach(video => {
            if (!video.dataset.endListenerAdded) {
                video.addEventListener('ended', () => {
                    const event = new CustomEvent('video-completed', {
                        detail: { videoId: video.dataset.videoId || video.src }
                    });
                    document.dispatchEvent(event);
                });
                video.dataset.endListenerAdded = 'true';
            }

            // Track when video reaches 80% (considered "viewed")
            if (!video.dataset.viewListenerAdded) {
                video.addEventListener('timeupdate', function() {
                    if (this.currentTime / this.duration > 0.8 && !this.dataset.viewedTriggered) {
                        const event = new CustomEvent('video-viewed', {
                            detail: { videoId: this.dataset.videoId || this.src }
                        });
                        document.dispatchEvent(event);
                        this.dataset.viewedTriggered = 'true';
                    }
                });
                video.dataset.viewListenerAdded = 'true';
            }
        });
    }, 2000); // Check every 2 seconds for new videos
});

// Listen for word clicks (hook into existing translation popups)
document.addEventListener('click', (e) => {
    // Check if clicked on a Spanish word
    if (e.target.classList.contains('spanish-word') ||
        e.target.classList.contains('word') ||
        e.target.closest('.word-translation')) {

        const word = e.target.textContent || e.target.dataset.word;
        if (word) {
            const event = new CustomEvent('word-clicked', {
                detail: { word: word.trim() }
            });
            document.dispatchEvent(event);
        }
    }
}, true);

console.log('âœ… Complete app integration snippet loaded');
</script>
</head>
<body>
    <!-- MINIMAL TOP BAR - Clean and Professional -->
    <div class="stats-top-bar" id="statsTopBar">
        <div class="minimal-stats">
            <span class="level-badge" id="levelBadge">A2</span> Â· 
            <span id="wordsDisplay">0</span> words Â· 
            <span id="streakDisplay">0</span> day streak
        </div>
    </div>


    <!-- Global Speed Control - REMOVED (now in sidebar per video) -->

        /* BEGINNER ONBOARDING STYLES */
        .beginner-onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .beginner-welcome-modal {
            background: #000000;
            border: 2px solid #00F5FF;
            border-radius: 24px;
            padding: 40px 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 245, 255, 0.3);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .beginner-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            max-width: 280px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
            border: 2px solid rgba(255, 215, 0, 0.3);
            animation: tooltipPulse 2s ease-in-out infinite;
        }

        @keyframes tooltipPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .tooltip-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
        }

        .speed-tooltip {
            top: 100px;
            right: 80px;
        }

        .speed-tooltip .tooltip-arrow {
            right: 30px;
            top: -12px;
            border-bottom: 12px solid rgba(255, 215, 0, 0.3);
        }

        .difficulty-tooltip {
            bottom: 200px;
            right: 80px;
        }

        .difficulty-tooltip .tooltip-arrow {
            right: 30px;
            bottom: -12px;
            border-top: 12px solid rgba(255, 215, 0, 0.3);
        }

        .words-tooltip {
            bottom: 30%;
            left: 50%;
            transform: translateX(-50%);
        }

        .words-tooltip .tooltip-arrow {
            left: 50%;
            transform: translateX(-50%);
            bottom: -12px;
            border-top: 12px solid rgba(255, 215, 0, 0.3);
        }

        .tooltip-content {
            text-align: center;
            color: white;
        }

        .tooltip-next-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s ease;
        }

        .tooltip-next-btn:active {
            transform: scale(0.95);
        }
    </style>

    <!-- TikTok-grade loading screen -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading your feed</div>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>
    
    <!-- Skeleton Loading Screen (shows immediately) -->
    <div class="skeleton-screen" id="skeletonScreen" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 1;
        transition: opacity 0.3s ease-out;
    ">
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; margin-bottom: 20px; animation: pulse 1.5s ease-in-out infinite;">ðŸ“š</div>
            <div style="font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 10px;">Langflix</div>
            <div style="width: 40px; height: 40px; margin: 30px auto 0; border: 3px solid rgba(0, 245, 255, 0.2); border-top-color: #00F5FF; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        /* ðŸŽ¯ ONBOARDING TOUR STYLES */
        .onboarding-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        .onboarding-overlay.show { display: flex; }
        
        .onboarding-card {
            background: #000000;
            border: 2px solid #00F5FF;
            border-radius: 24px;
            padding: 40px 32px;
            max-width: 90%;
            width: 400px;
            text-align: center;
            animation: slideUp 0.4s ease;
            box-shadow: 0 20px 60px rgba(0, 245, 255, 0.3);
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .onboarding-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .onboarding-title {
            font-size: 28px;
            font-weight: 800;
            color: white;
            margin-bottom: 16px;
            line-height: 1.2;
        }
        
        .onboarding-description {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 32px;
        }
        
        .onboarding-progress {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }
        
        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .progress-dot.active {
            background: white;
            width: 24px;
            border-radius: 4px;
        }
        
        .onboarding-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .onboarding-btn {
            padding: 16px 32px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            max-width: 150px;
        }
        
        .onboarding-btn-primary {
            background: white;
            color: #00F5FF;
        }
        
        .onboarding-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 255, 255, 0.3);
        }
        
        .onboarding-btn-skip {
            background: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .onboarding-btn-skip:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .goal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .goal-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .goal-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .goal-option.selected {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }
        
        .goal-option-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }
        
        .goal-option-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .goal-emoji {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        /* Daily Goal Progress Bar */
        .daily-goal-progress {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 24px;
            border-radius: 24px;
            backdrop-filter: blur(10px);
            z-index: 100;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .daily-goal-progress.show { display: block; }
        
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .goal-progress-text {
            font-size: 14px;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .goal-progress-bar {
            width: 200px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
    </style>

    <!-- Onboarding Tour Overlay - REMOVED (was blocking video load) -->
    
    <!-- Daily Goal Progress -->
    <div class="daily-goal-progress" id="dailyGoalProgress">
        <div class="goal-progress-text" id="goalProgressText">0/10 min today</div>
        <div class="goal-progress-bar">
            <div class="goal-progress-fill" id="goalProgressFill" style="width: 0%"></div>
        </div>
    </div>

    <!-- Feed container with scroll-snap -->
    <h1 style="position: absolute; left: -9999px; top: -9999px;">Langflix - Learn Spanish Through Viral Videos</h1>
    <div class="feed-container" id="feedContainer">
        <!-- Video cards will be dynamically inserted here -->
    </div>

    <!-- Word translation tooltip - MINIMAL TIKTOK-STYLE -->
    <div class="word-tooltip" id="wordTooltip">
        <div class="word-spanish"></div>
        <div class="word-english"></div>
        <button class="save-word-btn" title="Save word">Save</button>
    </div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-container" style="position: relative;">
            <button class="auth-close" onclick="closeAuthModal()">Ã—</button>
            <div class="auth-header">
                <div class="auth-title" id="authTitle">Sign In</div>
                <div class="auth-subtitle">Save your progress and vocabulary</div>
            </div>
            <form class="auth-form" id="authForm" onsubmit="handleAuth(event)">
                <input type="email" class="auth-input" id="authEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="authPassword" placeholder="Password" required>
                <input type="text" class="auth-input" id="authDisplayName" placeholder="Display Name" style="display: none;">
                <button type="submit" class="auth-button" id="authSubmitBtn">Sign In</button>
            </form>
            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <span class="auth-toggle-link" onclick="toggleAuthMode()">Sign Up</span>
            </div>
        </div>
    </div>

    <!-- Profile View - REDESIGNED BEAUTIFUL UI -->
    <div class="profile-view" id="profileView">
        <!-- Modern Header with Glassmorphism -->
        <div class="profile-header-modern">
            <!-- Back Button - Top Left -->
            <button class="profile-back-btn-modern" onclick="closeProfile()" aria-label="Back" title="Back">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>

            <!-- Sign Out Button - Top Right -->
            <button class="profile-signout-btn-modern" onclick="handleLogout()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span>Sign Out</span>
            </button>

            <!-- Profile Info Card -->
            <div class="profile-card-modern">
                <div class="profile-avatar-modern" id="profileAvatar">
                    <div class="avatar-gradient"></div>
                    <span class="avatar-emoji">ðŸ‘¤</span>
                </div>
                <h2 class="profile-name-modern" id="profileName">Guest User</h2>
                <p class="profile-email-modern" id="profileEmail">guest@example.com</p>

                <!-- LEVEL BADGE - Redesigned Premium -->
                <div class="profile-level-badge-modern" id="profileLevelBadge">
                    <div class="level-badge-icon-modern">ðŸŽ¯</div>
                    <div class="level-badge-text-modern">
                        <div class="level-badge-level-modern" id="profileLevel">A1</div>
                        <div class="level-badge-label-modern">Level</div>
                    </div>
                </div>
            </div>

            <!-- XP PROGRESS BAR -->
            <div class="profile-xp-container">
                <div class="profile-xp-label">
                    <span id="profileXP">0</span> XP
                    <span class="profile-xp-next">/ <span id="profileXPNext">100</span> to level up</span>
                </div>
                <div class="profile-xp-bar">
                    <div class="profile-xp-fill" id="profileXPFill" style="width: 0%"></div>
                </div>
            </div>

            <!-- FREQUENCY LIST PROGRESS (Duolingo-style) -->
            <div class="frequency-progress-container">
                <div class="frequency-progress-header">
                    <span class="frequency-icon">ðŸ“Š</span>
                    <div class="frequency-text">
                        <div class="frequency-title">Vocabulary Journey</div>
                        <div class="frequency-subtitle">Top 10,000 Spanish Words</div>
                    </div>
                </div>
                <div class="frequency-stats">
                    <div class="frequency-stat-item">
                        <div class="frequency-stat-number" id="frequencyWordsLearned">0</div>
                        <div class="frequency-stat-label">Words Mastered</div>
                    </div>
                    <div class="frequency-stat-divider"></div>
                    <div class="frequency-stat-item">
                        <div class="frequency-stat-number" id="frequencyPosition">1-500</div>
                        <div class="frequency-stat-label">Current Range</div>
                    </div>
                </div>
                <div class="frequency-progress-bar">
                    <div class="frequency-progress-fill" id="frequencyProgressFill" style="width: 0%"></div>
                </div>
                <div class="frequency-progress-text" id="frequencyProgressText">
                    You're learning the most essential Spanish words
                </div>
            </div>
        </div>

        <div class="profile-stats">
            <div class="profile-stat">
                <div class="profile-stat-icon">ðŸ“š</div>
                <div class="profile-stat-value" id="statsWords">0</div>
                <div class="profile-stat-label">Words Learned</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-icon">ðŸ”¥</div>
                <div class="profile-stat-value" id="statsDays">0</div>
                <div class="profile-stat-label">Day Streak</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-icon">ðŸŽ¬</div>
                <div class="profile-stat-value" id="statsVideos">0</div>
                <div class="profile-stat-label">Videos Watched</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-icon">â±ï¸</div>
                <div class="profile-stat-value" id="statsTime">0m</div>
                <div class="profile-stat-label">Study Time</div>
            </div>
        </div>
        <div class="profile-section">
            <div class="profile-section-title">
                <span>ðŸ“š</span>
                <span>Saved Vocabulary</span>
            </div>
            <div class="vocabulary-list" id="vocabularyList">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“–</div>
                    <div class="empty-state-text">No words saved yet. Tap on Spanish words to save them!</div>
                </div>
            </div>
        </div>
        <div class="profile-section">
            <button class="profile-logout-btn" onclick="handleLogout()">Sign Out</button>
        </div>
    </div>

    <!-- PRACTICE VIEW - Anki-style Flashcards -->
    <div class="practice-view" id="practiceView">
        <div class="practice-header">
            <h2>ðŸ“š Practice</h2>
            <p>Master your vocabulary with flashcards</p>
        </div>
        <div class="practice-progress" id="practiceProgress">
            Loading your words...
        </div>
        <div class="flashcard-container" id="flashcardContainer">
            <!-- Flashcards will be inserted here -->
        </div>
        <div class="flashcard-controls" id="flashcardControls" style="display: none;">
            <button class="flashcard-btn hard" onclick="rateCard('hard')">Hard</button>
            <button class="flashcard-btn good" onclick="rateCard('good')">Good</button>
            <button class="flashcard-btn easy" onclick="rateCard('easy')">Easy</button>
        </div>
    </div>

    <!-- QUIZ VIEW - Complete Quiz & Practice Section -->
    <div class="quiz-view" id="quizView">
        <div class="quiz-header">
            <h2>Quiz & Practice</h2>
            <p>Test your knowledge and review flashcards</p>
        </div>

        <!-- Mode Selector: Quiz or Practice -->
        <div style="display: flex; gap: 12px; padding: 16px; justify-content: center;">
            <button onclick="showQuizMode()" style="flex: 1; padding: 12px 24px; background: #007AFF; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
                Quizzes
            </button>
            <button onclick="showPracticeMode()" style="flex: 1; padding: 12px 24px; background: #34C759; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
                Flashcards
            </button>
        </div>

        <div class="quiz-container" id="quizContainer">
            <!-- Quiz questions will be inserted here -->
        </div>

        <!-- Practice/Flashcard Container (moved from separate view) -->
        <div id="practiceContainer" style="display: none;">
            <div class="practice-progress" id="practiceProgress">
                Loading your words...
            </div>
            <div class="flashcard-container" id="flashcardContainer">
                <!-- Flashcards will be shown here -->
            </div>
            <div class="flashcard-controls" id="flashcardControls" style="display: none;">
                <button onclick="rateCard('hard')" style="background: #FF3B30;">Hard</button>
                <button onclick="rateCard('good')" style="background: #34C759;">Good</button>
                <button onclick="rateCard('easy')" style="background: #007AFF;">Easy</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation - 4 tabs: Home, Discover, Quiz, Profile -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-feed="home" onclick="switchTab('home')">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
            </div>
            <div class="nav-label">Home</div>
        </div>
        <div class="nav-item" data-feed="discover" onclick="switchTab('discover')">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            <div class="nav-label">Discover</div>
        </div>
        <div class="nav-item" data-feed="quizzes" onclick="switchTab('quizzes')">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </div>
            <div class="nav-label">Games</div>
        </div>
        <div class="nav-item" onclick="window.location.href='/refer-a-friend.html'">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <line x1="19" y1="8" x2="19" y2="14"></line>
                    <line x1="22" y1="11" x2="16" y2="11"></line>
                </svg>
            </div>
            <div class="nav-label">Refer</div>
        </div>
        <div class="nav-item" data-feed="profile" onclick="switchTab('profile')">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </div>
            <div class="nav-label">Profile</div>
        </div>
    </nav>

    <script type="module">
        // TikTok-Style Video Feed - Complete Rebuild with Supabase
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Supabase client - UPDATED CREDENTIALS
        const SUPABASE_URL = 'https://uejiwteujraxczrxbqff.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlaml3dGV1anJheGN6cnhicWZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDMxMzksImV4cCI6MjA3NTUxOTEzOX0.iva8q5bMcLHfqd6niXqB_i-i-VrPmKLNGr9eiiPwZHQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let videos = [];
        let currentVideoIndex = 0;
        let loadedVideoCount = 0;
        // PERFORMANCE OPTIMIZATION: Load minimal videos initially for <1.5s load time
        const BATCH_SIZE = 5; // Load 5 videos per batch (reduced from 10)
        const INITIAL_BATCH_SIZE = 5; // Load 5 videos initially for MVP testing (was 3 for performance)
        const WORDS_CACHE = new Map();
        let currentUser = null;
        let currentTab = 'home';
        let isAuthMode = 'signin'; // 'signin' or 'signup'
        let currentPlaybackSpeed = parseFloat(localStorage.getItem('playbackSpeed') || '1');
        let wordsLearned = new Set(JSON.parse(localStorage.getItem('wordsLearned') || '[]'));

        // GAMIFICATION STATE
        let userXP = parseInt(localStorage.getItem('userXP') || '0');
        let userStreak = parseInt(localStorage.getItem('userStreak') || '0');
        let lastActiveDate = localStorage.getItem('lastActiveDate') || null;
        let videosWatched = parseInt(localStorage.getItem('videosWatched') || '0');
        let milestonesReached = new Set(JSON.parse(localStorage.getItem('milestonesReached') || '[]'));

        // PRACTICE/FLASHCARD STATE
        let practiceCards = [];
        let currentCardIndex = 0;
        let isCardFlipped = false;

        // QUIZ STATE
        let quizQuestions = [];
        let currentQuizIndex = 0;
        let quizScore = 0;
        let videoQuizData = null;

        // ðŸŽ¯ TIKTOK-STYLE BEHAVIORAL TRACKING STATE
        let behaviorTracker = {
            videoSessions: {}, // Track watch time per video
            skipPatterns: [], // Track which videos were skipped (< 30% watched)
            completionPatterns: [], // Track which videos were completed (> 70% watched)
            interests: {}, // Track topic/level engagement
            levelSignals: [], // Track signals indicating user's actual level
            lastVideoId: null,
            lastVideoStartTime: null
        };

        // Load behavioral data from localStorage
        try {
            const savedBehavior = localStorage.getItem('behaviorTracker');
            if (savedBehavior) {
                const parsed = JSON.parse(savedBehavior);
                behaviorTracker = { ...behaviorTracker, ...parsed };
            }
        } catch (e) {
            console.log('No saved behavioral data');
        }

        // GENERATE VIDEO TITLE - Only show real description, no fake viral hooks
        function generateViralTitle(video) {
            // Option 1: Use video's actual description/title if available
            if (video.title && video.title.trim() && video.title !== 'Untitled') {
                return video.title;
            }

            // Option 2: Use first sentence from transcription as description
            if (video.transcription && video.transcription.lines && video.transcription.lines.length > 0) {
                const firstLine = video.transcription.lines[0];
                if (firstLine.spanish) {
                    // Use first Spanish sentence (up to 60 chars)
                    let title = firstLine.spanish.substring(0, 60);
                    if (firstLine.spanish.length > 60) {
                        title += '...';
                    }
                    return title;
                }
            }

            // Option 3: Generic but honest description
            return `${video.level} Spanish Lesson`;
        }

        // Load ALL 106 videos from API with PERSONALIZED FEED ALGORITHM
        async function loadVideos() {
            try {
                console.log('ðŸ§  Loading with research-backed algorithms...');
                
                // Try research-backed API first
                let allVideos;
                if (window.researchFeed) {
                    const feedData = await window.researchFeed.loadPersonalizedFeed(50);
                    allVideos = feedData.feed || [];
                    console.log(`âœ… Research feed: ${allVideos.length} videos (${feedData.userProfile?.personalizationStage || 'unknown'} stage)`);
                }
                
                // Fallback to legacy API if research feed fails
                if (!allVideos || allVideos.length === 0) {
                    console.log('ðŸ“¡ Using legacy API as fallback...');
                    const response = await fetch('/api/videos?includeTranscript=true');
                    const data = await response.json();
                    // Extract videos array from catalog structure
                    allVideos = data.videos || data;
                    // ðŸš¨ FILTER: Prefer /videos/reels/ for best browser compatibility
                    // Keep /langfeed/reels/ as backup (may work in production browsers)
                    const reelsVideos = allVideos.filter(v => v.videoUrl && v.videoUrl.match(/\/videos\/reels\//));
                    const langfeedReelsVideos = allVideos.filter(v => v.videoUrl && v.videoUrl.match(/\/langfeed\/reels\//));

                    // Use reels first, fallback to langfeed/reels if needed
                    allVideos = reelsVideos.length >= 50 ? reelsVideos : [...reelsVideos, ...langfeedReelsVideos];
                    console.log(`âœ… Loaded ${allVideos.length} videos (${reelsVideos.length} optimal + ${langfeedReelsVideos.length} fallback)`);
                }

                // Apply legacy personalization as additional layer
                videos = await getPersonalizedFeed(allVideos);

                console.log(`ðŸŽ¯ Final personalized feed: ${videos.length} videos`);

                // ðŸš¨ DISABLED: Too aggressive - was filtering out ALL videos
                // Most videos don't have full transcription objects yet, but they work fine
                // videos = videos.filter(v => v.transcription?.lines?.length > 0);
                console.log(`âœ… Loaded ${videos.length} videos (transcription filter disabled)`);

                // ðŸ—‘ï¸ Filter out permanently deleted videos from localStorage
                const deletedVideos = JSON.parse(localStorage.getItem('deletedVideos') || '[]');
                if (deletedVideos.length > 0) {
                    const beforeDeleteFilter = videos.length;
                    videos = videos.filter(v => !deletedVideos.includes(v.id));
                    console.log(`âœ… Filtered out ${beforeDeleteFilter - videos.length} deleted videos`);
                }

                // ðŸ”„ Filter out videos being retranscribed (hide until retranscription complete)
                const retranscribingVideos = JSON.parse(localStorage.getItem('retranscribingVideos') || '[]');
                if (retranscribingVideos.length > 0) {
                    const beforeRetranscribeFilter = videos.length;
                    videos = videos.filter(v => !retranscribingVideos.includes(v.id));
                    console.log(`âœ… Filtered out ${beforeRetranscribeFilter - videos.length} videos being retranscribed`);
                }

                // Hide loading
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
                
                // Hide skeleton screen
                const skeletonEl = document.getElementById('skeletonScreen');
                if (skeletonEl) {
                    skeletonEl.style.transition = 'opacity 0.3s ease-out';
                    skeletonEl.style.opacity = '0';
                    setTimeout(() => skeletonEl.remove(), 300);
                }

                // Render first batch immediately (larger initial batch)
                console.log(`ðŸŽ¬ Calling renderVideosBatch(0, ${INITIAL_BATCH_SIZE}) with ${videos.length} videos loaded`);
                renderVideosBatch(0, INITIAL_BATCH_SIZE);
                console.log('âœ… renderVideosBatch completed');

                // Setup intersection observer for autoplay and infinite scroll
                setupIntersectionObserver();
                console.log('âœ… setupIntersectionObserver completed');

            } catch (error) {
                console.error('âŒ Error loading videos:', error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: white;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“¡</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px;">Connection Error</h3>
                            <p style="font-size: 14px; opacity: 0.8; margin-bottom: 24px;">
                                Unable to load videos. Please check your connection and try again.
                            </p>
                            <button onclick="location.reload()" style="
                                background: #00F5FF;
                                color: white;
                                border: none;
                                padding: 12px 32px;
                                border-radius: 24px;
                                font-size: 16px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                                Retry
                            </button>
                        </div>
                    `;
                }
            }
        }

        // SMART VIDEO RECOMMENDATION ALGORITHM with spaced repetition + behavioral tracking
        async function getPersonalizedFeed(allVideos) {
            if (!Array.isArray(allVideos)) {
                allVideos = [];
            }

            const appOrigin = window.location.origin;
            const originHost = (() => {
                try {
                    const parsed = new URL(appOrigin);
                    return parsed.host;
                } catch (err) {
                    return null;
                }
            })();

            allVideos = allVideos
                .map((video, index) => {
                    const normalized = { ...video };
                    normalized.id = normalized.id || `video_${index}`;
                    normalized.level = normalized.level || normalized.cefr || 'A1';

                    const candidateUrls = [
                        normalized.videoUrl,
                        normalized.url,
                        normalized.path,
                        normalized.video_path,
                        normalized.streamUrl,
                        normalized.stream_url,
                        normalized.playbackUrl,
                        normalized.playback_url
                    ].filter(Boolean);

                    let videoUrl = candidateUrls.find(Boolean);

                    if (videoUrl) {
                        if (typeof videoUrl === 'string') {
                            videoUrl = videoUrl.replace(/\\/g, '/');

                            if (videoUrl.startsWith('http://localhost') || videoUrl.startsWith('https://localhost')) {
                                try {
                                    const parsed = new URL(videoUrl);
                                    videoUrl = parsed.pathname + parsed.search + parsed.hash;
                                } catch (err) {
                                    // leave as-is
                                }
                            } else if (originHost && videoUrl.startsWith('http')) {
                                try {
                                    const parsed = new URL(videoUrl);
                                    if (parsed.host === originHost) {
                                        videoUrl = parsed.pathname + parsed.search + parsed.hash;
                                    }
                                } catch (err) {
                                    // leave as-is
                                }
                            } else if (!videoUrl.startsWith('http')) {
                                if (!videoUrl.startsWith('/')) {
                                    videoUrl = `/videos/${videoUrl.replace(/^videos\//i, '')}`;
                                } else if (!videoUrl.startsWith('/videos/')) {
                                    videoUrl = `/videos${videoUrl}`;
                                }
                            }
                        }
                    }

                    normalized.videoUrl = videoUrl || null;
                    normalized.path = normalized.path || (typeof videoUrl === 'string' && !videoUrl.startsWith('http') ? videoUrl : normalized.path);
                    normalized.thumbnail = normalized.thumbnail || normalized.thumbnailUrl || normalized.previewImage || normalized.coverImage || null;

                    if (!normalized.title) {
                        normalized.title = normalized.name || normalized.spanish || 'Spanish Learning Video';
                    }

                    return normalized;
                })
                .filter(video => {
                    if (!video.videoUrl) {
                        console.warn('âš ï¸ Skipping video without playable URL', video);
                        return false;
                    }
                    return true;
                });

            console.log(`ðŸŽ¥ Normalized ${allVideos.length} videos with playable URLs`);

            // Get user's level from localStorage or user metadata
            let userLevel = localStorage.getItem('userLevel') || 'A1';

            if (currentUser && currentUser.user_metadata && currentUser.user_metadata.level) {
                userLevel = currentUser.user_metadata.level;
            }

            console.log(`ðŸ‘¤ User level: ${userLevel}`);

            // ðŸŽ¯ CRITICAL: Load persistent watch history from localStorage (for all users, even non-signed in)
            const persistentWatchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '[]');
            const persistentCompletedVideos = JSON.parse(localStorage.getItem('completedVideos') || '[]');
            const persistentSkippedVideos = JSON.parse(localStorage.getItem('skippedVideos') || '[]');

            console.log(`ðŸ“Š Persistent history: ${persistentWatchedVideos.length} watched, ${persistentCompletedVideos.length} completed, ${persistentSkippedVideos.length} skipped`);

            // Merge in-memory behavioral tracking with persistent localStorage
            const allWatchedIds = new Set([
                ...persistentWatchedVideos,
                ...persistentCompletedVideos,
                ...Object.keys(behaviorTracker.videoSessions)
            ]);

            const allCompletedIds = new Set([
                ...persistentCompletedVideos,
                ...behaviorTracker.completionPatterns.map(p => p.videoId)
            ]);

            const allSkippedIds = new Set([
                ...persistentSkippedVideos,
                ...behaviorTracker.skipPatterns.map(p => p.videoId)
            ]);

            // ðŸŽ¯ TIKTOK-STYLE FILTERING: Hide watched videos and frequently skipped ones
            if (allWatchedIds.size > 0 || allSkippedIds.size > 0 || allCompletedIds.size > 0) {
                const skippedVideoIds = allSkippedIds;
                const completedVideoIds = allCompletedIds;
                const watchedVideoIds = allWatchedIds;

                // Filter out watched videos (TikTok behavior - never show same video twice)
                allVideos = allVideos.filter(v => {
                    // Check if video was completed (watched >70%)
                    if (completedVideoIds.has(v.id)) {
                        return false; // Hide completely watched videos
                    }

                    // Check if video has significant watch time (>30% or >10s)
                    const session = behaviorTracker.videoSessions[v.id];
                    if (session && session.totalWatchTime > 10000) {
                        return false; // Hide videos with significant watch time
                    }

                    // Filter out frequently skipped videos (user doesn't like them)
                    const skipCount = behaviorTracker.skipPatterns.filter(p => p.videoId === v.id).length;
                    if (skipCount >= 2) {
                        return false; // If skipped 2+ times, hide it
                    }

                    return true; // Show only fresh, unwatched videos
                });

                console.log(`ðŸŽ¯ TikTok-style filtering: ${completedVideoIds.size} completed hidden, ${skippedVideoIds.size} skipped, ${allVideos.length} fresh videos remaining`);
            }

            // Define level hierarchy for filtering
            const levelOrder = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            const userLevelIndex = levelOrder.indexOf(userLevel);

            // Filter videos by user level: 70% at level, 20% easier, 10% harder
            const atLevelVideos = [];
            const easierVideos = [];
            const harderVideos = [];

            allVideos.forEach(video => {
                const videoLevel = video.level || 'A1';
                const videoLevelIndex = levelOrder.indexOf(videoLevel);

                if (videoLevelIndex === userLevelIndex) {
                    atLevelVideos.push(video);
                } else if (videoLevelIndex < userLevelIndex) {
                    easierVideos.push(video);
                } else {
                    harderVideos.push(video);
                }
            });

            console.log(`ðŸ“Š Video distribution - At level (${userLevel}): ${atLevelVideos.length}, Easier: ${easierVideos.length}, Harder: ${harderVideos.length}`);

            // Calculate target counts: 70% at level, 20% easier, 10% harder
            const totalVideos = allVideos.length;
            const targetAtLevel = Math.ceil(totalVideos * 0.7);
            const targetEasier = Math.ceil(totalVideos * 0.2);
            const targetHarder = totalVideos - targetAtLevel - targetEasier;

            // ðŸŽ¯ GENIUS DIFFICULTY SORTING: Sort by actual difficulty score (easiest first)
            // This ensures complete beginners see the EASIEST videos first
            const sortByDifficulty = (videos) => {
                return videos.sort((a, b) => {
                    const scoreA = a.difficulty?.difficultyScore || 50;
                    const scoreB = b.difficulty?.difficultyScore || 50;
                    return scoreA - scoreB; // Ascending (easiest first)
                });
            };

            // Sort each category by difficulty
            const sortedAtLevel = sortByDifficulty([...atLevelVideos]);
            const sortedEasier = sortByDifficulty([...easierVideos]);
            const sortedHarder = sortByDifficulty([...harderVideos]);

            // For COMPLETE BEGINNERS (A1): Show easiest videos first, NO shuffling
            if (userLevel === 'A1') {
                console.log('ðŸŽ“ BEGINNER MODE: Showing easiest videos first (no shuffling)');
                const selectedAtLevel = sortedAtLevel.slice(0, Math.min(targetAtLevel, sortedAtLevel.length));
                const selectedEasier = sortedEasier.slice(0, Math.min(targetEasier, sortedEasier.length));
                const selectedHarder = sortedHarder.slice(0, Math.min(targetHarder, sortedHarder.length));

                // Combine: easiest at-level first, then easier, then harder
                let personalizedFeed = [...selectedAtLevel, ...selectedEasier, ...selectedHarder];
                return personalizedFeed;
            }

            // For intermediate/advanced: Mix with some shuffling for variety
            const selectedAtLevel = shuffle(sortedAtLevel.slice(0, Math.ceil(atLevelVideos.length * 0.7)));
            const selectedEasier = shuffle(sortedEasier.slice(0, Math.ceil(easierVideos.length * 0.2)));
            const selectedHarder = shuffle(sortedHarder.slice(0, Math.ceil(harderVideos.length * 0.1)));

            // If not enough videos at user's level, backfill with others
            let personalizedFeed = [...selectedAtLevel, ...selectedEasier, ...selectedHarder];

            if (personalizedFeed.length < totalVideos) {
                const remaining = shuffle(allVideos.filter(v => !personalizedFeed.includes(v)));
                personalizedFeed = [...personalizedFeed, ...remaining].slice(0, totalVideos);
            }

            // NOW apply vocabulary-based personalization if user is logged in
            if (currentUser) {
                try {
                    // Get user's saved words from vocabulary
                    const { data: vocabulary, error } = await supabase
                        .from('vocabulary')
                        .select('word, created_at')
                        .eq('user_id', currentUser.id);

                    if (!error && vocabulary && vocabulary.length > 0) {
                        const learnedWords = vocabulary.map(v => v.word.toLowerCase());
                        console.log(`ðŸ“š User has ${learnedWords.length} saved words`);

                        // Separate level-appropriate videos by learned words
                        const reviewVideos = [];
                        const newVideos = [];

                        personalizedFeed.forEach(video => {
                            if (!video.transcription || !video.transcription.lines) {
                                newVideos.push(video);
                                return;
                            }

                            const hasLearnedWord = video.transcription.lines.some(line => {
                                if (!line.spanish) return false;
                                const words = line.spanish.toLowerCase().split(/\s+/);
                                return words.some(word => {
                                    const cleanWord = word.replace(/[Â¿Â¡.,!?]/g, '');
                                    return learnedWords.includes(cleanWord);
                                });
                            });

                            if (hasLearnedWord) {
                                reviewVideos.push(video);
                            } else {
                                newVideos.push(video);
                            }
                        });

                        console.log(`ðŸ”„ Review: ${reviewVideos.length}, ðŸ†• New: ${newVideos.length}`);

                        // Mix: 70% new vocabulary, 30% review (spaced repetition)
                        const numReview = Math.min(Math.ceil(personalizedFeed.length * 0.3), reviewVideos.length);
                        const numNew = personalizedFeed.length - numReview;

                        const selectedReview = shuffle(reviewVideos).slice(0, numReview);
                        const selectedNew = shuffle(newVideos).slice(0, numNew);

                        // Interleave: 2 new, 1 review pattern
                        personalizedFeed = [];
                        let newIndex = 0, reviewIndex = 0;

                        while (newIndex < selectedNew.length || reviewIndex < selectedReview.length) {
                            if (newIndex < selectedNew.length) personalizedFeed.push(selectedNew[newIndex++]);
                            if (newIndex < selectedNew.length) personalizedFeed.push(selectedNew[newIndex++]);
                            if (reviewIndex < selectedReview.length) personalizedFeed.push(selectedReview[reviewIndex++]);
                        }
                    }
                } catch (err) {
                    console.warn('Vocabulary personalization error:', err);
                }
            }

            console.log(`âœ¨ Personalized feed: ${personalizedFeed.length} videos (Level: ${userLevel}, Mix: at-level + easier + harder + vocabulary)`);
            return personalizedFeed;
        }

        // Shuffle array (Fisher-Yates algorithm)
        function shuffle(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Render videos in batches (performance optimization)
        function renderVideosBatch(startIndex, count) {
            console.log(`ðŸ“º renderVideosBatch: start=${startIndex}, count=${count}, total videos=${videos.length}`);
            const feedContainer = document.getElementById('feedContainer');

            if (!feedContainer) {
                console.error('âŒ feedContainer not found!');
                return;
            }

            const endIndex = Math.min(startIndex + count, videos.length);
            console.log(`ðŸ“¦ Will render videos ${startIndex} to ${endIndex}`);

            for (let i = startIndex; i < endIndex; i++) {
                const card = createVideoCard(videos[i], i);
                if (card) {
                    feedContainer.appendChild(card);
                }
            }

            loadedVideoCount = endIndex;
            console.log(`ðŸ“Š Loaded ${loadedVideoCount}/${videos.length} videos`);
        }

        // Create a single video card
        function createVideoCard(video, index) {
            if (!video || !video.videoUrl) {
                console.warn('âš ï¸ Attempted to render video without playable URL', video);
                return null;
            }

            const card = document.createElement('div');
            card.className = 'video-card';
            card.dataset.index = index;
            card.dataset.id = video.id;

            // Video element
            const videoEl = document.createElement('video');
            videoEl.src = video.videoUrl;
            videoEl.loop = false;
            videoEl.muted = false; // Start unmuted (will be managed by user interaction)
            videoEl.playsinline = true;
            videoEl.autoplay = true; // TIKTOK-STYLE: Instant autoplay when video is in viewport

            // PERFORMANCE OPTIMIZATION: Lazy load videos for faster initial load
            // Only first video gets full preload, rest load on-demand
            if (index === 0) {
                videoEl.preload = 'auto'; // Fully load ONLY first video
            } else if (index <= 2) {
                videoEl.preload = 'metadata'; // Metadata for next 2 videos (fast preload)
            } else {
                videoEl.preload = 'none'; // No preload for others (load on scroll)
            }

            // Apply saved playback speed - read directly from localStorage to ensure freshness
            const savedSpeed = parseFloat(localStorage.getItem('playbackSpeed') || '1');
            videoEl.playbackRate = savedSpeed;
            console.log(`ðŸŽ¬ Video #${index} created with speed ${savedSpeed}x (from localStorage)`);

            // Auto-advance to next video OR x2 mode (TikTok behavior)
            videoEl.addEventListener('ended', () => {
                // Track video completion
                trackVideoWatched(video.id);
                
                // ðŸ§  RESEARCH: Track completion (TikTok 4-point event)
                if (window.researchFeed) {
                    window.researchFeed.trackVideoComplete(video, videoEl.currentTime, videoEl.duration);
                }

                // Check if x2 mode is enabled for this video
                const x2Btn = card.querySelector('.x2-btn');
                const isX2Active = x2Btn && x2Btn.classList.contains('x2-active');
                const x2FirstPlay = x2Btn && x2Btn.dataset.firstPlayDone !== 'true';

                if (isX2Active && x2FirstPlay) {
                    // First playthrough done - now play again with transcript only
                    x2Btn.dataset.firstPlayDone = 'true';
                    x2Btn.querySelector('.x2-status').textContent = '2nd';

                    // Hide subtitles overlay, keep transcript
                    const subtitlesOverlay = card.querySelector('.subtitles-overlay');
                    if (subtitlesOverlay) {
                        subtitlesOverlay.style.display = 'none';
                    }

                    // Restart video
                    videoEl.currentTime = 0;
                    videoEl.play();
                    console.log('ðŸ” x2 mode: Second playthrough (transcript only)');
                } else if (isX2Active && !x2FirstPlay) {
                    // Second playthrough done - reset and advance
                    x2Btn.classList.remove('x2-active');
                    x2Btn.dataset.firstPlayDone = 'false';
                    x2Btn.querySelector('.x2-status').textContent = 'Off';
                    x2Btn.style.background = '';

                    // Show subtitles again for next video
                    const subtitlesOverlay = card.querySelector('.subtitles-overlay');
                    if (subtitlesOverlay) {
                        subtitlesOverlay.style.display = '';
                    }

                    // Auto-advance to next video
                    const nextCard = card.nextElementSibling;
                    if (nextCard && nextCard.classList.contains('video-card')) {
                        nextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else if (loadedVideoCount < videos.length) {
                        renderVideosBatch(loadedVideoCount, BATCH_SIZE);
                        setTimeout(() => {
                            const newNextCard = card.nextElementSibling;
                            if (newNextCard) {
                                newNextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 100);
                    }
                }
            });

            // Transcription overlay (clean, no speed control - moved to global button)
            const transcriptionOverlay = document.createElement('div');
            transcriptionOverlay.className = 'transcription-overlay';
            transcriptionOverlay.innerHTML = `
                <div class="subtitle-container">
                    <div class="spanish-line"></div>
                    <div class="english-line"></div>
                </div>
            `;

            // Video info with GENIUS difficulty badge
            const videoInfo = document.createElement('div');
            videoInfo.className = 'video-info';

            // Get difficulty data
            const difficultyScore = video.difficulty?.difficultyScore || 50;
            const cefrLevel = video.difficulty?.cefrLevel || video.level;

            // CEFR level colors (matching Duolingo/Memrise 2025)
            const levelColors = {
                'A1': { bg: '#58cc02', text: '#000', label: 'Beginner' },
                'A2': { bg: '#00cd9c', text: '#000', label: 'Elementary' },
                'B1': { bg: '#0095f6', text: '#fff', label: 'Intermediate' },
                'B2': { bg: '#00F5FF', text: '#fff', label: 'Upper-Int' },
                'C1': { bg: '#00AACC', text: '#fff', label: 'Advanced' },
                'C2': { bg: '#ff3b5c', text: '#fff', label: 'Mastery' }
            };

            const levelStyle = levelColors[cefrLevel] || levelColors['B1'];

            // Subtle, minimal badge - top-left position
            videoInfo.innerHTML = `
                <div class="difficulty-badge" style="
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    color: rgba(255, 255, 255, 0.95);
                    padding: 6px 12px;
                    border-radius: 12px;
                    font-size: 13px;
                    font-weight: 600;
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                ">
                    <span style="font-size: 13px; opacity: 0.9;">${cefrLevel}</span>
                </div>
            `;

            // Speed Control
            const speedControl = document.createElement('div');
            speedControl.className = 'speed-control';
            speedControl.innerHTML = `
                <button class="speed-btn" onclick="event.stopPropagation(); toggleSpeedMenu(this.closest('.video-card'))">
                    ${currentPlaybackSpeed}x
                </button>
                <div class="speed-menu">
                    <div class="speed-option ${currentPlaybackSpeed === 0.5 ? 'active' : ''}" onclick="event.stopPropagation(); changeSpeed(0.5)">0.5x</div>
                    <div class="speed-option ${currentPlaybackSpeed === 0.75 ? 'active' : ''}" onclick="event.stopPropagation(); changeSpeed(0.75)">0.75x</div>
                    <div class="speed-option ${currentPlaybackSpeed === 1 ? 'active' : ''}" onclick="event.stopPropagation(); changeSpeed(1)">1x</div>
                    <div class="speed-option ${currentPlaybackSpeed === 1.25 ? 'active' : ''}" onclick="event.stopPropagation(); changeSpeed(1.25)">1.25x</div>
                    <div class="speed-option ${currentPlaybackSpeed === 1.5 ? 'active' : ''}" onclick="event.stopPropagation(); changeSpeed(1.5)">1.5x</div>
                </div>
            `;

            // Sidebar buttons - REORDERED: x2 (top), speed, like, comment, delete (bottom)
            const sidebar = document.createElement('div');
            sidebar.className = 'sidebar';
            // TIKTOK-STYLE SIDEBAR - Only level feedback (minimal, clean)
            sidebar.innerHTML = `
                <!-- ðŸŽ¯ LEVEL DETECTION: Difficulty Feedback -->
                <button class="sidebar-button too-easy-btn" onclick="event.stopPropagation(); markVideoEasy('${video.id}', '${cefrLevel}', ${difficultyScore}, this);" title="This is too easy - Show me harder content" aria-label="Too Easy">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                    <span class="sidebar-count" style="font-size: 11px; font-weight: 700;">Too Easy</span>
                </button>

                <button class="sidebar-button too-hard-btn" onclick="event.stopPropagation(); markVideoHard('${video.id}', '${cefrLevel}', ${difficultyScore}, this);" title="This is too hard - Show me easier content" aria-label="Too Hard">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M12 5v14M19 12l-7 7-7-7"/>
                    </svg>
                    <span class="sidebar-count" style="font-size: 11px; font-weight: 700;">Too Hard</span>
                </button>
                
                <!-- Share Button (for viral growth) -->
                <button class="sidebar-button share-btn" onclick="event.stopPropagation(); shareVideo('${video.id}', '${video.videoUrl}');" title="Share this video" aria-label="Share">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"/>
                        <circle cx="6" cy="12" r="3"/>
                        <circle cx="18" cy="19" r="3"/>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                    </svg>
                    <span class="sidebar-count" style="font-size: 10px;">Share</span>
                </button>

                <!-- More Options (Delete, Report) -->
                <button class="sidebar-button more-btn" onclick="event.stopPropagation(); showVideoOptions('${video.id}', '${video.videoUrl}', this);" title="More options" aria-label="More">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1" fill="currentColor"/>
                        <circle cx="12" cy="5" r="1" fill="currentColor"/>
                        <circle cx="12" cy="19" r="1" fill="currentColor"/>
                    </svg>
                    <span class="sidebar-count" style="font-size: 10px;">More</span>
                </button>
            `;

            // PLAYBACK CONTROLS - Bottom-left near subtitles (TikTok pattern)
            const playbackControls = document.createElement('div');
            playbackControls.className = 'playback-controls';
            playbackControls.innerHTML = `
                <button class="playback-btn x2-btn" onclick="event.stopPropagation(); toggleX2Mode(this);" title="Watch twice" aria-label="x2 mode">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <text x="6" y="18" font-size="12" fill="currentColor" stroke="none" font-weight="bold">x2</text>
                        <circle cx="12" cy="12" r="10" stroke-width="2"/>
                    </svg>
                    <span class="playback-status x2-status">Off</span>
                </button>
                <button class="playback-btn speed-btn" onclick="event.stopPropagation(); cycleSpeed();" title="Speed control" aria-label="Playback speed">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polygon points="10 8 16 12 10 16 10 8"/>
                    </svg>
                    <span class="playback-status speed-display">${currentPlaybackSpeed}x</span>
                </button>
                <button class="playback-btn translate-btn" onclick="event.stopPropagation(); toggleTranslation(this);" title="Toggle translation" aria-label="Translation">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 8h6m-2 0v10M6 18h8M15 8h.01M17 12h.01M21 16h.01"/>
                        <path d="m13 16 2-2 2 2"/>
                        <path d="M11 8l2 2 2-2"/>
                    </svg>
                    <span class="playback-status translate-status">EN</span>
                </button>
            `;

            // Admin delete button - TOP-LEFT corner (separate from sidebar)
            let adminDeleteBtn = null;
            if (currentUser?.role === 'admin') {
                adminDeleteBtn = document.createElement('button');
                adminDeleteBtn.className = 'admin-delete-btn';
                adminDeleteBtn.setAttribute('aria-label', 'Delete Video');
                adminDeleteBtn.dataset.videoId = video.id;
                adminDeleteBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                `;
            }

            // Progress bar
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';

            // Pause indicator - PROFESSIONAL SVG (NOT EMOJI)
            const pauseIndicator = document.createElement('div');
            pauseIndicator.className = 'pause-indicator';
            pauseIndicator.innerHTML = `
                <svg viewBox="0 0 24 24">
                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                </svg>
            `;
            pauseIndicator.dataset.state = 'pause';

            // Assemble card
            card.appendChild(videoEl);
            card.appendChild(transcriptionOverlay);
            card.appendChild(videoInfo);
            card.appendChild(playbackControls); // NEW: Playback controls bottom-left
            card.appendChild(sidebar);
            card.appendChild(progressBar);
            card.appendChild(pauseIndicator);
            if (adminDeleteBtn) {
                card.appendChild(adminDeleteBtn);
            }

            // Setup interactions
            setupTouchInteractions(card, videoEl, video);
            setupTranscriptions(videoEl, video.transcription, transcriptionOverlay);
            setupSidebarActions(sidebar, video, adminDeleteBtn);
            setupVideoProgress(videoEl, progressBar);

            return card;
        }

        // Setup touch interactions (TikTok pattern)
        // Single tap = pause/play, Double tap = like
        function setupTouchInteractions(card, videoEl, videoData) {
            let tapCount = 0;
            let tapTimer = null;
            const pauseIndicator = card.querySelector('.pause-indicator');
            const likeBtn = card.querySelector('.like-btn');

            card.addEventListener('click', (e) => {
                // Ignore clicks on buttons and words
                if (e.target.closest('.sidebar-button') ||
                    e.target.closest('.word') ||
                    e.target.closest('.nav-item')) {
                    return;
                }

                tapCount++;

                if (tapCount === 1) {
                    // Wait to see if it's a double tap
                    tapTimer = setTimeout(() => {
                        // Single tap - pause/play with professional SVG
                        if (videoEl.paused) {
                            videoEl.play();
                            // Play icon SVG
                            pauseIndicator.innerHTML = `
                                <svg viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            `;
                        } else {
                            videoEl.pause();
                            // Pause icon SVG
                            pauseIndicator.innerHTML = `
                                <svg viewBox="0 0 24 24">
                                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                                </svg>
                            `;
                        }

                        // Show pause indicator with smooth animation
                        pauseIndicator.classList.add('show');
                        setTimeout(() => pauseIndicator.classList.remove('show'), 600);

                        tapCount = 0;
                    }, 300);
                } else if (tapCount === 2) {
                    // Double tap - like
                    clearTimeout(tapTimer);

                    // Show double-tap heart animation
                    const heart = document.createElement('div');
                    heart.className = 'double-tap-heart';
                    heart.textContent = 'â¤ï¸';
                    card.appendChild(heart);

                    // Remove heart after animation
                    setTimeout(() => heart.remove(), 800);

                    // Toggle like button
                    likeBtn.classList.add('liked');

                    tapCount = 0;
                }
            });
        }

        // Setup synchronized transcriptions with video.currentTime
        function setupTranscriptions(videoEl, transcription, overlay) {
            if (!transcription || !transcription.lines || transcription.lines.length === 0) {
                console.warn('No transcription data available');
                return;
            }

            const spanishLine = overlay.querySelector('.spanish-line');
            const englishLine = overlay.querySelector('.english-line');
            let currentLineIndex = -1;

            videoEl.addEventListener('timeupdate', () => {
                const currentTime = videoEl.currentTime;

                // Find active transcription line - FIXED: proper timing comparison
                const activeLineIndex = transcription.lines.findIndex(line => {
                    const start = parseFloat(line.startTime);
                    const end = parseFloat(line.endTime);

                    // Validate timing values
                    if (isNaN(start) || isNaN(end)) {
                        console.warn('Invalid timing:', line);
                        return false;
                    }

                    // CRITICAL FIX: Use >= for start and <= for end (inclusive range)
                    return currentTime >= start && currentTime <= end;
                });

                // Only update DOM when line changes (prevents flashing)
                if (activeLineIndex !== currentLineIndex) {
                    currentLineIndex = activeLineIndex;

                    if (activeLineIndex >= 0) {
                        const activeLine = transcription.lines[activeLineIndex];
                        const subtitleContainer = overlay.querySelector('.subtitle-container');

                        // Debug logging
                        if (window.DEBUG_SUBTITLES) {
                            console.log(`[${currentTime.toFixed(2)}s] Showing subtitle:`, activeLine.spanish);
                        }

                        // Make Spanish words clickable
                        const words = (activeLine.spanish || '').split(' ');
                        spanishLine.innerHTML = words.map((word, i) =>
                            `<span class="word" data-word="${word}" data-english="${activeLine.english || ''}">${word}</span>`
                        ).join(' ');

                        // Set English translation
                        englishLine.textContent = activeLine.english || '';

                        // Show BOTH Spanish and English by default
                        subtitleContainer.className = 'subtitle-container';

                        // Show overlay
                        overlay.classList.add('active');

                        // Add click handlers to words
                        spanishLine.querySelectorAll('.word').forEach(wordEl => {
                            wordEl.addEventListener('click', (e) => {
                                e.stopPropagation();
                                // Show translation tooltip when word is clicked
                                showWordTranslation(wordEl, activeLine.spanish, videoEl);
                            });
                        });
                    } else {
                        // Hide overlay when no active line
                        overlay.classList.remove('active');
                    }
                }
            });
        }

        // Show word translation tooltip WITHOUT requiring sign-in
        // Only require sign-in when user wants to SAVE the word
        async function showWordTranslation(wordEl, contextSentence, videoEl) {
            const tooltip = document.getElementById('wordTooltip');
            const word = wordEl.dataset.word.replace(/[Â¿Â¡.,!?]/g, '');
            const englishSentence = wordEl.dataset.english;

            // CRITICAL FIX: Pause the video when user clicks a word
            if (videoEl && !videoEl.paused) {
                videoEl.pause();
                console.log('ðŸ”‡ Video paused for word translation');
            }

            // Position tooltip ABOVE word (centered horizontally, 80px above)
            const rect = wordEl.getBoundingClientRect();
            const tooltipHeight = 120; // Approximate tooltip height
            const tooltipWidth = 280; // max-width from CSS
            const topPosition = rect.top - tooltipHeight;

            // Ensure tooltip stays on screen (all edges)
            const finalTop = Math.max(10, Math.min(topPosition, window.innerHeight - tooltipHeight - 10));
            let finalLeft = rect.left + (rect.width / 2);

            // Check right edge
            if (finalLeft + (tooltipWidth / 2) > window.innerWidth - 10) {
                finalLeft = window.innerWidth - (tooltipWidth / 2) - 10;
            }

            // Check left edge
            if (finalLeft - (tooltipWidth / 2) < 10) {
                finalLeft = (tooltipWidth / 2) + 10;
            }

            tooltip.style.left = `${finalLeft}px`;
            tooltip.style.top = `${finalTop}px`;
            tooltip.style.transform = 'translateX(-50%)';

            // CRITICAL FIX: Get translation from API (ALWAYS works)
            const translation = await getWordTranslationAPI(word);

            // Update tooltip content
            tooltip.querySelector('.word-spanish').textContent = word;
            tooltip.querySelector('.word-english').textContent = translation;

            // Show tooltip with "Save" button
            tooltip.classList.add('show');

            // Add click handler to save button (requires sign-in)
            const saveBtn = tooltip.querySelector('.save-word-btn');
            if (saveBtn) {
                saveBtn.onclick = () => {
                    if (!currentUser) {
                        // Prompt to sign in when trying to SAVE
                        document.getElementById('authModal').classList.add('show');
                        tooltip.classList.remove('show');
                    } else {
                        // Save word if logged in - change icon to filled bookmark
                        saveWordToVocabulary(word, translation, contextSentence);
                        saveBtn.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                            </svg>
                        `;
                        saveBtn.disabled = true;
                        saveBtn.style.color = '#4CAF50';

                        // Track word clicked and update counter
                        trackWordClicked(word);
                    }
                };
            }

            // Track word clicked (even without saving)
            trackWordClicked(word);

            // Hide after 3 seconds
            setTimeout(() => tooltip.classList.remove('show'), 3000);
        }

        // CRITICAL FIX: Get word translation from API (ALWAYS returns valid translation)
        async function getWordTranslationAPI(word) {
            // Check cache first for performance
            if (WORDS_CACHE.has(word)) {
                return WORDS_CACHE.get(word);
            }

            try {
                const response = await fetch('/api/translate/word', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ word, sourceLang: 'es', targetLang: 'en' })
                });

                const data = await response.json();

                if (data.success && data.translation) {
                    // Cache the translation
                    WORDS_CACHE.set(word, data.translation);
                    console.log(`âœ… Translated "${word}" â†’ "${data.translation}" (${data.source || 'API'})`);
                    return data.translation;
                } else {
                    console.warn(`âš ï¸ Translation failed for "${word}", using fallback`);
                    return word; // Fallback to original word
                }
            } catch (error) {
                console.error(`âŒ Translation API error for "${word}":`, error);
                // Fallback to heuristic if API fails
                return getWordTranslationHeuristic(word);
            }
        }

        // Get word translation (heuristic fallback - kept for offline mode)
        function getWordTranslationHeuristic(word, englishSentence = '') {
            if (WORDS_CACHE.has(word)) {
                return WORDS_CACHE.get(word);
            }

            // Enhanced translation extraction with better heuristics
            let translation = word; // fallback to original word

            if (englishSentence) {
                // Method 1: Try to find word by position alignment
                // Split both Spanish and English sentences and try to match by position
                const englishWords = englishSentence.split(' ').filter(w => w.length > 0);

                // Method 2: Common Spanish-English word mappings
                const commonTranslations = {
                    'hola': 'hello', 'adiÃ³s': 'goodbye', 'gracias': 'thanks', 'por favor': 'please',
                    'sÃ­': 'yes', 'no': 'no', 'agua': 'water', 'comida': 'food', 'casa': 'house',
                    'dÃ­a': 'day', 'noche': 'night', 'buenos': 'good', 'dÃ­as': 'days', 'noches': 'nights',
                    'estÃ¡': 'is', 'estoy': 'am', 'muy': 'very', 'bien': 'well', 'mal': 'bad',
                    'grande': 'big', 'pequeÃ±o': 'small', 'nuevo': 'new', 'viejo': 'old',
                    'mucho': 'much', 'poco': 'little', 'mÃ¡s': 'more', 'menos': 'less',
                    'quiero': 'want', 'tengo': 'have', 'puedo': 'can', 'necesito': 'need',
                    'donde': 'where', 'cuando': 'when', 'como': 'how', 'que': 'what', 'quien': 'who',
                    'tiempo': 'time', 'persona': 'person', 'vida': 'life', 'mundo': 'world',
                    'hacer': 'do', 'decir': 'say', 'ir': 'go', 'ver': 'see', 'dar': 'give',
                    'poder': 'can', 'saber': 'know', 'querer': 'want', 'llegar': 'arrive',
                    'pensar': 'think', 'creer': 'believe', 'hablar': 'speak', 'encontrar': 'find'
                };

                const wordLower = word.toLowerCase();

                // Check common translations first
                if (commonTranslations[wordLower]) {
                    translation = commonTranslations[wordLower];
                }
                // Try to find similar word in English sentence
                else if (englishWords.length > 0) {
                    // Method 3: Find word with matching first 3 letters (improved)
                    const matchingWord = englishWords.find(w => {
                        const wLower = w.toLowerCase().replace(/[.,!?;:]/g, '');
                        const wordPrefix = wordLower.substring(0, Math.min(4, wordLower.length));
                        return wLower.startsWith(wordPrefix) || wLower.includes(wordPrefix);
                    });

                    if (matchingWord) {
                        translation = matchingWord.replace(/[.,!?;:]/g, '');
                    }
                    // Method 4: If no match, return first content word from English sentence
                    else {
                        const contentWords = englishWords.filter(w =>
                            w.length > 3 &&
                            !['the', 'and', 'for', 'with', 'this', 'that', 'from', 'have', 'been'].includes(w.toLowerCase())
                        );
                        if (contentWords.length > 0) {
                            translation = contentWords[0].replace(/[.,!?;:]/g, '');
                        }
                    }
                }
            }

            // Add console log for debugging
            console.log(`ðŸ”¤ Translation: "${word}" â†’ "${translation}"`);

            WORDS_CACHE.set(word, translation);
            return translation;
        }

        // Setup sidebar actions (like, comment, share only)
        function setupSidebarActions(sidebar, video, adminDeleteBtn) {
            const likeBtn = sidebar.querySelector('.like-btn');
            const commentBtn = sidebar.querySelector('.comment-btn');
            const shareBtn = sidebar.querySelector('.share-btn');

            // Like button
            if (likeBtn) {
                likeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    likeBtn.classList.toggle('liked');

                    // Update like count
                    const countEl = likeBtn.querySelector('.sidebar-count');
                    const currentCount = parseInt(countEl.textContent.replace(/[KM]/g, '')) || 0;
                    const isLiked = likeBtn.classList.contains('liked');
                    const newCount = isLiked ? currentCount + 1 : Math.max(0, currentCount - 1);
                    countEl.textContent = formatCount(newCount);

                    // Track analytics
                    trackVideoInteraction(video.id, 'like', isLiked);
                });
            }

            // Comment button - open comment modal
            if (commentBtn) {
                // Hide comments button - feature in development
                commentBtn.style.opacity = '0.3';
                commentBtn.style.pointerEvents = 'none';
            }

            // Share button
            if (shareBtn) {
                shareBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (navigator.share) {
                        navigator.share({
                            title: video.title,
                            text: `Learn Spanish: ${video.title}`,
                            url: window.location.href
                        });
                    } else {
                        // Fallback: copy to clipboard
                        navigator.clipboard.writeText(window.location.href);
                        alert('Link copied to clipboard! ðŸ“‹');
                    }
                    trackVideoInteraction(video.id, 'share', true);
                });
            }

            // Admin delete button (top-left corner)
            if (adminDeleteBtn) {
                adminDeleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();

                    if (confirm('Delete this video? This cannot be undone.')) {
                        try {
                            const response = await fetch(`/api/videos/${video.id}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${currentUser.token}`
                                }
                            });

                            if (response.ok) {
                                // Remove video card from DOM
                                const card = e.target.closest('.video-card');
                                card.remove();
                                alert('Video deleted successfully âœ…');
                            } else {
                                alert('Failed to delete video âŒ');
                            }
                        } catch (error) {
                            console.error('Delete error:', error);
                            alert('Error deleting video âŒ');
                        }
                    }
                });
            }
        }

        // Setup video progress bar
        function setupVideoProgress(videoEl, progressBar) {
            videoEl.addEventListener('timeupdate', () => {
                const progress = (videoEl.currentTime / videoEl.duration) * 100;
                progressBar.style.width = progress + '%';
            });
        }

        // Format numbers (1.2K, 3.4M)
        function formatCount(count) {
            if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
            if (count >= 1000) return (count / 1000).toFixed(1) + 'K';
            return count;
        }

        // Intersection Observer for autoplay + infinite scroll
        // Threshold 0.5 = 50%+ visible (TikTok/YouTube Shorts pattern)
        function setupIntersectionObserver() {
            const options = {
                root: null,
                threshold: [0, 0.5, 1] // Multiple thresholds for better detection
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target.querySelector('video');
                    if (!video) return;

                    const cardIndex = parseInt(entry.target.dataset.index);
                    const videoData = videos[cardIndex];

                    if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
                        // ðŸŽ¯ Track video start
                        if (videoData && videoData.id) {
                            trackVideoStart(videoData.id, videoData);
                        }

                        // CRITICAL FIX: Ensure video is fully loaded before playing
                        if (video.readyState < 3) { // 3 = HAVE_FUTURE_DATA
                            video.preload = 'auto';

                            // Wait for video to be ready before playing
                            video.addEventListener('loadeddata', () => {
                                if (entry.isIntersecting) {
                                    video.play().catch(e => {
                                        console.log('Autoplay prevented:', e);
                                        video.muted = true;
                                        video.play();
                                    });
                                }
                            }, { once: true });
                        } else {
                            // Video already loaded, play immediately
                            video.play().catch(e => {
                                console.log('Autoplay prevented:', e);
                                video.muted = true;
                                video.play();
                            });
                        }

                        // Preload next 2-3 videos for smooth scrolling (prevents black screen)
                        preloadNextVideos(entry.target, 3);

                        // Check if we need to load more videos (infinite scroll)
                        // Load next batch when user is 3 videos away from the end
                        if (cardIndex >= loadedVideoCount - 3 && loadedVideoCount < videos.length) {
                            console.log(`ðŸ“œ Infinite scroll triggered: Loading batch at position ${loadedVideoCount}`);
                            renderVideosBatch(loadedVideoCount, BATCH_SIZE);
                        }
                    } else {
                        // ðŸŽ¯ Track video stop before pausing
                        if (videoData && videoData.id && video.duration) {
                            trackVideoStop(videoData.id, video.duration, video.currentTime);
                        }

                        // Pause video when not visible
                        video.pause();
                    }
                });
            }, options);

            // Observe all video cards
            const observeVideos = () => {
                document.querySelectorAll('.video-card').forEach(card => {
                    observer.observe(card);
                });
            };

            observeVideos();

            // Re-observe when new videos are added
            const feedContainer = document.getElementById('feedContainer');
            const mutationObserver = new MutationObserver(observeVideos);
            mutationObserver.observe(feedContainer, { childList: true });
        }

        // ðŸŽ¯ TIKTOK-STYLE BEHAVIORAL TRACKING FUNCTIONS

        // Track when video starts playing
        function trackVideoStart(videoId, videoData) {
            behaviorTracker.lastVideoId = videoId;
            behaviorTracker.lastVideoStartTime = Date.now();

            // Initialize session tracking for this video
            if (!behaviorTracker.videoSessions[videoId]) {
                behaviorTracker.videoSessions[videoId] = {
                    totalWatchTime: 0,
                    viewCount: 0,
                    lastViewStart: Date.now(),
                    completed: false,
                    skipped: false,
                    level: videoData.level,
                    difficulty: videoData.difficulty?.difficultyScore || 50
                };
            } else {
                behaviorTracker.videoSessions[videoId].lastViewStart = Date.now();
            }

            behaviorTracker.videoSessions[videoId].viewCount++;

            // ðŸŽ¯ CRITICAL: Immediately save to localStorage so it persists across refreshes
            const watchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '[]');
            if (!watchedVideos.includes(videoId)) {
                watchedVideos.push(videoId);
                localStorage.setItem('watchedVideos', JSON.stringify(watchedVideos));
                console.log(`âœ… Saved ${videoId} to persistent watched list (${watchedVideos.length} total)`);
            }
        }

        // Track when video stops/pauses (skip or completion)
        function trackVideoStop(videoId, videoDuration, currentTime) {
            const session = behaviorTracker.videoSessions[videoId];
            if (!session || !session.lastViewStart) return;

            // Calculate watch time for this session
            const watchTime = Date.now() - session.lastViewStart;
            session.totalWatchTime += watchTime;

            // Calculate completion percentage
            const completionPercent = (currentTime / videoDuration) * 100;

            // Skip detection: < 30% watched = skip
            if (completionPercent < 30 && !session.skipped) {
                session.skipped = true;
                behaviorTracker.skipPatterns.push({
                    videoId,
                    level: session.level,
                    difficulty: session.difficulty,
                    watchTime,
                    completionPercent,
                    timestamp: Date.now()
                });
                console.log(`â­ï¸ Video skipped: ${videoId} (${completionPercent.toFixed(1)}% watched)`);
            }

            // Completion detection: > 70% watched = completed
            if (completionPercent > 70 && !session.completed) {
                session.completed = true;
                behaviorTracker.completionPatterns.push({
                    videoId,
                    level: session.level,
                    difficulty: session.difficulty,
                    watchTime: session.totalWatchTime,
                    completionPercent,
                    timestamp: Date.now()
                });
                console.log(`âœ… Video completed: ${videoId} (${completionPercent.toFixed(1)}% watched)`);

                // Level signal: Completing videos indicates comfort at that level
                trackLevelSignal(session.level, session.difficulty, 'completion');
            }

            // Save behavioral data
            saveBehaviorData();
        }

        // Track level signals from user behavior
        function trackLevelSignal(level, difficulty, signalType) {
            behaviorTracker.levelSignals.push({
                level,
                difficulty,
                signalType, // 'completion', 'skip', 'word_click', 'word_save'
                timestamp: Date.now()
            });

            // Update interests
            if (!behaviorTracker.interests[level]) {
                behaviorTracker.interests[level] = {
                    completions: 0,
                    skips: 0,
                    engagementScore: 0
                };
            }

            if (signalType === 'completion') {
                behaviorTracker.interests[level].completions++;
                behaviorTracker.interests[level].engagementScore += 10;
            } else if (signalType === 'skip') {
                behaviorTracker.interests[level].skips++;
                behaviorTracker.interests[level].engagementScore -= 5;
            }

            // Dynamically adjust user level based on recent behavior
            updateDynamicUserLevel();
        }

        // ðŸŽ¯ GENIUS MULTI-SIGNAL LEVEL DETECTION ALGORITHM
        // Weighs ALL signals: assessment, hard/easy buttons, completions, skips, word interactions
        function updateGeniusLevelDetection() {
            const levelOrder = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            const currentLevel = localStorage.getItem('userLevel') || 'A1';
            const currentLevelIndex = levelOrder.indexOf(currentLevel);

            // ðŸŽ¯ SIGNAL WEIGHTS (higher = more important)
            const weights = {
                marked_hard: 50,      // User explicitly says "too hard" - STRONGEST signal
                marked_easy: 50,      // User explicitly says "too easy" - STRONGEST signal
                assessment: 30,       // Initial assessment test - HIGH weight but fades
                completion: 15,       // Completed video - MODERATE signal
                skip: 10,             // Skipped video - MODERATE signal
                word_save: 8,         // Saved word - MODERATE-LOW signal
                word_click: 3         // Clicked word - WEAK signal
            };

            // Get recent signals (last 30, with decay for older ones)
            const recentSignals = behaviorTracker.levelSignals.slice(-30);

            if (recentSignals.length < 5) {
                console.log('ðŸ“Š Not enough data for level adjustment (need 5+ signals)');
                return; // Need at least 5 signals
            }

            // Calculate weighted votes for each level
            const levelVotes = {};
            levelOrder.forEach(level => {
                levelVotes[level] = { promote: 0, demote: 0, neutral: 0 };
            });

            recentSignals.forEach((signal, index) => {
                const level = signal.level;
                const levelIndex = levelOrder.indexOf(level);
                const signalType = signal.signalType;
                const weight = weights[signalType] || 1;

                // Time decay: recent signals matter more (last 10 at full weight)
                const decay = index >= recentSignals.length - 10 ? 1 : 0.5;
                const adjustedWeight = weight * decay;

                // Interpret signal direction
                if (signalType === 'marked_easy') {
                    // Video at this level is too easy â†’ promote user ABOVE this level
                    levelOrder.forEach((targetLevel, targetIndex) => {
                        if (targetIndex > levelIndex) {
                            levelVotes[targetLevel].promote += adjustedWeight;
                        } else if (targetIndex === levelIndex) {
                            levelVotes[targetLevel].demote += adjustedWeight / 2;
                        }
                    });
                } else if (signalType === 'marked_hard') {
                    // Video at this level is too hard â†’ demote user BELOW this level
                    levelOrder.forEach((targetLevel, targetIndex) => {
                        if (targetIndex < levelIndex) {
                            levelVotes[targetLevel].promote += adjustedWeight;
                        } else if (targetIndex === levelIndex) {
                            levelVotes[targetLevel].demote += adjustedWeight / 2;
                        }
                    });
                } else if (signalType === 'completion') {
                    // Completed video at this level â†’ user is comfortable at this level
                    levelVotes[level].promote += adjustedWeight;
                } else if (signalType === 'skip') {
                    // Skipped video at this level â†’ might be struggling
                    levelVotes[level].demote += adjustedWeight;
                } else if (signalType === 'word_save' || signalType === 'word_click') {
                    // Engaged with content â†’ slight positive signal
                    levelVotes[level].neutral += adjustedWeight;
                }
            });

            // Calculate net score for each level
            const levelScores = {};
            levelOrder.forEach(level => {
                const votes = levelVotes[level];
                levelScores[level] = votes.promote - votes.demote + (votes.neutral * 0.3);
            });

            // Find level with highest positive score
            let bestLevel = currentLevel;
            let bestScore = levelScores[currentLevel];

            levelOrder.forEach(level => {
                if (levelScores[level] > bestScore) {
                    bestScore = levelScores[level];
                    bestLevel = level;
                }
            });

            // Prevent over-promotion/demotion (max 1 level change at a time)
            const bestLevelIndex = levelOrder.indexOf(bestLevel);
            const levelDiff = Math.abs(bestLevelIndex - currentLevelIndex);

            if (levelDiff > 1) {
                // Only move 1 level at a time
                if (bestLevelIndex > currentLevelIndex) {
                    bestLevel = levelOrder[currentLevelIndex + 1];
                } else {
                    bestLevel = levelOrder[currentLevelIndex - 1];
                }
            }

            // Require significant evidence to change levels (threshold)
            const changeThreshold = 20; // Need at least 20 points to change
            if (Math.abs(levelScores[bestLevel] - levelScores[currentLevel]) < changeThreshold) {
                console.log(`ðŸ“Š Level stays at ${currentLevel} (score diff ${Math.abs(levelScores[bestLevel] - levelScores[currentLevel]).toFixed(1)} < threshold ${changeThreshold})`);
                return;
            }

            // Update user level if changed
            if (bestLevel !== currentLevel) {
                console.log(`ðŸŽ¯ LEVEL ADJUSTED: ${currentLevel} â†’ ${bestLevel}`);
                console.log(`ðŸ“Š Scores: ${JSON.stringify(levelScores)}`);
                console.log(`ðŸ’¡ Based on ${recentSignals.length} recent signals`);

                localStorage.setItem('userLevel', bestLevel);

                // Save to Supabase if user is logged in
                if (currentUser) {
                    supabase.auth.updateUser({
                        data: { level: bestLevel }
                    }).then(() => {
                        console.log(`âœ… Level synced to Supabase: ${bestLevel}`);
                    }).catch(e => console.log('Could not sync level to Supabase'));
                }

                // Show notification to user
                showLevelChangeNotification(currentLevel, bestLevel);
            }
        }

        // Show notification when level changes
        function showLevelChangeNotification(oldLevel, newLevel) {
            const levelOrder = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            const direction = levelOrder.indexOf(newLevel) > levelOrder.indexOf(oldLevel) ? 'up' : 'down';
            const emoji = direction === 'up' ? 'ðŸŽ‰' : 'ðŸ“š';
            const message = direction === 'up'
                ? `Level Up! You've progressed to ${newLevel}`
                : `Level adjusted to ${newLevel} for better learning`;

            // Create notification (TikTok-style toast)
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 700;
                z-index: 9999;
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                animation: slideDown 0.3s ease-out;
            `;
            notification.textContent = `${emoji} ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Backward compatibility alias
        const updateDynamicUserLevel = updateGeniusLevelDetection;

        // Save behavioral data to localStorage
        function saveBehaviorData() {
            try {
                // Keep only last 100 skip/completion patterns (prevent localStorage bloat)
                if (behaviorTracker.skipPatterns.length > 100) {
                    behaviorTracker.skipPatterns = behaviorTracker.skipPatterns.slice(-100);
                }
                if (behaviorTracker.completionPatterns.length > 100) {
                    behaviorTracker.completionPatterns = behaviorTracker.completionPatterns.slice(-100);
                }
                if (behaviorTracker.levelSignals.length > 50) {
                    behaviorTracker.levelSignals = behaviorTracker.levelSignals.slice(-50);
                }

                localStorage.setItem('behaviorTracker', JSON.stringify(behaviorTracker));
            } catch (e) {
                console.error('Error saving behavior data:', e);
            }
        }

        // ðŸŽ¯ GENIUS HARD/EASY BUTTON FUNCTIONS
        window.markVideoEasy = function(videoId, level, difficulty, button) {
            console.log(`âœ… User marked video as TOO EASY: ${videoId} (${level}, difficulty ${difficulty})`);

            // Visual feedback
            button.classList.add('marked');
            setTimeout(() => button.classList.remove('marked'), 500);

            // STRONG signal: User finds this level too easy â†’ promote user
            trackLevelSignal(level, difficulty, 'marked_easy');

            // Add to behavioral tracker
            if (!behaviorTracker.easyMarked) behaviorTracker.easyMarked = [];
            behaviorTracker.easyMarked.push({
                videoId,
                level,
                difficulty,
                timestamp: Date.now()
            });

            // Immediate level adjustment check (weighted heavily)
            updateGeniusLevelDetection();

            saveBehaviorData();

            // Advance to next video after feedback
            setTimeout(() => {
                const currentCard = button.closest('.video-card');
                if (currentCard) {
                    const nextCard = currentCard.nextElementSibling;
                    if (nextCard && nextCard.classList.contains('video-card')) {
                        nextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else if (loadedVideoCount < videos.length) {
                        renderVideosBatch(loadedVideoCount, BATCH_SIZE);
                        setTimeout(() => {
                            const newNextCard = currentCard.nextElementSibling;
                            if (newNextCard) {
                                newNextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 100);
                    }
                }
            }, 600); // Wait for animation
        };

        window.markVideoHard = function(videoId, level, difficulty, button) {
            console.log(`âŒ User marked video as TOO HARD: ${videoId} (${level}, difficulty ${difficulty})`);

            // Visual feedback
            button.classList.add('marked');
            setTimeout(() => button.classList.remove('marked'), 500);

            // STRONG signal: User finds this level too hard â†’ demote user
            trackLevelSignal(level, difficulty, 'marked_hard');

            // Add to behavioral tracker
            if (!behaviorTracker.hardMarked) behaviorTracker.hardMarked = [];
            behaviorTracker.hardMarked.push({
                videoId,
                level,
                difficulty,
                timestamp: Date.now()
            });

            // Immediate level adjustment check (weighted heavily)
            updateGeniusLevelDetection();

            saveBehaviorData();

            // Advance to next video after feedback
            setTimeout(() => {
                const currentCard = button.closest('.video-card');
                if (currentCard) {
                    const nextCard = currentCard.nextElementSibling;
                    if (nextCard && nextCard.classList.contains('video-card')) {
                        nextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else if (loadedVideoCount < videos.length) {
                        renderVideosBatch(loadedVideoCount, BATCH_SIZE);
                        setTimeout(() => {
                            const newNextCard = currentCard.nextElementSibling;
                            if (newNextCard) {
                                newNextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 100);
                    }
                }
            }, 600); // Wait for animation
        };
        
        // Share video function (Web Share API + fallback)
        window.shareVideo = async function(videoId, videoUrl) {
            console.log('ðŸ“¤ Sharing video:', videoId);
            
            // Track share event (TikTok 3-point engagement)
            if (window.researchFeed) {
                const video = videos.find(v => v.id === videoId);
                if (video) {
                    window.researchFeed.trackShare(video);
                }
            }
            
            const shareData = {
                title: 'Langflix - Learn Spanish',
                text: 'Check out this Spanish learning video!',
                url: window.location.href
            };
            
            // Try Web Share API first (mobile)
            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                    console.log('âœ… Shared via Web Share API');
                    
                    // Show success toast
                    showToast('Shared successfully! ðŸŽ‰');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Share failed:', err);
                    }
                }
            } else {
                // Fallback: Copy link to clipboard
                try {
                    await navigator.clipboard.writeText(window.location.href);
                    showToast('Link copied to clipboard! ðŸ“‹');
                    console.log('âœ… Link copied to clipboard');
                } catch (err) {
                    console.error('Clipboard failed:', err);
                    showToast('Share: ' + window.location.href);
                }
            }
        };
        
        // Show toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 12px 24px;
                border-radius: 24px;
                font-size: 14px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideUp 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transition = 'opacity 0.3s';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // Preload next N videos for smooth transition (prevents black screen)
        function preloadNextVideos(currentCard, count = 3) {
            let nextCard = currentCard.nextElementSibling;
            let preloaded = 0;

            while (nextCard && preloaded < count) {
                if (nextCard.classList.contains('video-card')) {
                    const nextVideo = nextCard.querySelector('video');
                    if (nextVideo) {
                        // Set preload to auto (downloads entire video)
                        nextVideo.preload = 'auto';

                        // Force load by setting a small currentTime (browser optimization)
                        if (nextVideo.readyState < 2) {
                            nextVideo.load();

                            // CRITICAL FIX: .load() resets playbackRate to 1.0
                            // Reapply saved speed after load()
                            const savedSpeed = parseFloat(localStorage.getItem('playbackSpeed') || '1');
                            nextVideo.playbackRate = savedSpeed;
                        }

                        console.log(`ðŸ“¹ Preloading video ${preloaded + 1}/${count}`);
                        preloaded++;
                    }
                }
                nextCard = nextCard.nextElementSibling;
            }
        }

        // AUTH FUNCTIONS
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            currentUser = user;
            if (user) {
                updateProfileUI(user);
            }
        }

        async function handleAuth(event) {
            event.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const displayName = document.getElementById('authDisplayName').value;
            const submitBtn = document.getElementById('authSubmitBtn');
            const originalText = submitBtn.textContent;

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = isAuthMode === 'signup' ? 'Creating account...' : 'Signing in...';
            submitBtn.style.opacity = '0.7';

            try {
                if (isAuthMode === 'signup') {
                    // Sign up new user
                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                display_name: displayName || email.split('@')[0],
                                level: 'A1', // Default level
                                words_learned: 0,
                                videos_watched: 0
                            }
                        }
                    });

                    if (error) throw error;

                    // Check if email confirmation is required
                    if (data.user && data.user.identities && data.user.identities.length === 0) {
                        // Email already exists
                        throw new Error('This email is already registered. Please sign in instead.');
                    }

                    // Create user profile in database
                    if (data.user) {
                        try {
                            const { error: profileError } = await supabase
                                .from('user_profiles')
                                .insert({
                                    user_id: data.user.id,
                                    email: email,
                                    display_name: displayName || email.split('@')[0],
                                    level: 'A1',
                                    words_learned: 0,
                                    videos_watched: 0,
                                    current_streak: 0,
                                    xp_points: 0
                                });

                            // Don't fail if table doesn't exist yet
                            if (profileError) console.warn('Profile creation warning:', profileError.message);
                        } catch (profileErr) {
                            console.warn('Profile creation error:', profileErr);
                        }
                    }

                    // Success message
                    submitBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                    submitBtn.textContent = 'âœ“ Account created!';

                    setTimeout(() => {
                        alert('ðŸŽ‰ Welcome to Langflix!\n\nYour account has been created successfully.\n\nTip: Start by taking the level assessment test to get personalized videos!');

                        // Auto sign in after signup
                        currentUser = data.user;
                        updateProfileUI(data.user);
                        closeAuthModal();

                        // Prompt for level test
                        setTimeout(() => {
                            if (confirm('Would you like to take a 5-minute test to find your Spanish level? (Recommended)')) {
                                window.location.href = '/level-assessment.html';
                            }
                        }, 500);
                    }, 1000);

                } else {
                    // Sign in existing user
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) throw error;

                    currentUser = data.user;
                    updateProfileUI(data.user);

                    submitBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                    submitBtn.textContent = 'âœ“ Signed in!';

                    setTimeout(() => {
                        closeAuthModal();
                        alert('ðŸ‘‹ Welcome back!');
                    }, 800);
                }
            } catch (error) {
                // Show detailed error message
                console.error('Auth error:', error);

                let errorMessage = 'Authentication failed';

                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'âŒ Invalid email or password.\n\nPlease check your credentials and try again.';
                } else if (error.message.includes('already registered')) {
                    errorMessage = 'âŒ This email is already registered.\n\nPlease sign in instead or use a different email.';
                } else if (error.message.includes('email')) {
                    errorMessage = 'âŒ Please enter a valid email address.';
                } else if (error.message.includes('password')) {
                    errorMessage = 'âŒ Password must be at least 6 characters long.';
                } else if (error.message.includes('rate limit')) {
                    errorMessage = 'âŒ Too many attempts.\n\nPlease wait a minute and try again.';
                } else {
                    errorMessage = `âŒ Error: ${error.message}`;
                }

                alert(errorMessage);

                // Reset button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                submitBtn.style.opacity = '1';
                submitBtn.style.background = 'linear-gradient(135deg, #00F5FF, #00AACC)';
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            currentUser = null;
            closeProfile();
            alert('Signed out successfully');
        }

        function toggleAuthMode() {
            isAuthMode = isAuthMode === 'signin' ? 'signup' : 'signin';
            const displayNameInput = document.getElementById('authDisplayName');
            const authTitle = document.getElementById('authTitle');
            const authSubmitBtn = document.getElementById('authSubmitBtn');
            const authToggleText = document.getElementById('authToggleText');

            if (isAuthMode === 'signup') {
                displayNameInput.style.display = 'block';
                authTitle.textContent = 'Sign Up';
                authSubmitBtn.textContent = 'Sign Up';
                authToggleText.textContent = 'Already have an account?';
            } else {
                displayNameInput.style.display = 'none';
                authTitle.textContent = 'Sign In';
                authSubmitBtn.textContent = 'Sign In';
                authToggleText.textContent = "Don't have an account?";
            }
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('show');
        }

        function updateProfileUI(user) {
            document.getElementById('profileName').textContent = user.user_metadata?.display_name || user.email;
            document.getElementById('profileEmail').textContent = user.email;

            // Update level badge
            const userLevel = user.user_metadata?.level || localStorage.getItem('userLevel') || 'A1';
            document.getElementById('profileLevel').textContent = userLevel;

            // Update XP and progress bar
            const userXP = user.user_metadata?.xp_points || parseInt(localStorage.getItem('userXP') || '0');
            const xpForNextLevel = 100 * (parseInt(userLevel.substring(1)) || 1); // A1=100, A2=200, B1=300, etc
            const xpProgress = (userXP % xpForNextLevel) / xpForNextLevel * 100;

            document.getElementById('profileXP').textContent = userXP % xpForNextLevel;
            document.getElementById('profileXPNext').textContent = xpForNextLevel;
            document.getElementById('profileXPFill').style.width = `${xpProgress}%`;

            // Update frequency list progress
            updateFrequencyProgress(userLevel);

            // Update streak
            const lastVisit = localStorage.getItem('lastVisit');
            const today = new Date().toDateString();
            let streak = parseInt(localStorage.getItem('currentStreak') || '0');

            if (lastVisit !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastVisit === yesterday.toDateString()) {
                    streak++; // Continue streak
                } else if (lastVisit !== today) {
                    streak = 1; // Reset streak
                }

                localStorage.setItem('currentStreak', streak.toString());
                localStorage.setItem('lastVisit', today);
            }

            document.getElementById('statsDays').textContent = streak;

            // Update videos watched
            const videosWatched = parseInt(localStorage.getItem('videosWatched') || '0');
            document.getElementById('statsVideos').textContent = videosWatched;

            // Update study time (in minutes)
            const studyTimeSeconds = parseInt(localStorage.getItem('totalStudyTime') || '0');
            const studyTimeMinutes = Math.floor(studyTimeSeconds / 60);
            document.getElementById('statsTime').textContent = studyTimeMinutes > 60 ?
                `${Math.floor(studyTimeMinutes / 60)}h ${studyTimeMinutes % 60}m` :
                `${studyTimeMinutes}m`;

            loadUserVocabulary();
        }

        async function loadUserVocabulary() {
            if (!currentUser) return;

            const { data, error } = await supabase
                .from('vocabulary')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading vocabulary:', error);
                return;
            }

            const vocabList = document.getElementById('vocabularyList');
            document.getElementById('statsWords').textContent = data.length;

            if (data.length === 0) {
                vocabList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“–</div>
                        <div class="empty-state-text">No words saved yet. Tap on Spanish words to save them!</div>
                    </div>
                `;
            } else {
                vocabList.innerHTML = data.map(word => `
                    <div class="vocabulary-item">
                        <div class="vocabulary-word">${word.word}</div>
                        <div class="vocabulary-translation">${word.translation}</div>
                        ${word.context_sentence ? `<div class="vocabulary-context">${word.context_sentence}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        // Update frequency list progress based on level and words learned
        async function updateFrequencyProgress(userLevel) {
            // Frequency ranges by CEFR level (based on assessment test)
            const frequencyRanges = {
                'A1': { min: 1, max: 500, total: 500, text: '1-500' },
                'A2': { min: 500, max: 1500, total: 1000, text: '500-1,500' },
                'B1': { min: 1500, max: 3000, total: 1500, text: '1,500-3,000' },
                'B2': { min: 3000, max: 6000, total: 3000, text: '3,000-6,000' },
                'C1': { min: 6000, max: 10000, total: 4000, text: '6,000+' },
                'C2': { min: 10000, max: 15000, total: 5000, text: '10,000+' }
            };

            const range = frequencyRanges[userLevel] || frequencyRanges['A1'];

            // Get number of words learned
            const wordsLearnedCount = wordsLearned.size;

            // Calculate progress within current range
            const progressInRange = Math.min((wordsLearnedCount / range.total) * 100, 100);

            // Calculate overall progress (out of 10,000)
            const overallProgress = Math.min((wordsLearnedCount / 10000) * 100, 100);

            // Update UI elements
            document.getElementById('frequencyWordsLearned').textContent = wordsLearnedCount;
            document.getElementById('frequencyPosition').textContent = range.text;
            document.getElementById('frequencyProgressFill').style.width = `${progressInRange}%`;

            // Update progress text based on level
            let progressMessage = '';
            if (userLevel === 'A1') {
                progressMessage = "You're learning the most essential Spanish words";
            } else if (userLevel === 'A2') {
                progressMessage = "Building your foundation with common phrases";
            } else if (userLevel === 'B1') {
                progressMessage = "Expanding vocabulary for everyday situations";
            } else if (userLevel === 'B2') {
                progressMessage = "Mastering advanced vocabulary and nuances";
            } else {
                progressMessage = "Achieving fluency with sophisticated vocabulary";
            }

            document.getElementById('frequencyProgressText').textContent = progressMessage;

            console.log(`ðŸ“Š Frequency Progress: ${wordsLearnedCount} words (${userLevel}: ${range.text}), ${progressInRange.toFixed(1)}% in range`);
        }

        async function saveWordToVocabulary(word, translation, contextSentence) {
            if (!currentUser) {
                document.getElementById('authModal').classList.add('show');
                alert('Please sign in to save words');
                return;
            }

            try {
                const { error } = await supabase
                    .from('vocabulary')
                    .upsert({
                        user_id: currentUser.id,
                        word: word,
                        translation: translation,
                        language: 'Spanish',
                        source_app: 'workspace3',
                        context_sentence: contextSentence
                    }, {
                        onConflict: 'user_id,word,language'
                    });

                if (error) throw error;
                console.log(`âœ… Saved "${word}" to vocabulary`);

                // ðŸŽ¯ Track level signal: Saving a word indicates engagement with that difficulty
                const wordData = await getWordFrequencyData(word);
                if (wordData && wordData.cefr_level) {
                    trackLevelSignal(wordData.cefr_level, wordData.frequency_rank, 'word_save');
                }
            } catch (error) {
                console.error('Error saving word:', error);
                alert('Error saving word âŒ');
            }
        }

        // ANALYTICS: Track video interactions (like, save, share, view)
        async function trackVideoInteraction(videoId, action, value) {
            if (!currentUser) return;

            try {
                await supabase
                    .from('video_analytics')
                    .insert({
                        user_id: currentUser.id,
                        video_id: videoId,
                        action: action,
                        value: value,
                        timestamp: new Date().toISOString()
                    });
            } catch (error) {
                console.error('Analytics error:', error);
            }
        }

        // Track word clicked and update counter
        async function trackWordClicked(word) {
            const cleanWord = word.toLowerCase().replace(/[Â¿Â¡.,!?]/g, '');

            if (!wordsLearned.has(cleanWord)) {
                wordsLearned.add(cleanWord);
                localStorage.setItem('wordsLearned', JSON.stringify([...wordsLearned]));

                // Award XP for learning new word
                addXP(10, 'Learned new word');

                // Update stats display
                updateStatsDisplay();

                // Update frequency progress
                const userLevel = localStorage.getItem('userLevel') || 'A1';
                updateFrequencyProgress(userLevel);

                // Check for milestones
                checkWordMilestones(wordsLearned.size);

                console.log(`âœ… Word learned: ${cleanWord} (Total: ${wordsLearned.size})`);

                // ðŸŽ¯ Track level signal: Clicking a word indicates interest in that difficulty
                const wordData = await getWordFrequencyData(cleanWord);
                if (wordData && wordData.cefr_level) {
                    trackLevelSignal(wordData.cefr_level, wordData.frequency_rank, 'word_click');
                }
                
                // ðŸ§  RESEARCH: Track word click for HLR memory update
                if (window.researchFeed && videos[currentVideo]) {
                    window.researchFeed.trackWordClick(videos[currentVideo], cleanWord, true);
                }
            }
        }

        // ========== GAMIFICATION SYSTEM ==========

        // Update stats display (top bar)
        function updateStatsDisplay() {
            const streakEl = document.getElementById('streakDisplay');
            const xpEl = document.getElementById('xpDisplay');
            const wordsEl = document.getElementById('wordsDisplay');

            if (streakEl) streakEl.textContent = userStreak;
            if (xpEl) xpEl.textContent = userXP;
            if (wordsEl) wordsEl.textContent = wordsLearned.size;
        }

        // Add XP with animation
        function addXP(amount, reason) {
            userXP += amount;
            localStorage.setItem('userXP', userXP);
            updateStatsDisplay();

            // Animate XP display
            const xpEl = document.getElementById('xpDisplay');
            if (xpEl) {
                xpEl.style.transform = 'scale(1.3)';
                xpEl.style.color = '#ffd700';
                setTimeout(() => {
                    xpEl.style.transform = 'scale(1)';
                    xpEl.style.color = '';
                }, 300);
            }

            console.log(`ðŸ† +${amount} XP: ${reason}`);
        }

        // Update streak (called daily)
        function updateStreak() {
            const today = new Date().toDateString();

            if (lastActiveDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();

                if (lastActiveDate === yesterdayStr) {
                    // Consecutive day - increment streak
                    userStreak++;
                    addXP(50, `${userStreak} day streak!`);
                } else if (lastActiveDate !== null) {
                    // Streak broken - reset to 1
                    userStreak = 1;
                } else {
                    // First day
                    userStreak = 1;
                }

                lastActiveDate = today;
                localStorage.setItem('userStreak', userStreak);
                localStorage.setItem('lastActiveDate', lastActiveDate);
                updateStatsDisplay();

                console.log(`ðŸ”¥ Streak updated: ${userStreak} days`);
            }
        }

        // Check word learning milestones
        function checkWordMilestones(wordCount) {
            const milestones = [
                { count: 10, emoji: 'ðŸŽ‰', title: '10 Words!', message: 'Great start! Keep learning!' },
                { count: 25, emoji: 'ðŸ”¥', title: '25 Words!', message: "You're on fire!" },
                { count: 50, emoji: 'â­', title: '50 Words!', message: 'Halfway to fluent!' },
                { count: 100, emoji: 'ðŸ†', title: 'Century!', message: '100 words mastered!' },
                { count: 250, emoji: 'ðŸ’Ž', title: 'Champion!', message: '250 words! Incredible!' },
                { count: 500, emoji: 'ðŸ‘‘', title: 'Master!', message: '500 words! You are amazing!' }
            ];

            for (const milestone of milestones) {
                if (wordCount === milestone.count && !milestonesReached.has(milestone.count)) {
                    showMilestoneCelebration(milestone);
                    milestonesReached.add(milestone.count);
                    localStorage.setItem('milestonesReached', JSON.stringify([...milestonesReached]));
                    addXP(100, `Reached ${milestone.count} words milestone!`);
                    break;
                }
            }
        }

        // Milestone celebrations removed - no spam popups

        // Track video watched
        function trackVideoWatched(videoId) {
            videosWatched++;
            localStorage.setItem('videosWatched', videosWatched);

            // Award XP
            addXP(5, 'Watched video');

            // Quiz prompts removed - no spam popups

            console.log(`ðŸ“¹ Videos watched: ${videosWatched}`);
        }

        // Video quiz prompts removed - no spam popups

            // Generate quiz questions from video
            generateVideoQuiz(videoQuizData);

            // Switch to quiz tab
            switchTab('quizzes');
        }

        // Generate quiz from video transcription
        function generateVideoQuiz(video) {
            quizQuestions = [];
            const words = new Set();

            // Extract unique words from transcription
            video.transcription.lines.forEach(line => {
                if (line.spanish && line.english) {
                    const spanishWords = line.spanish.split(' ').filter(w => w.length > 3);
                    spanishWords.forEach(word => {
                        const cleanWord = word.replace(/[Â¿Â¡.,!?]/g, '');
                        if (cleanWord.length > 3) {
                            words.add({
                                spanish: cleanWord,
                                english: line.english,
                                sentence: line.spanish
                            });
                        }
                    });
                }
            });

            // Create 3-5 quiz questions
            const wordsArray = Array.from(words).slice(0, 5);
            wordsArray.forEach(wordData => {
                quizQuestions.push({
                    question: `What does "${wordData.spanish}" mean?`,
                    correctAnswer: wordData.english,
                    options: generateQuizOptions(wordData.english),
                    context: wordData.sentence
                });
            });

            currentQuizIndex = 0;
            quizScore = 0;
            renderQuiz();
        }

        // Generate quiz options (1 correct + 3 wrong)
        function generateQuizOptions(correctAnswer) {
            const wrongAnswers = [
                'Hello', 'Goodbye', 'Thank you', 'Please', 'Yes', 'No',
                'Good morning', 'Good night', 'How are you?', 'I am fine',
                'What is your name?', 'My name is', 'Nice to meet you',
                'See you later', 'Excuse me', 'I am sorry'
            ];

            const options = [correctAnswer];

            while (options.length < 4) {
                const randomAnswer = wrongAnswers[Math.floor(Math.random() * wrongAnswers.length)];
                if (!options.includes(randomAnswer)) {
                    options.push(randomAnswer);
                }
            }

            // Shuffle options
            return options.sort(() => Math.random() - 0.5);
        }

        // Render quiz UI
        function renderQuiz() {
            const container = document.getElementById('quizContainer');

            if (currentQuizIndex >= quizQuestions.length) {
                // Quiz complete - show score
                container.innerHTML = `
                    <div class="quiz-score">
                        <div class="quiz-score-circle">
                            ${quizScore}/${quizQuestions.length}
                        </div>
                        <h2 style="font-size: 32px; margin-bottom: 16px;">
                            ${quizScore === quizQuestions.length ? 'ðŸŽ‰ Perfect!' : quizScore >= quizQuestions.length * 0.7 ? 'ðŸŽ¯ Great job!' : 'ðŸ’ª Keep practicing!'}
                        </h2>
                        <p style="font-size: 18px; opacity: 0.8; margin-bottom: 20px;">
                            You got ${quizScore} out of ${quizQuestions.length} correct!
                        </p>
                        <button class="quiz-restart-btn" onclick="switchTab('home')">Back to Videos</button>
                    </div>
                `;

                // Award XP
                addXP(20, `Quiz completed: ${quizScore}/${quizQuestions.length}`);

                return;
            }

            const question = quizQuestions[currentQuizIndex];

            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <span style="font-size: 18px; font-weight: 700; color: rgba(255, 255, 255, 0.6);">
                        Question ${currentQuizIndex + 1} of ${quizQuestions.length}
                    </span>
                </div>
                <div class="quiz-question">
                    <div class="quiz-question-text">${question.question}</div>
                    <div class="quiz-options" id="quizOptions">
                        ${question.options.map((option, i) => `
                            <div class="quiz-option" onclick="selectQuizAnswer('${option}', '${question.correctAnswer}', ${i})">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Handle quiz answer selection
        function selectQuizAnswer(selected, correct, optionIndex) {
            const options = document.querySelectorAll('.quiz-option');
            const selectedOption = options[optionIndex];

            if (selected === correct) {
                selectedOption.classList.add('correct');
                quizScore++;
            } else {
                selectedOption.classList.add('incorrect');
                // Highlight correct answer
                options.forEach((opt, i) => {
                    if (quizQuestions[currentQuizIndex].options[i] === correct) {
                        opt.classList.add('correct');
                    }
                });
            }

            // Disable all options
            options.forEach(opt => opt.style.pointerEvents = 'none');

            // Next question after 1.5s
            setTimeout(() => {
                currentQuizIndex++;
                renderQuiz();
            }, 1500);
        }

        // ========== FLASHCARD PRACTICE SYSTEM ==========

        // Load practice cards from vocabulary
        async function loadPracticeCards() {
            practiceCards = [];

            // Get saved words
            const savedWords = Array.from(wordsLearned);

            if (savedWords.length === 0) {
                document.getElementById('practiceProgress').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“–</div>
                        <div style="font-size: 18px; opacity: 0.7;">
                            No words saved yet. Start learning by clicking on Spanish words in videos!
                        </div>
                    </div>
                `;
                return;
            }

            // Load from Supabase if logged in
            if (currentUser) {
                try {
                    const { data, error } = await supabase
                        .from('vocabulary')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('created_at', { ascending: false });

                    if (!error && data) {
                        practiceCards = data.map(item => ({
                            spanish: item.word,
                            english: item.translation,
                            sentence: item.context_sentence || ''
                        }));
                    }
                } catch (e) {
                    console.error('Error loading vocabulary:', e);
                }
            }

            // Fallback: use saved words with mock translations
            if (practiceCards.length === 0) {
                practiceCards = savedWords.map(word => ({
                    spanish: word,
                    english: `Translation of ${word}`,
                    sentence: ''
                }));
            }

            currentCardIndex = 0;
            renderFlashcard();
        }

        // Render current flashcard
        function renderFlashcard() {
            if (practiceCards.length === 0) return;

            const container = document.getElementById('flashcardContainer');
            const card = practiceCards[currentCardIndex];

            document.getElementById('practiceProgress').textContent =
                `${currentCardIndex + 1} / ${practiceCards.length} cards`;

            container.innerHTML = `
                <div class="flashcard" onclick="flipCard()">
                    <div class="flashcard-front">
                        <div class="flashcard-word">${card.spanish}</div>
                        <div style="font-size: 14px; opacity: 0.6; margin-top: 20px;">
                            Tap to reveal translation
                        </div>
                    </div>
                    <div class="flashcard-back">
                        <div class="flashcard-translation">${card.english}</div>
                        ${card.sentence ? `<div class="flashcard-sentence">"${card.sentence}"</div>` : ''}
                    </div>
                </div>
            `;

            document.getElementById('flashcardControls').style.display = 'flex';
            isCardFlipped = false;
        }

        // Flip flashcard
        function flipCard() {
            const card = document.querySelector('.flashcard');
            if (card) {
                card.classList.toggle('flipped');
                isCardFlipped = !isCardFlipped;
            }
        }

        // Rate flashcard (Easy/Good/Hard) - SM-2 algorithm placeholder
        function rateCard(difficulty) {
            console.log(`Card rated as: ${difficulty}`);

            // Award XP based on difficulty
            const xpReward = { hard: 5, good: 10, easy: 15 };
            addXP(xpReward[difficulty], `Practiced flashcard (${difficulty})`);

            // Move to next card
            currentCardIndex++;

            if (currentCardIndex >= practiceCards.length) {
                // Practice complete
                const container = document.getElementById('flashcardContainer');
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 80px; margin-bottom: 20px;">ðŸŽ‰</div>
                        <h2 style="font-size: 32px; margin-bottom: 12px;">Practice Complete!</h2>
                        <p style="font-size: 18px; opacity: 0.8;">
                            You reviewed ${practiceCards.length} cards. Great work!
                        </p>
                        <button class="quiz-restart-btn" onclick="loadPracticeCards()" style="margin-top: 24px;">
                            Practice Again
                        </button>
                    </div>
                `;
                document.getElementById('flashcardControls').style.display = 'none';
                createConfetti();
            } else {
                renderFlashcard();
            }
        }

        // SPEED MENU: Show speed control modal (thumb-accessible)
        function showSpeedMenu(card) {
            // Find the old speed control
            const oldSpeedControl = card.querySelector('.speed-control');
            if (!oldSpeedControl) return;

            const speedMenu = oldSpeedControl.querySelector('.speed-menu');
            if (!speedMenu) return;

            // Toggle menu visibility
            speedMenu.classList.toggle('show');

            // Close menu when clicking outside
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!speedMenu.contains(e.target) && !e.target.closest('.speed-btn-new')) {
                        speedMenu.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 100);
        }

        // TAB SWITCHING (ENHANCED with Practice and Quiz)
        function switchTab(tabName) {
            currentTab = tabName;

            // Update active tab
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-feed="${tabName}"]`)?.classList.add('active');

            // Hide all views
            document.getElementById('profileView').classList.remove('show');
            if (document.getElementById('practiceView')) {
                document.getElementById('practiceView').classList.remove('show');
            }
            document.getElementById('quizView').classList.remove('show');
            document.getElementById('feedContainer').style.display = 'block';

            // Handle different tabs
            if (tabName === 'profile') {
                if (!currentUser) {
                    document.getElementById('authModal').classList.add('show');
                } else {
                    openProfile();
                }
            } else if (tabName === 'home') {
                // Show video feed
                document.getElementById('feedContainer').style.display = 'block';
            } else if (tabName === 'discover') {
                // Navigate to AI Discover Feed
                window.location.href = '/discover-ai.html';
            } else if (tabName === 'quizzes') {
                // Navigate to Duolingo-style quiz page
                window.location.href = '/components/duolingo-quiz.html';
            } else if (tabName === 'games') {
                // Navigate to Language Games page
                window.location.href = '/components/language-games.html';
            }
        }

        // Show Quiz Mode
        function showQuizMode() {
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('practiceContainer').style.display = 'none';

            // Start general quiz if no video quiz is active
            if (quizQuestions.length === 0) {
                startGeneralQuiz();
            }
        }

        // Show Practice Mode (Flashcards)
        function showPracticeMode() {
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('practiceContainer').style.display = 'block';
            loadPracticeCards();
        }

        // Start general quiz (not video-specific)
        function startGeneralQuiz() {
            const savedWords = Array.from(wordsLearned).slice(0, 10);

            if (savedWords.length === 0) {
                document.getElementById('quizContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“š</div>
                        <div style="font-size: 18px; opacity: 0.7;">
                            Learn some words first, then come back to practice!
                        </div>
                        <button class="quiz-restart-btn" onclick="switchTab('home')" style="margin-top: 24px;">
                            Watch Videos
                        </button>
                    </div>
                `;
                return;
            }

            // Create quiz from learned words
            quizQuestions = savedWords.map(word => ({
                question: `What does "${word}" mean in Spanish?`,
                correctAnswer: `Translation of ${word}`,
                options: generateQuizOptions(`Translation of ${word}`)
            }));

            currentQuizIndex = 0;
            quizScore = 0;
            renderQuiz();
        }

        function openProfile() {
            document.getElementById('profileView').classList.add('show');
            loadUserVocabulary();

            // Update frequency progress when profile is opened
            const userLevel = localStorage.getItem('userLevel') || 'A1';
            updateFrequencyProgress(userLevel);
        }

        function closeProfile() {
            document.getElementById('profileView').classList.remove('show');
        }

        // X2 MODE CONTROL - Watch video twice (first with subtitles, then transcript only)
        function toggleX2Mode(btn) {
            const isX2Active = btn.classList.toggle('x2-active');
            const x2Status = btn.querySelector('.x2-status');
            const card = btn.closest('.video-card');

            if (isX2Active) {
                x2Status.textContent = 'On';
                btn.style.background = 'rgba(124, 58, 237, 0.3)'; // Purple tint when active
                btn.dataset.firstPlayDone = 'false';
                console.log('ðŸ” x2 mode enabled: Will play twice (subtitles â†’ transcript only)');
            } else {
                x2Status.textContent = 'Off';
                btn.style.background = '';
                btn.dataset.firstPlayDone = 'false';

                // Restore subtitles if they were hidden
                const subtitlesOverlay = card.querySelector('.subtitles-overlay');
                if (subtitlesOverlay) {
                    subtitlesOverlay.style.display = '';
                }
                console.log('â†ªï¸ x2 mode disabled');
            }
        }

        // SPEED CONTROL FUNCTIONS - Single-tap cycle (1x â†’ 0.5x â†’ 0.75x â†’ 1x)
        const speedOptions = [1, 0.5, 0.75]; // NEW ORDER: normal â†’ half â†’ 0.75
        let speedIndex = 0;

        function cycleSpeed() {
            // Cycle through speeds
            speedIndex = (speedIndex + 1) % speedOptions.length;
            const newSpeed = speedOptions[speedIndex];

            // Update global speed
            currentPlaybackSpeed = newSpeed;
            localStorage.setItem('playbackSpeed', newSpeed);

            // Apply to all loaded videos
            document.querySelectorAll('video').forEach(video => {
                video.playbackRate = newSpeed;
            });

            // Update ALL speed displays in sidebar (all video cards)
            document.querySelectorAll('.speed-display').forEach(display => {
                display.textContent = newSpeed + 'x';
            });

            // Hide onboarding tooltip if shown
            const tooltip = document.getElementById('speedTooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }

            console.log(`âš¡ Speed changed to ${newSpeed}x`);
        }

        function toggleTranslation(btn) {
            // Get current video card
            const card = btn.closest('.video-card');
            if (!card) return;

            // Get subtitle container
            const subtitleContainer = card.querySelector('.subtitle-container');
            if (!subtitleContainer) return;

            // Get status display
            const statusDisplay = btn.querySelector('.translate-status');

            // Cycle through modes: Both -> Spanish Only -> English Only -> Both
            if (!subtitleContainer.classList.contains('spanish-only') && !subtitleContainer.classList.contains('english-only')) {
                // Currently: Both -> Switch to Spanish Only
                subtitleContainer.classList.add('spanish-only');
                statusDisplay.textContent = 'ES';
                console.log('ðŸ”¤ Translation mode: Spanish Only');
            } else if (subtitleContainer.classList.contains('spanish-only')) {
                // Currently: Spanish Only -> Switch to English Only
                subtitleContainer.classList.remove('spanish-only');
                subtitleContainer.classList.add('english-only');
                statusDisplay.textContent = 'EN';
                console.log('ðŸ”¤ Translation mode: English Only');
            } else {
                // Currently: English Only -> Switch to Both
                subtitleContainer.classList.remove('english-only');
                statusDisplay.textContent = 'Both';
                console.log('ðŸ”¤ Translation mode: Both');
            }
        }

        function applyPlaybackSpeed(videoEl) {
            videoEl.playbackRate = currentPlaybackSpeed;
        }

        function changeSpeed(speed) {
            currentPlaybackSpeed = speed;
            localStorage.setItem('playbackSpeed', speed);

            // Apply to all loaded videos
            document.querySelectorAll('video').forEach(video => {
                video.playbackRate = speed;
            });

            // Update speed button text
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.textContent = speed + 'x';
            });
            const globalBtn = document.getElementById('globalSpeedBtn');
            if (globalBtn) {
                globalBtn.textContent = speed + 'x';
            }

            // Update active state
            document.querySelectorAll('.speed-option').forEach(opt => {
                opt.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Hide menu
            document.querySelectorAll('.speed-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }

        function toggleSpeedMenu(card) {
            const menu = card.querySelector('.speed-menu');
            if (!menu) return;

            const isShown = menu.classList.contains('show');

            // Close all speed menus
            document.querySelectorAll('.speed-menu').forEach(m => m.classList.remove('show'));

            // Toggle current menu
            if (!isShown) {
                menu.classList.add('show');
            }
        }

        // DELETE VIDEO FUNCTION (called from sidebar delete button)
        async function deleteVideo(videoId, videoCard) {
            if (!confirm('Delete this video permanently? This cannot be undone.')) {
                return;
            }

            try {
                // Show loading indicator
                if (videoCard) {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 20px 40px;
                        border-radius: 12px;
                        font-size: 16px;
                        z-index: 10000;
                    `;
                    loadingDiv.textContent = 'Deleting...';
                    videoCard.appendChild(loadingDiv);
                }

                const response = await fetch(`/api/videos/${videoId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Add to localStorage blacklist for permanent hiding
                    const deletedVideos = JSON.parse(localStorage.getItem('deletedVideos') || '[]');
                    if (!deletedVideos.includes(videoId)) {
                        deletedVideos.push(videoId);
                        localStorage.setItem('deletedVideos', JSON.stringify(deletedVideos));
                    }

                    // Remove from DOM
                    if (videoCard) videoCard.remove();

                    // Remove from videos array
                    videos = videos.filter(v => v.id !== videoId);

                    console.log(`âœ… Video ${videoId} deleted permanently`);
                } else {
                    alert('Failed to delete video');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error deleting video');
            }
        }

        // Report transcription/timing issues for re-transcription
        async function reportTranscription(videoId, videoUrl, videoCard) {
            const confirmed = confirm('Report this video for incorrect transcription or timing?\n\nThis will flag it for automatic re-transcription.');

            if (!confirmed) return;

            try {
                // Show loading indicator
                let loadingDiv;
                if (videoCard) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 20px 40px;
                        border-radius: 12px;
                        font-size: 16px;
                        z-index: 10000;
                    `;
                    loadingDiv.textContent = 'Reporting...';
                    videoCard.appendChild(loadingDiv);
                }

                const response = await fetch('/api/transcription/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        videoId,
                        videoUrl,
                        reportedBy: currentUser?.email || 'anonymous',
                        timestamp: new Date().toISOString()
                    })
                });

                const data = await response.json();

                if (loadingDiv) loadingDiv.remove();

                if (response.ok) {
                    // IMMEDIATELY HIDE VIDEO until retranscription is complete (same as delete)
                    // Add to localStorage blacklist so user doesn't see it again
                    const retranscribingVideos = JSON.parse(localStorage.getItem('retranscribingVideos') || '[]');
                    if (!retranscribingVideos.includes(videoId)) {
                        retranscribingVideos.push(videoId);
                        localStorage.setItem('retranscribingVideos', JSON.stringify(retranscribingVideos));
                    }

                    // Remove from DOM immediately
                    if (videoCard) videoCard.remove();

                    // Remove from videos array
                    videos = videos.filter(v => v.id !== videoId);

                    alert(`âœ… Thank you! Video has been hidden and flagged for re-transcription.\n\nQueue position: #${data.queuePosition}\nExpected: ${data.estimatedCompletion || '5-10 min'}\n\nThe video will reappear once retranscription is complete.`);
                    console.log('ðŸ“ Transcription report:', data);
                } else {
                    alert(`âŒ Failed to report: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Report transcription error:', error);
                alert('âŒ Error submitting report. Please try again.');
            }
        }

        // Show video options menu (bottom sheet with more actions)
        function showVideoOptions(videoId, videoUrl, button) {
            const card = button.closest('.video-card');

            // Create bottom sheet overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 9999;
                display: flex;
                align-items: flex-end;
                animation: fadeIn 0.2s ease;
            `;

            const sheet = document.createElement('div');
            sheet.style.cssText = `
                background: #1a1a1a;
                border-radius: 20px 20px 0 0;
                padding: 24px;
                width: 100%;
                max-width: 500px;
                margin: 0 auto;
                animation: slideUp 0.3s ease;
            `;

            sheet.innerHTML = `
                <style>
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
                    .option-btn {
                        display: flex;
                        align-items: center;
                        gap: 16px;
                        padding: 16px;
                        background: rgba(255, 255, 255, 0.05);
                        border: none;
                        border-radius: 12px;
                        color: white;
                        font-size: 16px;
                        width: 100%;
                        margin-bottom: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .option-btn:hover {
                        background: rgba(255, 255, 255, 0.1);
                        transform: scale(1.02);
                    }
                    .option-btn:active {
                        transform: scale(0.98);
                    }
                    .option-btn.danger {
                        color: #ff4444;
                    }
                </style>
                <h3 style="margin: 0 0 20px 0; color: white; font-size: 18px;">Video Options</h3>

                <button class="option-btn" onclick="reportTranscription('${videoId}', '${videoUrl}'); this.closest('.overlay-tmp').remove();">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    Report Transcription Issue
                </button>

                <button class="option-btn danger" onclick="deleteVideo('${videoId}', document.querySelector('[data-video-id=\\'${videoId}\\']')); this.closest('.overlay-tmp').remove();">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Delete Video
                </button>

                <button class="option-btn" onclick="this.closest('.overlay-tmp').remove();" style="background: rgba(255, 255, 255, 0.1);">
                    Cancel
                </button>
            `;

            overlay.appendChild(sheet);
            overlay.className = 'overlay-tmp';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            document.body.appendChild(overlay);
        }

        // Make functions available globally for onclick handlers
        window.switchTab = switchTab;
        window.closeAuthModal = closeAuthModal;
        window.toggleAuthMode = toggleAuthMode;
        window.handleAuth = handleAuth;
        window.handleLogout = handleLogout;
        window.closeProfile = closeProfile;
        window.changeSpeed = changeSpeed;
        window.toggleSpeedMenu = toggleSpeedMenu;
        window.cycleSpeed = cycleSpeed;
        window.deleteVideo = deleteVideo;
        window.reportTranscription = reportTranscription;
        window.showVideoOptions = showVideoOptions;
        window.skipVideoQuiz = skipVideoQuiz;
        window.startVideoQuiz = startVideoQuiz;
        window.selectQuizAnswer = selectQuizAnswer;
        window.flipCard = flipCard;
        window.rateCard = rateCard;
        window.loadPracticeCards = loadPracticeCards;
        window.startGeneralQuiz = startGeneralQuiz;
        window.showQuizMode = showQuizMode;
        window.showPracticeMode = showPracticeMode;

        // GAMIFICATION BAR AUTO-HIDE on scroll (slides down, hides after 2s)
        let gamificationTimeout;
        const gamificationBar = document.getElementById('gamificationBar');
        const feedContainer = document.getElementById('feedContainer');

        feedContainer.addEventListener('scroll', () => {
            // Show bar on scroll
            gamificationBar.classList.remove('hidden');

            // Clear previous timeout
            clearTimeout(gamificationTimeout);

            // Hide after 2 seconds
            gamificationTimeout = setTimeout(() => {
                gamificationBar.classList.add('hidden');
            }, 2000);
        });

        // Initialize app FIRST (critical path)
        checkAuth();
        loadVideos();

        // ===== BEGINNER MODE INTEGRATION =====
        // Import beginner mode and quiz controllers (non-blocking, after critical init)
        import('/lib/beginnerModeController.js').then(module => {
            const BeginnerModeController = module.default;
            window.beginnerModeController = new BeginnerModeController(supabase);

            // Make functions globally available
            window.activateBeginnerMode = () => {
                window.beginnerModeController.activate();
                // Close prompt modal
                const modal = document.querySelector('.beginner-mode-prompt-modal');
                if (modal) modal.remove();
                // Reload videos with A1 filter
                loadVideos();
            };

            window.speakWord = (text) => {
                window.beginnerModeController.speakWord(text);
            };

            window.replayVocabPreview = () => {
                // Replay audio for current vocab preview
                const words = document.querySelectorAll('.word-item');
                words.forEach((item, i) => {
                    setTimeout(() => {
                        const spanish = item.querySelector('.spanish').textContent;
                        window.beginnerModeController.speakWord(spanish);
                        item.classList.add('active');
                        setTimeout(() => item.classList.remove('active'), 1000);
                    }, i * 1500);
                });
            };
        }).catch(err => {
            console.warn('Beginner mode controller failed to load:', err);
        });

        import('/lib/quizModeController.js').then(module => {
            const QuizModeController = module.default;
            window.quizModeController = new QuizModeController(supabase);

            // Make quiz functions globally available
            window.startBeginnerQuiz = () => {
                // Close quiz prompt
                const prompt = document.querySelector('.quiz-prompt-modal');
                if (prompt) prompt.remove();
                // Start quiz
                window.quizModeController.startQuiz();
            };
        }).catch(err => {
            console.warn('Quiz mode controller failed to load:', err);
        });

        // Initialize gamification
        updateStreak();
        updateStatsDisplay();

        // Update global speed button with saved speed
        const globalSpeedBtn = document.getElementById('globalSpeedBtn');
        if (globalSpeedBtn) {
            globalSpeedBtn.textContent = currentPlaybackSpeed + 'x';
            // Set initial speedIndex based on saved speed
            speedIndex = speedOptions.indexOf(currentPlaybackSpeed);
            if (speedIndex === -1) speedIndex = 0;
        }

        // Auto-hide stats top bar on scroll
        let statsBarTimeout;
        const statsTopBar = document.getElementById('statsTopBar');
        // feedContainer already declared above - reuse it

        feedContainer.addEventListener('scroll', () => {
            // Show bar on scroll
            statsTopBar.classList.remove('hidden');

            // Clear previous timeout
            clearTimeout(statsBarTimeout);

            // Hide after 3 seconds
            statsBarTimeout = setTimeout(() => {
                statsTopBar.classList.add('hidden');
            }, 3000);
        });

        // ========== BEGINNER ONBOARDING SYSTEM ==========

        let beginnerTourStep = 0;

        // Check if user is a complete beginner (demo mode or first visit)
        function isBeginnerUser() {
            // Demo mode: Add ?beginner=true to URL or use demo account
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('beginner') === 'true') return true;

            // Check if this is first visit AND user level is A1
            const hasSeenTour = localStorage.getItem('hasSeenBeginnerTour');
            const userLevel = localStorage.getItem('userLevel') || 'A1';
            const videosWatched = parseInt(localStorage.getItem('videosWatched') || '0');

            return !hasSeenTour && userLevel === 'A1' && videosWatched < 3;
        }

        // Start beginner tour
        window.startBeginnerTour = function() {
            beginnerTourStep = 1;
            document.getElementById('welcomeModal').style.display = 'none';
            showBeginnerStep(1);
        };

        // Skip beginner tour
        window.skipBeginnerTour = function() {
            localStorage.setItem('hasSeenBeginnerTour', 'true');
            document.getElementById('beginnerOnboarding').style.display = 'none';
        };

        // Show specific step of beginner tour
        function showBeginnerStep(step) {
            // Hide all tooltips
            document.getElementById('speedTooltip').style.display = 'none';
            document.getElementById('difficultyTooltip').style.display = 'none';
            document.getElementById('wordsTooltip').style.display = 'none';

            // Show current step
            if (step === 1) {
                document.getElementById('speedTooltip').style.display = 'block';
            } else if (step === 2) {
                document.getElementById('difficultyTooltip').style.display = 'block';
            } else if (step === 3) {
                document.getElementById('wordsTooltip').style.display = 'block';
            }
        }

        // Move to next step
        window.nextBeginnerStep = function() {
            beginnerTourStep++;
            showBeginnerStep(beginnerTourStep);
        };

        // Finish beginner tour
        window.finishBeginnerTour = function() {
            localStorage.setItem('hasSeenBeginnerTour', 'true');
            document.getElementById('beginnerOnboarding').style.display = 'none';

            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
                padding: 24px 32px;
                border-radius: 16px;
                font-size: 18px;
                font-weight: 700;
                z-index: 9999;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                text-align: center;
            `;
            successMsg.innerHTML = 'ðŸŽ‰ You\'re all set!<br><span style="font-size: 14px; opacity: 0.9;">Start learning Spanish!</span>';
            document.body.appendChild(successMsg);

            setTimeout(() => successMsg.remove(), 2500);
        };

        // Beginner onboarding tour removed - no spam popups

        console.log('ðŸŽ® Gamification initialized:', {
            streak: userStreak,
            xp: userXP,
            words: wordsLearned.size,
            videosWatched: videosWatched
        });

        // ðŸŽ CHECK FOR REFERRAL LINK
        function checkReferralLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            const myRefCode = localStorage.getItem('referralCode');
            
            if (refCode && refCode !== myRefCode) {
                console.log(`ðŸŽ Referral from: ${refCode}`);
                localStorage.setItem('referredBy', refCode);
                
                // Give 7 days Premium
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 7);
                localStorage.setItem('premiumExpiry', expiryDate.getTime());
                localStorage.setItem('isPremium', 'true');
                
                // Show welcome message (only if not in test environment)
                if (typeof window !== 'undefined' && !window.location.search.includes('test=true')) {
                    setTimeout(() => {
                        alert('ðŸŽ‰ Welcome! You got 7 days of Premium free!\n\nEnjoy unlimited learning!');
                    }, 1000);
                }
                
                // Track referral for the referrer (in production, API call)
                console.log('âœ… Premium trial activated via referral');
            }
        }

        // ðŸ“Š UPDATE LEVEL BADGE
        function updateLevelBadge() {
            const level = localStorage.getItem('userLevel') || 'A2';
            const levelBadge = document.getElementById('levelBadge');
            if (levelBadge) {
                levelBadge.textContent = level;
                console.log(`ðŸ“Š Level badge updated: ${level}`);
            }
        }

        // Initialize on load (with slight delay to ensure localStorage is ready)
        setTimeout(() => {
            checkReferralLink();
            updateLevelBadge();
        }, 100);
        
        // Update level badge on any localStorage change
        window.addEventListener('storage', updateLevelBadge);
        
        // Also update when page becomes visible
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                updateLevelBadge();
            }
        });

        // ðŸŽ¯ ONBOARDING TOUR SYSTEM
        let selectedDailyGoal = parseInt(localStorage.getItem('dailyGoalMinutes') || '10');
        let currentOnboardingStep = 1;

        function showOnboarding() {
            // DISABLED: Onboarding blocks video loading
            // User feedback: "basic things don't work. Even the videos don't load"
            console.log('â­ï¸  Onboarding skipped - loading videos immediately');
            return;

            const overlay = document.getElementById('onboardingOverlay');

            overlay.innerHTML = `
                <div class="onboarding-card" id="onboardingStep1">
                    <div class="onboarding-icon">ðŸ‘‹</div>
                    <h2 class="onboarding-title">Welcome to Langflix!</h2>
                    <p class="onboarding-description">
                        Learn Spanish through viral videos, AI-powered news, and fun games.
                        Let's get you started!
                    </p>
                    <div class="onboarding-progress">
                        <div class="progress-dot active"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                        <div class="progress-dot"></div>
                    </div>
                    <div class="onboarding-actions">
                        <button class="onboarding-btn onboarding-btn-skip" onclick="skipOnboarding()">Skip</button>
                        <button class="onboarding-btn onboarding-btn-primary" onclick="finishOnboarding()">Let's Go!</button>
                    </div>
                </div>
            `;

            overlay.classList.add('show');
        }

        function nextOnboardingStep(step) {
            const steps = {
                1: {
                    icon: 'ðŸ“±',
                    title: 'Swipe to Learn',
                    desc: 'Watch viral Spanish videos like TikTok. Swipe up for next video, tap to pause.',
                    progress: [0, 1, 0, 0, 0]
                },
                2: {
                    icon: 'ðŸ‘†',
                    title: 'Tap Any Word',
                    desc: 'See a word you don\'t know? Just tap it! Get instant translations and save to your vocabulary.',
                    progress: [0, 0, 1, 0, 0]
                },
                3: {
                    icon: 'ðŸ”¥',
                    title: 'Build Your Streak',
                    desc: 'Practice daily to build your streak! Track words learned, videos watched, and level up.',
                    progress: [0, 0, 0, 1, 0]
                },
                4: {
                    icon: 'ðŸŽ¯',
                    title: 'Set Your Daily Goal',
                    desc: 'How much time do you have each day?',
                    progress: [0, 0, 0, 0, 1],
                    isGoalSelection: true
                }
            };

            const nextStep = steps[step];
            if (!nextStep) return;

            const overlay = document.getElementById('onboardingOverlay');
            
            if (nextStep.isGoalSelection) {
                overlay.innerHTML = `
                    <div class="onboarding-card">
                        <div class="onboarding-icon">${nextStep.icon}</div>
                        <h2 class="onboarding-title">${nextStep.title}</h2>
                        <p class="onboarding-description">${nextStep.desc}</p>
                        <div class="goal-options">
                            <div class="goal-option" onclick="selectGoal(5)">
                                <div class="goal-emoji">â˜•</div>
                                <div class="goal-option-title">5 minutes</div>
                                <div class="goal-option-desc">Casual - Perfect for coffee breaks</div>
                            </div>
                            <div class="goal-option selected" onclick="selectGoal(10)">
                                <div class="goal-emoji">âš¡</div>
                                <div class="goal-option-title">10 minutes</div>
                                <div class="goal-option-desc">Regular - Great for daily practice</div>
                            </div>
                            <div class="goal-option" onclick="selectGoal(15)">
                                <div class="goal-emoji">ðŸš€</div>
                                <div class="goal-option-title">15 minutes</div>
                                <div class="goal-option-desc">Serious - Fast progress</div>
                            </div>
                            <div class="goal-option" onclick="selectGoal(20)">
                                <div class="goal-emoji">ðŸ”¥</div>
                                <div class="goal-option-title">20+ minutes</div>
                                <div class="goal-option-desc">Intense - Fluency focused</div>
                            </div>
                        </div>
                        <div class="onboarding-progress">
                            ${nextStep.progress.map(active => `<div class="progress-dot ${active ? 'active' : ''}"></div>`).join('')}
                        </div>
                        <div class="onboarding-actions">
                            <button class="onboarding-btn onboarding-btn-primary" style="max-width: 100%;" onclick="finishOnboarding()">
                                Start Learning! ðŸŽ‰
                            </button>
                        </div>
                    </div>
                `;
            } else {
                overlay.innerHTML = `
                    <div class="onboarding-card">
                        <div class="onboarding-icon">${nextStep.icon}</div>
                        <h2 class="onboarding-title">${nextStep.title}</h2>
                        <p class="onboarding-description">${nextStep.desc}</p>
                        <div class="onboarding-progress">
                            ${nextStep.progress.map(active => `<div class="progress-dot ${active ? 'active' : ''}"></div>`).join('')}
                        </div>
                        <div class="onboarding-actions">
                            <button class="onboarding-btn onboarding-btn-skip" onclick="skipOnboarding()">Skip</button>
                            <button class="onboarding-btn onboarding-btn-primary" onclick="nextOnboardingStep(${step + 1})">
                                ${step === 3 ? 'Awesome!' : step === 2 ? 'Nice!' : 'Got it!'}
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function selectGoal(minutes) {
            selectedDailyGoal = minutes;
            document.querySelectorAll('.goal-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.goal-option').classList.add('selected');
        }

        function finishOnboarding() {
            console.log('âœ… finishOnboarding() called');
            localStorage.setItem('onboardingComplete', 'true');
            localStorage.setItem('dailyGoalMinutes', selectedDailyGoal);
            localStorage.setItem('onboardingDate', new Date().toISOString());

            const overlay = document.getElementById('onboardingOverlay');
            console.log('ðŸ“‹ Overlay element:', overlay);
            console.log('ðŸ“‹ Has show class before remove:', overlay?.classList.contains('show'));

            if (overlay) {
                overlay.classList.remove('show');
                console.log('ðŸ“‹ Has show class after remove:', overlay.classList.contains('show'));
            }

            initDailyGoalTracking();

            // Show celebration
            setTimeout(() => {
                console.log(`ðŸŽ‰ Onboarding complete! Goal: ${selectedDailyGoal} minutes`);
            }, 300);
        }

        function skipOnboarding() {
            if (confirm('Skip the tour? You can always access help from your profile.')) {
                localStorage.setItem('onboardingComplete', 'true');
                localStorage.setItem('dailyGoalMinutes', 10);
                document.getElementById('onboardingOverlay').classList.remove('show');
            }
        }

        // ðŸ“Š DAILY GOAL TRACKING
        function initDailyGoalTracking() {
            const goal = parseInt(localStorage.getItem('dailyGoalMinutes') || '10');
            const today = new Date().toDateString();
            const lastDate = localStorage.getItem('lastActivityDate');
            
            // Reset if new day
            if (lastDate !== today) {
                localStorage.setItem('todayMinutes', '0');
                localStorage.setItem('lastActivityDate', today);
            }
            
            updateDailyGoalUI();
            
            // Show goal progress after a few seconds
            setTimeout(() => {
                document.getElementById('dailyGoalProgress').classList.add('show');
                setTimeout(() => {
                    document.getElementById('dailyGoalProgress').classList.remove('show');
                }, 5000);
            }, 3000);
        }

        function updateDailyGoalUI() {
            const goal = parseInt(localStorage.getItem('dailyGoalMinutes') || '10');
            const minutes = parseFloat(localStorage.getItem('todayMinutes') || '0');
            const percentage = Math.min((minutes / goal) * 100, 100);
            
            document.getElementById('goalProgressText').textContent = `${Math.round(minutes)}/${goal} min today`;
            document.getElementById('goalProgressFill').style.width = `${percentage}%`;
            
            if (percentage >= 100) {
                document.getElementById('goalProgressText').textContent = `ðŸŽ‰ Goal Complete!`;
            }
        }

        function trackTimeSpent(seconds) {
            const minutes = seconds / 60;
            const current = parseFloat(localStorage.getItem('todayMinutes') || '0');
            localStorage.setItem('todayMinutes', (current + minutes).toString());
            updateDailyGoalUI();
        }

        // Track video watch time
        let videoStartTime = Date.now();
        setInterval(() => {
            // Track 1 second of video watching
            trackTimeSpent(1);
        }, 1000);

        // Initialize - DISABLED onboarding entirely
        // User feedback: "basic things don't work. Even the videos don't load"
        // FIX: Comment out showOnboarding(), let videos load immediately
        localStorage.setItem('onboardingComplete', 'true');
        localStorage.setItem('beginnerWelcomeShown', 'true');
        localStorage.setItem('dailyGoalMinutes', '10');
        setTimeout(() => {
            // DISABLED: showOnboarding() - causes videos not to load
            // const onboardingComplete = localStorage.getItem('onboardingComplete');
            // if (!onboardingComplete) {
            //     setTimeout(() => showOnboarding(), 1000);
            // }
            initDailyGoalTracking();
        }, 100);

        // ===== TIKTOK-STYLE SWIPE GESTURES =====
        // Add touch gesture support for mobile (in addition to scroll)
        (function initSwipeGestures() {
            const feedContainer = document.getElementById('feedContainer');
            if (!feedContainer) return;

            let touchStartY = 0;
            let touchStartTime = 0;
            let isSwiping = false;

            feedContainer.addEventListener('touchstart', (e) => {
                // Don't interfere with button/input touches
                const target = e.target;
                if (target.tagName === 'BUTTON' || target.tagName === 'INPUT' || target.closest('button, input, a')) {
                    return;
                }

                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
                isSwiping = false;
            }, { passive: true });

            feedContainer.addEventListener('touchmove', (e) => {
                if (touchStartY === 0) return;

                const touchMoveY = e.touches[0].clientY;
                const distance = Math.abs(touchStartY - touchMoveY);

                // If moved > 20px, user is swiping (not tapping)
                if (distance > 20) {
                    isSwiping = true;
                }
            }, { passive: true });

            feedContainer.addEventListener('touchend', (e) => {
                if (touchStartY === 0) return;

                const touchEndY = e.changedTouches[0].clientY;
                const touchEndTime = Date.now();
                const swipeDistance = touchStartY - touchEndY;
                const swipeTime = touchEndTime - touchStartTime;

                // Trigger if quick swipe (< 500ms), far enough (> 70px), and actually swiping
                if (isSwiping && swipeTime < 500 && Math.abs(swipeDistance) > 70) {
                    const cards = Array.from(feedContainer.querySelectorAll('.video-card'));
                    const viewportHeight = window.innerHeight;
                    let currentCard = null;

                    // Find currently visible card
                    for (const card of cards) {
                        const rect = card.getBoundingClientRect();
                        if (rect.top >= -viewportHeight/2 && rect.top <= viewportHeight/2) {
                            currentCard = card;
                            break;
                        }
                    }

                    if (currentCard) {
                        if (swipeDistance > 0) {
                            // Swipe up â†’ next video
                            const nextCard = currentCard.nextElementSibling;
                            if (nextCard && nextCard.classList.contains('video-card')) {
                                nextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            } else if (loadedVideoCount < videos.length) {
                                renderVideosBatch(loadedVideoCount, BATCH_SIZE);
                                setTimeout(() => {
                                    const newNext = currentCard.nextElementSibling;
                                    if (newNext) newNext.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }, 100);
                            }
                        } else {
                            // Swipe down â†’ previous video
                            const prevCard = currentCard.previousElementSibling;
                            if (prevCard && prevCard.classList.contains('video-card')) {
                                prevCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }
                    }
                }

                // Reset
                touchStartY = 0;
                isSwiping = false;
            }, { passive: true });

            console.log('âœ… TikTok-style swipe gestures initialized');
        })();
    </script>

    <!-- ðŸ§  RESEARCH-BACKED FEED INTEGRATION -->
    <script src="/js/research-feed-integration.js"></script>
    
    <!-- ðŸŽ“ BEGINNER MODE INTEGRATION -->
    <script src="/js/beginner-mode-integration.js"></script>
    
    <!-- ðŸ§  GENIUS ADAPTIVE SYSTEM INTEGRATION -->
    <!-- TEMPORARILY DISABLED: MIME type issues - will extract JS in separate fix -->
    <!-- <script src="/components/adaptive-difficulty-controls.html"></script> -->
    <!-- <script src="/components/beginner-mode-helper.html"></script> -->
    <script>
        // Initialize Adaptive Difficulty Controls
        document.addEventListener('DOMContentLoaded', () => {
            // Add adaptive controls container to each video card
            document.querySelectorAll('.video-card').forEach((card, index) => {
                const videoId = card.dataset.videoId || `video_${index}`;
                
                // Create container for adaptive controls
                const controlsContainer = document.createElement('div');
                controlsContainer.id = `adaptive-controls-${index}`;
                controlsContainer.style.position = 'absolute';
                controlsContainer.style.bottom = '120px';
                controlsContainer.style.left = '0';
                controlsContainer.style.right = '0';
                controlsContainer.style.padding = '0 16px';
                controlsContainer.style.zIndex = '100';
                
                card.appendChild(controlsContainer);
                
                // Initialize adaptive controls when card is visible
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // Initialize controls for this video
                            if (window.AdaptiveDifficultyControls) {
                                new AdaptiveDifficultyControls(`adaptive-controls-${index}`, {
                                    contentId: videoId,
                                    contentType: 'video',
                                    showLevelIndicator: true,
                                    showProgress: true,
                                    onFeedback: (type, data) => {
                                        console.log('ðŸŽ¯ User feedback:', type, data);
                                        
                                        // If user says "too hard", could show simplified captions
                                        if (type === 'too_hard') {
                                            console.log('User needs easier content - system will adapt');
                                        } else if (type === 'too_easy') {
                                            console.log('User wants challenge - system will adapt');
                                        }
                                    }
                                });
                            }
                        }
                    });
                }, { threshold: 0.5 });
                
                observer.observe(card);
            });
            
            // Initialize beginner mode helper (shows at top if user is beginner)
            const beginnerContainer = document.createElement('div');
            beginnerContainer.id = 'beginner-helper-container';
            beginnerContainer.style.position = 'fixed';
            beginnerContainer.style.top = '60px';
            beginnerContainer.style.left = '0';
            beginnerContainer.style.right = '0';
            beginnerContainer.style.zIndex = '1000';
            beginnerContainer.style.padding = '0 16px';
            
            document.body.appendChild(beginnerContainer);
            
            if (window.BeginnerModeHelper) {
                new BeginnerModeHelper('beginner-helper-container', {
                    showTips: true,
                    showProgress: true,
                    showExtraHints: true
                });
            }
            
            console.log('âœ… Genius Adaptive System integrated successfully');
        });
    </script>
</body>
</html>
