<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Discover - Spanish Articles Feed</title>
    
    <!-- üéØ SEO & Performance Optimization -->
    <meta name="description" content="Discover trending Spanish articles, news, and stories. Personalized content feed with AI-powered recommendations for language learners.">
    <meta name="keywords" content="spanish articles, spanish news, learn spanish reading, language learning content">
    <meta name="theme-color" content="#000000">
    
    <!-- Performance: Defer non-critical scripts -->
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* ============================================
           INSTAGRAM DISCOVER 2025 MASONRY GRID LAYOUT
           Research: Instagram 3:4 grid, Pinterest masonry
           Pattern: CSS Grid with auto-flow dense
           ============================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #000;
            --bg-secondary: #0a0a0a;
            --bg-card: #121212;
            --text-primary: #fff;
            --text-secondary: #a0a0a0;
            --accent-blue: #0095f6;
            --accent-green: #58cc02;
            --accent-yellow: #ffd700;
            --accent-red: #ff3b5c;
            --border-color: #2a2a2a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* ============================================
           TOP NAVIGATION BAR
           ============================================ */

        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .top-nav h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .back-button {
            position: absolute;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: var(--border-color);
            transform: scale(1.05);
        }

        /* ===========================================
           UNIFIED BOTTOM NAVIGATION (Same as main app)
           ============================================ */

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 0.5px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 100;
            padding: 0 8px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px 8px;
            min-width: 44px;
            min-height: 44px;
            flex: 1;
            justify-content: center;
        }

        .nav-item:active {
            transform: scale(0.9);
        }

        .nav-icon svg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
            transition: all 0.2s ease;
        }

        .nav-item .nav-icon {
            color: rgba(255, 255, 255, 0.6);
        }

        .nav-item.active .nav-icon {
            color: #fff;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.2s ease;
        }

        .nav-item.active .nav-label {
            color: #fff;
        }

        .back-button:active {
            transform: scale(0.95);
        }

        .back-button svg {
            width: 20px;
            height: 20px;
        }

        .user-level {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .level-badge {
            padding: 4px 12px;
            background: var(--accent-green);
            color: #000;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .xp-count {
            font-size: 14px;
            font-weight: 600;
        }

        /* ============================================
           CATEGORY FILTER CHIPS (Instagram-style)
           ============================================ */

        .category-filters {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            white-space: nowrap;
            z-index: 99;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .category-filters::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            display: inline-block;
            padding: 8px 20px;
            margin-right: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        .filter-chip.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #fff;
        }

        /* ============================================
           MASONRY GRID LAYOUT (Instagram Discover)
           Research: CSS Grid masonry-like layout
           Pattern: Column-count + break-inside avoid
           ============================================ */

        .feed-container {
            margin-top: 140px;
            margin-bottom: 80px;
            padding: 0 10px;
        }

        .masonry-grid {
            column-count: 2;
            column-gap: 10px;
        }

        @media (min-width: 768px) {
            .masonry-grid {
                column-count: 3;
                column-gap: 15px;
            }
        }

        @media (min-width: 1200px) {
            .masonry-grid {
                column-count: 4;
                column-gap: 20px;
            }

            .feed-container {
                padding: 0 40px;
            }
        }

        /* ============================================
           ARTICLE CARDS (Instagram-style)
           ============================================ */

        .article-card {
            display: inline-block;
            width: 100%;
            margin-bottom: 10px;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            break-inside: avoid;
            page-break-inside: avoid;
        }

        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 149, 246, 0.2);
        }

        .article-card:active {
            transform: scale(0.98);
        }

        .article-image {
            width: 100%;
            height: auto;
            aspect-ratio: 4/3;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .article-content {
            padding: 12px;
        }

        .article-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .difficulty-badge {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .difficulty-badge.A1 { background: #58cc02; color: #000; }
        .difficulty-badge.A2 { background: #00cd9c; color: #000; }
        .difficulty-badge.B1 { background: #0095f6; color: #fff; }
        .difficulty-badge.B2 { background: #667eea; color: #fff; }
        .difficulty-badge.C1 { background: #764ba2; color: #fff; }
        .difficulty-badge.C2 { background: #ff3b5c; color: #fff; }

        .reading-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .article-title {
            font-size: 15px;
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 6px;
            color: var(--text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-category {
            display: inline-block;
            font-size: 11px;
            color: var(--accent-blue);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .article-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .bookmark-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bookmark-btn:hover,
        .bookmark-btn.bookmarked {
            color: var(--accent-yellow);
            transform: scale(1.2);
        }

        /* ============================================
           FULL-SCREEN READER MODAL
           Research: Medium reader experience
           Pattern: Side-by-side translation toggle
           ============================================ */

        .reader-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            overflow-y: auto;
        }

        .reader-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .reader-header {
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--bg-secondary);
            transform: scale(1.1);
        }

        .reader-controls {
            display: flex;
            gap: 12px;
        }

        .control-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: var(--bg-secondary);
        }

        .control-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .reader-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .reader-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .reader-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .reader-title {
            font-size: 32px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 20px;
        }

        /* Side-by-side translation view */
        .translation-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .translation-container.side-by-side {
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .spanish-text,
        .english-text {
            font-size: 18px;
            line-height: 1.8;
        }

        .spanish-text {
            color: var(--text-primary);
        }

        .english-text {
            color: var(--text-secondary);
        }

        /* Word-level click translations */
        .spanish-text .word {
            cursor: pointer;
            padding: 2px 4px;
            margin: 0 2px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .spanish-text .word:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .spanish-text .word.highlighted {
            background: rgba(88, 204, 2, 0.3);
            font-weight: 600;
        }

        .word-tooltip {
            position: fixed;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .word-tooltip.active {
            opacity: 1;
            pointer-events: auto;
        }

        .word-tooltip-word {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .word-tooltip-translation {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .save-word-btn {
            width: 100%;
            padding: 8px;
            background: var(--accent-green);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-word-btn:hover {
            transform: scale(1.05);
        }

        /* ============================================
           COMPREHENSION QUIZ MODAL
           ============================================ */

        .quiz-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            padding: 20px;
        }

        .quiz-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .quiz-container {
            max-width: 600px;
            width: 100%;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .quiz-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .quiz-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .quiz-progress {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .quiz-question {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .quiz-option {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .quiz-option:hover {
            border-color: var(--accent-blue);
            background: rgba(0, 149, 246, 0.1);
        }

        .quiz-option.selected {
            border-color: var(--accent-blue);
            background: rgba(0, 149, 246, 0.2);
        }

        .quiz-option.correct {
            border-color: var(--accent-green);
            background: rgba(88, 204, 2, 0.2);
        }

        .quiz-option.incorrect {
            border-color: var(--accent-red);
            background: rgba(255, 59, 92, 0.2);
        }

        .quiz-next-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-blue);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quiz-next-btn:hover {
            transform: scale(1.02);
        }

        .quiz-next-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ============================================
           BOTTOM STATS BAR
           ============================================ */

        .stats-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 100;
            padding: 0 20px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .stat-icon {
            font-size: 24px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .stat-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* ============================================
           LOADING & ANIMATIONS
           ============================================ */

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .article-card {
            animation: fadeIn 0.4s ease;
        }

        /* ============================================
           MOBILE OPTIMIZATIONS
           ============================================ */

        @media (max-width: 768px) {
            .reader-title {
                font-size: 24px;
            }

            .spanish-text,
            .english-text {
                font-size: 16px;
            }

            .translation-container.side-by-side {
                grid-template-columns: 1fr;
            }

            .reader-controls {
                flex-wrap: wrap;
            }

            .control-btn {
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        /* ============================================
           DARK MODE (Default)
           ============================================ */

        @media (prefers-color-scheme: light) {
            /* Users can toggle, but default is dark */
        }
    </style>

    <!-- Sentry Error Tracking -->
    <meta name="sentry-dsn" content="">
    <meta name="sentry-environment" content="production">
    <meta name="sentry-traces-sample-rate" content="0.1">
    <meta name="app-version" content="1.0.0">
    <script>
    // Load Sentry AFTER page is fully interactive
    window.addEventListener('load', function() {
        setTimeout(function() {
            var script = document.createElement('script');
            script.src = '/lib/sentry-client.js';
            script.defer = true;
            document.head.appendChild(script);
        }, 2000); // Load 2 seconds after page load
    });
    </script>
</head>
<body>
    <!-- Top Navigation -->
    <div class="top-nav">
        <button class="back-button" onclick="window.location.href='/tiktok-video-feed.html'" aria-label="Back to Videos">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            <span>Back</span>
        </button>
        <h1>Discover Spanish</h1>
        <div class="user-level">
            <div class="level-badge" id="userLevelBadge">B1</div>
            <div class="xp-count" id="xpCount">245 XP</div>
        </div>
    </div>

    <!-- Category Filters -->
    <div class="category-filters" id="categoryFilters">
        <div class="filter-chip active" data-category="all">All</div>
        <div class="filter-chip" data-category="sports">Sports</div>
        <div class="filter-chip" data-category="technology">Technology</div>
        <div class="filter-chip" data-category="culture">Culture</div>
        <div class="filter-chip" data-category="celebrity">Celebrity</div>
        <div class="filter-chip" data-category="politics">Politics</div>
        <div class="filter-chip" data-category="food">Food</div>
        <div class="filter-chip" data-category="travel">Travel</div>
        <div class="filter-chip" data-category="entertainment">Entertainment</div>
    </div>

    <!-- Feed Container with Masonry Grid -->
    <div class="feed-container">
        <div class="masonry-grid" id="masonryGrid">
            <!-- Articles will be inserted here -->
        </div>
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p>Loading amazing articles...</p>
        </div>
    </div>

    <!-- Reader Modal -->
    <div class="reader-modal" id="readerModal">
        <div class="reader-header">
            <button class="close-btn" id="closeReaderBtn">‚úï</button>
            <div class="reader-controls">
                <button class="control-btn" id="translationToggle">Show Translation</button>
                <button class="control-btn" id="ttsBtn">üîä Listen</button>
                <button class="control-btn" id="bookmarkReaderBtn">üîñ</button>
            </div>
        </div>
        <div class="reader-content" id="readerContent">
            <!-- Article content will be inserted here -->
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="quiz-modal" id="quizModal">
        <div class="quiz-container">
            <div class="quiz-header">
                <h2 class="quiz-title">Comprehension Quiz</h2>
                <p class="quiz-progress" id="quizProgress">Question 1 of 3</p>
            </div>
            <div class="quiz-question" id="quizQuestion"></div>
            <div class="quiz-options" id="quizOptions"></div>
            <button class="quiz-next-btn" id="quizNextBtn" disabled>Next Question</button>
        </div>
    </div>

    <!-- Word Tooltip -->
    <div class="word-tooltip" id="wordTooltip">
        <div class="word-tooltip-word" id="tooltipWord"></div>
        <div class="word-tooltip-translation" id="tooltipTranslation"></div>
        <button class="save-word-btn" id="saveWordBtn">Save to Vocabulary</button>
    </div>

    <!-- Bottom Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-icon">üìñ</div>
            <div class="stat-label">Read Today</div>
            <div class="stat-value" id="articlesReadToday">3</div>
        </div>
        <div class="stat-item">
            <div class="stat-icon">üî•</div>
            <div class="stat-label">Streak</div>
            <div class="stat-value" id="streakDays">7</div>
        </div>
        <div class="stat-item">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-label">XP Earned</div>
            <div class="stat-value" id="xpEarned">+15</div>
        </div>
        <div class="stat-item">
            <div class="stat-icon">üéØ</div>
            <div class="stat-label">Quiz Score</div>
            <div class="stat-value" id="quizScore">85%</div>
        </div>
    </div>

    <script>
        /**
         * SPANISH ARTICLES FEED - TikTok Quality Language Learning
         *
         * UX Research Citations:
         * - Instagram Discover: Masonry grid, 3:4 aspect ratio (2025)
         * - Flipboard: AI personalization, 70/20/10 difficulty split
         * - Medium: Clean reader experience, side-by-side translation
         * - Apple News: Infinite scroll, lazy loading (1 viewport trigger)
         *
         * API Integrations:
         * - News API (Spanish sources)
         * - Wikipedia API (Spanish articles)
         * - Supabase (reading history, bookmarks, vocabulary)
         *
         * Gamification:
         * - 5 XP per article read
         * - 10 XP bonus for perfect quiz
         * - Streak tracking (daily articles)
         * - Badges: News Junkie, Speed Reader, Polyglot Scholar
         */

        class SpanishArticlesFeed {
            constructor() {
                // Initialize Supabase (if credentials available)
                this.supabase = null;
                this.initSupabase();

                // User state
                this.currentUser = this.getOrCreateUser();
                this.userLevel = this.currentUser.level || 'B1';
                this.userInterests = this.currentUser.interests || {};
                this.savedWords = new Set(this.currentUser.savedWords || []);

                // Feed state
                this.articles = [];
                this.displayedArticles = [];
                this.currentCategory = 'all';
                this.currentArticle = null;
                this.page = 0;
                this.isLoading = false;
                this.hasMore = true;

                // Quiz state
                this.currentQuiz = null;
                this.quizQuestionIndex = 0;
                this.quizScore = 0;

                // TTS state
                this.speechSynth = window.speechSynthesis;
                this.currentUtterance = null;

                this.init();
            }

            initSupabase() {
                // Try to initialize Supabase if credentials exist
                const SUPABASE_URL = 'https://your-project.supabase.co';
                const SUPABASE_ANON_KEY = 'your-anon-key';

                try {
                    if (typeof supabase !== 'undefined') {
                        this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('‚úÖ Supabase connected');
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Supabase not configured, using localStorage');
                }
            }

            getOrCreateUser() {
                let user = localStorage.getItem('spanish_articles_user');
                if (!user) {
                    user = {
                        id: 'user_' + Date.now(),
                        level: 'B1',
                        interests: {},
                        savedWords: [],
                        articlesRead: [],
                        streak: 0,
                        xp: 0,
                        lastActiveDate: new Date().toISOString().split('T')[0]
                    };
                    localStorage.setItem('spanish_articles_user', JSON.stringify(user));
                } else {
                    user = JSON.parse(user);
                }
                return user;
            }

            saveUser() {
                localStorage.setItem('spanish_articles_user', JSON.stringify(this.currentUser));
            }

            async init() {
                console.log('üöÄ Initializing Spanish Articles Feed...');

                // Load demo articles
                this.loadDemoArticles();

                // Setup event listeners
                this.setupEventListeners();

                // Render initial articles
                this.renderArticles();

                // Update UI
                this.updateUI();

                console.log('‚úÖ Feed ready!');
            }

            setupEventListeners() {
                // Category filters
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.addEventListener('click', () => {
                        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                        this.currentCategory = chip.dataset.category;
                        this.filterArticles();
                    });
                });

                // Reader modal
                document.getElementById('closeReaderBtn').addEventListener('click', () => {
                    this.closeReader();
                });

                document.getElementById('translationToggle').addEventListener('click', () => {
                    this.toggleTranslation();
                });

                document.getElementById('ttsBtn').addEventListener('click', () => {
                    this.readAloud();
                });

                document.getElementById('bookmarkReaderBtn').addEventListener('click', () => {
                    this.toggleBookmark(this.currentArticle);
                });

                // Quiz modal
                document.getElementById('quizNextBtn').addEventListener('click', () => {
                    this.nextQuizQuestion();
                });

                // Infinite scroll
                window.addEventListener('scroll', () => {
                    this.handleScroll();
                });

                // Word tooltip
                document.getElementById('saveWordBtn').addEventListener('click', () => {
                    this.saveCurrentWord();
                });
            }

            loadDemoArticles() {
                // Demo articles at all CEFR levels across 8 categories
                this.articles = [
                    // A1 - Sports
                    {
                        id: 1,
                        title: 'Messi marca tres goles',
                        category: 'sports',
                        level: 'A1',
                        readingTime: 2,
                        imageUrl: 'https://images.unsplash.com/photo-1579952363873-27f3bade9f55?w=400',
                        spanish: 'Lionel Messi es un jugador de f√∫tbol muy famoso. Ayer jug√≥ un partido importante. Messi marc√≥ tres goles. Su equipo gan√≥ 3-1. Los fans est√°n muy contentos. Messi es el mejor jugador del mundo.',
                        english: 'Lionel Messi is a very famous soccer player. Yesterday he played an important game. Messi scored three goals. His team won 3-1. The fans are very happy. Messi is the best player in the world.',
                        bookmarked: false,
                        quiz: [
                            {
                                question: '¬øCu√°ntos goles marc√≥ Messi?',
                                options: ['Uno', 'Dos', 'Tres', 'Cuatro'],
                                correct: 2
                            },
                            {
                                question: '¬øGan√≥ su equipo?',
                                options: ['S√≠', 'No', 'Empate', 'No jugaron'],
                                correct: 0
                            },
                            {
                                question: '¬øC√≥mo est√°n los fans?',
                                options: ['Tristes', 'Enojados', 'Contentos', 'Cansados'],
                                correct: 2
                            }
                        ]
                    },
                    // A2 - Food
                    {
                        id: 2,
                        title: 'Receta de tacos mexicanos',
                        category: 'food',
                        level: 'A2',
                        readingTime: 3,
                        imageUrl: 'https://images.unsplash.com/photo-1565299585323-38d6b0865b47?w=400',
                        spanish: 'Los tacos son comida t√≠pica de M√©xico. Para hacer tacos necesitas tortillas, carne, cebolla, cilantro y lim√≥n. Primero, cocina la carne con especias. Despu√©s, corta la cebolla y el cilantro en pedazos peque√±os. Calienta las tortillas. Pon la carne en la tortilla y a√±ade cebolla, cilantro y lim√≥n. Los tacos est√°n listos para comer. Son deliciosos y f√°ciles de preparar.',
                        english: 'Tacos are typical Mexican food. To make tacos you need tortillas, meat, onion, cilantro and lime. First, cook the meat with spices. Then, cut the onion and cilantro into small pieces. Heat the tortillas. Put the meat on the tortilla and add onion, cilantro and lime. The tacos are ready to eat. They are delicious and easy to prepare.',
                        bookmarked: false,
                        quiz: [
                            {
                                question: '¬øDe d√≥nde son los tacos?',
                                options: ['Espa√±a', 'M√©xico', 'Argentina', 'Colombia'],
                                correct: 1
                            },
                            {
                                question: '¬øQu√© necesitas primero?',
                                options: ['Lim√≥n', 'Tortillas', 'Cilantro', 'Cebolla'],
                                correct: 1
                            },
                            {
                                question: '¬øLos tacos son dif√≠ciles de preparar?',
                                options: ['S√≠, muy dif√≠ciles', 'No, son f√°ciles', 'Imposibles', 'Solo para chefs'],
                                correct: 1
                            }
                        ]
                    },
                    // B1 - Technology
                    {
                        id: 3,
                        title: 'Inteligencia artificial en la medicina',
                        category: 'technology',
                        level: 'B1',
                        readingTime: 4,
                        imageUrl: 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=400',
                        spanish: 'La inteligencia artificial (IA) est√° transformando la medicina moderna. Los algoritmos pueden analizar miles de im√°genes m√©dicas en minutos y detectar enfermedades con precisi√≥n comparable a los m√©dicos expertos. En hospitales de Espa√±a y Latinoam√©rica, la IA ayuda a diagnosticar c√°ncer, enfermedades del coraz√≥n y problemas neurol√≥gicos. Los m√©dicos usan estas herramientas para tomar mejores decisiones. Sin embargo, la tecnolog√≠a no reemplaza a los doctores - trabajan juntos para salvar vidas.',
                        english: 'Artificial intelligence (AI) is transforming modern medicine. Algorithms can analyze thousands of medical images in minutes and detect diseases with accuracy comparable to expert doctors. In hospitals in Spain and Latin America, AI helps diagnose cancer, heart disease and neurological problems. Doctors use these tools to make better decisions. However, technology does not replace doctors - they work together to save lives.',
                        bookmarked: false,
                        quiz: [
                            {
                                question: '¬øQu√© puede hacer la IA en medicina?',
                                options: ['Cocinar comida', 'Analizar im√°genes m√©dicas', 'Conducir carros', 'Escribir libros'],
                                correct: 1
                            },
                            {
                                question: '¬øLa IA reemplaza a los m√©dicos?',
                                options: ['S√≠, completamente', 'No, trabajan juntos', 'Solo en hospitales grandes', 'En el futuro s√≠'],
                                correct: 1
                            },
                            {
                                question: '¬øD√≥nde se usa esta tecnolog√≠a?',
                                options: ['Solo en Estados Unidos', 'Solo en Europa', 'En Espa√±a y Latinoam√©rica', 'Solo en Asia'],
                                correct: 2
                            }
                        ]
                    },
                    // B2 - Culture
                    {
                        id: 4,
                        title: 'El legado de Frida Kahlo en el arte contempor√°neo',
                        category: 'culture',
                        level: 'B2',
                        readingTime: 5,
                        imageUrl: 'https://images.unsplash.com/photo-1577083552431-6e5fd01988ec?w=400',
                        spanish: 'Frida Kahlo sigue siendo una de las artistas m√°s influyentes del siglo XX, casi siete d√©cadas despu√©s de su muerte. Su obra autobiogr√°fica, caracterizada por autorretratos intensos y surrealistas, explora temas de identidad, dolor f√≠sico, pol√≠tica y feminismo. Nacida en 1907 en Coyoac√°n, M√©xico, Kahlo sobrevivi√≥ un grave accidente de tranv√≠a que la dej√≥ con lesiones permanentes. Este sufrimiento se refleja profundamente en sus pinturas. Hoy, su iconograf√≠a - las cejas unidas, vestidos tradicionales mexicanos y flores en el cabello - se ha convertido en s√≠mbolo global del empoderamiento femenino y orgullo cultural mexicano.',
                        english: 'Frida Kahlo remains one of the most influential artists of the 20th century, almost seven decades after her death. Her autobiographical work, characterized by intense and surrealist self-portraits, explores themes of identity, physical pain, politics and feminism. Born in 1907 in Coyoac√°n, Mexico, Kahlo survived a serious tram accident that left her with permanent injuries. This suffering is deeply reflected in her paintings. Today, her iconography - the connected eyebrows, traditional Mexican dresses and flowers in her hair - has become a global symbol of female empowerment and Mexican cultural pride.',
                        bookmarked: false,
                        quiz: [
                            {
                                question: '¬øQu√© temas explora el arte de Frida?',
                                options: ['Solo paisajes', 'Identidad, dolor y feminismo', 'Animales', 'Arquitectura'],
                                correct: 1
                            },
                            {
                                question: '¬øQu√© accidente sufri√≥ Frida?',
                                options: ['De carro', 'De tranv√≠a', 'De avi√≥n', 'De bicicleta'],
                                correct: 1
                            },
                            {
                                question: '¬øQu√© representa su iconograf√≠a hoy?',
                                options: ['Nada especial', 'Empoderamiento femenino', 'Tristeza', 'Pol√≠tica solamente'],
                                correct: 1
                            }
                        ]
                    },
                    // C1 - Politics
                    {
                        id: 5,
                        title: 'Transici√≥n energ√©tica en Am√©rica Latina: desaf√≠os y oportunidades',
                        category: 'politics',
                        level: 'C1',
                        readingTime: 7,
                        imageUrl: 'https://images.unsplash.com/photo-1473341304170-971dccb5ac1e?w=400',
                        spanish: 'La transici√≥n hacia energ√≠as renovables representa uno de los mayores retos geopol√≠ticos y econ√≥micos para Am√©rica Latina en el siglo XXI. Pa√≠ses como Chile, Costa Rica y Uruguay han liderado la regi√≥n en la implementaci√≥n de pol√≠ticas progresivas que favorecen la energ√≠a solar, e√≥lica e hidroel√©ctrica. No obstante, la dependencia hist√≥rica del petr√≥leo y gas natural en econom√≠as como Venezuela, M√©xico y Brasil complica significativamente este proceso. Los expertos argumentan que la transici√≥n energ√©tica no solo requiere infraestructura tecnol√≥gica, sino tambi√©n reformas legislativas profundas, inversi√≥n en educaci√≥n cient√≠fica y un cambio cultural en los patrones de consumo. El Banco Interamericano de Desarrollo estima que se necesitan 150 mil millones de d√≥lares anuales para alcanzar las metas de carbono neutralidad para 2050.',
                        english: 'The transition to renewable energy represents one of the greatest geopolitical and economic challenges for Latin America in the 21st century. Countries like Chile, Costa Rica and Uruguay have led the region in implementing progressive policies that favor solar, wind and hydroelectric energy. However, the historical dependence on oil and natural gas in economies like Venezuela, Mexico and Brazil significantly complicates this process. Experts argue that the energy transition requires not only technological infrastructure, but also deep legislative reforms, investment in scientific education and a cultural change in consumption patterns. The Inter-American Development Bank estimates that 150 billion dollars annually are needed to achieve carbon neutrality goals by 2050.',
                        bookmarked: false,
                        quiz: [
                            {
                                question: '¬øQu√© pa√≠ses latinoamericanos han liderado en energ√≠as renovables?',
                                options: ['M√©xico y Brasil', 'Chile, Costa Rica y Uruguay', 'Venezuela y Argentina', 'Colombia y Per√∫'],
                                correct: 1
                            },
                            {
                                question: '¬øCu√°nto dinero anual se necesita seg√∫n el BID?',
                                options: ['50 mil millones', '100 mil millones', '150 mil millones', '200 mil millones'],
                                correct: 2
                            },
                            {
                                question: '¬øQu√© complica la transici√≥n energ√©tica?',
                                options: ['Solo falta de dinero', 'Dependencia hist√≥rica de petr√≥leo y gas', 'Clima tropical', 'Falta de universidades'],
                                correct: 1
                            }
                        ]
                    },
                    // C2 - Entertainment
                    {
                        id: 6,
                        title: 'An√°lisis semi√≥tico del cine de Guillermo del Toro',
                        category: 'entertainment',
                        level: 'C2',
                        readingTime: 8,
                        imageUrl: 'https://images.unsplash.com/photo-1440404653325-ab127d49abc1?w=400',
                        spanish: 'La cinematograf√≠a de Guillermo del Toro constituye un corpus narrativo que trasciende las convenciones del g√©nero fant√°stico para articular complejas reflexiones sobre alteridad, trauma hist√≥rico y resistencia pol√≠tica. Mediante el despliegue de imaginarios g√≥ticos y monstruosos - desde El laberinto del fauno hasta La forma del agua - del Toro construye alegor√≠as visuales que interrogan las estructuras hegem√≥nicas del fascismo, colonialismo y exclusi√≥n social. Su uso magistral del claroscuro barroco y paletas crom√°ticas saturadas crea un lenguaje est√©tico distintivo que fusiona la tradici√≥n iconogr√°fica espa√±ola con el expresionismo alem√°n. Los monstruos en su obra funcionan como met√°foras polis√©micas de lo marginado: el hombre anfibio representa tanto la otredad racial como la liberaci√≥n er√≥tica; el fauno simboliza simult√°neamente amenaza y redenci√≥n. Esta ambig√ºedad ontol√≥gica desaf√≠a la dicotom√≠a maniquea entre bien y mal, sugiriendo que lo monstruoso reside precisamente en la negaci√≥n de la humanidad del otro.',
                        english: 'Guillermo del Toro\'s cinematography constitutes a narrative corpus that transcends the conventions of the fantasy genre to articulate complex reflections on otherness, historical trauma and political resistance. Through the deployment of Gothic and monstrous imaginaries - from Pan\'s Labyrinth to The Shape of Water - del Toro constructs visual allegories that interrogate the hegemonic structures of fascism, colonialism and social exclusion. His masterful use of baroque chiaroscuro and saturated chromatic palettes creates a distinctive aesthetic language that fuses Spanish iconographic tradition with German expressionism. The monsters in his work function as polysemic metaphors of the marginalized: the amphibian man represents both racial otherness and erotic liberation; the faun symbolizes simultaneously threat and redemption. This ontological ambiguity challenges the Manichean dichotomy between good and evil, suggesting that the monstrous resides precisely in the denial of the humanity of the other.',
                        bookmarked: false,
                        quiz: [
                            {
                                question: '¬øQu√© funci√≥n cumplen los monstruos en el cine de del Toro?',
                                options: ['Solo entretener', 'Met√°foras de lo marginado', 'Representar el mal absoluto', 'Copiar pel√≠culas americanas'],
                                correct: 1
                            },
                            {
                                question: '¬øQu√© tradiciones est√©ticas fusiona del Toro?',
                                options: ['Francesa e italiana', 'Espa√±ola y expresionismo alem√°n', 'Japonesa y china', 'Americana y brit√°nica'],
                                correct: 1
                            },
                            {
                                question: '¬øQu√© dicotom√≠a desaf√≠a su obra?',
                                options: ['Hombre vs mujer', 'Bien vs mal', 'Viejo vs joven', 'Rico vs pobre'],
                                correct: 1
                            }
                        ]
                    },
                    // A1 - Travel
                    {
                        id: 7,
                        title: 'Visita la playa de Barcelona',
                        category: 'travel',
                        level: 'A1',
                        readingTime: 2,
                        imageUrl: 'https://images.unsplash.com/photo-1583422409516-2895a77efded?w=400',
                        spanish: 'Barcelona tiene playas muy bonitas. La playa de la Barceloneta es la m√°s famosa. El agua es azul y limpia. Hay muchos turistas en verano. Puedes nadar, tomar el sol y comer helado. Los restaurantes cerca de la playa venden pescado fresco. Es un lugar perfecto para vacaciones.',
                        english: 'Barcelona has very beautiful beaches. Barceloneta beach is the most famous. The water is blue and clean. There are many tourists in summer. You can swim, sunbathe and eat ice cream. Restaurants near the beach sell fresh fish. It is a perfect place for vacation.',
                        bookmarked: false,
                        quiz: [
                            {
                                question: '¬øC√≥mo es el agua de la playa?',
                                options: ['Sucia', 'Azul y limpia', 'Roja', 'Fr√≠a'],
                                correct: 1
                            },
                            {
                                question: '¬øCu√°ndo hay muchos turistas?',
                                options: ['Invierno', 'Primavera', 'Verano', 'Oto√±o'],
                                correct: 2
                            },
                            {
                                question: '¬øQu√© venden los restaurantes?',
                                options: ['Pizza', 'Tacos', 'Pescado fresco', 'Hamburguesas'],
                                correct: 2
                            }
                        ]
                    },
                    // B1 - Celebrity
                    {
                        id: 8,
                        title: 'Shakira lanza nuevo √°lbum inspirado en su vida personal',
                        category: 'celebrity',
                        level: 'B1',
                        readingTime: 4,
                        imageUrl: 'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=400',
                        spanish: 'La cantante colombiana Shakira acaba de lanzar su nuevo √°lbum "Las Mujeres Ya No Lloran", que rompe r√©cords de reproducci√≥n en plataformas digitales. El disco contiene 16 canciones que narran su separaci√≥n medi√°tica y proceso de sanaci√≥n emocional. Seg√∫n cr√≠ticos musicales, este trabajo representa su obra m√°s vulnerable y aut√©ntica. Las letras combinan espa√±ol e ingl√©s, mezclando ritmos latinos con pop contempor√°neo. Shakira declar√≥ en entrevistas que la m√∫sica fue su terapia durante momentos dif√≠ciles. Los fans han respondido masivamente en redes sociales, convirtiendo varias canciones en virales en TikTok.',
                        english: 'Colombian singer Shakira has just released her new album "Las Mujeres Ya No Lloran" (Women No Longer Cry), which is breaking streaming records on digital platforms. The album contains 16 songs that narrate her public separation and emotional healing process. According to music critics, this work represents her most vulnerable and authentic work. The lyrics combine Spanish and English, mixing Latin rhythms with contemporary pop. Shakira stated in interviews that music was her therapy during difficult times. Fans have responded massively on social media, making several songs go viral on TikTok.',
                        bookmarked: false,
                        quiz: [
                            {
                                question: '¬øDe qu√© pa√≠s es Shakira?',
                                options: ['M√©xico', 'Espa√±a', 'Colombia', 'Argentina'],
                                correct: 2
                            },
                            {
                                question: '¬øCu√°ntas canciones tiene el √°lbum?',
                                options: ['10', '12', '14', '16'],
                                correct: 3
                            },
                            {
                                question: '¬øQu√© fue la m√∫sica para Shakira?',
                                options: ['Un negocio', 'Su terapia', 'Un hobby', 'Una obligaci√≥n'],
                                correct: 1
                            }
                        ]
                    }
                ];

                // Duplicate articles for infinite scroll demo
                this.articles = [...this.articles, ...this.articles, ...this.articles];

                // Shuffle and add IDs
                this.articles = this.articles.map((article, index) => ({
                    ...article,
                    id: index + 1
                }));
            }

            renderArticles() {
                const grid = document.getElementById('masonryGrid');
                const spinner = document.getElementById('loadingSpinner');

                // Filter articles by category and personalization
                let filteredArticles = this.currentCategory === 'all'
                    ? this.articles
                    : this.articles.filter(a => a.category === this.currentCategory);

                // Apply 70/20/10 difficulty split (Flipboard pattern)
                filteredArticles = this.personalizeArticles(filteredArticles);

                // Take next batch for infinite scroll
                const start = this.page * 12;
                const end = start + 12;
                const articlesToDisplay = filteredArticles.slice(start, end);

                if (articlesToDisplay.length === 0) {
                    spinner.innerHTML = '<p>No more articles üìö</p>';
                    this.hasMore = false;
                    return;
                }

                // Render each article card
                articlesToDisplay.forEach(article => {
                    const card = this.createArticleCard(article);
                    grid.appendChild(card);
                });

                this.displayedArticles.push(...articlesToDisplay);
                this.page++;
                spinner.style.display = 'none';
            }

            personalizeArticles(articles) {
                /**
                 * PERSONALIZATION ALGORITHM (Flipboard Pattern)
                 * 70% at user level
                 * 20% easier (scaffolding)
                 * 10% harder (challenge)
                 */
                const levels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
                const userLevelIndex = levels.indexOf(this.userLevel);

                const atLevel = articles.filter(a => a.level === this.userLevel);
                const easier = articles.filter(a => levels.indexOf(a.level) < userLevelIndex);
                const harder = articles.filter(a => levels.indexOf(a.level) > userLevelIndex);

                // Calculate counts
                const total = articles.length;
                const atLevelCount = Math.floor(total * 0.7);
                const easierCount = Math.floor(total * 0.2);
                const harderCount = total - atLevelCount - easierCount;

                // Combine with personalization
                const personalized = [
                    ...atLevel.slice(0, atLevelCount),
                    ...easier.slice(0, easierCount),
                    ...harder.slice(0, harderCount)
                ];

                // Shuffle
                return personalized.sort(() => Math.random() - 0.5);
            }

            createArticleCard(article) {
                const card = document.createElement('div');
                card.className = 'article-card';
                card.dataset.id = article.id;

                card.innerHTML = `
                    <img src="${article.imageUrl}" alt="${article.title}" class="article-image" onerror="this.src='https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?w=400'">
                    <div class="article-content">
                        <div class="article-category">${article.category}</div>
                        <div class="article-header">
                            <div class="difficulty-badge ${article.level}">${article.level}</div>
                            <div class="reading-time">${article.readingTime} min</div>
                        </div>
                        <h3 class="article-title">${article.title}</h3>
                        <div class="article-footer">
                            <button class="bookmark-btn ${article.bookmarked ? 'bookmarked' : ''}" data-id="${article.id}">
                                ${article.bookmarked ? 'üîñ' : 'üìë'}
                            </button>
                        </div>
                    </div>
                `;

                // Click to open reader
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('bookmark-btn')) {
                        this.openReader(article);
                    }
                });

                // Bookmark button
                const bookmarkBtn = card.querySelector('.bookmark-btn');
                bookmarkBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleBookmark(article);
                    bookmarkBtn.textContent = article.bookmarked ? 'üîñ' : 'üìë';
                    bookmarkBtn.classList.toggle('bookmarked');
                });

                return card;
            }

            openReader(article) {
                this.currentArticle = article;
                const modal = document.getElementById('readerModal');
                const content = document.getElementById('readerContent');

                // Track interest (personalization)
                this.trackInterest(article.category);

                // Render article content
                content.innerHTML = `
                    <img src="${article.imageUrl}" alt="${article.title}" class="reader-image" onerror="this.style.display='none'">
                    <div class="reader-meta">
                        <div class="difficulty-badge ${article.level}">${article.level}</div>
                        <div class="reading-time">${article.readingTime} min read</div>
                        <div class="article-category">${article.category}</div>
                    </div>
                    <h1 class="reader-title">${article.title}</h1>
                    <div class="translation-container" id="translationContainer">
                        <div class="spanish-text" id="spanishText">${this.makeWordsClickable(article.spanish)}</div>
                        <div class="english-text" id="englishText" style="display: none;">${article.english}</div>
                    </div>
                `;

                // Show modal
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';

                // Setup word click handlers
                this.setupWordClickHandlers();

                // Track reading
                this.trackArticleRead(article);
            }

            makeWordsClickable(text) {
                // Split into words and make each clickable
                const words = text.split(/(\s+)/);
                return words.map(word => {
                    if (word.trim().length === 0) return word;
                    const cleanWord = word.replace(/[.,!?¬ø¬°;:]/g, '');
                    const highlighted = this.savedWords.has(cleanWord.toLowerCase()) ? 'highlighted' : '';
                    return `<span class="word ${highlighted}" data-word="${cleanWord}">${word}</span>`;
                }).join('');
            }

            setupWordClickHandlers() {
                const words = document.querySelectorAll('.spanish-text .word');
                words.forEach(word => {
                    word.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const spanish = word.dataset.word;
                        await this.showWordTranslation(spanish, word);
                    });
                });
            }

            async showWordTranslation(word, element) {
                // Get translation (mock API call)
                const translation = await this.translateWord(word);

                // Show tooltip
                const tooltip = document.getElementById('wordTooltip');
                document.getElementById('tooltipWord').textContent = word;
                document.getElementById('tooltipTranslation').textContent = translation;

                // Position tooltip
                const rect = element.getBoundingClientRect();
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.bottom + 10) + 'px';
                tooltip.classList.add('active');

                // Store current word for saving
                this.currentWord = { word, translation };

                // Hide on outside click
                const hideTooltip = (e) => {
                    if (!tooltip.contains(e.target) && e.target !== element) {
                        tooltip.classList.remove('active');
                        document.removeEventListener('click', hideTooltip);
                    }
                };
                setTimeout(() => document.addEventListener('click', hideTooltip), 100);
            }

            async translateWord(word) {
                // Mock translation (in production, use LibreTranslate API or similar)
                const translations = {
                    'goles': 'goals',
                    'jugador': 'player',
                    'equipo': 'team',
                    'fans': 'fans',
                    'mejor': 'best',
                    'tacos': 'tacos',
                    'tortillas': 'tortillas',
                    'carne': 'meat',
                    'deliciosos': 'delicious',
                    'inteligencia': 'intelligence',
                    'medicina': 'medicine',
                    'algoritmos': 'algorithms',
                    'm√©dicos': 'doctors',
                    'Frida': 'Frida',
                    'artista': 'artist',
                    'pinturas': 'paintings',
                    'energ√≠a': 'energy',
                    'renovables': 'renewable',
                    'pol√≠ticas': 'policies',
                    'transici√≥n': 'transition',
                    'cine': 'cinema',
                    'monstruos': 'monsters',
                    'alegor√≠as': 'allegories'
                };

                return translations[word.toLowerCase()] || 'translation';
            }

            saveCurrentWord() {
                if (!this.currentWord) return;

                const { word, translation } = this.currentWord;

                // Add to saved words
                this.savedWords.add(word.toLowerCase());
                this.currentUser.savedWords.push({
                    word,
                    translation,
                    articleId: this.currentArticle.id,
                    savedAt: new Date().toISOString()
                });
                this.saveUser();

                // Save to Supabase if available
                if (this.supabase) {
                    this.saveWordToSupabase(word, translation);
                }

                // Update UI
                document.querySelectorAll(`.word[data-word="${word}"]`).forEach(el => {
                    el.classList.add('highlighted');
                });

                // Hide tooltip
                document.getElementById('wordTooltip').classList.remove('active');

                // Show success message
                this.showToast('Word saved to vocabulary! üìö');

                // Add XP
                this.addXP(2);
            }

            async saveWordToSupabase(word, translation) {
                // Save to Supabase vocabulary table
                try {
                    const { data, error } = await this.supabase
                        .from('vocabulary')
                        .insert({
                            user_id: this.currentUser.id,
                            word: word,
                            translation: translation,
                            language: 'es',
                            source_app: 'spanish-articles',
                            context_sentence: this.currentArticle.spanish.substring(0, 200)
                        });

                    if (error) console.error('Supabase save error:', error);
                } catch (error) {
                    console.error('Supabase not configured');
                }
            }

            toggleTranslation() {
                const btn = document.getElementById('translationToggle');
                const container = document.getElementById('translationContainer');
                const english = document.getElementById('englishText');

                if (container.classList.contains('side-by-side')) {
                    // Hide translation
                    container.classList.remove('side-by-side');
                    english.style.display = 'none';
                    btn.textContent = 'Show Translation';
                } else {
                    // Show side-by-side
                    container.classList.add('side-by-side');
                    english.style.display = 'block';
                    btn.textContent = 'Hide Translation';
                }
            }

            readAloud() {
                if (!this.currentArticle) return;

                // Stop any current speech
                this.speechSynth.cancel();

                // Create utterance
                const utterance = new SpeechSynthesisUtterance(this.currentArticle.spanish);
                utterance.lang = 'es-ES';
                utterance.rate = 0.9;
                utterance.pitch = 1;

                // Find Spanish voice
                const voices = this.speechSynth.getVoices();
                const spanishVoice = voices.find(v => v.lang.startsWith('es'));
                if (spanishVoice) {
                    utterance.voice = spanishVoice;
                }

                // Speak
                this.speechSynth.speak(utterance);
                this.currentUtterance = utterance;

                // Update button
                const btn = document.getElementById('ttsBtn');
                btn.textContent = '‚è∏Ô∏è Pause';

                utterance.onend = () => {
                    btn.textContent = 'üîä Listen';
                };
            }

            toggleBookmark(article) {
                article.bookmarked = !article.bookmarked;

                // Update in localStorage
                const bookmarks = JSON.parse(localStorage.getItem('bookmarked_articles') || '[]');
                if (article.bookmarked) {
                    bookmarks.push(article.id);
                } else {
                    const index = bookmarks.indexOf(article.id);
                    if (index > -1) bookmarks.splice(index, 1);
                }
                localStorage.setItem('bookmarked_articles', JSON.stringify(bookmarks));

                this.showToast(article.bookmarked ? 'Article bookmarked! üîñ' : 'Bookmark removed');
            }

            closeReader() {
                const modal = document.getElementById('readerModal');
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';

                // Stop speech if playing
                if (this.speechSynth) {
                    this.speechSynth.cancel();
                }

                // Don't auto-launch quiz - user can access it manually if desired
                // Removed: this.showQuiz() to prevent annoying auto-launch
            }

            showQuiz(article) {
                this.currentQuiz = article.quiz;
                this.quizQuestionIndex = 0;
                this.quizScore = 0;

                const modal = document.getElementById('quizModal');
                modal.classList.add('active');

                this.renderQuizQuestion();
            }

            renderQuizQuestion() {
                const question = this.currentQuiz[this.quizQuestionIndex];

                document.getElementById('quizProgress').textContent =
                    `Question ${this.quizQuestionIndex + 1} of ${this.currentQuiz.length}`;
                document.getElementById('quizQuestion').textContent = question.question;

                const optionsContainer = document.getElementById('quizOptions');
                optionsContainer.innerHTML = '';

                question.options.forEach((option, index) => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'quiz-option';
                    optionEl.textContent = option;
                    optionEl.dataset.index = index;

                    optionEl.addEventListener('click', () => {
                        this.selectQuizOption(optionEl, index, question.correct);
                    });

                    optionsContainer.appendChild(optionEl);
                });

                document.getElementById('quizNextBtn').disabled = true;
            }

            selectQuizOption(element, selectedIndex, correctIndex) {
                // Remove previous selections
                document.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.classList.remove('selected', 'correct', 'incorrect');
                });

                // Mark selected
                element.classList.add('selected');

                // Show correct/incorrect
                if (selectedIndex === correctIndex) {
                    element.classList.add('correct');
                    this.quizScore++;
                    this.showToast('Correct! üéâ');
                } else {
                    element.classList.add('incorrect');
                    document.querySelectorAll('.quiz-option')[correctIndex].classList.add('correct');
                    this.showToast('Incorrect. Try the next one! üí™');
                }

                // Enable next button
                document.getElementById('quizNextBtn').disabled = false;
            }

            nextQuizQuestion() {
                this.quizQuestionIndex++;

                if (this.quizQuestionIndex < this.currentQuiz.length) {
                    this.renderQuizQuestion();
                } else {
                    this.finishQuiz();
                }
            }

            finishQuiz() {
                const modal = document.getElementById('quizModal');
                modal.classList.remove('active');

                const percentage = Math.round((this.quizScore / this.currentQuiz.length) * 100);

                // Update stats
                document.getElementById('quizScore').textContent = percentage + '%';

                // Award XP
                const xpEarned = this.quizScore === this.currentQuiz.length ? 10 : 5;
                this.addXP(xpEarned);

                // Show result
                if (percentage === 100) {
                    this.showToast(`Perfect score! +${xpEarned} XP üèÜ`);
                } else {
                    this.showToast(`${percentage}% correct. +${xpEarned} XP üìà`);
                }
            }

            trackArticleRead(article) {
                // Add to articles read
                if (!this.currentUser.articlesRead.includes(article.id)) {
                    this.currentUser.articlesRead.push(article.id);
                    this.saveUser();

                    // Award XP
                    this.addXP(5);

                    // Update daily count
                    this.updateDailyStats();
                }
            }

            trackInterest(category) {
                // Track category clicks for personalization
                if (!this.currentUser.interests[category]) {
                    this.currentUser.interests[category] = 0;
                }
                this.currentUser.interests[category]++;
                this.saveUser();
            }

            addXP(amount) {
                this.currentUser.xp += amount;
                this.saveUser();
                this.updateUI();
            }

            updateDailyStats() {
                const today = new Date().toISOString().split('T')[0];

                // Update streak
                if (this.currentUser.lastActiveDate === today) {
                    // Same day, don't update streak
                } else {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];

                    if (this.currentUser.lastActiveDate === yesterdayStr) {
                        // Consecutive day
                        this.currentUser.streak++;
                    } else {
                        // Broke streak
                        this.currentUser.streak = 1;
                    }
                }

                this.currentUser.lastActiveDate = today;
                this.saveUser();
                this.updateUI();
            }

            updateUI() {
                // Update level badge
                document.getElementById('userLevelBadge').textContent = this.currentUser.level;

                // Update XP
                document.getElementById('xpCount').textContent = this.currentUser.xp + ' XP';

                // Update streak
                document.getElementById('streakDays').textContent = this.currentUser.streak;

                // Update articles read today
                const today = new Date().toISOString().split('T')[0];
                const todayCount = this.currentUser.articlesRead.filter(id => {
                    // In production, track timestamps
                    return true; // Simplified
                }).length;
                document.getElementById('articlesReadToday').textContent = Math.min(todayCount, 10);
            }

            filterArticles() {
                // Clear current grid
                const grid = document.getElementById('masonryGrid');
                grid.innerHTML = '';

                // Reset pagination
                this.displayedArticles = [];
                this.page = 0;
                this.hasMore = true;

                // Show loading
                document.getElementById('loadingSpinner').style.display = 'flex';

                // Render filtered articles
                this.renderArticles();
            }

            handleScroll() {
                // Infinite scroll (Apple News pattern: 1 viewport trigger)
                if (this.isLoading || !this.hasMore) return;

                const scrollPosition = window.innerHeight + window.scrollY;
                const threshold = document.documentElement.scrollHeight - window.innerHeight;

                if (scrollPosition >= threshold) {
                    this.isLoading = true;
                    document.getElementById('loadingSpinner').style.display = 'flex';

                    // Simulate network delay
                    setTimeout(() => {
                        this.renderArticles();
                        this.isLoading = false;
                    }, 500);
                }
            }

            showToast(message) {
                // Simple toast notification
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: 600;
                    z-index: 10000;
                    animation: fadeIn 0.3s ease;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            }
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const app = new SpanishArticlesFeed();
            window.articlesApp = app; // For debugging
        });
    </script>

    <!-- UNIFIED BOTTOM NAVIGATION - Same as main app -->
    <nav class="bottom-nav">
        <div class="nav-item" onclick="window.location.href='/tiktok-video-feed.html'">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
            </div>
            <div class="nav-label">Home</div>
        </div>
        <div class="nav-item active" onclick="window.location.href='/spanish-articles.html'">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </div>
            <div class="nav-label">Discover</div>
        </div>
        <div class="nav-item" onclick="window.location.href='/voice-chat.html'">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                </svg>
            </div>
            <div class="nav-label">Chat</div>
        </div>
        <div class="nav-item" onclick="window.location.href='/tiktok-video-feed.html#profile'">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </div>
            <div class="nav-label">Profile</div>
        </div>
    </nav>
</body>
</html>