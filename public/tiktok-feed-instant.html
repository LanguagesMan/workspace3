<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Langflix - Learn Spanish</title>
    <link rel="stylesheet" href="/css/mobile-first-framework.css">
    <style>
        /* INSTANT LOAD - TIKTOK STRATEGY */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
        }

        .video-container {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
        }

        .video-card {
            position: relative;
            height: 100vh;
            width: 100vw;
            scroll-snap-align: start;
            scroll-snap-stop: always;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        /* Skeleton loader - shows INSTANTLY */
        .video-skeleton {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                #1a1a1a 25%,
                #2a2a2a 50%,
                #1a1a1a 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .video-card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .video-card video.loaded {
            opacity: 1;
        }

        .video-overlay {
            position: absolute;
            bottom: 80px;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: #fff;
            pointer-events: none;
        }

        .video-overlay * {
            pointer-events: auto;
        }

        .video-level {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .video-title {
            font-size: 16px;
            font-weight: 600;
        }

        .video-actions {
            position: absolute;
            right: 12px;
            bottom: 120px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .action-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:active {
            transform: scale(0.9);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn.active {
            color: #fff;
        }

        .nav-btn span {
            font-size: 10px;
        }
    </style>
</head>
<body>
    <!-- Container renders INSTANTLY - no loading screen -->
    <div class="video-container" id="videoContainer">
        <!-- TikTok strategy: Show 3 skeleton cards immediately -->
        <div class="video-card">
            <div class="video-skeleton"></div>
        </div>
        <div class="video-card">
            <div class="video-skeleton"></div>
        </div>
        <div class="video-card">
            <div class="video-skeleton"></div>
        </div>
    </div>

    <!-- Bottom nav visible IMMEDIATELY -->
    <nav class="bottom-nav">
        <button class="nav-btn active">
            <div>üé¨</div>
            <span>Videos</span>
        </button>
        <button class="nav-btn" onclick="location.href='/langflix-app.html'">
            <div>üì∫</div>
            <span>Shows</span>
        </button>
        <button class="nav-btn" onclick="location.href='/premium.html'">
            <div>üëë</div>
            <span>Premium</span>
        </button>
        <button class="nav-btn" onclick="location.href='/profile.html'">
            <div>üë§</div>
            <span>Profile</span>
        </button>
    </nav>

    <script>
        // TIKTOK INSTANT LOAD STRATEGY
        const container = document.getElementById('videoContainer');
        let videos = [];
        let loadedCount = 0;

        // Step 1: Load and render IMMEDIATELY (no waiting for API)
        (async () => {
            console.log('‚ö° INSTANT LOAD - TikTok strategy');

            try {
                // Fetch videos in background (don't block rendering)
                const response = await fetch('/api/videos?includeTranscript=true&limit=20');
                const data = await response.json();
                videos = data.videos || [];

                console.log(`‚úÖ Loaded ${videos.length} videos`);

                // Step 2: Replace skeleton cards with real videos PROGRESSIVELY
                renderVideosProgressively();

            } catch (error) {
                console.error('‚ùå Error:', error);
                // Even on error, show error state instead of infinite loading
                container.innerHTML = '<div style="color:#fff;text-align:center;padding:40px;">‚ùå Failed to load videos</div>';
            }
        })();

        // PROGRESSIVE RENDERING - TikTok pattern
        function renderVideosProgressively() {
            const skeletons = container.querySelectorAll('.video-card');

            // Render first 3 videos immediately
            for (let i = 0; i < Math.min(3, videos.length); i++) {
                replaceSkeletonWithVideo(skeletons[i], videos[i], i);
            }

            // Render rest as user scrolls
            if (videos.length > 3) {
                for (let i = 3; i < videos.length; i++) {
                    const card = createVideoCard(videos[i], i);
                    container.appendChild(card);
                }
            }

            // Setup autoplay
            setupVideoPlayback();
        }

        function replaceSkeletonWithVideo(skeletonCard, video, index) {
            const videoEl = document.createElement('video');
            videoEl.src = video.videoUrl;
            videoEl.setAttribute('playsinline', '');
            videoEl.setAttribute('loop', '');
            videoEl.setAttribute('muted', '');
            videoEl.setAttribute('preload', index < 3 ? 'auto' : 'metadata'); // Preload first 3

            // Show video when loaded
            videoEl.addEventListener('loadeddata', () => {
                videoEl.classList.add('loaded');
                const skeleton = skeletonCard.querySelector('.video-skeleton');
                if (skeleton) skeleton.remove();
            });

            // Add overlay
            const overlay = document.createElement('div');
            overlay.className = 'video-overlay';
            overlay.innerHTML = `
                <div class="video-level">${video.level || 'A1'}</div>
                <div class="video-title">${video.title || 'Spanish Video'}</div>
            `;

            // Add actions
            const actions = document.createElement('div');
            actions.className = 'video-actions';
            actions.innerHTML = `
                <button class="action-btn">‚ù§Ô∏è</button>
                <button class="action-btn">üîñ</button>
                <button class="action-btn">üì§</button>
            `;

            skeletonCard.appendChild(videoEl);
            skeletonCard.appendChild(overlay);
            skeletonCard.appendChild(actions);
        }

        function createVideoCard(video, index) {
            const card = document.createElement('div');
            card.className = 'video-card';

            const videoEl = document.createElement('video');
            videoEl.src = video.videoUrl;
            videoEl.setAttribute('playsinline', '');
            videoEl.setAttribute('loop', '');
            videoEl.setAttribute('muted', '');
            videoEl.setAttribute('preload', 'metadata');
            videoEl.classList.add('loaded');

            card.innerHTML = `
                <div class="video-overlay">
                    <div class="video-level">${video.level || 'A1'}</div>
                    <div class="video-title">${video.title || 'Spanish Video'}</div>
                </div>
                <div class="video-actions">
                    <button class="action-btn">‚ù§Ô∏è</button>
                    <button class="action-btn">üîñ</button>
                    <button class="action-btn">üì§</button>
                </div>
            `;

            card.insertBefore(videoEl, card.firstChild);
            return card;
        }

        // AGGRESSIVE PRELOADING - TikTok strategy
        function setupVideoPlayback() {
            const videoElements = container.querySelectorAll('video');

            // Play first video immediately
            if (videoElements.length > 0) {
                videoElements[0].play().catch(e => console.log('Autoplay blocked'));
            }

            // Intersection observer for auto-play + preloading
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry, idx) => {
                    const video = entry.target;
                    const cardIndex = Array.from(videoElements).indexOf(video);

                    if (entry.isIntersecting) {
                        // Play current video
                        video.play().catch(e => console.log('Play failed'));

                        // PRELOAD next 3 videos (TikTok strategy)
                        for (let i = 1; i <= 3; i++) {
                            const nextVideo = videoElements[cardIndex + i];
                            if (nextVideo && nextVideo.preload !== 'auto') {
                                nextVideo.preload = 'auto';
                                nextVideo.load();
                            }
                        }
                    } else {
                        video.pause();
                    }
                });
            }, {
                threshold: 0.5
            });

            videoElements.forEach(video => {
                observer.observe(video);
                // Tap to unmute
                video.addEventListener('click', () => {
                    video.muted = !video.muted;
                });
            });
        }
    </script>
</body>
</html>
