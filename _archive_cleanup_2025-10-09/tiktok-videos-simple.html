<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ Spanish Reels</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* TikTok scroll - MUST be on html element */
        html {
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
        }

        html::-webkit-scrollbar {
            display: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000;
        }

        /* TikTok-style container */
        .video-container {
            width: 100vw;
        }
        
        /* Individual video slides */
        .video-slide {
            width: 100vw;
            height: 100vh;
            scroll-snap-align: start;
            scroll-snap-stop: always;
            position: relative;
            background: #000;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* Subtitles overlay - TikTok style */
        .subtitles {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            color: white;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            text-shadow:
                0 0 10px rgba(0,0,0,0.9),
                2px 2px 4px rgba(0,0,0,0.8),
                -1px -1px 2px rgba(0,0,0,0.6);
            pointer-events: none;
            line-height: 1.4;
            letter-spacing: 0.3px;
        }
        
        .subtitle-word {
            display: inline;
            padding: 4px 8px;
            margin: 0 2px;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .subtitle-word:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: scale(1.05);
        }

        .subtitle-word:active {
            background: rgba(255, 215, 0, 0.5);
            transform: scale(0.98);
        }

        .subtitle-line {
            margin: 6px 0;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 16px;
            border-radius: 24px;
            display: inline-block;
        }

        /* Translation popup */
        .translation-popup {
            position: fixed;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 1000;
            max-width: 80%;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .translation-spanish {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .translation-english {
            font-size: 18px;
            color: #aaa;
        }

        .translation-saved {
            margin-top: 10px;
            font-size: 14px;
            color: #4CAF50;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="loading">Loading Spanish videos...</div>
    <div class="video-container" id="videoContainer"></div>
    
    <script>
        let videos = [];
        let subtitleCache = new Map();

        // Load videos on page load
        // TikTok-style velocity detection for swipes
        let touchStartY = 0;
        let touchStartTime = 0;
        let lastScrollTop = 0;
        const velocityThreshold = 0.5; // px/ms (TikTok pattern)

        window.addEventListener('load', async () => {
            console.log('üé¨ Loading videos...');
            await loadVideos();
            initVelocityDetection();
        });

        async function loadVideos() {
            try {
                const response = await fetch('/api/videos/with-subtitles');
                const data = await response.json();

                if (data.success && data.videos) {
                    videos = data.videos.filter(v => v.path);
                    console.log(`‚úÖ Loaded ${videos.length} videos`);
                    renderVideos();
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.querySelector('.loading').textContent = 'Error loading videos';
            }
        }

        async function renderVideos() {
            const container = document.getElementById('videoContainer');
            document.querySelector('.loading').style.display = 'none';

            // Render first 10 videos
            for (let i = 0; i < Math.min(10, videos.length); i++) {
                const slide = await createVideoSlide(videos[i], i);
                container.appendChild(slide);
            }

            console.log(`‚úÖ Rendered ${Math.min(10, videos.length)} video slides`);
        }

        // Parse SRT subtitles - ONLY Spanish text with proper formatting
        function parseSRT(srtText) {
            const subtitles = [];
            const lines = srtText.trim().split('\n');

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Skip empty lines, numbers, and timestamps
                if (!line || /^\d+$/.test(line) || /-->/.test(line)) continue;

                // Check if this is Spanish text
                const hasSpanishChars = /[√°√©√≠√≥√∫√±√º¬ø¬°]/i.test(line);
                const hasSpanishWords = /\b(por|qu√©|que|est√°|muy|s√≠|no|el|la|es|yo|t√∫|mi|tu|su|hace|tiene|quiero|porque|c√≥mo|d√≥nde|cu√°ndo|voy|comprar|mierda|tengo)\b/i.test(line);
                const isEnglish = /\b(why|because|you|like|don't|very|yes|what|how|where|when|the|this|that|have|want|will|buy|shit)\b/i.test(line);

                // Only add if Spanish and NOT English
                if ((hasSpanishChars || hasSpanishWords) && !isEnglish) {
                    // Add proper Spanish formatting
                    let formatted = line;

                    // Capitalize first letter
                    formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);

                    // Add period if missing
                    if (!/[.!?¬°¬ø]$/.test(formatted)) {
                        formatted += '.';
                    }

                    // Add Spanish exclamation marks for emotional words
                    if (/\b(mierda|ay|wow|dios|incre√≠ble|genial)\b/i.test(formatted) && !formatted.includes('¬°')) {
                        formatted = '¬°' + formatted.replace(/\.$/, '!');
                    }

                    subtitles.push({ text: formatted });
                }
            }

            return subtitles;
        }

        // Load subtitles for a video
        async function loadSubtitles(path) {
            if (subtitleCache.has(path)) {
                return subtitleCache.get(path);
            }

            try {
                const response = await fetch(path);
                const srtText = await response.text();
                const subtitles = parseSRT(srtText);
                subtitleCache.set(path, subtitles);
                return subtitles;
            } catch (error) {
                console.error(`‚ùå Error loading subtitles:`, error);
                return [];
            }
        }

        async function createVideoSlide(video, index) {
            const slide = document.createElement('div');
            slide.className = 'video-slide';

            const videoEl = document.createElement('video');
            videoEl.src = video.path;
            videoEl.controls = true;
            videoEl.playsInline = true;
            videoEl.loop = true;

            if (index === 0) {
                videoEl.autoplay = true;
                videoEl.muted = false;
            } else {
                videoEl.muted = true;
            }

            // Load real subtitles
            const subtitlesDiv = document.createElement('div');
            subtitlesDiv.className = 'subtitles';

            // Command #3: Show ONLY real Spanish subtitles (no dummy content!)
            if (video.subtitlesPath) {
                const subs = await loadSubtitles(video.subtitlesPath);
                if (subs.length > 0) {
                    // Show first 4 Spanish subtitle lines with clickable words - TikTok style
                    const lines = subs.slice(0, 4);
                    lines.forEach(sub => {
                        const words = sub.text.split(' ');
                        const wordsHTML = words.map(word => {
                            const clean = word.replace(/[¬ø¬°,.!?]/g, '');
                            return `<span class="subtitle-word" onclick="showTranslation('${clean}')">${word}</span>`;
                        }).join(' ');
                        subtitlesDiv.innerHTML += `<div class="subtitle-line">${wordsHTML}</div>`;
                    });
                }
            }

            slide.appendChild(videoEl);
            slide.appendChild(subtitlesDiv);

            return slide;
        }

        // Show translation when word is clicked
        async function showTranslation(word) {
            console.log(`üìñ Translating: ${word}`);

            // Remove existing popup
            const existing = document.querySelector('.translation-popup');
            if (existing) existing.remove();

            // Create popup
            const popup = document.createElement('div');
            popup.className = 'translation-popup';
            popup.innerHTML = `
                <div class="translation-spanish">${word}</div>
                <div class="translation-english">Traduciendo...</div>
            `;
            document.body.appendChild(popup);

            // Fetch translation with grammar context
            try {
                const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=es|en`;
                const response = await fetch(url);
                const data = await response.json();
                let translation = data.responseData?.translatedText || word;

                // Detect gender/article from context
                let article = '';
                const lowerWord = word.toLowerCase();

                // Common Spanish articles and gender patterns
                if (/^(el|un)$/i.test(lowerWord)) {
                    article = '(masculine article)';
                } else if (/^(la|una)$/i.test(lowerWord)) {
                    article = '(feminine article)';
                } else if (/^(los|unos)$/i.test(lowerWord)) {
                    article = '(masc. plural article)';
                } else if (/^(las|unas)$/i.test(lowerWord)) {
                    article = '(fem. plural article)';
                } else if (lowerWord.endsWith('o')) {
                    article = 'el';
                } else if (lowerWord.endsWith('a')) {
                    article = 'la';
                }

                const grammarHint = article ? `<div style="color: #ffd700; font-size: 14px; margin-top: 4px;">${article}</div>` : '';

                popup.innerHTML = `
                    <div class="translation-spanish">${word}</div>
                    <div class="translation-english">${translation}</div>
                    ${grammarHint}
                    <div class="translation-saved">‚úÖ Guardado en vocabulario</div>
                `;

                // Save to unified database
                saveToDatabase(word, translation);

                // Auto-close after 3 seconds
                setTimeout(() => popup.remove(), 3000);
            } catch (error) {
                console.error('‚ùå Translation error:', error);
                popup.querySelector('.translation-english').textContent = 'Error de traducci√≥n';
            }
        }

        // Save word to unified database
        async function saveToDatabase(word, translation) {
            try {
                const userId = localStorage.getItem('userId') || 'user_' + Date.now();
                localStorage.setItem('userId', userId);

                const response = await fetch('/api/words/learned', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        word,
                        translation,
                        level: 'A2',
                        context: 'video_reel'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    console.log(`‚úÖ Saved to unified database: ${word} = ${translation}`);
                }
            } catch (error) {
                console.error('‚ùå Database error:', error);
            }
        }

        // TikTok-style momentum-based scroll physics
        function initVelocityDetection() {
            const container = document.documentElement; // Using html element since scroll-snap is on html

            // Track touch start
            container.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
                lastScrollTop = window.scrollY;
            });

            // Detect velocity on touch end
            container.addEventListener('touchend', (e) => {
                const timeDelta = Date.now() - touchStartTime;
                const scrollDelta = window.scrollY - lastScrollTop;
                const velocity = Math.abs(scrollDelta / timeDelta); // px/ms

                console.log(`üìä Swipe velocity: ${velocity.toFixed(2)} px/ms (threshold: ${velocityThreshold})`);

                if (velocity > velocityThreshold) {
                    // Fast swipe: advance to next/prev card
                    if (scrollDelta > 0) {
                        scrollToNextCard();
                    } else {
                        scrollToPrevCard();
                    }
                }
                // Slow drag: CSS scroll-snap handles it automatically
            });
        }

        function scrollToNextCard() {
            const cards = document.querySelectorAll('.video-slide');
            const viewportHeight = window.innerHeight;
            const currentIndex = Math.round(window.scrollY / viewportHeight);

            if (currentIndex < cards.length - 1) {
                window.scrollTo({
                    top: (currentIndex + 1) * viewportHeight,
                    behavior: 'smooth'
                });
            }
        }

        function scrollToPrevCard() {
            const viewportHeight = window.innerHeight;
            const currentIndex = Math.round(window.scrollY / viewportHeight);

            if (currentIndex > 0) {
                window.scrollTo({
                    top: (currentIndex - 1) * viewportHeight,
                    behavior: 'smooth'
                });
            }
        }
    </script>
</body>
</html>
