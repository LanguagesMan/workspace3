<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate AI Learning Feed</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow-x: hidden;
        }

        /* Navigation Header */
        .nav-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            padding: 10px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nav-tabs {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 5px 0;
        }

        .nav-tab {
            padding: 8px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 14px;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Language Switcher (Fixed) */
        .language-bar {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 10px 0;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .lang-btn {
            padding: 6px 12px;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            cursor: pointer;
            white-space: nowrap;
            font-size: 13px;
        }

        .lang-btn.active {
            background: rgba(255,215,0,0.3);
        }

        /* Feed Container */
        .feed-container {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
            padding-top: 120px;
        }

        .feed-container::-webkit-scrollbar { display: none; }

        .card {
            min-height: 100vh;
            width: 100vw;
            scroll-snap-align: start;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Content Types */
        .content-container {
            width: 100%;
            max-width: 600px;
            border-radius: 20px;
            overflow: hidden;
            background: #1a1a1a;
        }

        /* Video Player */
        .video-player {
            position: relative;
            width: 100%;
            aspect-ratio: 9/16;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .subtitle-container {
            position: absolute;
            bottom: 100px;
            left: 20px;
            right: 20px;
            text-align: center;
        }

        .subtitle-word {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background: rgba(0,0,0,0.7);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }

        .subtitle-word:hover {
            background: rgba(102,126,234,0.8);
            transform: scale(1.1);
        }

        .subtitle-word.active {
            background: rgba(255,215,0,0.8);
            color: #000;
            font-weight: bold;
        }

        /* News Article */
        .news-article {
            padding: 30px;
        }

        .news-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .news-content {
            font-size: 16px;
            line-height: 1.6;
            opacity: 0.9;
        }

        .news-word {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .news-word:hover {
            background: rgba(102,126,234,0.3);
        }

        /* AI Meme */
        .meme-container {
            width: 100%;
            aspect-ratio: 1;
            position: relative;
        }

        .meme-image {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
        }

        .meme-text {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 40px 20px 20px;
            text-align: center;
        }

        .meme-main {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .meme-translation {
            font-size: 16px;
            opacity: 0.8;
        }

        /* Translation Tooltip */
        .translation-tooltip {
            position: fixed;
            background: rgba(0,0,0,0.95);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,215,0,0.5);
            z-index: 2000;
            display: none;
        }

        .translation-tooltip.show {
            display: block;
        }

        .tooltip-word {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .tooltip-translation {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .tooltip-actions {
            display: flex;
            gap: 10px;
        }

        .tooltip-btn {
            padding: 8px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-hear {
            background: rgba(255,215,0,0.3);
            color: white;
        }

        /* Actions Panel */
        .actions-panel {
            position: absolute;
            right: 20px;
            bottom: 150px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            z-index: 3000;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">üöÄ Loading ultimate feed...</div>

    <!-- Navigation -->
    <div class="nav-header">
        <div class="nav-tabs" id="navTabs">
            <button class="nav-tab active" data-tab="all">üåü All</button>
            <button class="nav-tab" data-tab="ai">üé® AI Memes</button>
            <button class="nav-tab" data-tab="news">üì∞ News</button>
            <button class="nav-tab" data-tab="videos">üé¨ Videos</button>
        </div>
        <div class="language-bar" id="langBar"></div>
    </div>

    <!-- Feed -->
    <div class="feed-container" id="feed"></div>

    <!-- Translation Tooltip -->
    <div class="translation-tooltip" id="tooltip">
        <div class="tooltip-word" id="tooltipWord"></div>
        <div class="tooltip-translation" id="tooltipTranslation"></div>
        <div class="tooltip-actions">
            <button class="tooltip-btn btn-save" onclick="saveCurrentWord()">üíæ Save</button>
            <button class="tooltip-btn btn-hear" onclick="hearCurrentWord()">üîä Hear</button>
        </div>
    </div>

    <script>
        let currentLanguage = 'es';
        let currentTab = 'all';
        let languages = {};
        let allContent = [];
        let currentWord = { word: '', translation: '' };
        let videoLibrary = [];

        // Initialize
        async function init() {
            await loadLanguages();
            await loadVideoLibrary();
            await loadFeed();
            setupEventListeners();
        }

        // Load languages
        async function loadLanguages() {
            const res = await fetch('/api/languages');
            const data = await res.json();
            languages = data.languages;

            const langBar = document.getElementById('langBar');
            Object.entries(languages).forEach(([code, lang]) => {
                const btn = document.createElement('button');
                btn.className = 'lang-btn' + (code === currentLanguage ? ' active' : '');
                btn.textContent = `${lang.flag} ${lang.name}`;
                btn.onclick = () => switchLanguage(code, btn);
                langBar.appendChild(btn);
            });
        }

        // Switch language (FIXED!)
        function switchLanguage(code, clickedBtn) {
            currentLanguage = code;
            // Remove active from all buttons
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            // Add active to clicked button
            clickedBtn.classList.add('active');
            loadFeed();
        }

        // Load video library
        async function loadVideoLibrary() {
            try {
                const res = await fetch('/api/videos/library');
                const data = await res.json();
                videoLibrary = data.videos || [];
            } catch (e) {
                console.error('Video library error:', e);
            }
        }

        // Load feed content
        async function loadFeed() {
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            allContent = [];

            // Load AI memes
            for (let i = 0; i < 3; i++) {
                const scenario = await fetch(`/api/scenario/${currentLanguage}`).then(r => r.json());
                allContent.push({ type: 'ai', ...scenario });
            }

            // Load news
            try {
                const newsRes = await fetch(`/api/news/${currentLanguage}`);
                if (newsRes.ok) {
                    const newsData = await newsRes.json();
                    newsData.articles.forEach(article => {
                        allContent.push({ type: 'news', ...article });
                    });
                }
            } catch (e) {
                console.log('News not available');
            }

            // Load videos
            videoLibrary.slice(0, 3).forEach(video => {
                allContent.push({ type: 'video', ...video });
            });

            // Filter by tab
            let filteredContent = currentTab === 'all' ? allContent : allContent.filter(c => c.type === currentTab);

            // Render cards
            filteredContent.forEach((content, index) => {
                const card = createCard(content, index);
                feed.appendChild(card);
            });

            document.getElementById('loading').style.display = 'none';
        }

        // Create card based on type
        function createCard(content, index) {
            const card = document.createElement('div');
            card.className = 'card';

            if (content.type === 'ai') {
                card.innerHTML = `
                    <div class="content-container">
                        <div class="meme-container">
                            <div class="meme-image" style="background: linear-gradient(135deg, ${getRandomGradient()})">
                                ${content.emoji || 'üé®'}
                            </div>
                            <div class="meme-text">
                                <div class="meme-main">${content.text}</div>
                                <div class="meme-translation">${content.translation}</div>
                            </div>
                        </div>
                        <div class="actions-panel">
                            <div class="action-btn" onclick="playAudio('${content.text}', ${index})">üîä</div>
                            <div class="action-btn">‚ù§Ô∏è</div>
                            <div class="action-btn">üì§</div>
                        </div>
                    </div>
                `;
            } else if (content.type === 'news') {
                card.innerHTML = `
                    <div class="content-container">
                        <div class="news-article">
                            <div class="news-title">${makeWordsClickable(content.title || content.text)}</div>
                            <div class="news-content">${makeWordsClickable(content.description || content.translation)}</div>
                        </div>
                        <div class="actions-panel">
                            <div class="action-btn">‚ù§Ô∏è</div>
                            <div class="action-btn">üîñ</div>
                            <div class="action-btn">üì§</div>
                        </div>
                    </div>
                `;
            } else if (content.type === 'video') {
                card.innerHTML = `
                    <div class="content-container">
                        <div class="video-player">
                            <video src="${content.path}" controls></video>
                            <div class="subtitle-container" id="subs-${index}"></div>
                        </div>
                        <div class="actions-panel">
                            <div class="action-btn">‚ù§Ô∏è</div>
                            <div class="action-btn">üí¨</div>
                            <div class="action-btn">üì§</div>
                        </div>
                    </div>
                `;
                // Load subtitles
                if (content.subtitles) {
                    setTimeout(() => loadSubtitles(content.subtitles, index), 100);
                }
            }

            return card;
        }

        // Make words clickable for translation
        function makeWordsClickable(text) {
            return text.split(' ').map(word =>
                `<span class="news-word" onclick="showTranslation('${word}')">${word}</span>`
            ).join(' ');
        }

        // Show translation tooltip
        async function showTranslation(word) {
            const cleanWord = word.replace(/[^\w\s]/g, '').toLowerCase();
            const translation = await fetchTranslation(cleanWord);

            currentWord = { word: cleanWord, translation };

            document.getElementById('tooltipWord').textContent = cleanWord;
            document.getElementById('tooltipTranslation').textContent = translation;

            const tooltip = document.getElementById('tooltip');
            tooltip.className = 'translation-tooltip show';
            tooltip.style.top = '50%';
            tooltip.style.left = '50%';
            tooltip.style.transform = 'translate(-50%, -50%)';
        }

        // Fetch translation
        async function fetchTranslation(word) {
            // Mock translations
            const translations = {
                'hola': 'hello', 'c√≥mo': 'how', 'est√°s': 'are you', 'me': 'me', 'gusta': 'like',
                'la': 'the', 'paella': 'paella', 'quiero': 'I want', 'tacos': 'tacos', 'todos': 'all',
                'los': 'the', 'd√≠as': 'days', 'mi': 'my', 'guitarra': 'guitar', 'canta': 'sings',
                'mejor': 'better', 'que': 'than', 'yo': 'I', 'caf√©': 'coffee', 'primero': 'first',
                'espa√±ol': 'Spanish', 'despu√©s': 'later'
            };
            return translations[word] || 'translation';
        }

        // Save word
        async function saveCurrentWord() {
            await fetch('/api/words/learned', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: 'user_' + Date.now(),
                    word: currentWord.word,
                    translation: currentWord.translation,
                    level: 'A2',
                    context: ''
                })
            });
            document.getElementById('tooltip').classList.remove('show');
            alert('‚úÖ Word saved!');
        }

        // Hear word
        function hearCurrentWord() {
            const utterance = new SpeechSynthesisUtterance(currentWord.word);
            utterance.lang = currentLanguage === 'es' ? 'es-ES' : currentLanguage;
            speechSynthesis.speak(utterance);
        }

        // Play audio with OpenAI TTS
        async function playAudio(text, index) {
            try {
                const res = await fetch('/api/generate/audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, language: currentLanguage, voice: languages[currentLanguage]?.voice })
                });
                const audioBlob = await res.blob();
                const audio = new Audio(URL.createObjectURL(audioBlob));
                audio.play();
            } catch (e) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = currentLanguage === 'es' ? 'es-ES' : currentLanguage;
                speechSynthesis.speak(utterance);
            }
        }

        // Load subtitles
        function loadSubtitles(subtitles, videoIndex) {
            const container = document.getElementById(`subs-${videoIndex}`);
            if (!container) return;

            subtitles.slice(0, 1).forEach(sub => {
                sub.text.split(' ').forEach(word => {
                    const span = document.createElement('span');
                    span.className = 'subtitle-word';
                    span.textContent = word;
                    span.onclick = () => showTranslation(word);
                    container.appendChild(span);
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    currentTab = e.target.dataset.tab;
                    loadFeed();
                });
            });

            // Close tooltip on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.translation-tooltip') && !e.target.closest('.news-word') && !e.target.closest('.subtitle-word')) {
                    document.getElementById('tooltip').classList.remove('show');
                }
            });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                const feed = document.getElementById('feed');
                const currentScroll = feed.scrollTop;
                const cardHeight = window.innerHeight;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    feed.scrollTo({ top: currentScroll + cardHeight, behavior: 'smooth' });
                }
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    feed.scrollTo({ top: currentScroll - cardHeight, behavior: 'smooth' });
                }
            });
        }

        // Utility
        function getRandomGradient() {
            const gradients = [
                '#667eea 0%, #764ba2 100%', '#f093fb 0%, #f5576c 100%',
                '#4facfe 0%, #00f2fe 100%', '#43e97b 0%, #38f9d7 100%',
                '#fa709a 0%, #fee140 100%'
            ];
            return gradients[Math.floor(Math.random() * gradients.length)];
        }

        // Initialize app
        init();
    </script>
</body>
</html>
